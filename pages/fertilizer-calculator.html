---
layout: default
title: Fertilizer PPM Calculator
permalink: /fertilizer-calculator/
---

<link rel="stylesheet" href="{{ '/assets/css/fertilizer-calculator.css' | relative_url }}">

<!-- Progress Bar Overlay -->
<div id="progress-overlay" class="progress-overlay">
  <div class="progress-container">
    <h3 id="progress-title" data-i18n="calculating">Calculating...</h3>
    <div class="progress-bar-wrapper">
      <div id="progress-bar" class="progress-bar"></div>
    </div>
    <p id="progress-text" class="progress-text" data-i18n="initializingSolver">Initializing solver...</p>
    <button id="progress-cancel-btn" class="progress-cancel-btn" onclick="progressBar.cancel()" data-i18n="cancel">Cancel</button>
  </div>
</div>

<div class="calculator-container">
  <h1>Fertilizer Calculator</h1>

  <!-- Global Language Selector (visible on all wizard steps) -->
  <div class="language-selector" style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
    <label for="language-select" style="font-size: 0.85em; color: #666; margin-right: 8px; display: flex; align-items: center;" data-i18n="language">Language</label>
    <select id="language-select" onchange="i18n.setLanguage(this.value)" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
      <option value="en">English</option>
      <option value="gu">ગુજરાતી</option>
    </select>
  </div>

  <!-- Mode Selector (Wizard Step 1) -->
  <div id="mode-selector" class="mode-selector">
    <h2 data-i18n="whatWouldYouLikeToDo">What would you like to do?</h2>
    <p data-i18n="chooseModeDescription">Choose a calculator mode based on what information you have.</p>

    <div class="mode-cards">
      <!-- Grams to PPM -->
      <div class="mode-card" onclick="selectMode('ppm-calc')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L6 8"></path>
            <path d="M18 2L18 8"></path>
            <path d="M6 8C6 8 6 22 12 22C18 22 18 8 18 8"></path>
            <path d="M6 8H18"></path>
          </svg>
          <span data-i18n="gramsToPpm">Grams → PPM</span>
        </h3>
        <p class="description" data-i18n="gramsToPpmDescription">
          Calculate what nutrient concentrations (PPM) you'll get from specific amounts of fertilizers.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="gramsToPpmUseCase">You have fertilizers weighed out and want to know the resulting nutrient levels in your solution.</span>
        </div>
      </div>

      <!-- PPM to Grams -->
      <div class="mode-card" onclick="selectMode('formula-builder')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          <span data-i18n="ppmToGrams">PPM → Grams</span>
        </h3>
        <p class="description" data-i18n="ppmToGramsDescription">
          Enter your target PPM values and get the exact fertilizer amounts needed to achieve them.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="ppmToGramsUseCase">You have specific PPM targets (e.g., from a recipe or plant requirements) and need to know how much of each fertilizer to use.</span>
        </div>
      </div>

      <!-- NPK Ratio to Grams -->
      <div class="mode-card" onclick="selectMode('reverse-calc')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v18h18"></path>
            <path d="M18 17V9"></path>
            <path d="M13 17V5"></path>
            <path d="M8 17v-3"></path>
          </svg>
          <span data-i18n="npkRatioToGrams">NPK Ratio → Grams</span>
        </h3>
        <p class="description" data-i18n="npkRatioToGramsDescription">
          Enter nutrient ratios (like 3-1-2) and a target EC to get fertilizer amounts that match your desired balance.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="npkRatioUseCase">You know the nutrient ratio you want (e.g., for a specific growth stage) and want to scale it to your desired EC/strength.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Volume Selection -->
  <div id="volume-step" class="volume-step">
    <div class="step-indicator" id="volume-step-indicator" data-i18n-key="stepOf">Step 2 of 2</div>
    <h3 data-i18n="howMuchSolution">How much solution are you making?</h3>
    <p data-i18n="volumeDescription">Enter the total volume of water you'll be mixing your fertilizers into.</p>

    <div class="volume-step-input">
      <input type="number" id="wizard-volume" value="10" min="0.1" step="0.1" required onkeypress="if(event.key === 'Enter') proceedFromVolumeStep()">
      <span data-i18n="liters">liters</span>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" onclick="proceedFromVolumeStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" onclick="backToModeSelector()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step 3: Calculation Mode (only for PPM→Grams and NPK Ratio→Grams) -->
  <div id="calc-mode-step" class="calc-mode-step">
    <div class="step-indicator" id="calc-mode-step-indicator" data-i18n-key="stepOf">Step 3 of 3</div>
    <h3 data-i18n="howToEnterValues">How do you want to enter values?</h3>
    <p data-i18n="calcModeDescription">Choose between commercial fertilizer notation or pure elemental values.</p>

    <div class="calc-mode-options">
      <label class="calc-mode-option selected" onclick="selectCalcMode('oxide')">
        <input type="radio" name="wizard-calc-mode" value="oxide" checked>
        <div class="calc-mode-option-content">
          <strong data-i18n="oxideForms">Oxide Forms (P₂O₅, K₂O)</strong>
          <span data-i18n="oxideFormsDescription">Commercial standard - matches fertilizer bag labels</span>
        </div>
      </label>
      <label class="calc-mode-option" onclick="selectCalcMode('elemental')">
        <input type="radio" name="wizard-calc-mode" value="elemental">
        <div class="calc-mode-option-content">
          <strong data-i18n="elementalForms">Elemental Forms (P, K)</strong>
          <span data-i18n="elementalFormsDescription">Pure elements - for scientific calculations</span>
        </div>
      </label>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" onclick="proceedFromCalcModeStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" onclick="backToVolumeStep()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step 4: Target EC (only for NPK Ratio→Grams) -->
  <div id="ec-step" class="ec-step">
    <div class="step-indicator" id="ec-step-indicator" data-i18n-key="stepOf">Step 4 of 4</div>
    <h3 data-i18n="whatStrengthSolution">What strength solution do you want?</h3>
    <p data-i18n="ecDescription">Choose the EC (electrical conductivity) you want the mix to reach. It tells us how concentrated the nutrients should be, and we'll scale the fertilizer amounts to hit that strength for your batch.</p>

    <div class="ec-step-select">
      <select id="wizard-ec" onchange="updateECDescription()">
        <option value="ec:0.2" data-i18n="ecOption02">0.2 mS/cm - Plain Water Supplement</option>
        <option value="ec:0.4" data-i18n="ecOption04">0.4 mS/cm - Recovery/Flush</option>
        <option value="ec:0.6" data-i18n="ecOption06">0.6 mS/cm - Fresh Clones/Cuttings</option>
        <option value="ec:0.8" data-i18n="ecOption08">0.8 mS/cm - Rooted Cuttings</option>
        <option value="ec:1.0" data-i18n="ecOption10">1.0 mS/cm - Seedlings/Young Plants</option>
        <option value="ec:1.2" selected data-i18n="ecOption12">1.2 mS/cm - General Purpose</option>
        <option value="ec:1.5" data-i18n="ecOption15">1.5 mS/cm - Vegetative Growth</option>
        <option value="ec:1.8" data-i18n="ecOption18">1.8 mS/cm - Active Growth</option>
        <option value="ec:2.0" data-i18n="ecOption20">2.0 mS/cm - Heavy Feeders</option>
        <option value="ec:2.5" data-i18n="ecOption25">2.5 mS/cm - Flowering/Fruiting</option>
        <option value="ec:3.0" data-i18n="ecOption30">3.0 mS/cm - Maximum (experienced growers)</option>
      </select>
      <p class="ec-description" id="ec-description" data-i18n="ecDesc12">Good starting point for most plants in active growth.</p>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" onclick="proceedFromECStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" onclick="backToCalcModeStep()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step: Fertilizer Selection + Quantities (for Grams→PPM) -->
  <div id="grams-input-step" class="wizard-input-step">
    <div class="step-indicator" id="grams-input-step-indicator" data-i18n-key="stepOf">Step 3 of 3</div>
    <h3 data-i18n="selectFertilizersAndEnterAmounts">Select Fertilizers & Enter Amounts</h3>
    <p data-i18n="selectFertilizersDescription">Check the fertilizers you're using and enter how many grams of each you'll add to your solution.</p>

    <div class="wizard-fertilizer-section">
      <div class="wizard-fertilizer-search">
        <input type="text" id="wizard-grams-search" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers..." oninput="filterWizardGramsFertilizers(this.value)">
      </div>
      <div class="wizard-selection-controls">
        <button onclick="clearWizardGramsSelections()" data-i18n="clearAll">Clear All</button>
      </div>
      <div class="wizard-fertilizer-list" id="wizard-grams-fertilizer-list">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-calculate" onclick="calculateFromWizardGrams()" data-i18n="calculatePpm">Calculate PPM</button>
      <button class="btn-back" onclick="backToVolumeStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: Target PPM Values (for PPM→Grams) -->
  <div id="ppm-targets-step" class="wizard-input-step">
    <div class="step-indicator" id="ppm-targets-step-indicator" data-i18n-key="stepOf">Step 4 of 5</div>
    <h3 data-i18n="enterTargetPpmValues">Enter Target PPM Values</h3>
    <p data-i18n="targetPpmDescription">Enter the nutrient concentrations you want to achieve. At least one value is required.</p>

    <div class="input-grid">
      <div class="input-field">
        <label for="wizard-target-n" data-i18n="nitrogen">Nitrogen (N)</label>
        <input type="number" id="wizard-target-n" min="0" step="1" data-i18n-placeholder="exampleN" placeholder="e.g., 150">
      </div>
      <div class="input-field">
        <label for="wizard-target-p" id="wizard-target-p-label" data-i18n="phosphorusOxide">Phosphorus (P₂O₅)</label>
        <input type="number" id="wizard-target-p" min="0" step="1" data-i18n-placeholder="exampleP" placeholder="e.g., 50">
      </div>
      <div class="input-field">
        <label for="wizard-target-k" id="wizard-target-k-label" data-i18n="potassiumOxide">Potassium (K₂O)</label>
        <input type="number" id="wizard-target-k" min="0" step="1" data-i18n-placeholder="exampleK" placeholder="e.g., 200">
      </div>
      <div class="input-field">
        <label for="wizard-target-ca" data-i18n="calcium">Calcium (Ca)</label>
        <input type="number" id="wizard-target-ca" min="0" step="1" data-i18n-placeholder="exampleCa" placeholder="e.g., 150">
      </div>
      <div class="input-field">
        <label for="wizard-target-mg" data-i18n="magnesium">Magnesium (Mg)</label>
        <input type="number" id="wizard-target-mg" min="0" step="1" data-i18n-placeholder="exampleMg" placeholder="e.g., 50">
      </div>
      <div class="input-field">
        <label for="wizard-target-s" data-i18n="sulfur">Sulfur (S)</label>
        <input type="number" id="wizard-target-s" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-target-si" data-i18n="silicon">Silicon (Si)</label>
        <input type="number" id="wizard-target-si" min="0" step="1" value="0" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-continue" onclick="proceedToFormulaFertilizerStep()" data-i18n="continue">Continue →</button>
      <button class="btn-back" onclick="backToCalcModeStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: NPK Ratios (for NPK Ratio→Grams) -->
  <div id="npk-ratios-step" class="wizard-input-step">
    <div class="step-indicator" id="npk-ratios-step-indicator" data-i18n-key="stepOf">Step 5 of 6</div>
    <h3 data-i18n="enterNutrientRatios">Enter Nutrient Ratios</h3>
    <p data-i18n="nutrientRatiosDescription">Enter your desired nutrient ratios (e.g., N:P:K = 3:1:2). At least one must be greater than zero.</p>

    <div class="input-grid">
      <div class="input-field">
        <label for="wizard-ratio-n" data-i18n="nitrogen">Nitrogen (N)</label>
        <input type="number" id="wizard-ratio-n" min="0" step="1" data-i18n-placeholder="exampleRatioN" placeholder="e.g., 3">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-p" data-i18n="phosphorusElemental">Phosphorus (P)</label>
        <input type="number" id="wizard-ratio-p" min="0" step="1" data-i18n-placeholder="exampleRatioP" placeholder="e.g., 1">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-k" data-i18n="potassiumElemental">Potassium (K)</label>
        <input type="number" id="wizard-ratio-k" min="0" step="1" data-i18n-placeholder="exampleRatioK" placeholder="e.g., 2">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-ca" data-i18n="calcium">Calcium (Ca)</label>
        <input type="number" id="wizard-ratio-ca" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-mg" data-i18n="magnesium">Magnesium (Mg)</label>
        <input type="number" id="wizard-ratio-mg" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-s" data-i18n="sulfur">Sulfur (S)</label>
        <input type="number" id="wizard-ratio-s" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-si" data-i18n="siliconPpm">Silicon (Si) PPM</label>
        <input type="number" id="wizard-ratio-si" min="0" step="1" value="0" data-i18n-placeholder="targetPpm" placeholder="Target PPM">
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-continue" onclick="proceedToReverseFertilizerStep()" data-i18n="continue">Continue →</button>
      <button class="btn-back" onclick="backToECStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: Select Available Fertilizers (for PPM→Grams and NPK Ratio→Grams) -->
  <div id="fertilizer-select-step" class="wizard-input-step">
    <div class="step-indicator" id="fertilizer-select-step-indicator" data-i18n-key="stepOf">Step 5 of 5</div>
    <h3 data-i18n="selectAvailableFertilizers">Select Available Fertilizers</h3>
    <p data-i18n="selectAvailableFertilizersDescription">Choose the fertilizers you have on hand. The calculator will use only these to build your formula.</p>

    <div class="wizard-fertilizer-section">
      <div class="wizard-fertilizer-search">
        <input type="text" id="wizard-available-search" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers..." oninput="filterWizardAvailableFertilizers(this.value)">
      </div>
      <div class="wizard-selection-controls">
        <button onclick="selectAllWizardFertilizers()" data-i18n="selectAll">Select All</button>
        <button onclick="deselectAllWizardFertilizers()" data-i18n="deselectAll">Deselect All</button>
        <button onclick="selectCommonWizardFertilizers()" data-i18n="commonOnly">Common Only</button>
      </div>
      <div class="wizard-fertilizer-list" id="wizard-available-fertilizer-list">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-calculate" id="fertilizer-select-calc-btn" onclick="calculateFromWizardFertilizerSelect()" data-i18n="calculate">Calculate</button>
      <button class="btn-back" id="fertilizer-select-back-btn" onclick="backFromFertilizerSelectStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Two-Tank Question Step (shown when incompatible fertilizers detected) -->
  <div id="two-tank-question-step" class="wizard-input-step">
    <p class="step-indicator" id="two-tank-question-step-indicator">Step 6 of 6</p>
    <h3 data-i18n="twoTankQuestionTitle">Would you like to see a two-tank view?</h3>
    <div class="two-tank-explanation">
      <div class="incompatibility-warning">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <span data-i18n="incompatibleFertilizersDetected">Incompatible fertilizers detected in your selection</span>
      </div>
      <p data-i18n="twoTankExplanation">Your formula contains fertilizers that can react with each other when mixed at high concentrations (stock solutions). Specifically, calcium sources can precipitate when combined with sulfates, phosphates, or silicates at the wrong pH.</p>
      <div class="two-tank-info">
        <h4 data-i18n="whatIsTwoTankTitle">What is a Two-Tank System?</h4>
        <p data-i18n="whatIsTwoTankDescription">A two-tank system separates incompatible fertilizers into two concentrated stock solutions:</p>
        <ul>
          <li><strong data-i18n="tankALabel">Tank A (Calcium)</strong>: <span data-i18n="tankADescription">Contains calcium-based fertilizers like Calcium Nitrate</span></li>
          <li><strong data-i18n="tankBLabel">Tank B (Sulfates/Phosphates)</strong>: <span data-i18n="tankBDescription">Contains sulfate, phosphate, and silicate sources</span></li>
        </ul>
        <p data-i18n="twoTankMixingNote">Each tank is diluted separately, then combined in the final reservoir at working strength where the diluted concentrations are safe.</p>
      </div>
    </div>
    <div class="wizard-step-buttons two-tank-buttons">
      <button class="btn-continue btn-two-tank" onclick="showTwoTankView()" data-i18n="yesShowTwoTanks">Yes, show two-tank view</button>
      <button class="btn-back" onclick="skipTwoTankView()" data-i18n="noShowRegularResults">No, show regular results</button>
    </div>
  </div>

  <!-- Wizard Results View (shown after calculation from wizard) -->
  <div id="wizard-results" class="wizard-results">
    <div class="wizard-header">
      <button class="wizard-back-btn" onclick="backFromWizardResults()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        <span data-i18n="changeSettings">Change Settings</span>
      </button>
      <span class="wizard-current-mode" id="wizard-results-mode"></span>
    </div>
    <div id="wizard-results-container">
      <!-- Results will be rendered here -->
    </div>
  </div>

  <!-- Calculator Content (hidden in wizard flow, used for direct access) -->
  <div id="calculator-content" class="calculator-content">
    <div class="wizard-header">
      <button class="wizard-back-btn" onclick="backFromCalculator()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        <span data-i18n="changeSettings">Change Settings</span>
      </button>
      <span class="wizard-current-mode" id="wizard-current-mode"></span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab-target="ppm-calc" onclick="switchTab('ppm-calc', this)" data-i18n="tabGramsToPpm">Grams to PPM</button>
      <button class="tab" data-tab-target="formula-builder" onclick="switchTab('formula-builder', this)" data-i18n="tabPpmToGrams">PPM to Grams</button>
      <button class="tab" data-tab-target="reverse-calc" onclick="switchTab('reverse-calc', this)" data-i18n="tabNpkRatioToGrams">NPK Ratio to Grams</button>
    </div>

    <!-- PPM Calculator Tab -->
  <div id="ppm-calc" class="tab-content active">
    <div class="input-section">
    <div class="volume-control-row">
      <div class="volume-field">
        <label for="volume">Solution Volume:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" id="volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
          <span>liters</span>
        </div>
      </div>
      <div class="button-group">
        <button onclick="calculate()" class="btn btn-primary">
          Calculate PPM
        </button>
        <button onclick="clearAll()" class="btn btn-danger">
          Clear All
        </button>
      </div>
    </div>

    <div class="fertilizer-selector">
      <h3>Select Fertilizers and Enter Amounts</h3>
      <div class="search-box">
        <input type="text" id="search" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers...">
      </div>
      <div id="fertilizer-list"></div>
    </div>
  </div>

  <div class="results-section" id="selected-fertilizers-section" style="display: none;">
    <div class="results-header">
      <h2 data-i18n="selectedFertilizers">Selected Fertilizers</h2>
      <div id="grams-to-ppm-header-buttons" style="display: flex; gap: 10px;">
        <button class="copy-btn" onclick="copyGramsToPPMResults()" data-i18n-title="copyResultsToClipboard" title="Copy results to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          <span data-i18n="copyResults">Copy Results</span>
        </button>
      </div>
    </div>
    <div id="selected-fertilizers-list"></div>
  </div>

  <div class="results-section" id="results" style="display: none; margin-top: 20px;">
    <h2>
      <span data-i18n="resultsPpm">Results (PPM)</span>
      <span class="info-icon" onclick="openPPMExplanation()" data-i18n-title="clickToLearnPpm" title="Click to learn how we calculate PPM">?</span>
    </h2>
    <div class="results-grid" id="results-grid"></div>
    <div class="conversion-note">
      <strong data-i18n="noteLabel">Note:</strong> <span data-i18n="oxideConversionNote">Oxide values (P₂O₅, K₂O, etc.) are automatically converted to elemental forms (P, K, etc.) using standard conversion factors.</span>
    </div>
  </div>

  <div class="results-section" id="ion-balance-section" style="display: none; margin-top: 20px;">
    <h2>
      <span data-i18n="ionBalance">Ion Balance</span>
      <span class="info-icon" onclick="openIonBalanceExplanation()" data-i18n-title="clickToLearnIonBalance" title="Click to learn how we calculate Ion Balance">?</span>
    </h2>
    <div id="ion-balance-result"></div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong data-i18n="whatIsIonBalanceQuestion">What is ion balance?</strong> <span data-i18n="ionBalanceExplanationFull">Fertilizers dissolve into charged ions (cations like K⁺, Ca²⁺, NH₄⁺ and anions like NO₃⁻, SO₄²⁻, H₂PO₄⁻). A balanced feed has approximately equal positive and negative charges. Imbalance ≤10% is acceptable; higher values may cause pH swings and nutrient lockouts.</span>
    </div>
  </div>

  <div class="results-section" id="ratio-analysis-section" style="display: none; margin-top: 20px;">
    <h2 data-i18n="nutrientRatioAnalysis">Nutrient Ratio Analysis</h2>
    <div id="ratio-analysis-result"></div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong data-i18n="whatAreNutrientRatios">What are nutrient ratios?</strong> <span data-i18n="nutrientRatioExplanationFull">These ratios show the relative proportions of key nutrients. For example, "1 : 0.5 : 2" for N:P:K means for every 1 part nitrogen, you have 0.5 parts phosphorus and 2 parts potassium. These ratios help compare different fertilizer formulations and match specific crop requirements.</span>
    </div>
  </div>

  <div class="results-section" id="ec-tds-section" style="display: none; margin-top: 20px;">
    <h2 data-i18n="achievedEc">Achieved EC</h2>
    <div id="ec-tds-result"></div>
  </div>

  <div class="results-section" id="warnings-section" style="display: none; margin-top: 20px;">
    <h2 data-i18n="warningsAndRecommendations">Warnings & Recommendations</h2>
    <div id="warnings-result"></div>
  </div>
  </div>

  <!-- Formula Builder Tab -->
  <div id="formula-builder" class="tab-content">
    <div class="input-section">
      <h3>Target PPM Values</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient concentrations (at least one required). The calculator will find the best fertilizer combination to match your targets.</p>

      <div style="margin-bottom: 20px;">
        <label for="formula-calculation-mode" style="display: block; margin-bottom: 8px; font-weight: bold;">Input Mode</label>
        <select id="formula-calculation-mode" onchange="updateFormulaCalculationMode()" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
          <option value="oxide" selected>Oxide Forms (P₂O₅, K₂O) - Commercial Standard</option>
          <option value="elemental">Elemental Forms (P, K) - Pure Elements</option>
        </select>
        <p style="margin-top: 5px; margin-bottom: 15px; color: #666; font-size: 0.85em;">
          <strong>Oxide mode:</strong> Enter P₂O₅ and K₂O values (matches fertilizer labels and NPK Ratio to Grams output)<br>
          <strong>Elemental mode:</strong> Enter pure P and K values (scientific calculations)
        </p>
      </div>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="target-n">Nitrogen (N)</label>
          <input type="number" id="target-n" min="0" step="1" data-i18n-placeholder="exampleN" placeholder="e.g., 150" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-p" id="target-p-label">Phosphorus (P₂O₅)</label>
          <input type="number" id="target-p" min="0" step="1" data-i18n-placeholder="exampleP" placeholder="e.g., 50" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-k" id="target-k-label">Potassium (K₂O)</label>
          <input type="number" id="target-k" min="0" step="1" data-i18n-placeholder="exampleK" placeholder="e.g., 200" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-ca">Calcium (Ca)</label>
          <input type="number" id="target-ca" min="0" step="1" data-i18n-placeholder="exampleCa" placeholder="e.g., 150" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-mg">Magnesium (Mg)</label>
          <input type="number" id="target-mg" min="0" step="1" data-i18n-placeholder="exampleMg" placeholder="e.g., 50" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-s">Sulfur (S)</label>
          <input type="number" id="target-s" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="target-si">Silicon (Si) <small style="color:#666">PPM</small></label>
          <input type="number" id="target-si" min="0" step="1" value="0" data-i18n-placeholder="targetPpm" placeholder="Target PPM" oninput="validateTargetInput(this, true)">
        </div>
      </div>

      <div class="fertilizer-selection">
        <h4>Available Fertilizers</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Select the fertilizers you have available. The calculator will use only these to build your formula.</p>
        <div class="fertilizer-search">
          <input type="text" id="available-fertilizer-search" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers..." oninput="filterAvailableFertilizers(this.value)">
        </div>
        <div class="selection-controls">
          <button onclick="selectAllAvailableFertilizers()">Select All</button>
          <button onclick="deselectAllAvailableFertilizers()">Deselect All</button>
          <button onclick="selectCommonFertilizers()">Select Common Only</button>
        </div>
        <div class="fertilizer-grid" id="available-fertilizers-list"></div>
      </div>

      <div class="volume-input">
        <label for="formula-volume">Solution Volume:</label>
        <input type="number" id="formula-volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="buildFormula()" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Build Formula
        </button>
        <button onclick="clearFormulaBuilder()" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <div class="results-section" id="formula-results" style="display: none;">
      <div class="results-header" id="formula-results-header">
        <h2 data-i18n="recommendedFormula">Recommended Formula</h2>
        <div id="formula-header-buttons" style="display: flex; gap: 10px;">
          <button class="copy-btn" onclick="copyPPMToGramsResults()" title="Copy results to clipboard">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <span data-i18n="copyResults">Copy Results</span>
          </button>
        </div>
      </div>
      <div id="formula-output"></div>
    </div>
  </div>

  <!-- Reverse Calculator Tab -->
  <div id="reverse-calc" class="tab-content">
    <div class="input-section">
      <h3>Target Nutrient Ratios</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient ratios (e.g., N:P:K = 3:1:2). At least one nutrient must be greater than zero. The calculator will find fertilizer amounts that match these ratios.</p>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="reverse-n">Nitrogen (N)</label>
          <input type="number" id="reverse-n" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-p">Phosphorus (P)</label>
          <input type="number" id="reverse-p" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-k">Potassium (K)</label>
          <input type="number" id="reverse-k" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-ca">Calcium (Ca)</label>
          <input type="number" id="reverse-ca" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-mg">Magnesium (Mg)</label>
          <input type="number" id="reverse-mg" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-s">Sulfur (S)</label>
          <input type="number" id="reverse-s" min="0" step="1" data-i18n-placeholder="optionalZeroOrMore" placeholder="Optional (0 or more)" oninput="validateTargetInput(this, true)">
        </div>
        <div class="target-input-field">
          <label for="reverse-si">Silicon (Si) <small style="color:#666">PPM</small></label>
          <input type="number" id="reverse-si" min="0" step="1" value="0" data-i18n-placeholder="targetPpmNotRatio" placeholder="Target PPM (not ratio)" oninput="validateTargetInput(this, true)">
        </div>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-calculation-mode" style="display: block; margin-bottom: 8px; font-weight: bold;">Calculation Mode</label>
        <select id="reverse-calculation-mode" onchange="updateReverseCalculationMode()" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
          <option value="oxide" selected>Oxide Forms (P₂O₅, K₂O) - Commercial Standard</option>
          <option value="elemental">Elemental Forms (P, K) - Pure Elements</option>
        </select>
        <p style="margin-top: 5px; margin-bottom: 15px; color: #666; font-size: 0.85em;">
          <strong>Oxide mode:</strong> Uses P₂O₅ and K₂O (standard fertilizer labels)<br>
          <strong>Elemental mode:</strong> Uses pure P and K (scientific calculations)
        </p>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-concentration" style="display: block; margin-bottom: 8px; font-weight: bold;">Target EC (mS/cm)</label>
        <select id="reverse-concentration" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="ec:0.2">0.2 mS/cm - Plain Water Supplement</option>
          <option value="ec:0.4">0.4 mS/cm - Recovery/Flush</option>
          <option value="ec:0.6">0.6 mS/cm - Fresh Clones/Cuttings</option>
          <option value="ec:0.8">0.8 mS/cm - Rooted Cuttings</option>
          <option value="ec:1.0">1.0 mS/cm - Seedlings/Young Plants</option>
          <option value="ec:1.2" selected>1.2 mS/cm - General Purpose</option>
          <option value="ec:1.5">1.5 mS/cm - Vegetative Growth</option>
          <option value="ec:1.8">1.8 mS/cm - Active Growth</option>
          <option value="ec:2.0">2.0 mS/cm - Heavy Feeders</option>
          <option value="ec:2.5">2.5 mS/cm - Flowering/Fruiting</option>
          <option value="ec:3.0">3.0 mS/cm - Maximum (experienced growers)</option>
        </select>
        <p style="margin-top: 5px; color: #666; font-size: 0.85em;">
          Select your target EC. Fertilizer amounts will be scaled to achieve this conductivity.<br>
          <strong>Ratios are preserved</strong> while adjusting overall concentration.
        </p>
      </div>

      <div class="fertilizer-selection">
        <h4>Select Fertilizers to Use</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Choose which fertilizers you want to use. The calculator will find the best combination from your selection.<br>
        <strong>Priority:</strong> Lower values (1-10) = more preferred. The solver will try to use higher-priority fertilizers first.</p>
        <div class="fertilizer-search">
          <input type="text" id="reverse-fertilizer-search" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers..." oninput="filterReverseFertilizers(this.value)">
        </div>
        <div class="selection-controls">
          <button onclick="selectAllReverseFertilizers()">Select All</button>
          <button onclick="deselectAllReverseFertilizers()">Deselect All</button>
          <button onclick="selectCommonReverseFertilizers()">Select Common Only</button>
        </div>
        <div class="fertilizer-grid" id="reverse-fertilizers-list"></div>
      </div>

      <div class="volume-input">
        <label for="reverse-volume">Solution Volume:</label>
        <input type="number" id="reverse-volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="calculateReverse()" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Calculate Fertilizers
        </button>
        <button onclick="clearReverseCalculator()" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <div class="results-section" id="reverse-results" style="display: none;">
      <div class="results-header" id="reverse-results-header">
        <h2 data-i18n="requiredFertilizers">Required Fertilizers</h2>
        <div id="reverse-header-buttons" style="display: flex; gap: 10px;">
          <button class="copy-btn" onclick="copyNPKRatioResults()" title="Copy results to clipboard">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <span data-i18n="copyResults">Copy Results</span>
          </button>
        </div>
      </div>
      <div id="reverse-output"></div>
    </div>
  </div>

  </div><!-- End calculator-content -->

</div>

<!-- Educational Modal for PPM Calculation -->
<div id="ppm-modal" class="modal-overlay" onclick="closePPMExplanation(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Understanding PPM Calculations</h2>
      <button class="modal-close" onclick="closePPMExplanation()">&times;</button>
    </div>
    <div class="modal-body">

      <!-- What is PPM? -->
      <div class="explanation-section">
        <h3 data-i18n="whatIsPpm">What is PPM?</h3>
        <p data-i18n-html="ppmModalDescription1">
          <strong>PPM stands for "Parts Per Million"</strong> - it's a way to measure very small concentrations, similar to how we use percentages.
          Think of it like this: if you have 1 million drops of water, PPM tells you how many drops of nutrients are mixed in.
        </p>
        <p data-i18n-html="ppmModalDescription2">
          For example, <span class="highlight">100 PPM of Nitrogen</span> means there are 100 grams of nitrogen in every 1 million grams (1000 liters) of water.
          In simpler terms: <strong>1 PPM = 1 milligram per liter (mg/L)</strong>.
        </p>
      </div>

      <!-- The Basic Formula -->
      <div class="explanation-section">
        <h3 data-i18n="theBasicFormula">The Basic Formula</h3>
        <p data-i18n="hereIsTheFormula">Here's the formula we use to calculate PPM:</p>

        <div class="formula-box">
          <div class="formula" data-i18n="ppmFormulaEquation">PPM = (grams × 1000 × percentage) ÷ liters</div>
          <div class="description" data-i18n="ppmFormulaDescription">This tells us the concentration of nutrients in your solution</div>
        </div>

        <p data-i18n="breakDownEachPart">Let's break down each part:</p>
        <ul style="line-height: 1.8;">
          <li data-i18n-html="formulaPartGrams"><strong>grams</strong> = Amount of fertilizer you're adding</li>
          <li data-i18n-html="formulaPart1000"><strong>1000</strong> = Converts grams to milligrams (mg)</li>
          <li data-i18n-html="formulaPartPercentage"><strong>percentage</strong> = The nutrient content in the fertilizer (÷ 100)</li>
          <li data-i18n-html="formulaPartLiters"><strong>liters</strong> = Volume of water in your solution</li>
        </ul>
      </div>

      <!-- Step by Step Example -->
      <div class="explanation-section">
        <h3>Step-by-Step Example</h3>

        <div class="example-box">
          <h4>Real World Scenario:</h4>
          <p>You want to add <strong>2 grams</strong> of Calcium Nitrate (which contains <strong>19% Nitrogen</strong>) to <strong>10 liters</strong> of water.</p>
          <p><em>Question: How much Nitrogen (in PPM) will be in your final solution?</em></p>
        </div>

        <div class="step">
          <span class="step-number">1</span>
          <strong>Identify your values:</strong>
          <ul style="margin: 10px 0 0 38px; line-height: 1.6;">
            <li>Fertilizer amount = 2 grams</li>
            <li>Nitrogen percentage = 19% (or 0.19)</li>
            <li>Water volume = 10 liters</li>
          </ul>
        </div>

        <div class="step">
          <span class="step-number">2</span>
          <strong>Plug into the formula:</strong>
          <div style="margin: 10px 0 0 38px;">
            <code>PPM = (2 grams × 1000 × 0.19) ÷ 10 liters</code>
          </div>
        </div>

        <div class="step">
          <span class="step-number">3</span>
          <strong>Calculate step by step:</strong>
          <ul style="margin: 10px 0 0 38px; line-height: 1.6;">
            <li>2 × 1000 = 2000 mg</li>
            <li>2000 × 0.19 = 380 mg of nitrogen</li>
            <li>380 ÷ 10 = <strong>38 PPM</strong></li>
          </ul>
        </div>

        <div class="step">
          <span class="step-number">4</span>
          <strong>Result:</strong>
          <div style="margin: 10px 0 0 38px;">
            Your solution contains <span class="highlight">38 PPM of Nitrogen</span>
          </div>
        </div>
      </div>

      <!-- Multiple Fertilizers -->
      <div class="explanation-section">
        <h3>Using Multiple Fertilizers</h3>
        <p>
          When you use multiple fertilizers, we calculate the PPM from each one separately and then <strong>add them together</strong>.
        </p>

        <div class="example-box">
          <h4>Example with Two Fertilizers:</h4>
          <p>You add both Calcium Nitrate (2g, 19% N) and Potassium Nitrate (1.5g, 13% N) to 10 liters:</p>

          <ul style="line-height: 1.8; margin-top: 10px;">
            <li><strong>From Calcium Nitrate:</strong> (2 × 1000 × 0.19) ÷ 10 = 38 PPM</li>
            <li><strong>From Potassium Nitrate:</strong> (1.5 × 1000 × 0.13) ÷ 10 = 19.5 PPM</li>
            <li><strong>Total Nitrogen:</strong> 38 + 19.5 = <span class="highlight">57.5 PPM</span></li>
          </ul>
        </div>
      </div>

      <!-- Oxide Conversions -->
      <div class="explanation-section">
        <h3>Understanding Oxide Conversions</h3>
        <p>
          Many fertilizers list nutrients in their <strong>oxide form</strong> (like P₂O₅ for phosphorus or K₂O for potassium),
          but plants actually use the <strong>elemental form</strong>. Don't worry - the calculator handles this automatically!
        </p>

        <table class="conversion-table">
          <caption data-i18n="conversionTableCaption">Oxide to Elemental Nutrient Conversion Factors</caption>
          <thead>
            <tr>
              <th>Oxide Form (on fertilizer label)</th>
              <th>Elemental Form (what plants use)</th>
              <th>Conversion Factor</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td data-label-i18n="oxideFormHeader" data-i18n="phosphateOxide">P₂O₅ (Phosphate)</td>
              <td data-label-i18n="elementalFormHeader" data-i18n="phosphorusElemental">P (Phosphorus)</td>
              <td data-label-i18n="conversionFactorHeader" data-i18n="multiplyBy0436">Multiply by 0.436</td>
            </tr>
            <tr>
              <td data-label-i18n="oxideFormHeader" data-i18n="potassiumOxide">K₂O (Potash)</td>
              <td data-label-i18n="elementalFormHeader" data-i18n="potassiumElemental">K (Potassium)</td>
              <td data-label-i18n="conversionFactorHeader" data-i18n="multiplyBy0830">Multiply by 0.830</td>
            </tr>
            <tr>
              <td data-label-i18n="oxideFormHeader" data-i18n="magnesiumOxide">MgO (Magnesium Oxide)</td>
              <td data-label-i18n="elementalFormHeader" data-i18n="magnesiumElemental">Mg (Magnesium)</td>
              <td data-label-i18n="conversionFactorHeader" data-i18n="multiplyBy0603">Multiply by 0.603</td>
            </tr>
            <tr>
              <td data-label-i18n="oxideFormHeader" data-i18n="calciumOxide">CaO (Calcium Oxide)</td>
              <td data-label-i18n="elementalFormHeader" data-i18n="calciumElemental">Ca (Calcium)</td>
              <td data-label-i18n="conversionFactorHeader" data-i18n="multiplyBy0715">Multiply by 0.715</td>
            </tr>
          </tbody>
        </table>

        <div class="example-box" style="margin-top: 15px;">
          <h4>Quick Example:</h4>
          <p>
            If a fertilizer gives you <strong>100 PPM of P₂O₅</strong>, the actual phosphorus available to plants is:<br>
            <strong>100 × 0.436 = 43.6 PPM of P</strong>
          </p>
          <p style="margin-top: 10px; color: #17a2b8; font-weight: bold;">
            ✓ The calculator does this conversion automatically for you!
          </p>
        </div>
      </div>

      <!-- Why This Matters -->
      <div class="explanation-section">
        <h3>Why Does This Matter?</h3>
        <p>
          Understanding PPM helps you:
        </p>
        <ul style="line-height: 1.8;">
          <li><strong>Feed plants properly:</strong> Different plants need different nutrient levels (e.g., tomatoes might need 150-200 PPM nitrogen)</li>
          <li><strong>Avoid over-feeding:</strong> Too much nutrients can burn or damage plants</li>
          <li><strong>Save money:</strong> Use just the right amount of fertilizer</li>
          <li><strong>Compare recipes:</strong> Understand different fertilizer formulations</li>
        </ul>
      </div>

      <!-- Quick Tips -->
      <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
        <h3 style="color: #28a745;">Quick Tips</h3>
        <ul style="line-height: 1.8;">
          <li>Start with lower PPM values and increase gradually</li>
          <li>1 PPM = 1 mg/L (milligram per liter)</li>
          <li>More fertilizer ≠ better growth; balance is key</li>
          <li>Check your water's existing nutrient content if possible</li>
          <li>Different growth stages may need different PPM levels</li>
        </ul>
      </div>

    </div>
  </div>
</div>

<!-- Educational Modal for Ion Balance -->
<div id="ion-balance-modal" class="modal-overlay" onclick="closeIonBalanceExplanation(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Understanding Ion Balance</h2>
      <button class="modal-close" onclick="closeIonBalanceExplanation()">&times;</button>
    </div>
    <div class="modal-body" id="ion-balance-modal-body">
      <!-- Content will be dynamically generated -->
    </div>
  </div>
</div>

<!-- MILP dependencies -->
<script src="/assets/vendor/lp-model/lp-model.min.js"></script>
<script src="/assets/vendor/highs/highs.js"></script>

<!-- Fertilizer core calculations and data -->
<script src="/scripts/fertilizer-core.js"></script>

<!-- Localization files -->
<script src="/scripts/locales/en.js"></script>
<script src="/scripts/locales/gu.js"></script>

<script>
// =============================================================================
// IMPORT CORE CALCULATIONS AND DATA FROM EXTERNAL MODULE
// =============================================================================
const {
  FERTILIZERS,
  OXIDE_CONVERSIONS,
  MOLAR_MASSES,
  IONIC_CHARGES,
  EC_CONTRIBUTIONS,
  IONIC_MOLAR_CONDUCTIVITY,
  ION_CHARGES,
  ION_DATA,
  COMMON_FERTILIZERS,
  FERTILIZER_COMPATIBILITY,
  hasCaContent,
  hasSulfateContent,
  hasPhosphateContent,
  hasSilicateContent,
  hasIncompatibleFertilizers,
  solveMilpBrowser,
  estimateEC,
  ppmToIonsForEC,
  estimateECFromPPM,
  calculateNutrientRatios,
  solveNonNegativeLeastSquares,
  pruneSolution,
  optimizeFormula
} = window.FertilizerCore;
// Note: getIonBalanceStatus and calculateIonBalanceCore are defined locally as they use i18n

// =============================================================================
// INTERNATIONALIZATION (i18n) SUPPORT
// =============================================================================

const i18n = {
  currentLanguage: 'en',

  translations: {
    // English translations - loaded from /scripts/locales/en.js
    en: window.i18nLocales?.en || {},

    // Gujarati translations - loaded from /scripts/locales/gu.js
    gu: window.i18nLocales?.gu || {
      
    }
  },

  // Format a number according to the current language
  formatNumber(num) {
    const numStr = String(num);

    // Native numeral mappings for each language
    const numeralMaps = {
      'gu': ['૦', '૧', '૨', '૩', '૪', '૫', '૬', '૭', '૮', '૯']
    };

    const numerals = numeralMaps[this.currentLanguage];
    if (!numerals) {
      return numStr; // Return as-is for languages without custom numerals
    }

    // Replace each digit with its localized equivalent
    return numStr.replace(/[0-9]/g, digit => numerals[parseInt(digit)]);
  },

  // Format nutrient key into display-friendly label with proper subscripts
  formatNutrientLabel(nutrientKey) {
    const labelMap = {
      'N_total': 'N',
      'N_NO3': 'NO₃-N',
      'N_NH4': 'NH₄-N',
      'N_Urea': 'Urea-N',
      'P': 'P',
      'P2O5': 'P₂O₅',
      'K': 'K',
      'K2O': 'K₂O',
      'Ca': 'Ca',
      'Mg': 'Mg',
      'S': 'S',
      'Si': 'Si',
      'Fe': 'Fe',
      'Mn': 'Mn',
      'Zn': 'Zn',
      'Cu': 'Cu',
      'B': 'B',
      'Mo': 'Mo',
      'Cl': 'Cl',
      'Na': 'Na',
      'Co': 'Co',
      'Ni': 'Ni'
    };
    return labelMap[nutrientKey] || nutrientKey;
  },

  // Get translation for a key
  t(key, replacements = {}) {
    const lang = this.translations[this.currentLanguage] || this.translations.en;
    let text = lang[key] || this.translations.en[key] || key;

    // Handle replacements like {current} and {total}
    // Numbers are automatically formatted to localized numerals
    Object.keys(replacements).forEach(placeholder => {
      let value = replacements[placeholder];
      // Format numbers using localized numerals
      if (typeof value === 'number') {
        value = this.formatNumber(value);
      }
      text = text.replace(new RegExp(`\\{${placeholder}\\}`, 'g'), value);
    });

    return text;
  },

  // Set the current language and update UI
  setLanguage(langCode) {
    if (this.translations[langCode]) {
      this.currentLanguage = langCode;
      localStorage.setItem('fertCalcLanguage', langCode);
      this.updateUI();
      this.refreshDynamicContent();
    }
  },

  // Update all elements with data-i18n attribute
  updateUI() {
    // Update elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        el.textContent = this.t(key);
      }
    });

    // Update elements with data-i18n-placeholder attribute
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      const key = el.getAttribute('data-i18n-placeholder');
      if (key) {
        el.placeholder = this.t(key);
      }
    });

    // Update elements with data-i18n-title attribute
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      const key = el.getAttribute('data-i18n-title');
      if (key) {
        el.title = this.t(key);
      }
    });

    // Update elements with data-i18n-html attribute (for HTML content)
    document.querySelectorAll('[data-i18n-html]').forEach(el => {
      const key = el.getAttribute('data-i18n-html');
      if (key) {
        el.innerHTML = this.t(key);
      }
    });
  },

  // Refresh dynamically generated content (results, tables) after language change
  refreshDynamicContent() {
    // Re-render Grams → PPM results
    if (typeof lastGramsToPPMCalculation !== 'undefined' && lastGramsToPPMCalculation) {
      const { activeFertilizers, volume, results, ecData, ionBalance, ratios } = lastGramsToPPMCalculation;
      displaySelectedFertilizers(activeFertilizers);
      displayResults(results);
      displayECTDS(ecData, results);
      displayNutrientRatios(ratios);
    }

    // Re-render PPM → Grams results
    if (typeof lastFormulaCalculation !== 'undefined' && lastFormulaCalculation) {
      const { result, targets, volume, mode } = lastFormulaCalculation;
      displayFormulaResults(result, targets, volume, mode);
    }

    // Re-render NPK Ratio → Grams results
    if (typeof lastReverseCalculation !== 'undefined' && lastReverseCalculation) {
      const { result, targets, volume, mode, targetEC } = lastReverseCalculation;
      displayReverseResults(result, targets, volume, targetEC);
    }

    // Re-render Two-Tank results
    if (typeof currentTwoTankData !== 'undefined' && currentTwoTankData) {
      const { tankA, tankB, volume, mode, achieved, targets } = currentTwoTankData;
      displayTwoTankResults(tankA, tankB, volume, mode, achieved, targets);
    }
  },

  // Initialize language from localStorage or browser preference
  init() {
    const savedLang = localStorage.getItem('fertCalcLanguage');
    if (savedLang && this.translations[savedLang]) {
      this.currentLanguage = savedLang;
    } else {
      // Try to detect browser language
      const browserLang = navigator.language?.split('-')[0];
      if (browserLang && this.translations[browserLang]) {
        this.currentLanguage = browserLang;
      }
    }
    // Initial UI update will happen after DOM is ready
  },

  // Get list of available languages
  getAvailableLanguages() {
    return Object.keys(this.translations).map(code => ({
      code,
      name: this.getLanguageName(code)
    }));
  },

  // Get display name for a language code
  getLanguageName(code) {
    const names = {
      en: 'English',
      es: 'Español',
      fr: 'Français',
      de: 'Deutsch',
      pt: 'Português',
      it: 'Italiano',
      zh: '中文',
      ja: '日本語',
      ko: '한국어',
      hi: 'हिन्दी'
    };
    return names[code] || code.toUpperCase();
  }
};

// Initialize i18n
i18n.init();

// =============================================================================
// END INTERNATIONALIZATION
// =============================================================================

// Progress bar helper functions
const progressBar = {
  overlay: null,
  bar: null,
  title: null,
  text: null,
  cancelled: false,
  onCancel: null,

  init() {
    this.overlay = document.getElementById('progress-overlay');
    this.bar = document.getElementById('progress-bar');
    this.title = document.getElementById('progress-title');
    this.text = document.getElementById('progress-text');
  },

  show(title = 'Calculating...') {
    if (!this.overlay) this.init();
    this.cancelled = false;
    this.onCancel = null;
    this.title.textContent = title;
    this.bar.style.width = '0%';
    this.bar.classList.remove('indeterminate');
    this.text.textContent = 'Initializing...';
    this.overlay.classList.add('active');
  },

  update(percent, message) {
    if (!this.bar) this.init();
    this.bar.classList.remove('indeterminate');
    this.bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
    if (message) this.text.textContent = message;
  },

  setIndeterminate(message) {
    if (!this.bar) this.init();
    this.bar.classList.add('indeterminate');
    if (message) this.text.textContent = message;
  },

  hide() {
    if (!this.overlay) this.init();
    this.overlay.classList.remove('active');
    this.onCancel = null;
  },

  cancel() {
    this.cancelled = true;
    if (this.onCancel) {
      this.onCancel();
    }
    this.hide();
  },

  isCancelled() {
    return this.cancelled;
  }
};



// Validation functions
function validateVolumeInput(input) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for invalid values
  if (input.value !== '' && (isNaN(value) || value <= 0)) {
    input.classList.add('input-error');
    // Reset to minimum valid value if user tries to leave field
    if (value <= 0) {
      input.value = 0.1;
    }
  }

  // Auto-recalculate if results are showing
  if (document.getElementById('results') && document.getElementById('results').style.display !== 'none') {
    const validValue = parseFloat(input.value);
    if (!isNaN(validValue) && validValue > 0) {
      calculate();
    }
  }
}

function validateGramsInput(input) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for negative values
  if (input.value !== '' && (isNaN(value) || value < 0)) {
    input.classList.add('input-error');
    // Reset to 0 for negative values
    if (value < 0) {
      input.value = 0;
    }
  }
}

function validateTargetInput(input, allowZero = false) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for invalid values
  if (input.value !== '') {
    if (isNaN(value) || value < 0) {
      input.classList.add('input-error');
      if (value < 0) {
        input.value = allowZero ? 0 : 0.1;
      }
    } else if (!allowZero && value === 0) {
      input.classList.add('input-error');
    }
  }
}

// Wizard Mode Selection
// Returns localized mode names
function getModeName(mode) {
  const modeKeys = {
    'ppm-calc': 'gramsToPpm',
    'formula-builder': 'ppmToGrams',
    'reverse-calc': 'npkRatioToGrams'
  };
  return i18n.t(modeKeys[mode]) || mode;
}

// Modes that need the calculation mode step (step 3)
const MODES_WITH_CALC_MODE = ['formula-builder', 'reverse-calc'];

// Modes that need the EC step (step 4)
const MODES_WITH_EC = ['reverse-calc'];

// EC descriptions for the dropdown (maps to i18n translation keys)
const EC_DESCRIPTIONS = {
  'ec:0.2': 'ecDesc02',
  'ec:0.4': 'ecDesc04',
  'ec:0.6': 'ecDesc06',
  'ec:0.8': 'ecDesc08',
  'ec:1.0': 'ecDesc10',
  'ec:1.2': 'ecDesc12',
  'ec:1.5': 'ecDesc15',
  'ec:1.8': 'ecDesc18',
  'ec:2.0': 'ecDesc20',
  'ec:2.5': 'ecDesc25',
  'ec:3.0': 'ecDesc30'
};

let selectedMode = null;
let selectedCalcMode = 'oxide';
let selectedEC = 'ec:1.2';

function getStepCount(mode) {
  // Grams → PPM: mode, volume, grams input = 3 steps
  // PPM → Grams: mode, volume, calc-mode, ppm-targets, fertilizer-select = 5 steps
  // NPK Ratio → Grams: mode, volume, calc-mode, ec, npk-ratios, fertilizer-select = 6 steps
  if (mode === 'reverse-calc') return 6;
  if (mode === 'formula-builder') return 5;
  return 3; // ppm-calc
}

// =============================================================================
// CENTRALIZED WIZARD STEP MANAGEMENT
// =============================================================================

// All wizard step IDs in order
const WIZARD_STEPS = [
  'mode-selector',
  'volume-step',
  'calc-mode-step',
  'ec-step',
  'grams-input-step',
  'ppm-targets-step',
  'npk-ratios-step',
  'fertilizer-select-step',
  'two-tank-question-step',
  'wizard-results',
  'calculator-content'
];

// Step configuration: maps step ID to its indicator ID and step number per mode
const STEP_CONFIG = {
  'volume-step': {
    indicatorId: 'volume-step-indicator',
    stepNumber: { 'ppm-calc': 2, 'formula-builder': 2, 'reverse-calc': 2 }
  },
  'calc-mode-step': {
    indicatorId: 'calc-mode-step-indicator',
    stepNumber: { 'formula-builder': 3, 'reverse-calc': 3 }
  },
  'ec-step': {
    indicatorId: 'ec-step-indicator',
    stepNumber: { 'reverse-calc': 4 }
  },
  'grams-input-step': {
    indicatorId: 'grams-input-step-indicator',
    stepNumber: { 'ppm-calc': 3 }
  },
  'ppm-targets-step': {
    indicatorId: 'ppm-targets-step-indicator',
    stepNumber: { 'formula-builder': 4 }
  },
  'npk-ratios-step': {
    indicatorId: 'npk-ratios-step-indicator',
    stepNumber: { 'reverse-calc': 5 }
  },
  'fertilizer-select-step': {
    indicatorId: 'fertilizer-select-step-indicator',
    stepNumber: { 'formula-builder': 5, 'reverse-calc': 6 }
  },
  'two-tank-question-step': {
    indicatorId: 'two-tank-question-step-indicator',
    // Step number is dynamic (total + 1), handled specially
    stepNumber: null
  }
};

/**
 * Show a specific wizard step and hide all others
 * @param {string} stepId - The ID of the step to show
 * @param {Object} options - Optional configuration
 * @param {boolean} options.updateIndicator - Whether to update the step indicator (default: true)
 * @param {number} options.stepNumber - Override the step number (for dynamic steps like two-tank)
 * @param {number} options.totalSteps - Override the total steps (for dynamic steps)
 * @param {boolean} options.scroll - Whether to scroll to top (default: true)
 */
function showWizardStep(stepId, options = {}) {
  const { updateIndicator = true, stepNumber = null, totalSteps = null, scroll = true } = options;

  // Hide all wizard steps
  WIZARD_STEPS.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (id === 'mode-selector') {
        el.style.display = 'none';
      } else {
        el.classList.remove('active');
      }
    }
  });

  // Show the target step
  const targetStep = document.getElementById(stepId);
  if (targetStep) {
    if (stepId === 'mode-selector') {
      targetStep.style.display = '';
    } else {
      targetStep.classList.add('active');
    }
  }

  // Update step indicator if configured
  if (updateIndicator && selectedMode) {
    const config = STEP_CONFIG[stepId];
    if (config && config.indicatorId) {
      const indicator = document.getElementById(config.indicatorId);
      if (indicator) {
        const total = totalSteps || getStepCount(selectedMode);
        const current = stepNumber || (config.stepNumber && config.stepNumber[selectedMode]);
        if (current) {
          indicator.textContent = i18n.t('stepOf', { current, total });
        }
      }
    }
  }

  // Scroll wizard step into view
  if (scroll && targetStep) {
    targetStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// =============================================================================
// END CENTRALIZED WIZARD STEP MANAGEMENT
// =============================================================================

function selectMode(tabId) {
  // Store the selected mode
  selectedMode = tabId;

  // Show volume step (indicator will be updated automatically)
  showWizardStep('volume-step');

  // Focus on the volume input
  document.getElementById('wizard-volume').focus();
  document.getElementById('wizard-volume').select();
}

function proceedFromVolumeStep() {
  // Validate volume is a positive number
  const volumeInput = document.getElementById('wizard-volume');
  const volume = parseFloat(volumeInput.value);
  if (isNaN(volume) || volume <= 0) {
    volumeInput.focus();
    volumeInput.reportValidity();
    return;
  }

  // Check if this mode needs the calculation mode step
  if (MODES_WITH_CALC_MODE.includes(selectedMode)) {
    showWizardStep('calc-mode-step');
  } else if (selectedMode === 'ppm-calc') {
    showWizardStep('grams-input-step');
    renderWizardGramsFertilizerList();
  } else {
    // Skip directly to calculator (fallback)
    proceedToCalculator();
  }
}

function selectCalcMode(mode) {
  selectedCalcMode = mode;

  // Update visual selection
  document.querySelectorAll('.calc-mode-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  const selectedOption = document.querySelector(`input[name="wizard-calc-mode"][value="${mode}"]`);
  if (selectedOption) {
    selectedOption.checked = true;
    selectedOption.closest('.calc-mode-option').classList.add('selected');
  }
}

function proceedFromCalcModeStep() {
  // Check if this mode needs the EC step (NPK Ratio → Grams)
  if (MODES_WITH_EC.includes(selectedMode)) {
    showWizardStep('ec-step');
  } else if (selectedMode === 'formula-builder') {
    // Update P and K labels based on calc mode
    updateWizardPPMLabels();
    showWizardStep('ppm-targets-step');
  } else {
    // Skip to calculator (fallback)
    proceedToCalculator();
  }
}

function updateWizardPPMLabels() {
  const pLabel = document.getElementById('wizard-target-p-label');
  const kLabel = document.getElementById('wizard-target-k-label');
  if (selectedCalcMode === 'elemental') {
    pLabel.textContent = i18n.t('phosphorusElemental');
    kLabel.textContent = i18n.t('potassiumElemental');
  } else {
    pLabel.textContent = i18n.t('phosphorusOxide');
    kLabel.textContent = i18n.t('potassiumOxide');
  }
}

function updateECDescription() {
  const ecSelect = document.getElementById('wizard-ec');
  const descEl = document.getElementById('ec-description');
  if (ecSelect && descEl) {
    selectedEC = ecSelect.value;
    const descKey = EC_DESCRIPTIONS[selectedEC];
    descEl.textContent = descKey ? i18n.t(descKey) : '';
  }
}

function proceedFromECStep() {
  // EC step is only for NPK Ratio → Grams, go to npk-ratios-step
  showWizardStep('npk-ratios-step');
}

function proceedToCalculator() {
  // Get the volume from wizard input
  const wizardVolume = parseFloat(document.getElementById('wizard-volume').value) || 10;

  // Update volume inputs in all calculator tabs
  const volumeInput = document.getElementById('volume');
  if (volumeInput) volumeInput.value = wizardVolume;

  const formulaVolumeInput = document.getElementById('formula-volume');
  if (formulaVolumeInput) formulaVolumeInput.value = wizardVolume;

  const reverseVolumeInput = document.getElementById('reverse-volume');
  if (reverseVolumeInput) reverseVolumeInput.value = wizardVolume;

  // Apply calculation mode if applicable
  if (MODES_WITH_CALC_MODE.includes(selectedMode)) {
    if (selectedMode === 'formula-builder') {
      const formulaModeSelect = document.getElementById('formula-calculation-mode');
      if (formulaModeSelect) {
        formulaModeSelect.value = selectedCalcMode;
        updateFormulaCalculationMode();
      }
    } else if (selectedMode === 'reverse-calc') {
      const reverseModeSelect = document.getElementById('reverse-calculation-mode');
      if (reverseModeSelect) {
        reverseModeSelect.value = selectedCalcMode;
        updateReverseCalculationMode();
      }
    }
  }

  // Apply EC setting if applicable
  if (MODES_WITH_EC.includes(selectedMode)) {
    const reverseConcentration = document.getElementById('reverse-concentration');
    if (reverseConcentration) {
      reverseConcentration.value = selectedEC;
    }
  }

  // Show the calculator content (hides all wizard steps)
  showWizardStep('calculator-content', { updateIndicator: false });

  // Build mode indicator text
  let indicatorText = i18n.t('currentLabel') + ' <strong>' + getModeName(selectedMode) + '</strong> · ' + wizardVolume + i18n.t('litersShort');
  if (MODES_WITH_CALC_MODE.includes(selectedMode)) {
    indicatorText += ' · ' + (selectedCalcMode === 'oxide' ? i18n.t('oxideShort') : i18n.t('elementalShort'));
  }
  if (MODES_WITH_EC.includes(selectedMode)) {
    const ecValue = selectedEC.replace('ec:', '');
    indicatorText += ' · ' + ecValue + ' mS/cm';
  }

  // Update the current mode indicator
  const modeIndicator = document.getElementById('wizard-current-mode');
  modeIndicator.innerHTML = indicatorText;

  // Switch to the selected tab
  switchTab(selectedMode, document.querySelector(`[data-tab-target="${selectedMode}"]`));

  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function backToECStep() {
  showWizardStep('ec-step');
}

function backToCalcModeStep() {
  showWizardStep('calc-mode-step');
}

function backToVolumeStep() {
  showWizardStep('volume-step');
}

function backFromCalculator() {
  // Go back to the appropriate step based on mode
  if (selectedMode === 'ppm-calc') {
    showWizardStep('grams-input-step');
  } else if (selectedMode === 'formula-builder' || selectedMode === 'reverse-calc') {
    showWizardStep('fertilizer-select-step');
  } else {
    showWizardStep('volume-step');
  }
}

function backFromWizardResults() {
  // Go back to the appropriate step based on mode
  if (selectedMode === 'ppm-calc') {
    showWizardStep('grams-input-step');
  } else if (selectedMode === 'formula-builder' || selectedMode === 'reverse-calc') {
    showWizardStep('fertilizer-select-step');
  } else {
    showWizardStep('volume-step');
  }
}

function backToModeSelector() {
  // Clear pending two-tank calculation
  pendingWizardCalculation = null;

  // Show the mode selector
  showWizardStep('mode-selector');

  // Reset state
  selectedMode = null;
  selectedCalcMode = 'oxide';
  selectedEC = 'ec:1.2';

  // Reset calc mode selection UI
  document.querySelectorAll('.calc-mode-option').forEach(opt => opt.classList.remove('selected'));
  const oxideOption = document.querySelector('input[name="wizard-calc-mode"][value="oxide"]');
  if (oxideOption) {
    oxideOption.checked = true;
    oxideOption.closest('.calc-mode-option').classList.add('selected');
  }

  // Reset EC selection
  const ecSelect = document.getElementById('wizard-ec');
  if (ecSelect) {
    ecSelect.value = 'ec:1.2';
    updateECDescription();
  }

  // Reset wizard inputs
  clearWizardGramsSelections();
  clearWizardPPMTargets();
  clearWizardNPKRatios();

  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==========================================
// WIZARD STEP FUNCTIONS
// ==========================================

// --- Grams → PPM Wizard Functions ---

function renderWizardGramsFertilizerList() {
  const container = document.getElementById('wizard-grams-fertilizer-list');
  if (!container) return;
  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'wizard-fertilizer-item';
    item.id = `wizard-grams-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `wizard-grams-check-${fert.id}`;
    checkbox.className = 'wizard-fert-checkbox';

    const label = document.createElement('label');
    label.htmlFor = `wizard-grams-check-${fert.id}`;
    label.className = 'wizard-fert-label';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'wizard-fert-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'wizard-fert-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    const gramsInput = document.createElement('input');
    gramsInput.type = 'number';
    gramsInput.id = `wizard-grams-input-${fert.id}`;
    gramsInput.className = 'wizard-grams-input';
    gramsInput.placeholder = i18n.t('grams');
    gramsInput.setAttribute('data-i18n-placeholder', 'grams');
    gramsInput.min = '0';
    gramsInput.step = '0.1';
    gramsInput.oninput = function() {
      // Auto-check checkbox when user enters a value
      if (parseFloat(this.value) > 0) {
        checkbox.checked = true;
      }
    };

    item.appendChild(checkbox);
    item.appendChild(label);
    item.appendChild(gramsInput);
    container.appendChild(item);
  });
}

function filterWizardGramsFertilizers(searchTerm) {
  const term = searchTerm.toLowerCase();
  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`wizard-grams-item-${fert.id}`);
    if (!item) return;

    const nameMatch = fert.name.toLowerCase().includes(term);
    const aliasMatch = fert.aliases && fert.aliases.some(a => a.toLowerCase().includes(term));

    item.style.display = (nameMatch || aliasMatch || term === '') ? '' : 'none';
  });
}

function clearWizardGramsSelections() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`wizard-grams-check-${fert.id}`);
    const input = document.getElementById(`wizard-grams-input-${fert.id}`);
    if (checkbox) checkbox.checked = false;
    if (input) input.value = '';
  });
  const searchInput = document.getElementById('wizard-grams-search');
  if (searchInput) {
    searchInput.value = '';
    filterWizardGramsFertilizers('');
  }
}

// Store pending wizard calculation for two-tank decision
let pendingWizardCalculation = null;

function calculateFromWizardGrams() {
  // Get the volume from wizard input
  const wizardVolume = parseFloat(document.getElementById('wizard-volume').value) || 10;

  // Update volume in the main calculator
  const volumeInput = document.getElementById('volume');
  if (volumeInput) volumeInput.value = wizardVolume;

  // Clear all existing fertilizer selections in main calculator
  FERTILIZERS.forEach(fert => {
    const mainCheckbox = document.getElementById(`check-${fert.id}`);
    const mainInput = document.getElementById(`grams-${fert.id}`);
    if (mainCheckbox) mainCheckbox.checked = false;
    if (mainInput) mainInput.value = '';
  });

  // Transfer wizard selections to main calculator and build formula for compatibility check
  let hasSelection = false;
  const formula = {};
  FERTILIZERS.forEach(fert => {
    const wizardCheckbox = document.getElementById(`wizard-grams-check-${fert.id}`);
    const wizardInput = document.getElementById(`wizard-grams-input-${fert.id}`);
    const mainCheckbox = document.getElementById(`check-${fert.id}`);
    const mainInput = document.getElementById(`grams-${fert.id}`);

    if (wizardCheckbox && wizardCheckbox.checked && wizardInput && mainCheckbox && mainInput) {
      const grams = parseFloat(wizardInput.value) || 0;
      if (grams > 0) {
        mainCheckbox.checked = true;
        mainInput.value = grams;
        hasSelection = true;
        formula[fert.id] = grams;
      }
    }
  });

  if (!hasSelection) {
    alert(i18n.t('alertSelectFertilizerAndAmount'));
    return;
  }

  // Run the calculation (this renders results in the main calculator)
  calculate();

  // Copy results to wizard results container
  const resultsContainer = document.getElementById('wizard-results-container');
  const selectedFertSection = document.getElementById('selected-fertilizers-section');
  const resultsSection = document.getElementById('results');
  const ionBalanceSection = document.getElementById('ion-balance-section');
  const ratioSection = document.getElementById('ratio-analysis-section');
  const ecSection = document.getElementById('ec-tds-section');
  const warningsSection = document.getElementById('warnings-section');

  if (resultsContainer && selectedFertSection && resultsSection) {
    let html = selectedFertSection.outerHTML + resultsSection.outerHTML;
    if (ionBalanceSection) html += ionBalanceSection.outerHTML;
    if (ratioSection) html += ratioSection.outerHTML;
    if (ecSection) html += ecSection.outerHTML;
    if (warningsSection) html += warningsSection.outerHTML;
    resultsContainer.innerHTML = html;
  }

  // Build mode indicator text
  const indicatorText = i18n.t('currentLabel') + ' <strong>' + getModeName(selectedMode) + '</strong> · ' + wizardVolume + i18n.t('litersShort');

  // Check for incompatible fertilizers
  if (hasIncompatibleFertilizers(formula)) {
    // Store pending calculation for later
    pendingWizardCalculation = {
      type: 'grams-to-ppm',
      formula: formula,
      volume: wizardVolume,
      indicatorText: indicatorText,
      previousStep: 'grams-input-step'
    };

    // Show two-tank question step with dynamic step number
    const totalSteps = getStepCount(selectedMode) + 1;
    showWizardStep('two-tank-question-step', { stepNumber: totalSteps, totalSteps: totalSteps });
  } else {
    // No incompatibilities - show results directly
    document.getElementById('wizard-results-mode').innerHTML = indicatorText;
    showWizardStep('wizard-results', { updateIndicator: false });
  }
}

// --- PPM → Grams Wizard Functions ---

function clearWizardPPMTargets() {
  const fields = ['n', 'p', 'k', 'ca', 'mg', 's', 'si'];
  fields.forEach(field => {
    const input = document.getElementById(`wizard-target-${field}`);
    if (input) input.value = '';
  });
}

function proceedToFormulaFertilizerStep() {
  // Validate that at least one target is entered
  const fields = ['n', 'p', 'k', 'ca', 'mg', 's'];
  let hasTarget = false;
  fields.forEach(field => {
    const input = document.getElementById(`wizard-target-${field}`);
    if (input && parseFloat(input.value) > 0) {
      hasTarget = true;
    }
  });

  if (!hasTarget) {
    alert(i18n.t('alertEnterTargetPpm'));
    return;
  }

  // Render the fertilizer selection list
  renderWizardAvailableFertilizerList();

  // Show fertilizer select step
  showWizardStep('fertilizer-select-step');
}

// --- NPK Ratio → Grams Wizard Functions ---

function clearWizardNPKRatios() {
  const fields = ['n', 'p', 'k', 'ca', 'mg', 's', 'si'];
  fields.forEach(field => {
    const input = document.getElementById(`wizard-ratio-${field}`);
    if (input) input.value = '';
  });
}

function proceedToReverseFertilizerStep() {
  // Validate that at least one ratio is entered
  const fields = ['n', 'p', 'k', 'ca', 'mg', 's'];
  let hasRatio = false;
  fields.forEach(field => {
    const input = document.getElementById(`wizard-ratio-${field}`);
    if (input && parseFloat(input.value) > 0) {
      hasRatio = true;
    }
  });

  if (!hasRatio) {
    alert(i18n.t('alertEnterRatioValue'));
    return;
  }

  // Render the fertilizer selection list
  renderWizardAvailableFertilizerList();

  // Show fertilizer select step
  showWizardStep('fertilizer-select-step');
}

// --- Shared Fertilizer Selection Functions ---

function renderWizardAvailableFertilizerList() {
  const container = document.getElementById('wizard-available-fertilizer-list');
  if (!container) return;
  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'wizard-fertilizer-item';
    item.id = `wizard-avail-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `wizard-avail-check-${fert.id}`;
    checkbox.className = 'wizard-fert-checkbox';
    checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);

    const label = document.createElement('label');
    label.htmlFor = `wizard-avail-check-${fert.id}`;
    label.className = 'wizard-fert-label';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'wizard-fert-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'wizard-fert-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    item.appendChild(checkbox);
    item.appendChild(label);
    container.appendChild(item);
  });
}

function filterWizardAvailableFertilizers(searchTerm) {
  const term = searchTerm.toLowerCase();
  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`wizard-avail-item-${fert.id}`);
    if (!item) return;

    const nameMatch = fert.name.toLowerCase().includes(term);
    const aliasMatch = fert.aliases && fert.aliases.some(a => a.toLowerCase().includes(term));

    item.style.display = (nameMatch || aliasMatch || term === '') ? '' : 'none';
  });
}

function selectAllWizardFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`wizard-avail-check-${fert.id}`);
    if (checkbox) checkbox.checked = true;
  });
}

function deselectAllWizardFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`wizard-avail-check-${fert.id}`);
    if (checkbox) checkbox.checked = false;
  });
}

function selectCommonWizardFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`wizard-avail-check-${fert.id}`);
    if (checkbox) {
      checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);
    }
  });
}

function backFromFertilizerSelectStep() {
  if (selectedMode === 'formula-builder') {
    // Go back to PPM targets step
    showWizardStep('ppm-targets-step');
  } else if (selectedMode === 'reverse-calc') {
    // Go back to NPK ratios step
    showWizardStep('npk-ratios-step');
  }
}

async function calculateFromWizardFertilizerSelect() {
  // Get the volume from wizard input
  const wizardVolume = parseFloat(document.getElementById('wizard-volume').value) || 10;

  // Get selected fertilizers
  const selectedFerts = [];
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`wizard-avail-check-${fert.id}`);
    if (checkbox && checkbox.checked) {
      selectedFerts.push(fert.id);
    }
  });

  if (selectedFerts.length === 0) {
    alert(i18n.t('alertSelectFertilizer'));
    return;
  }

  // Build mode indicator text
  let indicatorText = i18n.t('currentLabel') + ' <strong>' + getModeName(selectedMode) + '</strong> · ' + wizardVolume + i18n.t('litersShort');
  indicatorText += ' · ' + (selectedCalcMode === 'oxide' ? i18n.t('oxideShort') : i18n.t('elementalShort'));

  let calculatedFormula = null;

  if (selectedMode === 'formula-builder') {
    // PPM → Grams calculation
    // Update volume
    const formulaVolumeInput = document.getElementById('formula-volume');
    if (formulaVolumeInput) formulaVolumeInput.value = wizardVolume;

    // Apply calculation mode
    const formulaModeSelect = document.getElementById('formula-calculation-mode');
    if (formulaModeSelect) {
      formulaModeSelect.value = selectedCalcMode;
      updateFormulaCalculationMode();
    }

    // Transfer target PPM values to the main calculator inputs
    const ppmMapping = {
      'n': 'target-n',
      'p': 'target-p',
      'k': 'target-k',
      'ca': 'target-ca',
      'mg': 'target-mg',
      's': 'target-s'
    };

    Object.entries(ppmMapping).forEach(([wizardField, formulaField]) => {
      const wizardInput = document.getElementById(`wizard-target-${wizardField}`);
      const formulaInput = document.getElementById(formulaField);
      if (wizardInput && formulaInput) {
        formulaInput.value = wizardInput.value || '';
      }
    });

    // Handle Silicon
    const siInput = document.getElementById('wizard-target-si');
    const formulaSiInput = document.getElementById('target-si');
    if (siInput && formulaSiInput) {
      formulaSiInput.value = siInput.value || '0';
    }

    // Transfer fertilizer selections to main calculator
    FERTILIZERS.forEach(fert => {
      const mainCheckbox = document.getElementById(`available-${fert.id}`);
      if (mainCheckbox) {
        mainCheckbox.checked = selectedFerts.includes(fert.id);
      }
    });

    // Run the calculation and wait for it to complete
    await buildFormula();

    // Copy results to wizard results container
    const resultsContainer = document.getElementById('wizard-results-container');
    const formulaResults = document.getElementById('formula-results');
    if (resultsContainer && formulaResults) {
      resultsContainer.innerHTML = formulaResults.outerHTML;
    }

    // Get the calculated formula for incompatibility check
    if (lastFormulaCalculation && lastFormulaCalculation.result) {
      calculatedFormula = lastFormulaCalculation.result.formula;
    }

  } else if (selectedMode === 'reverse-calc') {
    // NPK Ratio → Grams calculation
    // Update volume
    const reverseVolumeInput = document.getElementById('reverse-volume');
    if (reverseVolumeInput) reverseVolumeInput.value = wizardVolume;

    // Apply calculation mode
    const reverseModeSelect = document.getElementById('reverse-calculation-mode');
    if (reverseModeSelect) {
      reverseModeSelect.value = selectedCalcMode;
      updateReverseCalculationMode();
    }

    // Apply EC setting
    const reverseConcentration = document.getElementById('reverse-concentration');
    if (reverseConcentration) {
      reverseConcentration.value = selectedEC;
    }

    // Transfer ratio values to the main calculator inputs
    const ratioMapping = {
      'n': 'reverse-n',
      'p': 'reverse-p',
      'k': 'reverse-k',
      'ca': 'reverse-ca',
      'mg': 'reverse-mg',
      's': 'reverse-s'
    };

    Object.entries(ratioMapping).forEach(([wizardField, reverseField]) => {
      const wizardInput = document.getElementById(`wizard-ratio-${wizardField}`);
      const reverseInput = document.getElementById(reverseField);
      if (wizardInput && reverseInput) {
        reverseInput.value = wizardInput.value || '';
      }
    });

    // Handle Silicon
    const siInput = document.getElementById('wizard-ratio-si');
    const reverseSiInput = document.getElementById('reverse-si');
    if (siInput && reverseSiInput) {
      reverseSiInput.value = siInput.value || '0';
    }

    // Transfer fertilizer selections to main calculator
    FERTILIZERS.forEach(fert => {
      const mainCheckbox = document.getElementById(`reverse-${fert.id}`);
      if (mainCheckbox) {
        mainCheckbox.checked = selectedFerts.includes(fert.id);
      }
    });

    // Add EC to indicator
    const ecValue = selectedEC.replace('ec:', '');
    indicatorText += ' · ' + ecValue + ' mS/cm';

    // Run the calculation and wait for it to complete
    await calculateReverse();

    // Copy results to wizard results container
    const resultsContainer = document.getElementById('wizard-results-container');
    const reverseResults = document.getElementById('reverse-results');
    if (resultsContainer && reverseResults) {
      resultsContainer.innerHTML = reverseResults.outerHTML;
    }

    // Get the calculated formula for incompatibility check
    if (lastReverseCalculation && lastReverseCalculation.result) {
      calculatedFormula = lastReverseCalculation.result.formula;
    }
  }

  // Check for incompatible fertilizers
  if (calculatedFormula && hasIncompatibleFertilizers(calculatedFormula)) {
    // Store pending calculation for later
    pendingWizardCalculation = {
      type: selectedMode === 'formula-builder' ? 'ppm-to-grams' : 'npk-ratio-to-grams',
      formula: calculatedFormula,
      volume: wizardVolume,
      indicatorText: indicatorText,
      previousStep: 'fertilizer-select-step'
    };

    // Show two-tank question step with dynamic step number
    const totalSteps = getStepCount(selectedMode) + 1;
    showWizardStep('two-tank-question-step', { stepNumber: totalSteps, totalSteps: totalSteps });
  } else {
    // No incompatibilities - show results directly
    document.getElementById('wizard-results-mode').innerHTML = indicatorText;
    showWizardStep('wizard-results', { updateIndicator: false });
  }
}

// --- Two-Tank Question Step Functions ---

// Skip two-tank view and show regular results
function skipTwoTankView() {
  // Update the mode indicator in wizard results
  if (pendingWizardCalculation) {
    document.getElementById('wizard-results-mode').innerHTML = pendingWizardCalculation.indicatorText;

    // Re-copy all results to wizard container (in case they were modified)
    if (pendingWizardCalculation.type === 'grams-to-ppm') {
      const resultsContainer = document.getElementById('wizard-results-container');
      const selectedFertSection = document.getElementById('selected-fertilizers-section');
      const resultsSection = document.getElementById('results');
      const ionBalanceSection = document.getElementById('ion-balance-section');
      const ratioSection = document.getElementById('ratio-analysis-section');
      const ecSection = document.getElementById('ec-tds-section');
      const warningsSection = document.getElementById('warnings-section');

      if (resultsContainer && selectedFertSection && resultsSection) {
        let html = selectedFertSection.outerHTML + resultsSection.outerHTML;
        if (ionBalanceSection) html += ionBalanceSection.outerHTML;
        if (ratioSection) html += ratioSection.outerHTML;
        if (ecSection) html += ecSection.outerHTML;
        if (warningsSection) html += warningsSection.outerHTML;
        resultsContainer.innerHTML = html;
      }
    }
  }

  // Clear pending calculation
  pendingWizardCalculation = null;

  // Show wizard results
  showWizardStep('wizard-results', { updateIndicator: false });
}

// Show two-tank view
function showTwoTankView() {
  if (!pendingWizardCalculation) {
    alert(i18n.t('alertNoCalculationData'));
    return;
  }

  const { type, formula, volume, indicatorText } = pendingWizardCalculation;

  // Call the appropriate two-tank display function based on calculation type
  if (type === 'grams-to-ppm') {
    displayTwoTankGramsToPPMResults();
  } else if (type === 'ppm-to-grams') {
    displayTwoTankFormulaResults();
  } else if (type === 'npk-ratio-to-grams') {
    displayTwoTankReverseResults();
  }

  // Copy two-tank results to wizard results container
  const resultsContainer = document.getElementById('wizard-results-container');
  let sourceResults;

  if (type === 'grams-to-ppm') {
    const selectedFertSection = document.getElementById('selected-fertilizers-section');
    sourceResults = selectedFertSection;
  } else if (type === 'ppm-to-grams') {
    sourceResults = document.getElementById('formula-results');
  } else {
    sourceResults = document.getElementById('reverse-results');
  }

  if (resultsContainer && sourceResults) {
    resultsContainer.innerHTML = sourceResults.outerHTML;
  }

  // Update the mode indicator in wizard results
  document.getElementById('wizard-results-mode').innerHTML = indicatorText + ' · <span style="color: #17a2b8;">' + i18n.t('twoTankView') + '</span>';

  // Clear pending calculation
  pendingWizardCalculation = null;

  // Show wizard results
  showWizardStep('wizard-results', { updateIndicator: false });
}

// Back button handler for two-tank question step
function backFromTwoTankQuestion() {
  const previousStep = pendingWizardCalculation?.previousStep;

  // Clear pending calculation
  pendingWizardCalculation = null;

  // Show previous step or fallback to fertilizer select
  showWizardStep(previousStep || 'fertilizer-select-step');
}

// ==========================================
// END WIZARD STEP FUNCTIONS
// ==========================================

// Initialize the page
function init() {
  renderFertilizerList();
  renderAvailableFertilizersList();
  renderReverseFertilizersList();

  // Add event listeners
  document.getElementById('search').addEventListener('input', filterFertilizers);

  // Add Enter key support for wizard steps
  setupWizardKeyboardNavigation();

  // Initialize i18n (update UI with current language)
  i18n.updateUI();

  // Set language selector to current language
  const langSelect = document.getElementById('language-select');
  if (langSelect) {
    langSelect.value = i18n.currentLanguage;
  }
}

// Setup Enter key navigation for all wizard steps
function setupWizardKeyboardNavigation() {
  // Volume step - Enter proceeds
  const volumeStep = document.getElementById('volume-step');
  if (volumeStep) {
    volumeStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && volumeStep.classList.contains('active')) {
        e.preventDefault();
        proceedFromVolumeStep();
      }
    });
  }

  // Calc mode step - Enter proceeds
  const calcModeStep = document.getElementById('calc-mode-step');
  if (calcModeStep) {
    calcModeStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && calcModeStep.classList.contains('active')) {
        e.preventDefault();
        proceedFromCalcModeStep();
      }
    });
  }

  // EC step - Enter proceeds
  const ecStep = document.getElementById('ec-step');
  if (ecStep) {
    ecStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && ecStep.classList.contains('active')) {
        e.preventDefault();
        proceedFromECStep();
      }
    });
  }

  // Grams input step - Enter calculates
  const gramsInputStep = document.getElementById('grams-input-step');
  if (gramsInputStep) {
    gramsInputStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && gramsInputStep.classList.contains('active')) {
        // Don't trigger if focus is on search input
        if (e.target.id !== 'wizard-grams-search') {
          e.preventDefault();
          calculateFromWizardGrams();
        }
      }
    });
  }

  // PPM targets step - Enter proceeds
  const ppmTargetsStep = document.getElementById('ppm-targets-step');
  if (ppmTargetsStep) {
    ppmTargetsStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && ppmTargetsStep.classList.contains('active')) {
        e.preventDefault();
        proceedToFormulaFertilizerStep();
      }
    });
  }

  // NPK ratios step - Enter proceeds
  const npkRatiosStep = document.getElementById('npk-ratios-step');
  if (npkRatiosStep) {
    npkRatiosStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && npkRatiosStep.classList.contains('active')) {
        e.preventDefault();
        proceedToReverseFertilizerStep();
      }
    });
  }

  // Fertilizer select step - Enter calculates
  const fertilizerSelectStep = document.getElementById('fertilizer-select-step');
  if (fertilizerSelectStep) {
    fertilizerSelectStep.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && fertilizerSelectStep.classList.contains('active')) {
        // Don't trigger if focus is on search input
        if (e.target.id !== 'wizard-available-search') {
          e.preventDefault();
          calculateFromWizardFertilizerSelect();
        }
      }
    });
  }
}

// Render available fertilizers list for formula builder
function renderAvailableFertilizersList() {
  const container = document.getElementById('available-fertilizers-list');
  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'fertilizer-checkbox-item';
    item.id = `available-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `available-${fert.id}`;
    checkbox.checked = COMMON_FERTILIZERS.includes(fert.id); // Pre-select common fertilizers

    const label = document.createElement('label');
    label.htmlFor = `available-${fert.id}`;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'fertilizer-label-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'fertilizer-label-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    item.appendChild(checkbox);
    item.appendChild(label);
    container.appendChild(item);
  });
}

// Select all available fertilizers
function selectAllAvailableFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) checkbox.checked = true;
  });
}

// Deselect all available fertilizers
function deselectAllAvailableFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Select only common fertilizers
function selectCommonFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) {
      checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);
    }
  });
}

// Filter available fertilizers based on search term
function filterAvailableFertilizers(searchTerm) {
  const normalizedSearch = searchTerm.toLowerCase().trim();

  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`available-item-${fert.id}`);
    if (!item) return;

    // Search in name and aliases
    const nameMatch = fert.name.toLowerCase().includes(normalizedSearch);
    const aliasMatch = fert.aliases && fert.aliases.some(alias =>
      alias.toLowerCase().includes(normalizedSearch)
    );

    // Show/hide based on match
    if (nameMatch || aliasMatch || normalizedSearch === '') {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}

// Render the fertilizer list
function renderFertilizerList(filter = '') {
  const container = document.getElementById('fertilizer-list');

  // If list is empty, create all items first
  if (container.children.length === 0) {
    FERTILIZERS.forEach(fertilizer => {
      const item = document.createElement('div');
      item.className = 'fertilizer-item';
      item.id = `fert-${fertilizer.id}`;
      item.dataset.fertId = fertilizer.id;

      const composition = Object.entries(fertilizer.pct)
        .map(([key, val]) => `${key}: ${val}%`)
        .join(', ');

      item.innerHTML = `
        <div class="fertilizer-checkbox">
          <input type="checkbox" id="check-${fertilizer.id}"
                 onchange="toggleFertilizer('${fertilizer.id}')">
        </div>
        <label for="check-${fertilizer.id}" class="fertilizer-info">
          <div class="fertilizer-name">${fertilizer.name}</div>
          <div class="fertilizer-composition">${composition}</div>
        </label>
        <div class="fertilizer-input">
          <input type="number" id="grams-${fertilizer.id}"
                 value="0" min="0" step="0.1"
                 disabled
                 oninput="validateGramsInput(this)"
                 onchange="handleGramsChange('${fertilizer.id}')">
          <label>grams</label>
        </div>
      `;

      container.appendChild(item);
    });
  }

  // Filter by showing/hiding items
  const searchText = filter.toLowerCase();
  FERTILIZERS.forEach(fertilizer => {
    const item = document.getElementById(`fert-${fertilizer.id}`);
    if (item) {
      const matches = fertilizer.name.toLowerCase().includes(searchText) ||
                     fertilizer.aliases.some(a => a.toLowerCase().includes(searchText));
      item.style.display = matches ? '' : 'none';
    }
  });
}

// Filter fertilizers based on search
function filterFertilizers() {
  const search = document.getElementById('search').value;
  renderFertilizerList(search);
}

// Toggle fertilizer selection
function toggleFertilizer(id) {
  const checkbox = document.getElementById(`check-${id}`);
  const input = document.getElementById(`grams-${id}`);
  const item = document.getElementById(`fert-${id}`);

  if (checkbox.checked) {
    input.disabled = false;
    item.classList.add('active');
  } else {
    input.disabled = true;
    input.value = 0;
    item.classList.remove('active');
  }

  // Auto-calculate if results are showing
  if (document.getElementById('results').style.display !== 'none') {
    calculate();
  }
}

// Handle grams input change
function handleGramsChange(id) {
  if (document.getElementById('results').style.display !== 'none') {
    calculate();
  }
}

// Check for warnings (incompatibilities and imbalances)
function checkWarnings(results, activeFertilizers, ionBalance = null) {
  const warnings = [];

  // Extract common values
  const ca = results.Ca || 0;
  const mg = results.Mg || 0;
  const k = results.K || 0;
  const p = results.P || 0;
  const s = results.S || 0;
  const si = results.Si || 0;
  const cl = results.Cl || 0;
  const na = results.Na || 0;
  const fe = results.Fe || 0;
  const mn = results.Mn || 0;
  const zn = results.Zn || 0;
  const cu = results.Cu || 0;
  const b = results.B || 0;
  const mo = results.Mo || 0;
  const nh4 = results.N_NH4 || 0;
  const no3 = results.N_NO3 || 0;
  const totalN = nh4 + no3;

  // ============================================================================
  // SECTION A: STOCK SOLUTION / MIXING COMPATIBILITY (HARD warnings)
  // ============================================================================

  // 1. Calcium + Sulfate incompatibility (in stock solutions)
  if (ca > 10 && s > 10) {
    const caFertilizers = activeFertilizers.filter(f => f.pct && f.pct.Ca).map(f => f.name).join(', ');
    const sFertilizers = activeFertilizers.filter(f => f.pct && f.pct.S).map(f => f.name).join(', ');
    warnings.push({
      level: 'warning',
      category: i18n.t('warningCategoryCaSulfate'),
      message: i18n.t('warningMsgCaSulfate', { caFertilizers: caFertilizers || i18n.t('calciumFertilizers'), sFertilizers: sFertilizers || i18n.t('sulfateFertilizers') })
    });
  }

  // 8. Calcium + Phosphate incompatibility (Ca-P precipitate)
  if (ca > 10 && p > 10) {
    const caFertilizers = activeFertilizers.filter(f => f.pct && f.pct.Ca).map(f => f.name).join(', ');
    const pFertilizers = activeFertilizers.filter(f => f.pct && (f.pct.P || f.pct.P2O5)).map(f => f.name).join(', ');
    warnings.push({
      level: 'warning',
      category: i18n.t('warningCategoryCaPhosphate'),
      message: i18n.t('warningMsgCaPhosphate', { ca: i18n.formatNumber(ca.toFixed(1)), p: i18n.formatNumber(p.toFixed(1)), caFertilizers: caFertilizers || i18n.t('calciumFertilizers'), pFertilizers: pFertilizers || i18n.t('phosphateFertilizers') })
    });
  }

  // 9. Calcium + Silicate incompatibility (Ca-silicate gel/scale)
  if (ca > 10 && si > 10) {
    warnings.push({
      level: 'warning',
      category: i18n.t('warningCategoryCaSilicate'),
      message: i18n.t('warningMsgCaSilicate', { ca: i18n.formatNumber(ca.toFixed(1)), si: i18n.formatNumber(si.toFixed(1)) })
    });
  }

  // ============================================================================
  // SECTION B: NITROGEN / AMMONIUM BALANCE
  // ============================================================================

  // 2. High NH4 ratio (>30% - HARD warning)
  if (totalN > 0) {
    const nh4Ratio = (nh4 / totalN) * 100;
    if (nh4Ratio > 30) {
      warnings.push({
        level: 'warning',
        category: i18n.t('warningCategoryHighAmmonium'),
        message: i18n.t('warningMsgHighAmmonium', { ratio: i18n.formatNumber(nh4Ratio.toFixed(1)) })
      });
    }
  }

  // 12. Zero Ammonium (SOFT warning - optional guidance)
  if (totalN > 0 && nh4 === 0) {
    warnings.push({
      level: 'info',
      category: i18n.t('warningCategoryZeroAmmonium'),
      message: i18n.t('warningMsgZeroAmmonium')
    });
  }

  // 13. Very Low Ammonium (<3% - SOFT warning)
  if (totalN > 0 && nh4 > 0) {
    const nh4Ratio = (nh4 / totalN) * 100;
    if (nh4Ratio < 3) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryVeryLowAmmonium'),
        message: i18n.t('warningMsgVeryLowAmmonium', { ratio: i18n.formatNumber(nh4Ratio.toFixed(1)) })
      });
    }
  }

  // ============================================================================
  // SECTION C: NUTRIENT PRESENCE CHECKS (important for RO water)
  // ============================================================================

  // 14. Missing Calcium baseline
  if (ca < 20 && totalN > 0) {
    warnings.push({
      level: 'info',
      category: i18n.t('warningCategoryLowCalcium'),
      message: i18n.t('warningMsgLowCalcium', { ca: i18n.formatNumber(ca.toFixed(1)) })
    });
  }

  // 15. Missing Magnesium baseline
  if (mg < 10 && totalN > 0) {
    warnings.push({
      level: 'info',
      category: i18n.t('warningCategoryLowMagnesium'),
      message: i18n.t('warningMsgLowMagnesium', { mg: i18n.formatNumber(mg.toFixed(1)) })
    });
  }

  // 16. Micronutrients missing (sanity check for complete feeds)
  if (totalN > 0) {
    const missingMicros = [];
    if (fe === 0) missingMicros.push('Fe');
    if (b === 0) missingMicros.push('B');
    if (mn === 0) missingMicros.push('Mn');
    if (zn === 0) missingMicros.push('Zn');
    if (cu === 0) missingMicros.push('Cu');
    if (mo === 0) missingMicros.push('Mo');

    if (missingMicros.length > 0) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryMissingMicronutrients'),
        message: i18n.t('warningMsgMissingMicronutrients', { micros: missingMicros.join(', ') })
      });
    }
  }

  // ============================================================================
  // SECTION D: RATIO / ANTAGONISM RULES (SOFT warnings)
  // ============================================================================

  // 3. Ca:Mg ratio (optimal is 3:1 to 5:1)
  if (ca > 10 && mg > 5) {
    const ratio = ca / mg;
    if (ratio < 2) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryCaMgRatio'),
        message: i18n.t('warningMsgCaMgRatioLow', { ratio: i18n.formatNumber(ratio.toFixed(2)), ca: i18n.formatNumber(ca.toFixed(1)), mg: i18n.formatNumber(mg.toFixed(1)) })
      });
    } else if (ratio > 7) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryCaMgRatio'),
        message: i18n.t('warningMsgCaMgRatioHigh', { ratio: i18n.formatNumber(ratio.toFixed(2)), ca: i18n.formatNumber(ca.toFixed(1)), mg: i18n.formatNumber(mg.toFixed(1)) })
      });
    }
  }

  // 4. K:Ca ratio (should be reasonably balanced)
  if (k > 10 && ca > 10) {
    const kCaRatio = k / ca;
    if (kCaRatio > 3) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryKCaRatio'),
        message: i18n.t('warningMsgKCaRatioHigh', { ratio: i18n.formatNumber(kCaRatio.toFixed(2)) })
      });
    }
  }

  // 17. K:Mg antagonism risk
  if (k > 10 && mg > 5) {
    const kMgRatio = k / mg;
    if (kMgRatio > 6) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryKMgRatio'),
        message: i18n.t('warningMsgKMgRatioHigh', { ratio: i18n.formatNumber(kMgRatio.toFixed(2)), k: i18n.formatNumber(k.toFixed(1)), mg: i18n.formatNumber(mg.toFixed(1)) })
      });
    } else if (kMgRatio < 1.5) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryKMgRatio'),
        message: i18n.t('warningMsgKMgRatioLow', { ratio: i18n.formatNumber(kMgRatio.toFixed(2)), k: i18n.formatNumber(k.toFixed(1)), mg: i18n.formatNumber(mg.toFixed(1)) })
      });
    }
  }

  // 18. (Ca + Mg):K balance
  if (k > 10 && (ca + mg) > 10) {
    const caMgSum = ca + mg;
    if (k > caMgSum * 1.5) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryCaMgKBalance'),
        message: i18n.t('warningMsgCaMgKBalance', { k: i18n.formatNumber(k.toFixed(1)), caMgSum: i18n.formatNumber(caMgSum.toFixed(1)) })
      });
    }
  }

  // 19. N:K ratio (vegetative vs generative style)
  if (totalN > 0 && k > 0) {
    const nkRatio = totalN / k;
    warnings.push({
      level: 'info',
      category: i18n.t('warningCategoryNKRatio'),
      message: i18n.t('warningMsgNKRatio', { nkRatio: i18n.formatNumber((k/totalN).toFixed(2)), n: i18n.formatNumber(totalN.toFixed(1)), k: i18n.formatNumber(k.toFixed(1)) })
    });
  }

  // ============================================================================
  // SECTION E: TOXICITY / UNDESIRABLE IONS
  // ============================================================================

  // 5. EC levels (high and low) - using unified estimateECFromPPM
  const ecData = estimateECFromPPM(results);
  if (ecData.ec_mS_cm > 3.5) {
    warnings.push({
      level: 'warning',
      category: i18n.t('warningCategoryHighEC'),
      message: i18n.t('warningMsgHighEC', { ec: i18n.formatNumber(ecData.ec_mS_cm.toFixed(2)) })
    });
  } else if (ecData.ec_mS_cm < 0.5 && totalN > 0) {
    warnings.push({
      level: 'info',
      category: i18n.t('warningCategoryLowEC'),
      message: i18n.t('warningMsgLowEC', { ec: i18n.formatNumber(ecData.ec_mS_cm.toFixed(2)) })
    });
  }

  // 6. High Chloride
  if (cl > 100) {
    warnings.push({
      level: 'warning',
      category: i18n.t('warningCategoryHighChloride'),
      message: i18n.t('warningMsgHighChlorideLevel', { cl: i18n.formatNumber(cl.toFixed(1)) })
    });
  }

  // 20. High Sodium
  if (na > 50) {
    const severity = na > 100 ? 'warning' : 'info';
    warnings.push({
      level: severity,
      category: i18n.t('warningCategoryHighSodium'),
      message: i18n.t('warningMsgHighSodiumLevel', { na: i18n.formatNumber(na.toFixed(1)), severity: na > 100 ? i18n.t('warningMsgThisIsVeryHigh') : '' })
    });
  }

  // 21. High Boron (narrow safe window)
  if (b > 0.5) {
    const severity = b > 1.0 ? 'warning' : 'info';
    warnings.push({
      level: severity,
      category: i18n.t('warningCategoryHighBoron'),
      message: i18n.t('warningMsgHighBoron', { b: i18n.formatNumber(b.toFixed(2)), severity: b > 1.0 ? i18n.t('warningMsgThisMayCauseToxicity') : i18n.t('warningMsgThisIsOnTheHighEnd') })
    });
  }

  // 22. High Cu/Zn/Mn (micros can go toxic fast)
  if (cu > 0.1) {
    warnings.push({
      level: cu > 0.2 ? 'warning' : 'info',
      category: i18n.t('warningCategoryHighCopper'),
      message: i18n.t('warningMsgHighCopper', { cu: i18n.formatNumber(cu.toFixed(2)), severity: cu > 0.2 ? i18n.t('warningMsgThisMayCauseToxicity') : i18n.t('warningMsgThisIsOnTheHighEnd') })
    });
  }

  if (zn > 0.5) {
    warnings.push({
      level: zn > 1.0 ? 'warning' : 'info',
      category: i18n.t('warningCategoryHighZinc'),
      message: i18n.t('warningMsgHighZinc', { zn: i18n.formatNumber(zn.toFixed(2)), severity: zn > 1.0 ? i18n.t('warningMsgThisMayCauseToxicity') : i18n.t('warningMsgThisIsOnTheHighEnd') })
    });
  }

  if (mn > 2) {
    warnings.push({
      level: mn > 3 ? 'warning' : 'info',
      category: i18n.t('warningCategoryHighManganese'),
      message: i18n.t('warningMsgHighManganese', { mn: i18n.formatNumber(mn.toFixed(2)), severity: mn > 3 ? i18n.t('warningMsgThisMayCauseToxicity') : i18n.t('warningMsgThisIsOnTheHighEnd') })
    });
  }

  // ============================================================================
  // SECTION F: CALCULATOR SANITY CHECK
  // ============================================================================

  // 23. Charge balance (electroneutrality) - use data from ion balance section if available
  if (ionBalance && ionBalance.totalCations > 0.1) {
    // Use the properly calculated ion balance data
    if (ionBalance.imbalance > 15) {
      warnings.push({
        level: 'info',
        category: i18n.t('warningCategoryChargeBalance'),
        message: i18n.t('warningMsgChargeBalance', { imbalance: i18n.formatNumber(ionBalance.imbalance.toFixed(1)), cations: i18n.formatNumber(ionBalance.totalCations.toFixed(2)), anions: i18n.formatNumber(ionBalance.totalAnions.toFixed(2)) })
      });
    }
  }

  return warnings;
}

// Display EC results using unified render function
function displayECTDS(ecData, ppmResults = null) {
  const resultsSection = document.getElementById('ec-tds-section');
  const outputDiv = document.getElementById('ec-tds-result');

  resultsSection.style.display = 'block';

  // If ppmResults provided, use the new estimateECFromPPM for detailed breakdown
  // Otherwise, create a compatible structure from legacy ecData
  let ecPrediction;
  if (ppmResults) {
    ecPrediction = estimateECFromPPM(ppmResults);
  } else {
    // Legacy fallback - create minimal structure
    ecPrediction = {
      ec_mS_cm: ecData.ec,
      ionicStrength: ecData.ionicStrength,
      contributions: {}
    };
  }

  // Use unified render function (no targetEC for Grams→PPM mode)
  outputDiv.innerHTML = renderEcSection(ecPrediction, {});
}

// Display warnings
function displayWarnings(warnings) {
  const resultsSection = document.getElementById('warnings-section');
  const outputDiv = document.getElementById('warnings-result');

  if (warnings.length === 0) {
    resultsSection.style.display = 'none';
    return;
  }

  resultsSection.style.display = 'block';

  let html = '';

  warnings.forEach(warning => {
    const boxClass = warning.level === 'warning' ? 'warning-box' :
                     warning.level === 'error' ? 'error-box' : 'conversion-note';
    const icon = warning.level === 'warning' ? '⚠️' :
                 warning.level === 'error' ? '❌' : 'ℹ️';

    html += `
      <div class="${boxClass}" style="margin-bottom: 10px;">
        <strong>${icon} ${warning.category}</strong><br>
        ${warning.message}
      </div>
    `;
  });

  outputDiv.innerHTML = html;
}

// Store last Grams to PPM calculation result for copy function
let lastGramsToPPMCalculation = null;

// Main calculation function
function calculate() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value);

  // Validate volume
  if (!volume || volume <= 0 || isNaN(volume)) {
    alert(i18n.t('alertEnterValidVolume'));
    volumeInput.classList.add('input-error');
    volumeInput.focus();
    return;
  }
  volumeInput.classList.remove('input-error');

  // Collect all active fertilizers and their amounts
  const activeFertilizers = [];
  let hasInvalidGrams = false;

  FERTILIZERS.forEach(f => {
    const checkbox = document.getElementById(`check-${f.id}`);
    if (checkbox && checkbox.checked) {
      const gramsInput = document.getElementById(`grams-${f.id}`);
      const grams = parseFloat(gramsInput.value);

      // Validate grams input
      if (isNaN(grams) || grams < 0) {
        gramsInput.classList.add('input-error');
        hasInvalidGrams = true;
      } else {
        gramsInput.classList.remove('input-error');
        if (grams > 0) {
          activeFertilizers.push({ ...f, grams });
        }
      }
    }
  });

  if (hasInvalidGrams) {
    alert(i18n.t('alertFixInvalidInputs'));
    return;
  }

  if (activeFertilizers.length === 0) {
    alert(i18n.t('alertSelectFertilizerWithAmount'));
    return;
  }

  // Calculate PPM for each nutrient
  const ppmResults = {};

  activeFertilizers.forEach(fert => {
    Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
      // ppm = (grams × 1000 × (pct/100)) / liters
      const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;

      if (!ppmResults[nutrient]) {
        ppmResults[nutrient] = 0;
      }

      // Handle nitrogen forms properly to avoid double counting
      if (nutrient === 'N_NO3' || nutrient === 'N_NH4') {
        ppmResults[nutrient] += ppm;
        // Also add to N_total
        if (!ppmResults.N_total) ppmResults.N_total = 0;
        ppmResults.N_total += ppm;
      } else if (nutrient === 'N_total') {
        // Only use N_total if there are no specific nitrogen forms
        if (!fert.pct.N_NO3 && !fert.pct.N_NH4) {
          ppmResults[nutrient] += ppm;
        }
      } else {
        ppmResults[nutrient] += ppm;
      }
    });
  });

  // Convert oxides to elements
  const finalResults = { ...ppmResults };

  // P from P2O5
  if (ppmResults.P2O5) {
    finalResults.P = (finalResults.P || 0) + (ppmResults.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P);
  }

  // K from K2O
  if (ppmResults.K2O) {
    finalResults.K = (finalResults.K || 0) + (ppmResults.K2O * OXIDE_CONVERSIONS.K2O_to_K);
  }

  // Ca from CaO
  if (ppmResults.CaO) {
    finalResults.Ca = (finalResults.Ca || 0) + (ppmResults.CaO * OXIDE_CONVERSIONS.CaO_to_Ca);
  }

  // Mg from MgO
  if (ppmResults.MgO) {
    finalResults.Mg = (finalResults.Mg || 0) + (ppmResults.MgO * OXIDE_CONVERSIONS.MgO_to_Mg);
  }

  // S from SO3
  if (ppmResults.SO3) {
    finalResults.S = (finalResults.S || 0) + (ppmResults.SO3 * OXIDE_CONVERSIONS.SO3_to_S);
  }

  // Si from SiO2
  if (ppmResults.SiO2) {
    finalResults.Si = (finalResults.Si || 0) + (ppmResults.SiO2 * OXIDE_CONVERSIONS.SiO2_to_Si);
  }

  // Si from SiOH4 (orthosilicic acid)
  if (ppmResults.SiOH4) {
    finalResults.Si = (finalResults.Si || 0) + (ppmResults.SiOH4 * OXIDE_CONVERSIONS.SiOH4_to_Si);
  }

  // Display selected fertilizers
  displaySelectedFertilizers(activeFertilizers);

  // Display results
  displayResults(finalResults);

  // Calculate and display EC - using unified estimateECFromPPM
  const ecData = estimateECFromPPM(finalResults);
  displayECTDS(ecData, finalResults);

  // Calculate and display ion balance (must be before warnings so we can use the data)
  const ionBalance = calculateIonBalance(activeFertilizers, volume);

  // Check and display warnings (pass ion balance data)
  const warnings = checkWarnings(finalResults, activeFertilizers, ionBalance);
  displayWarnings(warnings);

  // Calculate and display nutrient ratios
  const ratios = calculateNutrientRatios(finalResults);
  displayNutrientRatios(ratios);

  // Store calculation data for copy function
  lastGramsToPPMCalculation = {
    activeFertilizers,
    volume,
    results: finalResults,
    ecData,
    ionBalance,
    ratios
  };
}

// Display selected fertilizers
function displaySelectedFertilizers(activeFertilizers) {
  const section = document.getElementById('selected-fertilizers-section');
  const list = document.getElementById('selected-fertilizers-list');

  section.style.display = 'block';
  list.innerHTML = '';

  if (activeFertilizers.length === 0) {
    section.style.display = 'none';
    return;
  }

  // Calculate total grams
  let totalGrams = 0;

  activeFertilizers.forEach((fert, index) => {
    totalGrams += fert.grams;
    const item = document.createElement('div');
    item.className = 'selected-fertilizer-item';

    const composition = Object.entries(fert.pct)
      .map(([key, val]) => `${key}: ${val}%`)
      .join(', ');

    item.innerHTML = `
      <div class="selected-fertilizer-info">
        <div class="selected-fertilizer-name"><span class="fertilizer-number">${index + 1}.</span> ${fert.name}</div>
        <div class="selected-fertilizer-composition">${composition}</div>
      </div>
      <div class="selected-fertilizer-amount">${i18n.formatNumber(fert.grams.toFixed(2))} ${i18n.t('gramsShort')}</div>
    `;

    list.appendChild(item);
  });

  // Add total row if more than one fertilizer
  if (activeFertilizers.length > 0) {
    const totalItem = document.createElement('div');
    totalItem.className = 'selected-fertilizer-item selected-fertilizer-total';
    totalItem.innerHTML = `
      <div class="selected-fertilizer-info">
        <div class="selected-fertilizer-name">${i18n.t('totalFertilizers', { count: i18n.formatNumber(activeFertilizers.length) })}</div>
      </div>
      <div class="selected-fertilizer-amount">${i18n.formatNumber(totalGrams.toFixed(2))} ${i18n.t('gramsShort')}</div>
    `;
    list.appendChild(totalItem);
  }
}

// Display the results
function displayResults(results) {
  const resultsSection = document.getElementById('results');
  const resultsGrid = document.getElementById('results-grid');

  resultsSection.style.display = 'block';
  resultsGrid.innerHTML = '';

  // Define display order and labels
  const displayOrder = [
    { key: 'N_total', label: i18n.t('totalNitrogenN') },
    { key: 'N_NO3', label: i18n.t('nitrateN') },
    { key: 'N_NH4', label: i18n.t('ammoniumN') },
    { key: 'N_Urea', label: 'Urea-N' },
    { key: 'P', label: i18n.t('phosphorusElemental') },
    { key: 'P2O5', label: i18n.t('phosphorusOxide') },
    { key: 'K', label: i18n.t('potassiumElemental') },
    { key: 'K2O', label: i18n.t('potassiumOxide') },
    { key: 'Ca', label: i18n.t('calcium') },
    { key: 'Mg', label: i18n.t('magnesium') },
    { key: 'S', label: i18n.t('sulfur') },
    { key: 'Fe', label: 'Iron (Fe)' },
    { key: 'B', label: 'Boron (B)' },
    { key: 'Zn', label: 'Zinc (Zn)' },
    { key: 'Mn', label: 'Manganese (Mn)' },
    { key: 'Cu', label: 'Copper (Cu)' },
    { key: 'Mo', label: 'Molybdenum (Mo)' },
    { key: 'Cl', label: 'Chlorine (Cl)' },
    { key: 'Si', label: i18n.t('silicon') }
  ];

  displayOrder.forEach(item => {
    if (results[item.key] !== undefined) {
      const card = document.createElement('div');
      const value = results[item.key];
      card.className = `result-card ${value < 0.01 ? 'zero' : ''}`;

      card.innerHTML = `
        <div class="result-label">${item.label}</div>
        <div class="result-value">
          ${value.toFixed(2)}
          <span class="result-unit">ppm</span>
        </div>
      `;

      resultsGrid.appendChild(card);
    }
  });

  // Scroll to results
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Display nutrient ratio analysis
function displayNutrientRatios(ratios) {
  const ratioSection = document.getElementById('ratio-analysis-section');
  const ratioResult = document.getElementById('ratio-analysis-result');

  if (ratios.length === 0) {
    ratioSection.style.display = 'none';
    return;
  }

  ratioSection.style.display = 'block';

  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';

  ratios.forEach(ratio => {
    const unit = ratio.unit || 'ppm';
    html += `
      <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff;">
        <div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 1.1em;">
          ${ratio.name}
        </div>
        <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
          ${ratio.ratio}
        </div>
        <div style="font-size: 0.85em; color: #666;">
          ${ratio.labels.map((label, i) => `${label}: ${ratio.values[i].toFixed(1)} ${unit}`).join(' | ')}
        </div>
      </div>
    `;
  });

  html += '</div>';
  ratioResult.innerHTML = html;
}

// ============================================================
// REUSABLE RENDER FUNCTIONS (to reduce code duplication)
// ============================================================

/**
 * Renders EC breakdown by ion table (collapsible)
 * @param {Object} ecPrediction - EC prediction data with contributions
 * @returns {string} HTML string
 */
function renderEcBreakdownTable(ecPrediction) {
  if (!ecPrediction || !ecPrediction.contributions) return '';

  const ionContributions = Object.entries(ecPrediction.contributions)
    .sort((a, b) => b[1].contribution_mS_cm - a[1].contribution_mS_cm);

  if (ionContributions.length === 0) return '';

  let html = `<details style="margin-top: 10px;">
    <summary style="cursor: pointer; color: #007bff; font-size: 0.9em;">${i18n.t('showEcBreakdownByIon')}</summary>
    <div style="margin-top: 10px; background: #f8f9fa; padding: 15px; border-radius: 4px;">
      <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="text-align: left; padding: 8px;">${i18n.t('ionHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('concMmolLHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('lambdaHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('ecContribHeader')}</th>
          </tr>
        </thead>
        <tbody>`;

  ionContributions.forEach(([ion, data]) => {
    const percentage = i18n.formatNumber((data.contribution_mS_cm / ecPrediction.rawEC * 100).toFixed(1));
    html += `
          <tr style="border-bottom: 1px solid #dee2e6;">
            <td style="padding: 8px;">${ion}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.concentration_mmolL.toFixed(2))}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.lambda)}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.contribution_mS_cm.toFixed(3))} ${i18n.t('mScmUnit')} (${percentage}%)</td>
          </tr>`;
  });

  html += `
        </tbody>
      </table>
      <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
        <strong>${i18n.t('ecBreakdownNote')}</strong> ${i18n.t('rawEcLabel')} = ${i18n.formatNumber(ecPrediction.rawEC.toFixed(3))} ${i18n.t('mScmUnit')}.
        ${i18n.t('ionicStrengthCorrectionApplied', { factor: i18n.formatNumber((ecPrediction.rawEC / ecPrediction.ec_mS_cm).toFixed(3)) })}
      </div>
    </div>
  </details>`;

  return html;
}

/**
 * Renders nutrient ratio analysis cards
 * @param {Array} ratios - Array of ratio objects from calculateNutrientRatios
 * @returns {string} HTML string
 */
function renderNutrientRatioCards(ratios) {
  if (!ratios || ratios.length === 0) return '';

  let html = '<h3 style="margin-top: 20px;">Nutrient Ratio Analysis</h3>';
  html += '<div class="nutrient-ratio-grid">';

  ratios.forEach(ratio => {
    const unit = ratio.unit || 'ppm';
    html += `
      <div class="nutrient-ratio-card">
        <div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 1.1em;">
          ${ratio.name}
        </div>
        <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
          ${ratio.ratio}
        </div>
        <div style="font-size: 0.85em; color: #666;">
          ${ratio.labels.map((label, i) => `${label}: ${ratio.values[i].toFixed(1)} ${unit}`).join(' | ')}
        </div>
      </div>
    `;
  });

  html += '</div>';
  return html;
}

/**
 * Renders nutritional warnings section
 * @param {Array} warnings - Array of warning objects from checkWarnings
 * @returns {string} HTML string
 */
function renderNutritionalWarnings(warnings) {
  if (!warnings || warnings.length === 0) return '';

  let html = '<h3 style="margin-top: 20px;">' + i18n.t('warningsAndRecommendations') + '</h3>';

  warnings.forEach(warning => {
    const boxClass = warning.level === 'warning' ? 'warning-box' :
                     warning.level === 'error' ? 'error-box' : 'conversion-note';
    const icon = warning.level === 'warning' ? '⚠️' :
                 warning.level === 'error' ? '❌' : 'ℹ️';
    html += `
      <div class="${boxClass}" style="margin-bottom: 10px;">
        <strong>${icon} ${warning.category}</strong><br>
        ${warning.message}
      </div>
    `;
  });

  return html;
}

/**
 * Renders Ion Balance explanation sections
 * @returns {string} HTML string
 */
function renderIonBalanceExplanation() {
  return `
    <!-- What is Ion Balance? -->
    <div class="explanation-section">
      <h3>${i18n.t('whatIsIonBalance')}</h3>
      <p>
        ${i18n.t('ionBalanceExplanation')}
      </p>
      <ul style="line-height: 1.8;">
        <li>${i18n.t('cationsDescription')}</li>
        <li>${i18n.t('anionsDescription')}</li>
      </ul>
      <p>
        ${i18n.t('ionBalanceImportance')}
      </p>
    </div>

    <!-- What is meq/L? -->
    <div class="explanation-section">
      <h3>${i18n.t('understandingMeqL')}</h3>
      <p>
        ${i18n.t('meqLDescription')}
      </p>
      <p>
        ${i18n.t('meqLAnalogy')}
      </p>
      <div class="formula-box">
        <div class="formula">${i18n.t('meqLFormula')}</div>
        <div class="description">${i18n.t('meqLFormulaDesc')}</div>
      </div>
      <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #6c757d;">
        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">
          <strong>${i18n.t('importantNotes')}</strong>
        </p>
        <ul style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
          <li>${i18n.t('hydrationWaterNote')}</li>
          <li>${i18n.t('ureaNote')}</li>
        </ul>
      </div>
    </div>
  `;
}

/**
 * Renders Oxide Conversion explanation table (full version with all 4 conversions)
 * @returns {string} HTML string
 */
function renderOxideConversionTable() {
  return `
    <table class="conversion-table">
      <caption data-i18n="conversionTableCaption">${i18n.t('conversionTableCaption')}</caption>
      <thead>
        <tr>
          <th>${i18n.t('oxideFormHeader')}</th>
          <th>${i18n.t('elementalFormHeader')}</th>
          <th>${i18n.t('conversionFactorHeader')}</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('phosphateOxide')}</td>
          <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('phosphorusElemental')}</td>
          <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.436')}</td>
        </tr>
        <tr>
          <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('potassiumOxide')}</td>
          <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('potassiumElemental')}</td>
          <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.830')}</td>
        </tr>
        <tr>
          <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('magnesiumOxide')}</td>
          <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('magnesiumElemental')}</td>
          <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.603')}</td>
        </tr>
        <tr>
          <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('calciumOxide')}</td>
          <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('calciumElemental')}</td>
          <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.715')}</td>
        </tr>
      </tbody>
    </table>
  `;
}

/**
 * Renders Oxide Conversion explanation section (simplified version with P and K only)
 * Used in reverse calculator and two-tank explanation views
 * @returns {string} HTML string
 */
function renderOxideConversionExplanation() {
  return `
    <div class="explanation-section">
      <h3>${i18n.t('understandingOxideConversions')}</h3>
      <p>
        ${i18n.t('oxideConversionsExplanation')}
      </p>
      <table class="conversion-table">
        <thead>
          <tr>
            <th>${i18n.t('oxideFormHeader')}</th>
            <th>${i18n.t('elementalFormHeader')}</th>
            <th>${i18n.t('conversionFactorHeader')}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>P₂O₅</td>
            <td>P</td>
            <td>× 0.436</td>
          </tr>
          <tr>
            <td>K₂O</td>
            <td>K</td>
            <td>× 0.830</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

/**
 * Determines EC status color and text based on EC value
 * @param {number} ecValue - EC value in mS/cm
 * @returns {Object} {color, text} - Status color and localized text
 */
function getEcStatus(ecValue) {
  if (ecValue < 0.8) {
    return { color: '#17a2b8', text: i18n.t('ecVeryLight') };
  } else if (ecValue < 1.2) {
    return { color: '#28a745', text: i18n.t('ecLight') };
  } else if (ecValue < 1.8) {
    return { color: '#28a745', text: i18n.t('ecModerate') };
  } else if (ecValue < 2.5) {
    return { color: '#ffc107', text: i18n.t('ecStrong') };
  } else if (ecValue < 3.5) {
    return { color: '#fd7e14', text: i18n.t('ecVeryStrong') };
  } else {
    return { color: '#dc3545', text: i18n.t('ecVeryHigh') };
  }
}

/**
 * Determines ion balance status color and text based on imbalance percentage
 * @param {number} imbalance - Imbalance percentage
 * @param {boolean} useSymbols - Whether to use symbols (✓, ⚠, ✗) in status text
 * @returns {Object} {statusColor, statusText} - Status color and localized text
 */
function getIonBalanceStatus(imbalance, useSymbols = true) {
  let statusColor, statusText;
  if (imbalance <= 10) {
    statusColor = '#28a745';
    statusText = useSymbols ? i18n.t('balancedCheck') : i18n.t('balanced');
  } else if (imbalance <= 20) {
    statusColor = '#ffc107';
    statusText = useSymbols ? i18n.t('cautionWarning') : i18n.t('caution');
  } else {
    statusColor = '#dc3545';
    statusText = useSymbols ? i18n.t('imbalancedX') : i18n.t('imbalanced');
  }
  return { statusColor, statusText };
}

/**
 * Core ion balance calculation - unified function for all modes
 * @param {Object|Array} fertilizers - Either array of {id, grams} or object {fertId: grams}
 * @param {number} volume - Solution volume in liters
 * @param {Object} options - Optional settings
 * @param {boolean} options.includeBreakdown - Include per-fertilizer breakdown (default false)
 * @param {boolean} options.useSymbols - Use symbols in status text (default true)
 * @returns {Object} Complete ion balance data
 */
function calculateIonBalanceCore(fertilizers, volume, options = {}) {
  const { includeBreakdown = false, useSymbols = true } = options;

  let totalCations = 0;
  let totalAnions = 0;
  const ionDetails = {};
  const fertilizerBreakdown = [];

  // Normalize input: convert object to array if needed
  const fertArray = Array.isArray(fertilizers)
    ? fertilizers
    : Object.entries(fertilizers).map(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        return fert ? { ...fert, grams } : { id: fertId, grams };
      });

  fertArray.forEach(fert => {
    const ionData = ION_DATA[fert.id];
    if (!ionData || !fert.grams || fert.grams <= 0) return;

    const moles = fert.grams / ionData.molarMass;
    const fertIons = [];

    ionData.ions.forEach(ionInfo => {
      const meq = moles * ionInfo.count * ionInfo.charge * 1000;
      const meqPerLiter = meq / volume;

      if (includeBreakdown) {
        fertIons.push({
          ...ionInfo,
          meq: meqPerLiter,
          calculation: { moles, meq, meqPerLiter }
        });
      }

      // Track by ion name
      if (!ionDetails[ionInfo.ion]) {
        ionDetails[ionInfo.ion] = { meq: 0, type: ionInfo.type };
      }
      ionDetails[ionInfo.ion].meq += meqPerLiter;

      // Add to totals
      if (ionInfo.type === 'cation') {
        totalCations += meqPerLiter;
      } else {
        totalAnions += meqPerLiter;
      }
    });

    if (includeBreakdown) {
      fertilizerBreakdown.push({
        fert,
        ionData,
        moles,
        ions: fertIons
      });
    }
  });

  const average = (totalCations + totalAnions) / 2;
  const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;
  const { statusColor, statusText } = getIonBalanceStatus(imbalance, useSymbols);

  const result = {
    totalCations,
    totalAnions,
    imbalance,
    statusColor,
    statusText,
    ionDetails
  };

  if (includeBreakdown) {
    result.fertilizerBreakdown = fertilizerBreakdown;
  }

  return result;
}

/**
 * Renders ion balance breakdown showing individual cations and anions
 * @param {Object} ionDetails - Ion details from calculateIonBalanceCore
 * @param {number} totalCations - Total cations in meq/L
 * @param {number} totalAnions - Total anions in meq/L
 * @param {boolean} compact - If true, renders a compact inline view (default false)
 * @returns {string} HTML string
 */
function renderIonBalanceBreakdown(ionDetails, totalCations, totalAnions, compact = false) {
  const cations = Object.entries(ionDetails).filter(([, data]) => data.type === 'cation');
  const anions = Object.entries(ionDetails).filter(([, data]) => data.type === 'anion');

  if (cations.length === 0 && anions.length === 0) return '';

  if (compact) {
    // Compact inline view - ions as small badges in a flex row
    let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">';

    // Cations
    html += `<span style="font-size: 0.75em; color: #28a745; font-weight: bold;">${i18n.t('cationsPlus')}:</span>`;
    cations.forEach(([ion, data]) => {
      html += `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${ion} <strong>${i18n.formatNumber(data.meq.toFixed(1))}</strong></span>`;
    });

    // Separator
    html += `<span style="color: #ccc; margin: 0 4px;">|</span>`;

    // Anions
    html += `<span style="font-size: 0.75em; color: #dc3545; font-weight: bold;">${i18n.t('anionsMinus')}:</span>`;
    anions.forEach(([ion, data]) => {
      html += `<span style="background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${ion} <strong>${i18n.formatNumber(data.meq.toFixed(1))}</strong></span>`;
    });

    html += '</div>';
    return html;
  }

  // Full breakdown view - two columns
  let html = '<div class="ion-balance-breakdown">';

  // Cations column
  html += `<div><h4 style="margin-top: 0; color: #007bff;">${i18n.t('cationsPlus')}</h4>`;
  cations.forEach(([ion, data]) => {
    const percentage = totalCations > 0 ? (data.meq / totalCations * 100).toFixed(1) : 0;
    html += `
      <div class="ion-list-item">
        <span>${ion}</span>
        <span><strong>${i18n.formatNumber(data.meq.toFixed(2))}</strong> meq/L (${i18n.formatNumber(percentage)}%)</span>
      </div>
    `;
  });
  html += '</div>';

  // Anions column
  html += `<div><h4 style="margin-top: 0; color: #007bff;">${i18n.t('anionsMinus')}</h4>`;
  anions.forEach(([ion, data]) => {
    const percentage = totalAnions > 0 ? (data.meq / totalAnions * 100).toFixed(1) : 0;
    html += `
      <div class="ion-list-item">
        <span>${ion}</span>
        <span><strong>${i18n.formatNumber(data.meq.toFixed(2))}</strong> meq/L (${i18n.formatNumber(percentage)}%)</span>
      </div>
    `;
  });
  html += '</div></div>';

  return html;
}

/**
 * Renders complete ion balance section with header, summary, breakdown, and explanation
 * @param {Object} ionBalance - Ion balance data from calculateIonBalanceCore
 * @param {Object} options - Display options
 * @param {boolean} options.showHeader - Show section header with title and info icon (default true)
 * @param {string} options.headerTitleKey - i18n key for header title (default 'ionBalance')
 * @param {string} options.infoIconHandler - onclick handler for info icon (default 'openIonBalanceExplanation()')
 * @param {boolean} options.showBreakdown - Show ion breakdown by cation/anion (default true)
 * @param {boolean} options.showExplanation - Show explanation text at bottom (default false)
 * @param {string} options.variant - Display variant: 'full', 'compact', 'inline' (default 'full')
 * @returns {string} HTML string
 */
function renderIonBalanceSection(ionBalance, options = {}) {
  const {
    showHeader = true,
    headerTitleKey = 'ionBalance',
    infoIconHandler = 'openIonBalanceExplanation()',
    showBreakdown = true,
    showExplanation = false,
    variant = 'full'
  } = options;

  let html = '';

  // Header with title and info icon
  if (showHeader) {
    const headerTag = variant === 'inline' ? 'h5' : 'h3';
    const iconStyle = variant === 'inline' ? ' style="font-size: 0.7em; width: 18px; height: 18px; line-height: 18px;"' : '';
    html += `<${headerTag} style="margin-${variant === 'inline' ? 'bottom' : 'top'}: ${variant === 'inline' ? '10px' : '20px'}; ${variant === 'inline' ? 'color: #333;' : ''}">${i18n.t(headerTitleKey)} <span class="info-icon" onclick="${infoIconHandler}" title="${i18n.t('clickToLearnIonBalance')}"${iconStyle}>?</span></${headerTag}>`;
  }

  // Summary cards
  if (variant === 'inline') {
    // Compact inline display for two-tank view
    html += '<div style="display: flex; gap: 15px; flex-wrap: wrap;">';
    html += `<div style="padding: 10px 15px; background: white; border-radius: 4px;">`;
    html += `<div style="font-size: 0.8em; color: #666;">${i18n.t('totalCations')}</div>`;
    html += `<div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalCations.toFixed(2))} ${i18n.t('meqPerLiter')}</div>`;
    html += '</div>';
    html += `<div style="padding: 10px 15px; background: white; border-radius: 4px;">`;
    html += `<div style="font-size: 0.8em; color: #666;">${i18n.t('totalAnions')}</div>`;
    html += `<div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalAnions.toFixed(2))} ${i18n.t('meqPerLiter')}</div>`;
    html += '</div>';
    html += `<div style="padding: 10px 15px; background: ${ionBalance.statusColor}20; border: 1px solid ${ionBalance.statusColor}; border-radius: 4px;">`;
    html += `<div style="font-size: 0.8em; color: #666;">${i18n.t('imbalance')}</div>`;
    html += `<div style="font-size: 1.1em; font-weight: bold; color: ${ionBalance.statusColor};">${i18n.formatNumber(ionBalance.imbalance.toFixed(1))}%</div>`;
    html += `<div style="font-size: 0.8em; color: ${ionBalance.statusColor};">${ionBalance.statusText}</div>`;
    html += '</div></div>';
  } else {
    // Standard summary cards
    html += renderIonBalanceSummary(ionBalance);
  }

  // Ion breakdown (compact for inline variant)
  if (showBreakdown && ionBalance.ionDetails) {
    const useCompactBreakdown = variant === 'inline';
    html += renderIonBalanceBreakdown(ionBalance.ionDetails, ionBalance.totalCations, ionBalance.totalAnions, useCompactBreakdown);
  }

  // Explanation text
  if (showExplanation) {
    html += `<div style="font-size: 0.8em; color: #666; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;"><strong>${i18n.t('whatIsIonBalance')}</strong> ${i18n.t('ionBalanceExplanation')}</div>`;
  }

  return html;
}

/**
 * Renders ion balance summary cards (cations, anions, imbalance)
 * @param {Object} ionBalance - Ion balance data with totalCations, totalAnions, imbalance, statusColor, statusText
 * @returns {string} HTML string
 */
function renderIonBalanceSummary(ionBalance) {
  return `<div class="ion-balance-summary" style="margin-top: 10px;">
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('cations')}</div>
      <div style="font-size: 1.3em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalCations.toFixed(2))} ${i18n.t('meqPerLiter')}</div>
    </div>
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('anions')}</div>
      <div style="font-size: 1.3em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalAnions.toFixed(2))} ${i18n.t('meqPerLiter')}</div>
    </div>
    <div class="ion-balance-card status" style="background: ${ionBalance.statusColor}20; border-color: ${ionBalance.statusColor};">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('imbalance')}</div>
      <div style="font-size: 1.3em; font-weight: bold; color: ${ionBalance.statusColor};">${i18n.formatNumber(ionBalance.imbalance.toFixed(1))}%</div>
      <div style="font-size: 0.9em; color: ${ionBalance.statusColor};">${ionBalance.statusText}</div>
    </div>
  </div>`;
}

/**
 * Renders unified EC section with configurable display options
 * @param {Object} ecPrediction - EC prediction data from estimateECFromPPM
 * @param {Object} options - Display options
 * @param {string} options.variant - Display variant: 'full', 'compact', 'inline' (default 'full')
 * @param {boolean} options.showHeader - Show section header (default true)
 * @param {string} options.headerTitleKey - i18n key for header title (default 'achievedEc')
 * @param {boolean} options.showBreakdown - Show EC breakdown table (default true for full, false for others)
 * @param {boolean} options.showIonicStrength - Show ionic strength card (default true for full/compact, false for inline)
 * @param {number} options.targetEC - Target EC if user specified one (optional)
 * @param {Object} options.ecScaling - EC scaling info if applied (optional)
 * @returns {string} HTML string
 */
function renderEcSection(ecPrediction, options = {}) {
  const {
    variant = 'full',
    showHeader = true,
    headerTitleKey = 'achievedEc',
    showBreakdown = variant === 'full',
    showIonicStrength = variant !== 'inline',
    targetEC = null,
    ecScaling = null
  } = options;

  const ecValue = ecPrediction.ec_mS_cm;
  const ecStatus = getEcStatus(ecValue);

  let html = '';

  // Header
  if (showHeader) {
    if (variant === 'inline') {
      html += `<h5 style="margin-bottom: 10px; color: #333;">${i18n.t(headerTitleKey)}</h5>`;
    } else {
      html += `<h3 style="margin-top: 20px;">${i18n.t(headerTitleKey)}</h3>`;
    }
  }

  // Cards container
  if (variant === 'inline') {
    // Compact inline display for two-tank view
    html += '<div style="display: flex; gap: 15px; flex-wrap: wrap;">';

    // Target EC (if provided)
    if (targetEC !== null) {
      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px;">
        <div style="font-size: 0.8em; color: #666;">${i18n.t('targetEcLabel')}</div>
        <div style="font-size: 1.1em; font-weight: bold; color: #007bff;">${i18n.formatNumber(targetEC.toFixed(2))} ${i18n.t('mScmUnit')}</div>
      </div>`;
    }

    // Achieved EC
    html += `<div style="padding: 10px 15px; background: ${ecStatus.color}20; border: 1px solid ${ecStatus.color}; border-radius: 4px;">
      <div style="font-size: 0.8em; color: #666;">${i18n.t('achievedEc')}</div>
      <div style="font-size: 1.1em; font-weight: bold; color: ${ecStatus.color};">${i18n.formatNumber(ecValue.toFixed(2))} ${i18n.t('mScmUnit')}</div>
      <div style="font-size: 0.8em; color: ${ecStatus.color};">${ecStatus.text}</div>
    </div>`;

    // Ionic Strength (optional for inline)
    if (showIonicStrength) {
      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px;">
        <div style="font-size: 0.8em; color: #666;">${i18n.t('ionicStrength')}</div>
        <div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber((ecPrediction.ionicStrength * 1000).toFixed(1))} ${i18n.t('mMUnit')}</div>
      </div>`;
    }

    html += '</div>';
  } else {
    // Full or compact card display
    html += '<div class="ion-balance-summary" style="margin-top: 10px;">';

    // Show Target EC card only if provided
    if (targetEC !== null) {
      html += `<div class="ion-balance-card">
        <div style="font-size: 0.9em; color: #666;">${i18n.t('targetEcLabel')}</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #007bff;">${i18n.formatNumber(targetEC.toFixed(2))} <span style="font-size: 0.6em;">${i18n.t('mScmUnit')}</span></div>
      </div>`;
    }

    // Achieved EC card
    html += `<div class="ion-balance-card" style="flex: 2;">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('achievedEc')}</div>
      <div style="font-size: 1.8em; font-weight: bold; color: ${ecStatus.color};">${i18n.formatNumber(ecValue.toFixed(2))} <span style="font-size: 0.6em;">${i18n.t('mScmUnit')}</span></div>
      <div style="font-size: 0.9em; color: ${ecStatus.color}; margin-top: 5px;">${ecStatus.text}</div>
    </div>`;

    // Ionic Strength card
    if (showIonicStrength) {
      html += `<div class="ion-balance-card">
        <div style="font-size: 0.9em; color: #666;">${i18n.t('ionicStrength')}</div>
        <div style="font-size: 1.3em; font-weight: bold;">${i18n.formatNumber((ecPrediction.ionicStrength * 1000).toFixed(1))} <span style="font-size: 0.7em;">${i18n.t('mMUnit')}</span></div>
      </div>`;
    }

    html += '</div>';
  }

  // Show scaling info if available
  if (ecScaling && targetEC !== null) {
    const accuracy = ((ecValue / targetEC) * 100).toFixed(1);
    html += `<div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px; font-size: 0.9em;">
      <strong>${i18n.t('ecScalingApplied')}</strong> ${i18n.t('ecScalingDescription', { scaleFactor: i18n.formatNumber(ecScaling.scaleFactor.toFixed(3)) })}
      <br><span style="color: #666;">${i18n.t('ecScalingAccuracy', { accuracy: i18n.formatNumber(accuracy) })}</span>
    </div>`;
  }

  // EC breakdown by ion (collapsible)
  if (showBreakdown) {
    html += renderEcBreakdownTable(ecPrediction);
  }

  return html;
}

/**
 * Renders individual ion card for breakdown display
 * @param {string} ion - Ion name
 * @param {number} meq - meq/L value
 * @param {number} percentage - Percentage of total
 * @param {string} percentageKey - i18n key for percentage label
 * @returns {string} HTML string
 */
function renderIonCard(ion, meq, percentage, percentageKey) {
  return `
    <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
      <div style="display: flex; justify-content: space-between;">
        <strong>${ion}</strong>
        <span>${i18n.formatNumber(meq.toFixed(2))} meq/L</span>
      </div>
      <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${i18n.t(percentageKey, {percentage})}</div>
    </div>
  `;
}

/**
 * Renders ion breakdown grid (cations and anions side by side)
 * @param {Array} cations - Array of [ion, data] pairs
 * @param {Array} anions - Array of [ion, data] pairs
 * @param {number} totalCations - Total cations in meq/L
 * @param {number} totalAnions - Total anions in meq/L
 * @returns {string} HTML string
 */
function renderIonBreakdownGrid(cations, anions, totalCations, totalAnions) {
  if (cations.length === 0 && anions.length === 0) return '';

  let html = `
    <div class="explanation-section">
      <h3>${i18n.t('ionBreakdownByType')}</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
  `;

  // Cations column
  html += `<div><h4 style="color: #007bff; margin-top: 0;">${i18n.t('cationsPlus')}</h4>`;
  cations.forEach(([ion, data]) => {
    const percentage = totalCations > 0 ? (data.meq / totalCations * 100).toFixed(1) : 0;
    html += renderIonCard(ion, data.meq, percentage, 'percentOfTotalCations');
  });
  html += `</div>`;

  // Anions column
  html += `<div><h4 style="color: #007bff; margin-top: 0;">${i18n.t('anionsMinus')}</h4>`;
  anions.forEach(([ion, data]) => {
    const percentage = totalAnions > 0 ? (data.meq / totalAnions * 100).toFixed(1) : 0;
    html += renderIonCard(ion, data.meq, percentage, 'percentOfTotalAnions');
  });
  html += `</div>`;

  html += `</div></div>`;
  return html;
}

/**
 * Renders the final ion balance results section with totals, imbalance, and optional calculation explanation
 * @param {number} totalCations - Total cations in meq/L
 * @param {number} totalAnions - Total anions in meq/L
 * @param {number} imbalance - Imbalance percentage
 * @param {string} statusColor - Status color based on imbalance level
 * @param {string} statusText - Status text (e.g., "Balanced", "Caution", "Imbalanced")
 * @param {string} titleKey - i18n key for section title (e.g., 'finalIonBalanceResults' or 'finalResults')
 * @param {boolean} useLocalized2 - Whether to use localized "2" in the formula display
 * @param {boolean} showCalculation - Whether to show the calculation explanation section
 * @returns {string} HTML string
 */
function renderFinalIonBalanceResults(totalCations, totalAnions, imbalance, statusColor, statusText, titleKey = 'finalIonBalanceResults', useLocalized2 = true, showCalculation = true) {
  const average = (totalCations + totalAnions) / 2;
  const twoDisplay = useLocalized2 ? i18n.formatNumber(2) : '2';
  const hundredDisplay = useLocalized2 ? i18n.formatNumber(100) : '100';

  let html = `
    <div class="explanation-section" style="background: ${statusColor}20; border-left-color: ${statusColor};">
      <h3 style="color: ${statusColor};">${i18n.t(titleKey)}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">${i18n.t('totalCationsPlus')}</div>
          <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${i18n.formatNumber(totalCations.toFixed(2))}</div>
          <div style="font-size: 0.9em; color: #666;">${i18n.t('meqLHeader')}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">${i18n.t('totalAnionsMinus')}</div>
          <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${i18n.formatNumber(totalAnions.toFixed(2))}</div>
          <div style="font-size: 0.9em; color: #666;">${i18n.t('meqLHeader')}</div>
        </div>
      </div>

      <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid ${statusColor};">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">${i18n.t('imbalancePercentage')}</div>
        <div style="font-size: 2em; font-weight: bold; color: ${statusColor};">${i18n.formatNumber(imbalance.toFixed(1))}%</div>
        <div style="font-size: 1em; color: ${statusColor}; margin-top: 5px;">${statusText}</div>
      </div>`;

  if (showCalculation) {
    html += `
      <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
        <h4 style="margin-top: 0;">${i18n.t('howWeCalculatedImbalance')}</h4>
        <p style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
          Average = (${i18n.formatNumber(totalCations.toFixed(2))} + ${i18n.formatNumber(totalAnions.toFixed(2))}) ÷ ${twoDisplay} = ${i18n.formatNumber(average.toFixed(2))} ${i18n.t('meqLHeader')}<br>
          Imbalance = |${i18n.formatNumber(totalCations.toFixed(2))} - ${i18n.formatNumber(totalAnions.toFixed(2))}| ÷ ${i18n.formatNumber(average.toFixed(2))} × ${hundredDisplay} = <strong>${i18n.formatNumber(imbalance.toFixed(1))}%</strong>
        </p>
      </div>`;
  }

  html += `
    </div>
  `;
  return html;
}

/**
 * Calculates ion balance details for a list of fertilizers - uses unified core
 * Returns all calculated data including per-fertilizer breakdown
 * @param {Array} activeFertilizers - Array of fertilizer objects with grams
 * @param {number} volume - Solution volume in liters
 * @returns {Object} {totalCations, totalAnions, ionDetails, fertilizerBreakdown, imbalance, statusColor, statusText}
 */
function calculateIonBalanceDetails(activeFertilizers, volume) {
  return calculateIonBalanceCore(activeFertilizers, volume, { includeBreakdown: true, useSymbols: true });
}

// ============================================================
// END OF REUSABLE RENDER FUNCTIONS
// ============================================================

// Calculate and display ion balance (uses unified core function)
function calculateIonBalance(activeFertilizers, volume) {
  // Use unified core calculation
  const ionBalance = calculateIonBalanceCore(activeFertilizers, volume, { useSymbols: true });

  // Display results
  const ionBalanceSection = document.getElementById('ion-balance-section');
  const ionBalanceResult = document.getElementById('ion-balance-result');

  ionBalanceSection.style.display = 'block';

  // Use unified renderer (without header since HTML section already has one)
  const html = renderIonBalanceSection(ionBalance, {
    showHeader: false,
    showBreakdown: true,
    showExplanation: false
  });

  ionBalanceResult.innerHTML = html;

  // Return ion balance data for copy function (with clean status text)
  return {
    totalCations: ionBalance.totalCations,
    totalAnions: ionBalance.totalAnions,
    imbalance: ionBalance.imbalance,
    statusText: ionBalance.statusText.replace(/[✓⚠✗]/g, '').trim(),
    statusColor: ionBalance.statusColor,
    ionDetails: ionBalance.ionDetails
  };
}

// Clear all selections and reset the form
function clearAll() {
  // Clear search box
  document.getElementById('search').value = '';

  // Reset volume input
  const volumeInput = document.getElementById('volume');
  volumeInput.value = 10;
  volumeInput.classList.remove('input-error');

  // Reset all fertilizers
  FERTILIZERS.forEach(f => {
    const checkbox = document.getElementById(`check-${f.id}`);
    const input = document.getElementById(`grams-${f.id}`);
    const item = document.getElementById(`fert-${f.id}`);

    if (checkbox) checkbox.checked = false;
    if (input) {
      input.value = 0;
      input.disabled = true;
      input.classList.remove('input-error');
    }
    if (item) {
      item.classList.remove('active');
      item.style.display = ''; // Show all items
    }
  });

  // Hide results
  document.getElementById('selected-fertilizers-section').style.display = 'none';
  document.getElementById('results').style.display = 'none';
  document.getElementById('ion-balance-section').style.display = 'none';
  document.getElementById('ratio-analysis-section').style.display = 'none';
  document.getElementById('ec-tds-section').style.display = 'none';
  document.getElementById('warnings-section').style.display = 'none';
}

// Tab switching
function switchTab(tabId, tabButton) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(btn => {
    btn.classList.remove('active');
  });

  // Show selected tab
  const targetTab = document.getElementById(tabId);
  if (targetTab) {
    targetTab.classList.add('active');
  }

  // Mark the clicked tab active (or fall back by data attribute)
  if (tabButton instanceof HTMLElement) {
    tabButton.classList.add('active');
  } else {
    const fallbackButton = document.querySelector(`.tab[data-tab-target="${tabId}"]`);
    if (fallbackButton) {
      fallbackButton.classList.add('active');
    }
  }

  // Update the mode indicator in wizard header
  const modeIndicator = document.getElementById('wizard-current-mode');
  if (modeIndicator && MODE_NAMES[tabId]) {
    const wizardVolume = document.getElementById('wizard-volume');
    const volumeStr = wizardVolume ? wizardVolume.value + 'L' : '';
    modeIndicator.innerHTML = 'Current: <strong>' + MODE_NAMES[tabId] + '</strong>' + (volumeStr ? ' · ' + volumeStr : '');
  }
}

// Clear formula builder
function clearFormulaBuilder() {
  // Clear target inputs and remove error states
  const targetIds = ['target-n', 'target-p', 'target-k', 'target-ca', 'target-mg', 'target-s', 'target-si'];
  targetIds.forEach(id => {
    const input = document.getElementById(id);
    input.value = id === 'target-si' ? '0' : '';  // Si defaults to 0
    input.classList.remove('input-error');
  });

  // Reset volume input
  const volumeInput = document.getElementById('formula-volume');
  volumeInput.value = '10';
  volumeInput.classList.remove('input-error');

  // Clear search box
  const searchInput = document.getElementById('available-fertilizer-search');
  if (searchInput) {
    searchInput.value = '';
    filterAvailableFertilizers('');
  }

  // Hide results
  document.getElementById('formula-results').style.display = 'none';
}

// Formula builder - main function
async function buildFormula() {
  // Validate volume first
  const volumeInput = document.getElementById('formula-volume');
  const volume = parseFloat(volumeInput.value);

  if (!volume || volume <= 0 || isNaN(volume)) {
    alert(i18n.t('alertEnterValidSolutionVolume'));
    volumeInput.classList.add('input-error');
    volumeInput.focus();
    return;
  }
  volumeInput.classList.remove('input-error');

  // Get and validate target values
  const targetInputs = {
    N: document.getElementById('target-n'),
    P: document.getElementById('target-p'),
    K: document.getElementById('target-k'),
    Ca: document.getElementById('target-ca'),
    Mg: document.getElementById('target-mg'),
    S: document.getElementById('target-s'),
    Si: document.getElementById('target-si')
  };

  const targets = {};
  let hasInvalidInput = false;
  let hasAtLeastOneTarget = false;

  Object.entries(targetInputs).forEach(([key, input]) => {
    const value = parseFloat(input.value);

    if (input.value === '' || isNaN(value)) {
      input.classList.remove('input-error');
      targets[key] = 0;
    } else if (value < 0) {
      input.classList.add('input-error');
      hasInvalidInput = true;
      targets[key] = 0;
    } else {
      input.classList.remove('input-error');
      targets[key] = value;
      if (value > 0) {
        hasAtLeastOneTarget = true;
      }
    }
  });

  // Validate at least one nutrient target is specified
  if (!hasAtLeastOneTarget) {
    alert(i18n.t('alertEnterPositiveNutrientTarget'));
    return;
  }

  if (hasInvalidInput) {
    alert(i18n.t('alertFixInvalidInputs'));
    return;
  }

  // Get available fertilizers
  const availableFertilizers = [];
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox && checkbox.checked) {
      availableFertilizers.push(fert);
    }
  });

  if (availableFertilizers.length === 0) {
    alert(i18n.t('alertSelectAvailableFertilizer'));
    return;
  }

  // Get calculation mode
  const mode = document.getElementById('formula-calculation-mode').value;

  // Show progress bar
  progressBar.show(i18n.t('buildingFormula'));
  progressBar.update(10, i18n.t('validatingInputs'));

  try {
    // Allow UI to update
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(30, i18n.t('preparingModel'));
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(50, i18n.t('runningSolver'));
    progressBar.setIndeterminate(i18n.t('optimizingCombination'));

    // Run optimization algorithm using absolute PPM targets
    const result = await optimizeFormula(targets, volume, availableFertilizers, 75, mode, { useAbsoluteTargets: true, useMilp: true });
    if (progressBar.isCancelled()) return;

    progressBar.update(90, i18n.t('preparingResults'));
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(100, i18n.t('complete'));
    await new Promise(resolve => setTimeout(resolve, 200));

    // Hide progress bar
    progressBar.hide();

    // Display results
    displayFormulaResults(result, targets, volume, mode);
  } catch (error) {
    if (progressBar.isCancelled()) return;
    progressBar.hide();
    console.error('Formula optimization error:', error);
    alert(i18n.t('alertCalculationError'));
  }
}


// Store last formula builder calculation result for explanation modals
let lastFormulaCalculation = null;

// Display formula results
function displayFormulaResults(result, targets, volume, mode = 'oxide') {
  // Store data for explanation modals
  lastFormulaCalculation = { result, targets, volume, mode };

  const resultsSection = document.getElementById('formula-results');
  const outputDiv = document.getElementById('formula-output');

  resultsSection.style.display = 'block';

  let html = '<div class="formula-result"><h3>' + i18n.t('fertilizersToAddPer', { volume: i18n.formatNumber(volume), unit: i18n.t('litersShort') }) + '</h3>';

  // Display formula and calculate total grams
  let totalGrams = 0;
  const fertEntries = Object.entries(result.formula);

  fertEntries.forEach(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    if (fert) {
      totalGrams += grams;
      const composition = Object.entries(fert.pct)
        .map(([key, val]) => `${key}: ${val}%`)
        .join(', ');
      html += `
        <div class="formula-fertilizer">
          <div class="formula-fertilizer-info">
            <div class="formula-fertilizer-name">${fert.name}</div>
            <div class="formula-fertilizer-composition">${composition}</div>
          </div>
          <div class="formula-fertilizer-amount">${i18n.formatNumber(grams.toFixed(2))} ${i18n.t('gramsShort')}</div>
        </div>
      `;
    }
  });

  // Show total grams
  if (fertEntries.length > 1) {
    html += `
      <div class="formula-fertilizer" style="background: #e8f5e9; border-left: 4px solid #4caf50; margin-top: 10px;">
        <div class="formula-fertilizer-info">
          <div class="formula-fertilizer-name" style="color: #2e7d32; font-weight: bold;">${i18n.t('totalFertilizers', { count: i18n.formatNumber(fertEntries.length) })}</div>
        </div>
        <div class="formula-fertilizer-amount" style="color: #2e7d32; font-size: 1.2em;">${i18n.formatNumber(totalGrams.toFixed(2))} ${i18n.t('gramsShort')}</div>
      </div>
    `;
  }

  html += '</div>';

  // Comparison table - show values in the same mode as input
  html += '<h3>' + i18n.t('targetVsAchieved') + '</h3>';
  html += '<div class="comparison-table-wrapper">';
  html += '<table class="comparison-table">';
  html += '<tr><th>' + i18n.t('nutrient') + '</th><th>' + i18n.t('targetPpmHeader') + '</th><th>' + i18n.t('achievedPpmHeader') + '</th><th>' + i18n.t('difference') + '</th></tr>';

  // Choose nutrients and labels based on mode
  const nutrients = mode === 'elemental'
    ? ['N_total', 'P', 'K', 'Ca', 'Mg', 'S', 'Si']
    : ['N_total', 'P2O5', 'K2O', 'Ca', 'Mg', 'S', 'Si'];

  const labels = mode === 'elemental'
    ? {
        N_total: i18n.t('nitrogen'),
        P: i18n.t('phosphorusElemental'),
        K: i18n.t('potassiumElemental'),
        Ca: i18n.t('calcium'),
        Mg: i18n.t('magnesium'),
        S: i18n.t('sulfur'),
        Si: i18n.t('silicon')
      }
    : {
        N_total: i18n.t('nitrogen'),
        P2O5: i18n.t('phosphorusOxide'),
        K2O: i18n.t('potassiumOxide'),
        Ca: i18n.t('calcium'),
        Mg: i18n.t('magnesium'),
        S: i18n.t('sulfur'),
        Si: i18n.t('silicon')
      };

  let allGood = true;
  const warnings = [];

  nutrients.forEach(nutrient => {
    // Map nutrient key to target key
    let targetKey;
    if (nutrient === 'N_total') targetKey = 'N';
    else if (nutrient === 'P2O5') targetKey = 'P';
    else if (nutrient === 'K2O') targetKey = 'K';
    else targetKey = nutrient;

    const target = targets[targetKey];
    const achieved = result.achieved[nutrient] || 0;

    if (target === 0 && (nutrient === 'S' || nutrient === 'Si')) return; // Skip S/Si if not specified

    const diff = achieved - target;
    const percentDiff = target > 0 ? (Math.abs(diff) / target * 100) : 0;

    let className = 'match';
    let status = '✓';

    if (percentDiff > 20) {
      className = 'miss';
      status = '✗';
      allGood = false;
      warnings.push(i18n.t('nutrientOffTarget', { nutrient: labels[nutrient], percent: i18n.formatNumber(percentDiff.toFixed(1)) }));
    } else if (percentDiff > 10) {
      className = 'close';
      status = '⚠';
      warnings.push(i18n.t('nutrientOffTargetAcceptable', { nutrient: labels[nutrient], percent: i18n.formatNumber(percentDiff.toFixed(1)) }));
    }

    html += `
      <tr>
        <td>${labels[nutrient]}</td>
        <td>${i18n.formatNumber(target.toFixed(1))}</td>
        <td class="${className}">${i18n.formatNumber(achieved.toFixed(1))} ${status}</td>
        <td class="${className}">${diff >= 0 ? '+' : ''}${i18n.formatNumber(diff.toFixed(1))} (${i18n.formatNumber(percentDiff.toFixed(1))}%)</td>
      </tr>
    `;
  });

  html += '</table>';
  html += '</div>';

  // Mode note
  if (mode === 'elemental') {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>${i18n.t('elementalModeLabel')}</strong> ${i18n.t('elementalModeNote')}
      <br>
      ${i18n.t('elementalToOxideConversion')}
    </div>`;
  } else {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>${i18n.t('oxideModeLabel')}</strong> ${i18n.t('oxideModeNote')}
      <br>
      ${i18n.t('oxideToElementalConversion')}
    </div>`;
  }

  // NH4-N percentage
  const nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;
  html += `<div class="conversion-note" style="margin-top: 15px;">
    <strong>${i18n.t('nitrogenFormLabel')}</strong> ${i18n.formatNumber(result.achieved.N_NH4.toFixed(1))} ppm NH₄-N (${i18n.formatNumber(nh4Percent.toFixed(1))}% ${i18n.t('ofTotalN')}),
    ${i18n.formatNumber(result.achieved.N_NO3.toFixed(1))} ppm NO₃-N (${i18n.formatNumber((100 - nh4Percent).toFixed(1))}% ${i18n.t('ofTotalN')})
  </div>`;

  // Calculate ion balance for this formula
  const activeFertilizers = Object.entries(result.formula).map(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    return { ...fert, grams };
  });

  const ionBalance = calculateIonBalanceForFormula(activeFertilizers, volume);

  // Ion balance section with breakdown - using unified renderer
  html += renderIonBalanceSection(ionBalance, {
    showHeader: true,
    headerTitleKey: 'ionBalance',
    infoIconHandler: 'openFormulaIonBalanceExplanation()',
    showBreakdown: true,
    showExplanation: false
  });

  // Calculate and display EC prediction - using unified renderer
  const ecPrediction = estimateECFromPPM(result.achieved);
  html += renderEcSection(ecPrediction, {
    variant: 'full',
    headerTitleKey: 'predictedEc',
    showBreakdown: true
  });

  // Add nutrient ratio analysis - using reusable function
  const ratios = calculateNutrientRatios(result.achieved);
  html += renderNutrientRatioCards(ratios);

  // Nutritional warnings - using reusable function
  const nutritionalWarnings = checkWarnings(result.achieved, activeFertilizers);
  html += renderNutritionalWarnings(nutritionalWarnings);

  // Warnings or errors (target deviation warnings)
  if (!allGood) {
    html += '<div class="error-box"><strong>⚠ ' + i18n.t('cannotAchieveExactTargets') + '</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul><p>' + i18n.t('cannotAchieveExactTargetsDescription') + '</p></div>';
  } else if (warnings.length > 0) {
    html += '<div class="warning-box"><strong>' + i18n.t('note') + '</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul></div>';
  }

  outputDiv.innerHTML = html;
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Calculate ion balance for formula (returns summary data) - uses unified core
function calculateIonBalanceForFormula(activeFertilizers, volume) {
  return calculateIonBalanceCore(activeFertilizers, volume, { useSymbols: true });
}

// ============================================================================
// TWO-TANK SYSTEM FUNCTIONS
// ============================================================================

// Split fertilizers into two compatible tanks
// Tank A: Calcium-containing fertilizers + compatible neutrals
// Tank B: Sulfate/Phosphate-containing fertilizers + compatible neutrals
// Neutral fertilizers can be split between tanks to help balance ions
function splitIntoTwoTanks(formula, volume) {
  const tankA = { fertilizers: {}, name: i18n.t('tankALabel'), description: i18n.t('tankADescription') };
  const tankB = { fertilizers: {}, name: i18n.t('tankBLabel'), description: i18n.t('tankBDescription') };

  const neutralFertilizers = [];

  // First pass: categorize fertilizers
  Object.entries(formula).forEach(([fertId, grams]) => {
    if (grams <= 0) return;

    const hasCa = hasCaContent(fertId);
    const hasS = hasSulfateContent(fertId);
    const hasP = hasPhosphateContent(fertId);
    const hasSi = hasSilicateContent(fertId);

    if (hasCa && !hasS && !hasSi) {
      // Pure calcium source -> Tank A
      tankA.fertilizers[fertId] = grams;
    } else if (hasS && !hasCa) {
      // Sulfate source (no calcium) -> Tank B
      tankB.fertilizers[fertId] = grams;
    } else if (hasP && !hasCa && !hasS) {
      // Pure phosphate source -> Tank B (safer with sulfates than calcium at high conc)
      tankB.fertilizers[fertId] = grams;
    } else if (hasSi && !hasCa) {
      // Silicate source (no calcium) -> Tank B (silicates precipitate with calcium)
      tankB.fertilizers[fertId] = grams;
    } else if (hasCa && hasS) {
      // Contains both Ca and S - problematic, put in Tank A with warning
      tankA.fertilizers[fertId] = grams;
    } else if (hasCa && hasSi) {
      // Contains both Ca and Si - problematic, put in Tank A with warning
      tankA.fertilizers[fertId] = grams;
    } else {
      // Neutral fertilizer - will be assigned to help balance
      neutralFertilizers.push({ fertId, grams });
    }
  });

  // Calculate initial ion balance for each tank
  let tankABalance = calculateTankIonBalance(tankA.fertilizers, volume);
  let tankBBalance = calculateTankIonBalance(tankB.fertilizers, volume);

  // Second pass: distribute neutral fertilizers to help balance tanks
  neutralFertilizers.forEach(({ fertId, grams }) => {
    // Get ion contribution of this fertilizer
    const ionData = ION_DATA[fertId];

    // Determine which tank needs more help with balance
    // Also consider if one tank is empty
    const tankAEmpty = Object.keys(tankA.fertilizers).length === 0;
    const tankBEmpty = Object.keys(tankB.fertilizers).length === 0;

    if (tankAEmpty && tankBEmpty) {
      // Both empty, put in Tank A
      tankA.fertilizers[fertId] = grams;
    } else if (tankAEmpty) {
      // Tank A is empty, put there to give it something
      tankA.fertilizers[fertId] = grams;
    } else if (tankBEmpty) {
      // Tank B is empty, put there
      tankB.fertilizers[fertId] = grams;
    } else {
      // Both tanks have items - assign to the one with worse balance
      // or split if both are similar
      const tankAImbalance = tankABalance.imbalance;
      const tankBImbalance = tankBBalance.imbalance;

      if (Math.abs(tankAImbalance - tankBImbalance) < 5) {
        // Similar imbalance - check which direction each tank leans
        // and assign to help correct it
        const tankAExcess = tankABalance.totalCations - tankABalance.totalAnions;
        const tankBExcess = tankBBalance.totalCations - tankBBalance.totalAnions;

        // Check if this fertilizer contributes more cations or anions
        let fertCations = 0, fertAnions = 0;
        if (ionData) {
          const testFert = [{ id: fertId, grams: grams }];
          const testBalance = calculateTankIonBalance({ [fertId]: grams }, volume);
          fertCations = testBalance.totalCations;
          fertAnions = testBalance.totalAnions;
        }

        const fertExcess = fertCations - fertAnions;

        // Assign to tank where it helps balance
        if (tankAExcess > 0 && fertExcess < 0) {
          tankA.fertilizers[fertId] = grams;
        } else if (tankBExcess > 0 && fertExcess < 0) {
          tankB.fertilizers[fertId] = grams;
        } else if (tankAExcess < 0 && fertExcess > 0) {
          tankA.fertilizers[fertId] = grams;
        } else if (tankBExcess < 0 && fertExcess > 0) {
          tankB.fertilizers[fertId] = grams;
        } else {
          // Can't help balance either way - put in tank with higher imbalance
          if (tankAImbalance >= tankBImbalance) {
            tankA.fertilizers[fertId] = grams;
          } else {
            tankB.fertilizers[fertId] = grams;
          }
        }
      } else if (tankAImbalance > tankBImbalance) {
        tankA.fertilizers[fertId] = grams;
      } else {
        tankB.fertilizers[fertId] = grams;
      }
    }

    // Recalculate balances after assignment
    tankABalance = calculateTankIonBalance(tankA.fertilizers, volume);
    tankBBalance = calculateTankIonBalance(tankB.fertilizers, volume);
  });

  // Final balance calculation
  tankA.ionBalance = calculateTankIonBalance(tankA.fertilizers, volume);
  tankB.ionBalance = calculateTankIonBalance(tankB.fertilizers, volume);

  // Calculate nutrient contributions for each tank
  tankA.nutrients = calculateTankNutrients(tankA.fertilizers, volume);
  tankB.nutrients = calculateTankNutrients(tankB.fertilizers, volume);

  return { tankA, tankB };
}

// Calculate ion balance for a single tank - uses unified core
function calculateTankIonBalance(fertilizers, volume) {
  // Use unified core with useSymbols: false for tank display (no ✓/⚠/✗)
  return calculateIonBalanceCore(fertilizers, volume, { useSymbols: false });
}

// Calculate nutrient PPM contributions for a tank
function calculateTankNutrients(fertilizers, volume) {
  const nutrients = {
    N_total: 0, N_NO3: 0, N_NH4: 0,
    P2O5: 0, P: 0, K2O: 0, K: 0,
    Ca: 0, Mg: 0, S: 0
  };

  Object.entries(fertilizers).forEach(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    if (!fert) return;

    Object.keys(nutrients).forEach(nutrient => {
      if (fert.pct[nutrient]) {
        nutrients[nutrient] += (grams * fert.pct[nutrient] / 100) / volume * 1000;
      }
    });
  });

  // Calculate total N
  nutrients.N_total = nutrients.N_NO3 + nutrients.N_NH4;

  // Calculate elemental from oxide if not directly available
  if (nutrients.P2O5 > 0 && nutrients.P === 0) {
    nutrients.P = nutrients.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P;
  }
  if (nutrients.K2O > 0 && nutrients.K === 0) {
    nutrients.K = nutrients.K2O * OXIDE_CONVERSIONS.K2O_to_K;
  }

  return nutrients;
}

// Display two-tank results for formula builder
function displayTwoTankFormulaResults() {
  if (!lastFormulaCalculation) {
    alert(i18n.t('alertNoFormulaResults'));
    return;
  }

  const { result, targets, volume, mode } = lastFormulaCalculation;
  const { tankA, tankB } = splitIntoTwoTanks(result.formula, volume);

  displayTwoTankResults(tankA, tankB, volume, mode, 'formula-output', result.achieved, targets);
}

// Display two-tank results for reverse calculator
function displayTwoTankReverseResults() {
  if (!lastReverseCalculation) {
    alert(i18n.t('alertNoCalculationResults'));
    return;
  }

  const { result, targets, volume, mode } = lastReverseCalculation;
  const { tankA, tankB } = splitIntoTwoTanks(result.formula, volume);

  displayTwoTankResults(tankA, tankB, volume, mode, 'reverse-output', result.achieved, targets);
}

// Display two-tank results for Grams to PPM calculator (Tab 1)
function displayTwoTankGramsToPPMResults() {
  if (!lastGramsToPPMCalculation) {
    alert(i18n.t('alertNoCalculationResultsPpm'));
    return;
  }

  const { activeFertilizers, volume, results } = lastGramsToPPMCalculation;

  // Convert activeFertilizers array to formula object format
  const formula = {};
  activeFertilizers.forEach(fert => {
    formula[fert.id] = fert.grams;
  });

  const { tankA, tankB } = splitIntoTwoTanks(formula, volume);

  // For Grams to PPM, we use elemental mode and no specific targets
  displayTwoTankResults(tankA, tankB, volume, 'elemental', 'selected-fertilizers-list', results, null);
}

// Store current two-tank data for copy function
let currentTwoTankData = null;

// Common display function for two-tank results
function displayTwoTankResults(tankA, tankB, volume, mode, outputDivId, achieved, targets) {
  const outputDiv = document.getElementById(outputDivId);

  // Hide header buttons when showing two-tank view
  let headerButtonsId;
  if (outputDivId === 'formula-output') {
    headerButtonsId = 'formula-header-buttons';
  } else if (outputDivId === 'reverse-output') {
    headerButtonsId = 'reverse-header-buttons';
  } else if (outputDivId === 'selected-fertilizers-list') {
    headerButtonsId = 'grams-to-ppm-header-buttons';
  }
  const headerButtons = document.getElementById(headerButtonsId);
  if (headerButtons) {
    headerButtons.style.display = 'none';
  }

  // Store data for copy function
  currentTwoTankData = { tankA, tankB, volume, mode, achieved, targets };

  let html = '<div class="two-tank-results">';

  // Header with copy button
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
  html += '<h3 style="margin: 0; color: #007bff;">' + i18n.t('twoTankStockSolutionSystem') + '</h3>';
  html += `<button class="copy-btn" onclick="copyTwoTankResults()" title="Copy two-tank results to clipboard">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    ${i18n.t('copyResults')}
  </button>`;
  html += '</div>';

  html += '<p style="margin-bottom: 20px; color: #666;">' + i18n.t('twoTankSeparationNote') + '</p>';

  // Calculate combined nutrients first (needed for ratio calculations)
  const combinedNutrients = {
    N_total: tankA.nutrients.N_total + tankB.nutrients.N_total,
    P2O5: tankA.nutrients.P2O5 + tankB.nutrients.P2O5,
    P: tankA.nutrients.P + tankB.nutrients.P,
    K2O: tankA.nutrients.K2O + tankB.nutrients.K2O,
    K: tankA.nutrients.K + tankB.nutrients.K,
    Ca: tankA.nutrients.Ca + tankB.nutrients.Ca,
    Mg: tankA.nutrients.Mg + tankB.nutrients.Mg,
    S: tankA.nutrients.S + tankB.nutrients.S
  };

  // Tank A
  html += renderTankSection(tankA, volume, mode, 'A', targets, combinedNutrients);

  // Tank B
  html += renderTankSection(tankB, volume, mode, 'B', targets, combinedNutrients);

  // Calculate combined totals
  let totalGramsA = Object.values(tankA.fertilizers).reduce((sum, g) => sum + g, 0);
  let totalGramsB = Object.values(tankB.fertilizers).reduce((sum, g) => sum + g, 0);
  let grandTotalGrams = totalGramsA + totalGramsB;

  // Calculate combined EC - using unified estimateECFromPPM
  const combinedEcPrediction = estimateECFromPPM(combinedNutrients);
  const combinedEcStatus = getEcStatus(combinedEcPrediction.ec_mS_cm);

  // Combined totals note
  html += '<div class="combined-note" style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #007bff;">';
  html += '<h4 style="margin-bottom: 10px;">' + i18n.t('combinedSolutionWhenMixed') + '</h4>';
  html += '<p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">' + i18n.t('combinedSolutionDescription') + '</p>';

  const nutrientLabels = mode === 'elemental'
    ? { N: 'N', P: 'P', K: 'K', Ca: 'Ca', Mg: 'Mg', S: 'S' }
    : { N: 'N', P: 'P₂O₅', K: 'K₂O', Ca: 'Ca', Mg: 'Mg', S: 'S' };

  html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">';
  html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>${nutrientLabels.N}:</strong> ${i18n.formatNumber(combinedNutrients.N_total.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  if (mode === 'elemental') {
    html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>${nutrientLabels.P}:</strong> ${i18n.formatNumber(combinedNutrients.P.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
    html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>${nutrientLabels.K}:</strong> ${i18n.formatNumber(combinedNutrients.K.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  } else {
    html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>${nutrientLabels.P}:</strong> ${i18n.formatNumber(combinedNutrients.P2O5.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
    html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>${nutrientLabels.K}:</strong> ${i18n.formatNumber(combinedNutrients.K2O.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  }
  html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Ca:</strong> ${i18n.formatNumber(combinedNutrients.Ca.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Mg:</strong> ${i18n.formatNumber(combinedNutrients.Mg.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  html += `<span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>S:</strong> ${i18n.formatNumber(combinedNutrients.S.toFixed(1))} ${i18n.t('ppmUnit')}</span>`;
  html += '</div>';

  // EC and Totals row
  html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px dashed #007bff;">';
  html += `<span style="padding: 5px 10px; background: ${combinedEcStatus.color}15; border: 1px solid ${combinedEcStatus.color}; border-radius: 4px;"><strong style="color: ${combinedEcStatus.color};">${i18n.t('combinedEcLabel')} ${i18n.formatNumber(combinedEcPrediction.ec_mS_cm.toFixed(2))} ${i18n.t('mScmUnit')} (${combinedEcStatus.text})</strong></span>`;
  html += `<span style="padding: 5px 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;"><strong style="color: #2e7d32;">Total: ${i18n.formatNumber(grandTotalGrams.toFixed(2))} ${i18n.t('gramsShort')}</strong> <span style="color: #666; font-size: 0.85em;">(Tank A: ${i18n.formatNumber(totalGramsA.toFixed(2))}${i18n.t('gramsShort')} + Tank B: ${i18n.formatNumber(totalGramsB.toFixed(2))}${i18n.t('gramsShort')})</span></span>`;
  html += '</div>';
  html += '</div>';

  html += '</div>';

  outputDiv.innerHTML = html;
}

// Render a single tank section
function renderTankSection(tank, volume, mode, tankLetter, targets, combinedNutrients) {
  const bgColor = tankLetter === 'A' ? '#f0f7ff' : '#fff7f0';
  const borderColor = tankLetter === 'A' ? '#007bff' : '#fd7e14';
  const detailsId = `tank-details-${tankLetter}`;

  let html = `<div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">`;

  // Header with name and Show Details button
  html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">`;
  html += `<h4 style="margin: 0; color: ${borderColor};">${tank.name}</h4>`;

  const fertEntries = Object.entries(tank.fertilizers);
  if (fertEntries.length > 0) {
    html += `<button onclick="toggleTankDetails('${detailsId}')" id="btn-${detailsId}" style="padding: 5px 12px; font-size: 12px; background: ${borderColor}; color: white; border: none; border-radius: 4px; cursor: pointer;">Show Details</button>`;
  }
  html += `</div>`;

  html += `<p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">${tank.description}</p>`;

  // Fertilizers list
  if (fertEntries.length === 0) {
    html += '<p style="color: #999; font-style: italic;">No fertilizers in this tank</p>';
  } else {
    let tankTotal = 0;
    html += '<div class="tank-fertilizers" style="margin-bottom: 15px;">';
    fertEntries.forEach(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      if (fert) {
        tankTotal += grams;
        html += `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">`;
        html += `<span>${fert.name}</span>`;
        html += `<strong>${i18n.formatNumber(grams.toFixed(2))} ${i18n.t('gramsShort')}</strong>`;
        html += `</div>`;
      }
    });
    // Show total for this tank
    if (fertEntries.length > 1) {
      html += `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: ${borderColor}20; border-radius: 4px; border-top: 2px solid ${borderColor}; margin-top: 5px;">`;
      html += `<span style="color: ${borderColor};"><strong>${i18n.t('totalFertilizers', { count: i18n.formatNumber(fertEntries.length) })}</strong></span>`;
      html += `<strong style="color: ${borderColor}; font-size: 1.1em;">${i18n.formatNumber(tankTotal.toFixed(2))} ${i18n.t('gramsShort')}</strong>`;
      html += `</div>`;
    }
    html += '</div>';

    // Quick summary - PPM and ion balance in compact form
    const nutrients = tank.nutrients;
    const pVal = mode === 'elemental' ? nutrients.P : nutrients.P2O5;
    const kVal = mode === 'elemental' ? nutrients.K : nutrients.K2O;
    const nLabel = 'N';
    const pLabel = mode === 'elemental' ? 'P' : 'P₂O₅';
    const kLabel = mode === 'elemental' ? 'K' : 'K₂O';

    // Calculate EC for this tank - using unified estimateECFromPPM
    const tankEcPrediction = estimateECFromPPM(nutrients);
    const tankEcStatus = getEcStatus(tankEcPrediction.ec_mS_cm);

    html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">';
    if (nutrients.N_total > 0.1) html += `<span class="tank-nutrient-badge"><strong>${nLabel}:</strong> ${i18n.formatNumber(nutrients.N_total.toFixed(1))}</span>`;
    if (pVal > 0.1) html += `<span class="tank-nutrient-badge"><strong>${pLabel}:</strong> ${i18n.formatNumber(pVal.toFixed(1))}</span>`;
    if (kVal > 0.1) html += `<span class="tank-nutrient-badge"><strong>${kLabel}:</strong> ${i18n.formatNumber(kVal.toFixed(1))}</span>`;
    if (nutrients.Ca > 0.1) html += `<span class="tank-nutrient-badge"><strong>Ca:</strong> ${i18n.formatNumber(nutrients.Ca.toFixed(1))}</span>`;
    if (nutrients.Mg > 0.1) html += `<span class="tank-nutrient-badge"><strong>Mg:</strong> ${i18n.formatNumber(nutrients.Mg.toFixed(1))}</span>`;
    if (nutrients.S > 0.1) html += `<span class="tank-nutrient-badge"><strong>S:</strong> ${i18n.formatNumber(nutrients.S.toFixed(1))}</span>`;
    html += `<span class="tank-status-badge" style="background: ${tank.ionBalance.statusColor}20; border: 1px solid ${tank.ionBalance.statusColor};"><strong style="color: ${tank.ionBalance.statusColor};">${i18n.formatNumber(tank.ionBalance.imbalance.toFixed(1))}% ${tank.ionBalance.statusText}</strong></span>`;
    html += `<span class="tank-status-badge" style="background: ${tankEcStatus.color}15; border: 1px solid ${tankEcStatus.color};"><strong style="color: ${tankEcStatus.color};">${i18n.t('ecLabel')} ${i18n.formatNumber(tankEcPrediction.ec_mS_cm.toFixed(2))}</strong></span>`;
    html += '</div>';

    // Collapsible details section
    html += `<div id="${detailsId}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed ${borderColor};">`;

    // Full PPM Table
    html += `<h5 style="margin-bottom: 10px; color: #333;">${i18n.t('nutrientPpmValues')} <span class="info-icon" onclick="openTwoTankPPMExplanation()" title="${i18n.t('clickToLearnPpm')}" style="font-size: 0.7em; width: 18px; height: 18px; line-height: 18px;">?</span></h5>`;
    html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">';
    html += `<tr style="background: white;"><th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${i18n.t('nutrientHeader')}</th><th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">${i18n.t('ppmHeader')}</th></tr>`;

    const ppmData = [
      { label: i18n.t('nitrogen'), value: nutrients.N_total },
      { label: mode === 'elemental' ? i18n.t('phosphorusElemental') : i18n.t('phosphorusOxide'), value: pVal },
      { label: mode === 'elemental' ? i18n.t('potassiumElemental') : i18n.t('potassiumOxide'), value: kVal },
      { label: i18n.t('calcium'), value: nutrients.Ca },
      { label: i18n.t('magnesium'), value: nutrients.Mg },
      { label: i18n.t('sulfur'), value: nutrients.S }
    ];

    ppmData.forEach(item => {
      if (item.value > 0.01) {
        html += `<tr style="background: white;"><td style="padding: 8px; border-bottom: 1px solid #eee;">${item.label}</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${i18n.formatNumber(item.value.toFixed(2))}</td></tr>`;
      }
    });
    html += '</table>';
    html += `<div style="font-size: 0.8em; color: #666; margin-bottom: 15px; padding: 8px; background: #f8f9fa; border-radius: 4px;"><strong>${i18n.t('noteLabel')}</strong> ${i18n.t('ppmCalculationNote')}</div>`;

    // Nitrogen form breakdown
    if (nutrients.N_total > 0.1) {
      const nh4Pct = (nutrients.N_NH4 / nutrients.N_total * 100) || 0;
      const no3Pct = (nutrients.N_NO3 / nutrients.N_total * 100) || 0;
      html += '<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">';
      html += `<strong style="font-size: 0.9em;">${i18n.t('nitrogenFormsLabel')}</strong><br>`;
      html += `<span style="font-size: 0.85em;">NH₄-N: ${i18n.formatNumber(nutrients.N_NH4.toFixed(2))} ${i18n.t('ppmUnit')} (${i18n.formatNumber(nh4Pct.toFixed(1))}%) | NO₃-N: ${i18n.formatNumber(nutrients.N_NO3.toFixed(2))} ${i18n.t('ppmUnit')} (${i18n.formatNumber(no3Pct.toFixed(1))}%)</span>`;
      html += '</div>';
    }

    // NPK:Ca:Mg Ratio relative to original user input
    html += `<h5 style="margin-bottom: 10px; color: #333;">${i18n.t('nutrientRatiosRelative')}</h5>`;
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">';

    // Show the original user-entered ratio and this tank's proportional contribution
    // Tank's contribution = (tank_ppm / combined_ppm) * original_target_value
    if (targets && combinedNutrients) {
      // Use original target values (what user entered), not normalized
      const nTarget = targets.N || 0;
      const pTarget = targets.P || 0;
      const kTarget = targets.K || 0;
      const caTarget = targets.Ca || 0;
      const mgTarget = targets.Mg || 0;

      // Build the ratio label based on what the user entered
      let ratioLabel = 'N';
      let targetRatioValues = i18n.formatNumber(nTarget);

      if (pTarget > 0) {
        ratioLabel += `:${pLabel}`;
        targetRatioValues += ` : ${i18n.formatNumber(pTarget)}`;
      }
      if (kTarget > 0) {
        ratioLabel += `:${kLabel}`;
        targetRatioValues += ` : ${i18n.formatNumber(kTarget)}`;
      }
      if (caTarget > 0) {
        ratioLabel += ':Ca';
        targetRatioValues += ` : ${i18n.formatNumber(caTarget)}`;
      }
      if (mgTarget > 0) {
        ratioLabel += ':Mg';
        targetRatioValues += ` : ${i18n.formatNumber(mgTarget)}`;
      }

      // Show original target ratio (what user entered)
      html += `<div style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">`;
      html += `<div style="font-size: 0.8em; color: #2e7d32;">${i18n.t('targetRatioLabel', { ratio: ratioLabel })}</div>`;
      html += `<div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">${targetRatioValues}</div>`;
      html += `</div>`;

      // Calculate this tank's contribution as proportion of target
      // Formula: (tank_ppm / combined_ppm) * original_target_value
      // Tank A contrib + Tank B contrib = original target value
      const combinedP = mode === 'elemental' ? combinedNutrients.P : combinedNutrients.P2O5;
      const combinedK = mode === 'elemental' ? combinedNutrients.K : combinedNutrients.K2O;

      const nContrib = combinedNutrients.N_total > 0 ? (nutrients.N_total / combinedNutrients.N_total) * nTarget : 0;
      const pContrib = combinedP > 0 ? (pVal / combinedP) * pTarget : 0;
      const kContrib = combinedK > 0 ? (kVal / combinedK) * kTarget : 0;
      const caContrib = combinedNutrients.Ca > 0 ? (nutrients.Ca / combinedNutrients.Ca) * caTarget : 0;
      const mgContrib = combinedNutrients.Mg > 0 ? (nutrients.Mg / combinedNutrients.Mg) * mgTarget : 0;

      // Build tank ratio values - only include nutrients that the user targeted
      let tankRatioValues = i18n.formatNumber(nContrib.toFixed(1));
      if (pTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(pContrib.toFixed(1))}`;
      if (kTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(kContrib.toFixed(1))}`;
      if (caTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(caContrib.toFixed(1))}`;
      if (mgTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(mgContrib.toFixed(1))}`;

      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">`;
      html += `<div style="font-size: 0.8em; color: #666;">${i18n.t('thisTankRatioLabel', { ratio: ratioLabel })}</div>`;
      html += `<div style="font-size: 1.1em; font-weight: bold;">${tankRatioValues}</div>`;
      html += `</div>`;
    }

    // Ca:Mg ratio
    if (nutrients.Ca > 0.1 && nutrients.Mg > 0.1) {
      const caMgRatio = (nutrients.Ca / nutrients.Mg).toFixed(2);
      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">`;
      html += `<div style="font-size: 0.8em; color: #666;">Ca:Mg</div>`;
      html += `<div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber(caMgRatio)} : ${i18n.formatNumber(1)}</div>`;
      html += `</div>`;
    }

    // N:Ca ratio
    if (nutrients.N_total > 0.1 && nutrients.Ca > 0.1) {
      const nCaRatio = (nutrients.N_total / nutrients.Ca).toFixed(2);
      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">`;
      html += `<div style="font-size: 0.8em; color: #666;">N:Ca</div>`;
      html += `<div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber(nCaRatio)} : ${i18n.formatNumber(1)}</div>`;
      html += `</div>`;
    }

    // K:Ca ratio
    if (kVal > 0.1 && nutrients.Ca > 0.1) {
      const kCaRatio = (kVal / nutrients.Ca).toFixed(2);
      html += `<div style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">`;
      html += `<div style="font-size: 0.8em; color: #666;">${kLabel}:Ca</div>`;
      html += `<div style="font-size: 1.1em; font-weight: bold;">${i18n.formatNumber(kCaRatio)} : ${i18n.formatNumber(1)}</div>`;
      html += `</div>`;
    }

    html += '</div>';

    // Ion balance details - using unified renderer with compact breakdown
    html += renderIonBalanceSection(tank.ionBalance, {
      showHeader: true,
      headerTitleKey: 'ionBalanceDetails',
      infoIconHandler: 'openTwoTankIonBalanceExplanation()',
      showBreakdown: true,
      showExplanation: true,
      variant: 'inline'
    });

    // EC details - using unified renderer with inline variant
    html += renderEcSection(tankEcPrediction, {
      variant: 'inline',
      headerTitleKey: 'achievedEc',
      showBreakdown: false,
      showIonicStrength: true
    });

    html += '</div>'; // End details section
  }

  html += '</div>';
  return html;
}

// Toggle tank details visibility
function toggleTankDetails(detailsId) {
  const details = document.getElementById(detailsId);
  const btn = document.getElementById('btn-' + detailsId);

  if (details.style.display === 'none') {
    details.style.display = 'block';
    btn.textContent = 'Hide Details';
  } else {
    details.style.display = 'none';
    btn.textContent = 'Show Details';
  }
}

// Copy two-tank results to clipboard
function copyTwoTankResults() {
  if (!currentTwoTankData) {
    alert(i18n.t('alertNoTwoTankData'));
    return;
  }

  const { tankA, tankB, volume, mode, achieved } = currentTwoTankData;
  const pLabel = mode === 'elemental' ? 'P' : 'P₂O₅';
  const kLabel = mode === 'elemental' ? 'K' : 'K₂O';

  let text = '═══════════════════════════════════════════\n';
  text += '       TWO-TANK STOCK SOLUTION SYSTEM\n';
  text += '═══════════════════════════════════════════\n';
  text += `Volume: ${volume}L per tank\n\n`;

  // Tank A
  text += generateTankCopyText(tankA, 'A', mode, pLabel, kLabel);

  // Tank B
  text += generateTankCopyText(tankB, 'B', mode, pLabel, kLabel);

  // Combined solution
  const combinedNutrients = {
    N_total: tankA.nutrients.N_total + tankB.nutrients.N_total,
    N_NH4: tankA.nutrients.N_NH4 + tankB.nutrients.N_NH4,
    N_NO3: tankA.nutrients.N_NO3 + tankB.nutrients.N_NO3,
    P2O5: tankA.nutrients.P2O5 + tankB.nutrients.P2O5,
    P: tankA.nutrients.P + tankB.nutrients.P,
    K2O: tankA.nutrients.K2O + tankB.nutrients.K2O,
    K: tankA.nutrients.K + tankB.nutrients.K,
    Ca: tankA.nutrients.Ca + tankB.nutrients.Ca,
    Mg: tankA.nutrients.Mg + tankB.nutrients.Mg,
    S: tankA.nutrients.S + tankB.nutrients.S
  };

  text += '═══════════════════════════════════════════\n';
  text += '         COMBINED SOLUTION (Final Mix)\n';
  text += '═══════════════════════════════════════════\n\n';

  text += 'PPM Values:\n';
  text += '───────────────────────────────────────────\n';
  text += `  ${i18n.t('nitrogen').padEnd(16)} ${i18n.formatNumber(combinedNutrients.N_total.toFixed(2))} ppm\n`;
  const pVal = mode === 'elemental' ? combinedNutrients.P : combinedNutrients.P2O5;
  const kVal = mode === 'elemental' ? combinedNutrients.K : combinedNutrients.K2O;
  text += `  ${pLabel.padEnd(16)} ${i18n.formatNumber(pVal.toFixed(2))} ppm\n`;
  text += `  ${kLabel.padEnd(16)} ${i18n.formatNumber(kVal.toFixed(2))} ppm\n`;
  text += `  ${i18n.t('calcium').padEnd(16)} ${i18n.formatNumber(combinedNutrients.Ca.toFixed(2))} ppm\n`;
  text += `  ${i18n.t('magnesium').padEnd(16)} ${i18n.formatNumber(combinedNutrients.Mg.toFixed(2))} ppm\n`;
  text += `  ${i18n.t('sulfur').padEnd(16)} ${i18n.formatNumber(combinedNutrients.S.toFixed(2))} ppm\n\n`;

  // Nitrogen forms
  if (combinedNutrients.N_total > 0.1) {
    const nh4Pct = (combinedNutrients.N_NH4 / combinedNutrients.N_total * 100) || 0;
    const no3Pct = (combinedNutrients.N_NO3 / combinedNutrients.N_total * 100) || 0;
    text += 'Nitrogen Forms:\n';
    text += `  NH₄-N: ${combinedNutrients.N_NH4.toFixed(2)} ppm (${nh4Pct.toFixed(1)}%)\n`;
    text += `  NO₃-N: ${combinedNutrients.N_NO3.toFixed(2)} ppm (${no3Pct.toFixed(1)}%)\n\n`;
  }

  // Combined ratios
  const npkValues = [combinedNutrients.N_total, pVal, kVal].filter(v => v > 0.1);
  if (npkValues.length > 0) {
    const minNPK = Math.min(...npkValues);
    text += 'Nutrient Ratios:\n';
    text += '───────────────────────────────────────────\n';
    text += `  N:${pLabel}:${kLabel} = ${(combinedNutrients.N_total/minNPK).toFixed(1)} : ${(pVal/minNPK).toFixed(1)} : ${(kVal/minNPK).toFixed(1)}\n`;
    if (combinedNutrients.Ca > 0.1 && combinedNutrients.Mg > 0.1) {
      text += `  Ca:Mg = ${(combinedNutrients.Ca/combinedNutrients.Mg).toFixed(2)} : 1\n`;
    }
  }

  text += '\n═══════════════════════════════════════════\n';
  text += 'Generated by Fertilizer Calculator\n';
  text += 'https://bhattumang7.github.io/pages/fertilizer-calculator.html\n';
  text += '═══════════════════════════════════════════\n';

  navigator.clipboard.writeText(text).then(() => {
    // Show success feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
    btn.style.background = '#28a745';
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.style.background = '';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert(i18n.t('alertCopyFailed'));
  });
}

// Generate copy text for a single tank
function generateTankCopyText(tank, letter, mode, pLabel, kLabel) {
  let text = '';
  text += `───────────────────────────────────────────\n`;
  text += `  TANK ${letter}: ${tank.name.replace('Tank ' + letter + ' ', '').toUpperCase()}\n`;
  text += `───────────────────────────────────────────\n`;
  text += `${tank.description}\n\n`;

  const fertEntries = Object.entries(tank.fertilizers);
  if (fertEntries.length === 0) {
    text += 'No fertilizers in this tank\n\n';
    return text;
  }

  text += 'Fertilizers:\n';
  fertEntries.forEach(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    if (fert) {
      text += `  • ${fert.name}: ${i18n.formatNumber(grams.toFixed(2))} ${i18n.t('gramsShort')}\n`;
    }
  });
  text += '\n';

  // PPM values
  const nutrients = tank.nutrients;
  const pVal = mode === 'elemental' ? nutrients.P : nutrients.P2O5;
  const kVal = mode === 'elemental' ? nutrients.K : nutrients.K2O;

  text += 'PPM Values:\n';
  if (nutrients.N_total > 0.01) text += `  ${i18n.t('nitrogen').padEnd(16)} ${i18n.formatNumber(nutrients.N_total.toFixed(2))} ppm\n`;
  if (pVal > 0.01) text += `  ${pLabel.padEnd(16)} ${i18n.formatNumber(pVal.toFixed(2))} ppm\n`;
  if (kVal > 0.01) text += `  ${kLabel.padEnd(16)} ${i18n.formatNumber(kVal.toFixed(2))} ppm\n`;
  if (nutrients.Ca > 0.01) text += `  ${i18n.t('calcium').padEnd(16)} ${i18n.formatNumber(nutrients.Ca.toFixed(2))} ppm\n`;
  if (nutrients.Mg > 0.01) text += `  ${i18n.t('magnesium').padEnd(16)} ${i18n.formatNumber(nutrients.Mg.toFixed(2))} ppm\n`;
  if (nutrients.S > 0.01) text += `  ${i18n.t('sulfur').padEnd(16)} ${i18n.formatNumber(nutrients.S.toFixed(2))} ppm\n`;
  text += '\n';

  // Nitrogen forms
  if (nutrients.N_total > 0.1) {
    const nh4Pct = (nutrients.N_NH4 / nutrients.N_total * 100) || 0;
    const no3Pct = (nutrients.N_NO3 / nutrients.N_total * 100) || 0;
    text += 'Nitrogen Forms:\n';
    text += `  NH₄-N: ${nutrients.N_NH4.toFixed(2)} ppm (${nh4Pct.toFixed(1)}%)\n`;
    text += `  NO₃-N: ${nutrients.N_NO3.toFixed(2)} ppm (${no3Pct.toFixed(1)}%)\n\n`;
  }

  // Ratios
  const npkValues = [nutrients.N_total, pVal, kVal].filter(v => v > 0.1);
  if (npkValues.length > 0 || (nutrients.Ca > 0.1 && nutrients.Mg > 0.1)) {
    text += 'Ratios:\n';
    if (npkValues.length > 0) {
      const minNPK = Math.min(...npkValues);
      text += `  N:${pLabel}:${kLabel} = ${(nutrients.N_total/minNPK).toFixed(1)} : ${(pVal/minNPK).toFixed(1)} : ${(kVal/minNPK).toFixed(1)}\n`;
    }
    if (nutrients.Ca > 0.1 && nutrients.Mg > 0.1) {
      text += `  Ca:Mg = ${(nutrients.Ca/nutrients.Mg).toFixed(2)} : 1\n`;
    }
    if (nutrients.N_total > 0.1 && nutrients.Ca > 0.1) {
      text += `  N:Ca = ${(nutrients.N_total/nutrients.Ca).toFixed(2)} : 1\n`;
    }
    text += '\n';
  }

  // Ion balance
  text += 'Ion Balance:\n';
  text += `  Cations: ${tank.ionBalance.totalCations.toFixed(2)} meq/L\n`;
  text += `  Anions:  ${tank.ionBalance.totalAnions.toFixed(2)} meq/L\n`;
  text += `  Balance: ${tank.ionBalance.imbalance.toFixed(1)}% (${tank.ionBalance.statusText})\n\n`;

  return text;
}

// Restore single tank view
function restoreSingleTankView(outputDivId) {
  // Show header buttons again
  let headerButtonsId;
  if (outputDivId === 'formula-output') {
    headerButtonsId = 'formula-header-buttons';
  } else if (outputDivId === 'reverse-output') {
    headerButtonsId = 'reverse-header-buttons';
  } else if (outputDivId === 'selected-fertilizers-list') {
    headerButtonsId = 'grams-to-ppm-header-buttons';
  }
  const headerButtons = document.getElementById(headerButtonsId);
  if (headerButtons) {
    headerButtons.style.display = 'flex';
  }

  if (outputDivId === 'formula-output' && lastFormulaCalculation) {
    displayFormulaResults(
      lastFormulaCalculation.result,
      lastFormulaCalculation.targets,
      lastFormulaCalculation.volume,
      lastFormulaCalculation.mode
    );
  } else if (outputDivId === 'reverse-output' && lastReverseCalculation) {
    displayReverseResults(
      lastReverseCalculation.result,
      lastReverseCalculation.targets,
      lastReverseCalculation.volume,
      lastReverseCalculation.targetEC
    );
  } else if (outputDivId === 'selected-fertilizers-list' && lastGramsToPPMCalculation) {
    // For Grams to PPM, re-display the selected fertilizers list
    displaySelectedFertilizers(lastGramsToPPMCalculation.activeFertilizers);
  }
}

// ============================================================================
// REVERSE CALCULATOR FUNCTIONS
// ============================================================================

// Render reverse fertilizers list
function renderReverseFertilizersList() {
  const container = document.getElementById('reverse-fertilizers-list');
  if (!container) return;

  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'fertilizer-checkbox-item';
    item.id = `reverse-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `reverse-${fert.id}`;
    checkbox.checked = COMMON_FERTILIZERS.includes(fert.id); // Pre-select common fertilizers

    const label = document.createElement('label');
    label.htmlFor = `reverse-${fert.id}`;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'fertilizer-label-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'fertilizer-label-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    // Priority input (lower = more preferred, default 10)
    const priorityDiv = document.createElement('div');
    priorityDiv.className = 'fertilizer-priority';

    const priorityInput = document.createElement('input');
    priorityInput.type = 'number';
    priorityInput.id = `priority-${fert.id}`;
    priorityInput.min = '1';
    priorityInput.max = '100';
    priorityInput.value = '10';
    priorityInput.title = 'Priority (1-100, lower = more preferred)';

    const priorityLabel = document.createElement('label');
    priorityLabel.htmlFor = `priority-${fert.id}`;
    priorityLabel.textContent = 'priority';
    priorityLabel.title = 'Lower value = higher priority (more preferred)';

    priorityDiv.appendChild(priorityInput);
    priorityDiv.appendChild(priorityLabel);

    item.appendChild(checkbox);
    item.appendChild(label);
    item.appendChild(priorityDiv);
    container.appendChild(item);
  });
}

// Select all reverse fertilizers
function selectAllReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) checkbox.checked = true;
  });
}

// Deselect all reverse fertilizers
function deselectAllReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Select only common reverse fertilizers
function selectCommonReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) {
      checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);
    }
  });
}

// Filter reverse fertilizers based on search term
function filterReverseFertilizers(searchTerm) {
  const normalizedSearch = searchTerm.toLowerCase().trim();

  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`reverse-item-${fert.id}`);
    if (!item) return;

    // Search in name and aliases
    const nameMatch = fert.name.toLowerCase().includes(normalizedSearch);
    const aliasMatch = fert.aliases && fert.aliases.some(alias =>
      alias.toLowerCase().includes(normalizedSearch)
    );

    // Show/hide based on match
    if (nameMatch || aliasMatch || normalizedSearch === '') {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}

// Clear reverse calculator
// Update input labels based on calculation mode
function updateReverseCalculationMode() {
  const mode = document.getElementById('reverse-calculation-mode').value;
  const pLabel = document.querySelector('label[for="reverse-p"]');
  const kLabel = document.querySelector('label[for="reverse-k"]');

  if (mode === 'elemental') {
    pLabel.textContent = i18n.t('phosphorusElemental');
    kLabel.textContent = i18n.t('potassiumElemental');
  } else {
    pLabel.textContent = i18n.t('phosphorusOxide');
    kLabel.textContent = i18n.t('potassiumOxide');
  }
}

// Update input labels for formula builder based on calculation mode
function updateFormulaCalculationMode() {
  const mode = document.getElementById('formula-calculation-mode').value;
  const pLabel = document.getElementById('target-p-label');
  const kLabel = document.getElementById('target-k-label');

  if (mode === 'elemental') {
    pLabel.textContent = i18n.t('phosphorusElemental') + ' *';
    kLabel.textContent = i18n.t('potassiumElemental') + ' *';
  } else {
    pLabel.textContent = i18n.t('phosphorusOxide') + ' *';
    kLabel.textContent = i18n.t('potassiumOxide') + ' *';
  }
}

function clearReverseCalculator() {
  // Clear target inputs and remove error states
  const targetIds = ['reverse-n', 'reverse-p', 'reverse-k', 'reverse-ca', 'reverse-mg', 'reverse-s', 'reverse-si'];
  targetIds.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.value = id === 'reverse-si' ? '0' : '';  // Si defaults to 0
      input.classList.remove('input-error');
    }
  });

  // Reset volume
  const volumeInput = document.getElementById('reverse-volume');
  if (volumeInput) {
    volumeInput.value = '10';
    volumeInput.classList.remove('input-error');
  }

  // Reset fertilizer selections to common only
  selectCommonReverseFertilizers();

  // Clear search box
  const searchInput = document.getElementById('reverse-fertilizer-search');
  if (searchInput) {
    searchInput.value = '';
    filterReverseFertilizers('');
  }

  // Hide results
  const resultsSection = document.getElementById('reverse-results');
  if (resultsSection) {
    resultsSection.style.display = 'none';
  }
}

// Main reverse calculator function
async function calculateReverse() {
  // Get target values
  // Note: P and K inputs are treated as P2O5 and K2O (industry standard N-P2O5-K2O)
  const targets = {
    N: parseFloat(document.getElementById('reverse-n').value) || 0,
    P: parseFloat(document.getElementById('reverse-p').value) || 0,
    K: parseFloat(document.getElementById('reverse-k').value) || 0,
    Ca: parseFloat(document.getElementById('reverse-ca').value) || 0,
    Mg: parseFloat(document.getElementById('reverse-mg').value) || 0,
    S: parseFloat(document.getElementById('reverse-s').value) || 0,
    Si: parseFloat(document.getElementById('reverse-si').value) || 0
  };

  const volume = parseFloat(document.getElementById('reverse-volume').value) || 10;
  const concentrationValue = document.getElementById('reverse-concentration').value;

  // Check if targeting EC or PPM base
  let targetEC = null;
  let concentration = 100;  // Default reference concentration for EC-based calculation

  if (concentrationValue.startsWith('ec:')) {
    targetEC = parseFloat(concentrationValue.substring(3));
  } else {
    concentration = parseFloat(concentrationValue) || 75;
  }

  // Validate inputs
  let hasError = false;
  const allNutrientFields = ['reverse-n', 'reverse-p', 'reverse-k', 'reverse-ca', 'reverse-mg', 'reverse-s', 'reverse-si'];

  // Validate all nutrient fields - must be valid numbers >= 0 or blank (treated as 0)
  allNutrientFields.forEach(id => {
    const input = document.getElementById(id);
    const value = input.value.trim();

    // Allow empty fields (treated as 0) or valid numbers >= 0
    if (value !== '' && (isNaN(parseFloat(value)) || parseFloat(value) < 0)) {
      input.classList.add('input-error');
      hasError = true;
    } else {
      input.classList.remove('input-error');
    }
  });

  // Check that at least one nutrient has a value > 0
  const hasAtLeastOneNutrient = Object.values(targets).some(val => val > 0);
  if (!hasAtLeastOneNutrient) {
    alert(i18n.t('alertEnterNutrientValue'));
    return;
  }

  // Validate volume
  const volumeInput = document.getElementById('reverse-volume');
  if (!volume || volume <= 0) {
    volumeInput.classList.add('input-error');
    hasError = true;
  } else {
    volumeInput.classList.remove('input-error');
  }

  if (hasError) {
    alert(i18n.t('alertFillAllNutrientFields'));
    return;
  }

  // Get selected fertilizers with their priorities
  const selectedFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    return checkbox && checkbox.checked;
  }).map(fert => {
    const priorityInput = document.getElementById(`priority-${fert.id}`);
    const priority = priorityInput ? parseFloat(priorityInput.value) || 10 : 10;
    return { ...fert, priority: Math.max(1, Math.min(100, priority)) }; // Clamp 1-100
  });

  if (selectedFertilizers.length === 0) {
    alert(i18n.t('alertSelectFertilizerToUse'));
    return;
  }

  // Get calculation mode (oxide vs elemental)
  const calculationMode = document.getElementById('reverse-calculation-mode').value;

  // Show progress bar
  progressBar.show(i18n.t('calculatingFertilizers'));
  progressBar.update(10, i18n.t('validatingInputs'));

  try {
    // Allow UI to update
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(30, i18n.t('preparingModel'));
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(50, i18n.t('runningSolver'));
    progressBar.setIndeterminate(i18n.t('optimizingCombination'));

    // Run optimization
    let result = await optimizeFormula(targets, volume, selectedFertilizers, concentration, calculationMode, { useMilp: true });
    if (progressBar.isCancelled()) return;

    // If targeting EC, scale fertilizer amounts to achieve target EC
    if (targetEC !== null && Object.keys(result.formula).length > 0) {
      progressBar.update(70, i18n.t('scalingToTargetEc'));
      await new Promise(resolve => setTimeout(resolve, 50));
      if (progressBar.isCancelled()) return;

      // Calculate predicted EC from initial result
      const initialEC = estimateECFromPPM(result.achieved);
      const predictedEC = initialEC.ec_mS_cm;

      if (predictedEC > 0) {
        // Scale factor to achieve target EC
        const scaleFactor = targetEC / predictedEC;

        // Scale all fertilizer grams
        const scaledFormula = {};
        for (const [fertId, grams] of Object.entries(result.formula)) {
          scaledFormula[fertId] = grams * scaleFactor;
        }

        // Recalculate achieved values based on scaled grams
        const scaledAchieved = {
          N_total: result.achieved.N_total * scaleFactor,
          N_NO3: result.achieved.N_NO3 * scaleFactor,
          N_NH4: result.achieved.N_NH4 * scaleFactor,
          P2O5: result.achieved.P2O5 * scaleFactor,
          K2O: result.achieved.K2O * scaleFactor,
          P: result.achieved.P * scaleFactor,
          K: result.achieved.K * scaleFactor,
          Ca: result.achieved.Ca * scaleFactor,
          Mg: result.achieved.Mg * scaleFactor,
          S: result.achieved.S * scaleFactor,
          Si: result.achieved.Si * scaleFactor
        };

        // Update result with scaled values
        result = {
          ...result,
          formula: scaledFormula,
          achieved: scaledAchieved,
          ecScaling: {
            targetEC: targetEC,
            initialEC: predictedEC,
            scaleFactor: scaleFactor
          }
        };
      }
    }

    progressBar.update(90, i18n.t('preparingResults'));
    await new Promise(resolve => setTimeout(resolve, 50));
    if (progressBar.isCancelled()) return;

    progressBar.update(100, i18n.t('complete'));
    await new Promise(resolve => setTimeout(resolve, 200));

    // Hide progress bar
    progressBar.hide();

    // Display results
    displayReverseResults(result, targets, volume, targetEC);
  } catch (error) {
    if (progressBar.isCancelled()) return;
    progressBar.hide();
    console.error('Reverse calculation error:', error);
    alert(i18n.t('alertCalculationError'));
  }
}

// Store last reverse calculation result for explanation modals
let lastReverseCalculation = null;

// Display reverse calculator results
function displayReverseResults(result, targets, volume, targetEC = null) {
  // Get calculation mode for storage
  const mode = document.getElementById('reverse-calculation-mode').value;
  // Store data for explanation modals and two-tank feature
  lastReverseCalculation = { result, targets, volume, mode, targetEC };

  const resultsSection = document.getElementById('reverse-results');
  const outputDiv = document.getElementById('reverse-output');

  resultsSection.style.display = 'block';

  let html = '<div class="formula-result"><h3>' + i18n.t('fertilizersToAddPer', { volume: i18n.formatNumber(volume), unit: i18n.t('litersShort') }) + '</h3>';

  // Display formula
  if (Object.keys(result.formula).length === 0) {
    html += '<div class="error-box"><strong>Unable to calculate formula</strong><p>The selected fertilizers cannot achieve the target nutrient ratios. Try selecting different fertilizers or adjusting your targets.</p></div>';
  } else {
    let totalGrams = 0;
    let fertCount = 0;

    Object.entries(result.formula).forEach(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      if (fert && grams > 0.01) { // Only show if significant amount
        totalGrams += grams;
        fertCount++;
        const composition = Object.entries(fert.pct)
          .map(([key, val]) => `${key}: ${val}%`)
          .join(', ');
        html += `
          <div class="formula-fertilizer">
            <div class="formula-fertilizer-info">
              <div class="formula-fertilizer-name">${fert.name}</div>
              <div class="formula-fertilizer-composition">${composition}</div>
            </div>
            <div class="formula-fertilizer-amount">${i18n.formatNumber(grams.toFixed(2))} ${i18n.t('gramsShort')}</div>
          </div>
        `;
      }
    });

    // Show total
    if (fertCount > 1) {
      html += `
        <div class="formula-fertilizer" style="border-top: 2px solid #007bff; margin-top: 10px; padding-top: 10px; background: #e3f2fd;">
          <div class="formula-fertilizer-info">
            <div class="formula-fertilizer-name" style="color: #007bff;"><strong>${i18n.t('totalFertilizers', { count: i18n.formatNumber(fertCount) })}</strong></div>
            <div class="formula-fertilizer-composition">${i18n.formatNumber((totalGrams / volume).toFixed(2))} ${i18n.t('gramsPerLiter')}</div>
          </div>
          <div class="formula-fertilizer-amount" style="color: #007bff; font-size: 1.2em;"><strong>${i18n.formatNumber(totalGrams.toFixed(2))} ${i18n.t('gramsShort')}</strong></div>
        </div>
      `;
    }
  }

  html += '</div>';

  // Note: Input values for P and K are treated as commercial oxide forms (P2O5, K2O)
  // This matches standard fertilizer labeling conventions
  // We'll display both oxide and elemental forms in the results table

  // Calculate achieved ratios using COMMERCIAL values (N:P2O5:K2O)
  // Note: Si is treated as absolute PPM, not as a ratio
  const achievedPPM_Commercial = {
    N: result.achieved.N_total,
    P2O5: result.achieved.P2O5,
    K2O: result.achieved.K2O,
    Ca: result.achieved.Ca,
    Mg: result.achieved.Mg,
    S: result.achieved.S
  };

  // Normalize achieved values to ratios (find smallest non-zero value) - excluding Si
  const achievedValues = Object.values(achievedPPM_Commercial).filter(v => v > 0);
  const minAchieved = achievedValues.length > 0 ? Math.min(...achievedValues) : 1;
  const achievedRatios = {
    N: achievedPPM_Commercial.N > 0 ? achievedPPM_Commercial.N / minAchieved : 0,
    P2O5: achievedPPM_Commercial.P2O5 > 0 ? achievedPPM_Commercial.P2O5 / minAchieved : 0,
    K2O: achievedPPM_Commercial.K2O > 0 ? achievedPPM_Commercial.K2O / minAchieved : 0,
    Ca: achievedPPM_Commercial.Ca > 0 ? achievedPPM_Commercial.Ca / minAchieved : 0,
    Mg: achievedPPM_Commercial.Mg > 0 ? achievedPPM_Commercial.Mg / minAchieved : 0,
    S: achievedPPM_Commercial.S > 0 ? achievedPPM_Commercial.S / minAchieved : 0
  };
  // Si is stored as absolute PPM
  const achievedSiPPM = result.achieved.Si || 0;

  // Normalize target values to ratios - excluding Si
  const targetNutrients = { N: targets.N, P: targets.P, K: targets.K, Ca: targets.Ca, Mg: targets.Mg, S: targets.S };
  const targetValues = Object.values(targetNutrients).filter(v => v > 0);
  const minTarget = targetValues.length > 0 ? Math.min(...targetValues) : 1;
  const targetRatios = {
    N: targets.N > 0 ? targets.N / minTarget : 0,
    P2O5: targets.P > 0 ? targets.P / minTarget : 0,  // P input is treated as P2O5
    K2O: targets.K > 0 ? targets.K / minTarget : 0,   // K input is treated as K2O
    Ca: targets.Ca > 0 ? targets.Ca / minTarget : 0,
    Mg: targets.Mg > 0 ? targets.Mg / minTarget : 0,
    S: targets.S > 0 ? targets.S / minTarget : 0
  };
  // Si target is absolute PPM
  const targetSiPPM = targets.Si || 0;

  // Get calculation mode preference
  const calculationMode = document.getElementById('reverse-calculation-mode').value; // 'oxide' or 'elemental'

  // Comparison table - showing nutrients based on selected mode
  html += '<h3>' + i18n.t('targetVsAchievedRatios') + ' <span class="info-icon" onclick="openReversePPMExplanation()" title="Click to learn how we calculate PPM">?</span></h3>';
  html += '<div class="comparison-table-wrapper">';
  html += '<table class="comparison-table">';
  html += '<tr><th>' + i18n.t('nutrient') + '</th><th>' + i18n.t('yourInput') + '</th><th>' + i18n.t('achievedRatio') + '</th><th>' + i18n.t('ppmAchieved') + '</th></tr>';

  // Display nutrients based on calculation mode
  let displayNutrients;
  if (calculationMode === 'elemental') {
    // Elemental mode: Show P and K (pure elements)
    displayNutrients = [
      { key: 'N', label: i18n.t('nitrogen'), isCommercial: false },
      { key: 'P', label: i18n.t('phosphorusElemental'), isCommercial: false },
      { key: 'K', label: i18n.t('potassiumElemental'), isCommercial: false },
      { key: 'Ca', label: i18n.t('calcium'), isCommercial: false },
      { key: 'Mg', label: i18n.t('magnesium'), isCommercial: false },
      { key: 'S', label: i18n.t('sulfur'), isCommercial: false },
      { key: 'Si', label: i18n.t('silicon'), isCommercial: false }
    ];
  } else {
    // Oxide mode: Show P₂O₅ and K₂O (commercial standard)
    displayNutrients = [
      { key: 'N', label: i18n.t('nitrogen'), isCommercial: false },
      { key: 'P2O5', label: i18n.t('phosphorusOxide'), isCommercial: true },
      { key: 'K2O', label: i18n.t('potassiumOxide'), isCommercial: true },
      { key: 'Ca', label: i18n.t('calcium'), isCommercial: false },
      { key: 'Mg', label: i18n.t('magnesium'), isCommercial: false },
      { key: 'S', label: i18n.t('sulfur'), isCommercial: false },
      { key: 'Si', label: i18n.t('silicon'), isCommercial: false }
    ];
  }

  let allGood = true;
  const warnings = [];

  displayNutrients.forEach(nutrient => {
    let targetRatio, achievedRatio, achievedPPM, userInput;

    // Get the ratio values for comparison (normalized) and user's original input
    if (nutrient.key === 'N') {
      targetRatio = targetRatios.N || 0;
      achievedRatio = achievedRatios.N || 0;
      achievedPPM = result.achieved.N_total || 0;
      userInput = targets.N || 0;
    } else if (nutrient.key === 'P') {
      // Elemental P - use P2O5 ratio but show elemental PPM
      targetRatio = targetRatios.P2O5 || 0;
      achievedRatio = achievedRatios.P2O5 || 0;
      achievedPPM = result.achieved.P || 0;
      userInput = targets.P || 0;
    } else if (nutrient.key === 'P2O5') {
      // Oxide form P2O5 (commercial)
      targetRatio = targetRatios.P2O5 || 0;
      achievedRatio = achievedRatios.P2O5 || 0;
      achievedPPM = result.achieved.P2O5 || 0;
      userInput = targets.P || 0;
    } else if (nutrient.key === 'K') {
      // Elemental K - use K2O ratio but show elemental PPM
      targetRatio = targetRatios.K2O || 0;
      achievedRatio = achievedRatios.K2O || 0;
      achievedPPM = result.achieved.K || 0;
      userInput = targets.K || 0;
    } else if (nutrient.key === 'K2O') {
      // Oxide form K2O (commercial)
      targetRatio = targetRatios.K2O || 0;
      achievedRatio = achievedRatios.K2O || 0;
      achievedPPM = result.achieved.K2O || 0;
      userInput = targets.K || 0;
    } else if (nutrient.key === 'Si') {
      // Silicon is treated as absolute PPM, not ratio
      // Handle specially below
      targetRatio = null;
      achievedRatio = null;
      achievedPPM = achievedSiPPM;
      userInput = targets.Si || 0;
    } else {
      // Ca, Mg, S - already elemental
      targetRatio = targetRatios[nutrient.key] || 0;
      achievedRatio = achievedRatios[nutrient.key] || 0;
      achievedPPM = result.achieved[nutrient.key] || 0;
      userInput = targets[nutrient.key] || 0;
    }

    // Special handling for Silicon (PPM-based, not ratio-based)
    if (nutrient.key === 'Si') {
      // Skip if both target and achieved are zero
      if (targetSiPPM === 0 && achievedSiPPM === 0) return;

      // Compare absolute PPM values for Si
      const ppmDiff = targetSiPPM > 0 ? Math.abs((achievedSiPPM - targetSiPPM) / targetSiPPM * 100) : 0;

      let className = 'match';
      let status = '✓';

      if (ppmDiff > 20) {
        className = 'miss';
        status = '✗';
        allGood = false;
        warnings.push(`${nutrient.label} is ${ppmDiff.toFixed(1)}% off target PPM`);
      } else if (ppmDiff > 10) {
        className = 'close';
        status = '⚠';
        warnings.push(`${nutrient.label} is ${ppmDiff.toFixed(1)}% off target PPM (acceptable range)`);
      }

      html += `
        <tr>
          <td>${nutrient.label} <small style="color:#666">${i18n.t('ppmLabel')}</small></td>
          <td>${i18n.formatNumber(Number(targetSiPPM || 0).toFixed(1))} ${i18n.t('ppmUnit')}</td>
          <td class="${className}">${i18n.formatNumber(Number(achievedSiPPM || 0).toFixed(1))} ${i18n.t('ppmUnit')} ${status}</td>
          <td>${i18n.formatNumber(Number(achievedSiPPM || 0).toFixed(1))} ${i18n.t('ppmUnit')}</td>
        </tr>
      `;
      return;
    }

    // Skip if both target and achieved are zero
    if (targetRatio === 0 && achievedRatio === 0) return;

    // Compare RATIOS, not absolute PPM values
    const ratioDiff = targetRatio > 0 ? Math.abs((achievedRatio - targetRatio) / targetRatio * 100) : 0;

    let className = 'match';
    let status = '✓';

    if (ratioDiff > 15) {
      className = 'miss';
      status = '✗';
      allGood = false;
      if (!nutrient.isCommercial) {  // Only warn once for elemental form
        warnings.push(i18n.t('ratioOffTarget', { nutrient: nutrient.label, percent: i18n.formatNumber(ratioDiff.toFixed(1)) }));
      }
    } else if (ratioDiff > 5) {
      className = 'close';
      status = '⚠';
      if (!nutrient.isCommercial) {  // Only warn once for elemental form
        warnings.push(i18n.t('ratioOffTargetAcceptable', { nutrient: nutrient.label, percent: i18n.formatNumber(ratioDiff.toFixed(1)) }));
      }
    }

    html += `
      <tr>
        <td>${nutrient.label}</td>
        <td>${i18n.formatNumber(Number(userInput || 0).toFixed(2))}</td>
        <td class="${className}">${i18n.formatNumber(Number(achievedRatio || 0).toFixed(2))} ${status}</td>
        <td>${i18n.formatNumber(Number(achievedPPM || 0).toFixed(1))} ${i18n.t('ppmUnit')}</td>
      </tr>
    `;
  });

  html += '</table>';
  html += '</div>';

  // Add mode-specific conversion note
  if (calculationMode === 'elemental') {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>${i18n.t('elementalModeLabel')}</strong> ${i18n.t('elementalModeNote')}
      <br>
      ${i18n.t('elementalToOxideConversion')}
    </div>`;
  } else {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>${i18n.t('oxideModeLabel')}</strong> ${i18n.t('oxideModeNote')}
      <br>
      ${i18n.t('oxideToElementalConversion')}
    </div>`;
  }

  // NH4-N percentage
  const nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;
  html += `<div class="conversion-note" style="margin-top: 15px;">
    <strong>${i18n.t('nitrogenFormLabel')}</strong> ${i18n.formatNumber(result.achieved.N_NH4.toFixed(1))} ppm NH₄-N (${i18n.formatNumber(nh4Percent.toFixed(1))}% ${i18n.t('ofTotalN')}),
    ${i18n.formatNumber(result.achieved.N_NO3.toFixed(1))} ppm NO₃-N (${i18n.formatNumber((100 - nh4Percent).toFixed(1))}% ${i18n.t('ofTotalN')})
  </div>`;

  // Calculate ion balance for this formula
  const activeFertilizers = Object.entries(result.formula).map(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    return { ...fert, grams };
  });

  const ionBalance = calculateIonBalanceForFormula(activeFertilizers, volume);

  // Ion balance section with breakdown - using unified renderer
  html += renderIonBalanceSection(ionBalance, {
    showHeader: true,
    headerTitleKey: 'ionBalance',
    infoIconHandler: 'openReverseIonBalanceExplanation()',
    showBreakdown: true,
    showExplanation: false
  });

  // Calculate and display EC using unified render function
  const ecPrediction = estimateECFromPPM(result.achieved);
  html += renderEcSection(ecPrediction, { targetEC, ecScaling: result.ecScaling });

  // Add nutrient ratio analysis - using reusable function
  const ratios = calculateNutrientRatios(result.achieved);
  html += renderNutrientRatioCards(ratios);

  // Nutritional warnings - using reusable function
  const nutritionalWarnings = checkWarnings(result.achieved, activeFertilizers);
  html += renderNutritionalWarnings(nutritionalWarnings);

  // Warnings or errors (target deviation warnings)
  if (!allGood) {
    html += '<div class="error-box"><strong>⚠ ' + i18n.t('cannotAchieveExactTargets') + '</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul><p>' + i18n.t('cannotAchieveExactTargetsConsider') + '</p><ul><li>' + i18n.t('considerSelectingAdditionalFertilizers') + '</li><li>' + i18n.t('considerAdjustingTargetValues') + '</li><li>' + i18n.t('considerAcceptingDeviations') + '</li></ul></div>';
  } else if (warnings.length > 0) {
    html += '<div class="warning-box"><strong>' + i18n.t('note') + '</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul></div>';
  } else {
    html += '<div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 4px; margin-top: 15px;"><strong style="color: #28a745;">✓ ' + i18n.t('targetsSuccessfullyAchieved') + '</strong><p style="margin: 5px 0 0 0;">' + i18n.t('allNutrientValuesWithinRange') + '</p></div>';
  }

  outputDiv.innerHTML = html;
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// PPM Explanation Modal Functions
let calculationData = null; // Store calculation data for the modal

function openPPMExplanation() {
  const modal = document.getElementById('ppm-modal');
  const modalBody = modal.querySelector('.modal-body');

  // Generate dynamic content based on current calculation
  modalBody.innerHTML = generateExplanationContent();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
}

function closePPMExplanation(event) {
  if (event && event.target !== event.currentTarget) return;

  const modal = document.getElementById('ppm-modal');
  modal.classList.remove('active');
  document.body.style.overflow = ''; // Restore scrolling
}

function generateExplanationContent() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value) || 10;

  // Get active fertilizers
  const activeFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`check-${fert.id}`);
    const input = document.getElementById(`grams-${fert.id}`);
    const grams = input ? parseFloat(input.value) : 0;
    return checkbox && checkbox.checked && grams > 0;
  }).map(fert => {
    const input = document.getElementById(`grams-${fert.id}`);
    return {
      ...fert,
      grams: parseFloat(input.value)
    };
  });

  let content = `
    <!-- What is PPM? -->
    <div class="explanation-section">
      <h3>${i18n.t('whatIsPpm')}</h3>
      <p>
        ${i18n.t('ppmStandsFor')}
        ${i18n.t('thinkOfItLikeThis')}
      </p>
      <p>
        ${i18n.t('ppmExample')}
      </p>
    </div>

    <!-- The Basic Formula -->
    <div class="explanation-section">
      <h3>${i18n.t('theBasicFormula')}</h3>
      <div class="formula-box">
        <div class="formula">${i18n.t('ppmFormulaEquation')}</div>
        <div class="description">${i18n.t('ppmFormulaDescription')}</div>
      </div>
      <p><strong>${i18n.t('whereLabel')}</strong></p>
      <ul style="line-height: 1.8;">
        <li>${i18n.t('formulaPartGrams')}</li>
        <li>${i18n.t('formulaPart1000')}</li>
        <li>${i18n.t('formulaPartPercentage')}</li>
        <li>${i18n.t('formulaPartLiters')}</li>
      </ul>
    </div>
  `;

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>
          ${i18n.t('addFertilizersToSeeBreakdown')}
        </p>
        <p>
          ${i18n.t('calculatorShowsStepByStep')}
        </p>
      </div>
    `;
  } else {
    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">${i18n.t('yourCurrentCalculation')}</h3>
        <p><strong>${i18n.t('solutionVolumeLabel')}</strong> ${i18n.formatNumber(volume)} ${i18n.t('litersUnit')}</p>
        <p><strong>${i18n.t('fertilizersUsedLabel')}</strong> ${i18n.formatNumber(activeFertilizers.length)}</p>
      </div>
    `;

    // Calculate contributions from each fertilizer
    const nutrientContributions = {};

    content += `
      <div class="explanation-section">
        <h3>${i18n.t('stepByStepBreakdown')}</h3>
        <p>${i18n.t('howWeCalculatedEachNutrient')}</p>
    `;

    activeFertilizers.forEach((fert, index) => {
      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${fert.name}
          </h4>
          <p style="margin: 10px 0 10px 38px;"><strong>${i18n.t('amountUsedLabel')}</strong> ${i18n.formatNumber(fert.grams)} ${i18n.t('gramsUnit')}</p>
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>${i18n.t('nutrientHeader')}</th>
                  <th>${i18n.t('percentInFertilizerHeader')}</th>
                  <th>${i18n.t('calculationHeader')}</th>
                  <th>${i18n.t('ppmHeader')}</th>
                </tr>
              </thead>
              <tbody>
      `;

      Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
        const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;
        const calculation = `(${i18n.formatNumber(fert.grams)} × ${i18n.formatNumber(1000)} × ${i18n.formatNumber(percentage / 100)}) ÷ ${i18n.formatNumber(volume)}`;

        // Track contributions for summary
        if (!nutrientContributions[nutrient]) {
          nutrientContributions[nutrient] = [];
        }
        nutrientContributions[nutrient].push({
          fertilizer: fert.name,
          ppm: ppm,
          percentage: percentage
        });

        content += `
          <tr>
            <td data-label="${i18n.t('nutrientHeader')}"><strong>${i18n.formatNutrientLabel(nutrient)}</strong></td>
            <td data-label="${i18n.t('percentInFertilizerHeader')}">${i18n.formatNumber(percentage)}%</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td data-label="${i18n.t('ppmHeader')}"><strong>${i18n.formatNumber(ppm.toFixed(2))} PPM</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary section showing total PPM for each nutrient
    if (Object.keys(nutrientContributions).length > 0) {
      content += `
        <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
          <h3 style="color: #28a745;">${i18n.t('finalResultsTotalPpm')}</h3>
          <p>${i18n.t('whenUsingMultipleFertilizers')}</p>
          <div style="margin-top: 15px;">
      `;

      // Calculate final results with oxide conversions
      const finalResults = {};
      Object.entries(nutrientContributions).forEach(([nutrient, contributions]) => {
        const totalPPM = contributions.reduce((sum, c) => sum + c.ppm, 0);

        // Check if this is an oxide that needs conversion
        let displayNutrient = nutrient;
        let displayPPM = totalPPM;
        let conversionNote = '';

        if (nutrient === 'P2O5' && OXIDE_CONVERSIONS.P2O5_to_P) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.P2O5_to_P;
          finalResults['P'] = convertedPPM;
          conversionNote = ` → <strong>${i18n.formatNumber(convertedPPM.toFixed(2))} PPM P</strong> ${i18n.t('elementalForm')}`;
          displayNutrient = 'P₂O₅';
        } else if (nutrient === 'K2O' && OXIDE_CONVERSIONS.K2O_to_K) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.K2O_to_K;
          finalResults['K'] = convertedPPM;
          conversionNote = ` → <strong>${i18n.formatNumber(convertedPPM.toFixed(2))} PPM K</strong> ${i18n.t('elementalForm')}`;
          displayNutrient = 'K₂O';
        } else if (nutrient === 'MgO' && OXIDE_CONVERSIONS.MgO_to_Mg) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.MgO_to_Mg;
          finalResults['Mg'] = convertedPPM;
          conversionNote = ` → <strong>${i18n.formatNumber(convertedPPM.toFixed(2))} PPM Mg</strong> ${i18n.t('elementalForm')}`;
        } else if (nutrient === 'CaO' && OXIDE_CONVERSIONS.CaO_to_Ca) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.CaO_to_Ca;
          finalResults['Ca'] = convertedPPM;
          conversionNote = ` → <strong>${i18n.formatNumber(convertedPPM.toFixed(2))} PPM Ca</strong> ${i18n.t('elementalForm')}`;
        } else {
          finalResults[nutrient] = totalPPM;
        }

        content += `
          <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 3px solid #28a745;">
            <strong style="font-size: 1.1em; color: #28a745;">${displayNutrient}:</strong>
        `;

        if (contributions.length > 1) {
          content += `<div style="margin: 8px 0 8px 20px; line-height: 1.8;">`;
          contributions.forEach(c => {
            content += `<div>• ${c.fertilizer}: ${i18n.formatNumber(c.ppm.toFixed(2))} PPM</div>`;
          });
          content += `</div>`;
          content += `<div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #dee2e6;">`;
          content += `<strong>${i18n.t('totalLabel')} ${i18n.formatNumber(totalPPM.toFixed(2))} PPM${conversionNote}</strong>`;
          content += `</div>`;
        } else {
          content += ` <strong>${i18n.formatNumber(totalPPM.toFixed(2))} PPM${conversionNote}</strong>`;
        }

        content += `</div>`;
      });

      content += `
          </div>
        </div>
      `;

      // Oxide conversion explanation if applicable
      const hasOxides = Object.keys(nutrientContributions).some(n =>
        n === 'P2O5' || n === 'K2O' || n === 'MgO' || n === 'CaO'
      );

      if (hasOxides) {
        content += `
          <div class="explanation-section">
            <h3>${i18n.t('aboutOxideConversions')}</h3>
            <p>
              ${i18n.t('oxideConversionExplanation')}
            </p>
            <table class="conversion-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>${i18n.t('oxideFormHeader')}</th>
                  <th>${i18n.t('elementalFormHeader')}</th>
                  <th>${i18n.t('conversionFactorHeader')}</th>
                </tr>
              </thead>
              <tbody>
        `;

        if (nutrientContributions['P2O5']) {
          content += `
                <tr>
                  <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('phosphateOxide')}</td>
                  <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('phosphorusElemental')}</td>
                  <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.436')}</td>
                </tr>
          `;
        }
        if (nutrientContributions['K2O']) {
          content += `
                <tr>
                  <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('potassiumOxide')}</td>
                  <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('potassiumElemental')}</td>
                  <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.830')}</td>
                </tr>
          `;
        }
        if (nutrientContributions['MgO']) {
          content += `
                <tr>
                  <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('magnesiumOxide')}</td>
                  <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('magnesiumElemental')}</td>
                  <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.603')}</td>
                </tr>
          `;
        }
        if (nutrientContributions['CaO']) {
          content += `
                <tr>
                  <td data-label="${i18n.t('oxideFormHeader')}">${i18n.t('calciumOxide')}</td>
                  <td data-label="${i18n.t('elementalFormHeader')}">${i18n.t('calciumElemental')}</td>
                  <td data-label="${i18n.t('conversionFactorHeader')}">×${i18n.formatNumber('0.715')}</td>
                </tr>
          `;
        }

        content += `
              </tbody>
            </table>
          </div>
        `;
      }
    }
  }

  // Always include helpful tips
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">${i18n.t('quickTips')}</h3>
      <ul style="line-height: 1.8;">
        <li>${i18n.t('tip1PpmEquals')}</li>
        <li>${i18n.t('tip2StartLower')}</li>
        <li>${i18n.t('tip3DifferentPlants')}</li>
        <li>${i18n.t('tip4BalanceIsKey')}</li>
        <li>${i18n.t('tip5CheckWater')}</li>
      </ul>
    </div>
  `;

  return content;
}

// Ion Balance Explanation Modal Functions
function openIonBalanceExplanation() {
  const modal = document.getElementById('ion-balance-modal');
  const modalBody = modal.querySelector('#ion-balance-modal-body');

  // Generate dynamic content based on current calculation
  modalBody.innerHTML = generateIonBalanceExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeIonBalanceExplanation(event) {
  if (event && event.target !== event.currentTarget) return;

  const modal = document.getElementById('ion-balance-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function generateIonBalanceExplanation() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value) || 10;

  // Get active fertilizers
  const activeFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`check-${fert.id}`);
    const input = document.getElementById(`grams-${fert.id}`);
    const grams = input ? parseFloat(input.value) : 0;
    return checkbox && checkbox.checked && grams > 0;
  }).map(fert => {
    const input = document.getElementById(`grams-${fert.id}`);
    return {
      ...fert,
      grams: parseFloat(input.value)
    };
  });

  // Ion Balance explanation - using reusable function
  let content = renderIonBalanceExplanation();

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>
          ${i18n.t('addFertilizersForIonBalance')}
        </p>
        <p>
          ${i18n.t('ionBalanceStepByStep')}
        </p>
      </div>
    `;
  } else {
    // Calculate ion balance - using reusable function (now returns statusColor/statusText too)
    const { totalCations, totalAnions, ionDetails, fertilizerBreakdown, imbalance, statusColor, statusText } = calculateIonBalanceDetails(activeFertilizers, volume);

    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">${i18n.t('yourCurrentSolution')}</h3>
        <p><strong>${i18n.t('solutionVolumeLabel')}</strong> ${i18n.formatNumber(volume)} ${i18n.t('litersUnit')}</p>
        <p><strong>${i18n.t('fertilizersUsedLabel')}</strong> ${i18n.formatNumber(activeFertilizers.length)}</p>
      </div>

      <!-- Step-by-Step Breakdown -->
      <div class="explanation-section">
        <h3>${i18n.t('stepByStepIonCalculation')}</h3>
        <p>${i18n.t('howEachFertilizerContributesIons')}</p>
    `;

    fertilizerBreakdown.forEach((item, index) => {
      const formulaDisplay = item.ionData.formula ?
        `<span style="background: #e8f4f8; padding: 4px 8px; border-radius: 4px; font-family: monospace; margin-left: 10px; font-size: 0.9em;">${item.ionData.formula}</span>` :
        '';

      // Check for hydration water in the formula
      const hasHydrationWater = item.ionData.formula && item.ionData.formula.includes('H₂O');

      // Check if this is urea or urea-based (name contains 'urea' but not 'urea phosphate' since that has ions)
      const isUreaOnly = item.fert.name.toLowerCase().includes('urea') &&
                         !item.fert.name.toLowerCase().includes('phosphate') &&
                         !item.fert.name.toLowerCase().includes('thiosulfate');

      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${item.fert.name}
            ${formulaDisplay}
          </h4>
          <p style="margin: 10px 0 10px 38px;">
            <strong>${i18n.t('amountLabel')}</strong> ${i18n.formatNumber(item.fert.grams)} ${i18n.t('gramsUnit')}<br>
            <strong>${i18n.t('molarMassLabel')}</strong> ${i18n.formatNumber(item.ionData.molarMass)} g/mol<br>
            <strong>${i18n.t('molesLabel')}</strong> ${i18n.formatNumber(item.fert.grams)} ÷ ${i18n.formatNumber(item.ionData.molarMass)} = <strong>${i18n.formatNumber(item.moles.toFixed(4))} ${i18n.t('molUnit')}</strong>
          </p>
      `;

      // Add note about hydration water if applicable
      if (hasHydrationWater) {
        content += `
          <div style="margin: 10px 0 10px 38px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.9em;">
            <strong>${i18n.t('hydrationWaterTitle')}</strong> ${i18n.t('hydrationWaterExplanation')}
          </div>
        `;
      }

      // Add note about urea if applicable
      if (isUreaOnly) {
        content += `
          <div style="margin: 10px 0 10px 38px; padding: 10px; background: #d1ecf1; border-left: 3px solid #17a2b8; border-radius: 4px; font-size: 0.9em;">
            <strong>${i18n.t('ureaInfoTitle')}</strong> ${i18n.t('ureaInfoExplanation')}
          </div>
        `;
      }

      content += `
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>${i18n.t('ionHeader')}</th>
                  <th>${i18n.t('typeHeader')}</th>
                  <th>${i18n.t('countTimesChargeHeader')}</th>
                  <th>${i18n.t('calculationHeader')}</th>
                  <th>${i18n.t('meqLHeader')}</th>
                </tr>
              </thead>
              <tbody>
      `;

      item.ions.forEach(ion => {
        const chargeSymbol = ion.type === 'cation' ? '+' : '-';
        const calculation = `${i18n.formatNumber(item.moles.toFixed(4))} × ${i18n.formatNumber(ion.count)} × ${i18n.formatNumber(ion.charge)} × ${i18n.formatNumber(1000)} ÷ ${i18n.formatNumber(volume)}`;

        content += `
          <tr>
            <td data-label="Ion"><strong>${ion.ion}</strong></td>
            <td data-label="Type">${ion.type === 'cation' ? i18n.t('cationType') : i18n.t('anionType')}</td>
            <td data-label="Count × Charge">${i18n.formatNumber(ion.count)} × ${i18n.formatNumber(ion.charge)}</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td data-label="meq/L"><strong>${i18n.formatNumber(ion.meq.toFixed(2))} meq/L</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary section - status comes from calculateIonBalanceDetails (via unified core)
    const cations = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'cation');
    const anions = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'anion');

    // Final Ion Balance Results - using reusable function
    content += renderFinalIonBalanceResults(totalCations, totalAnions, imbalance, statusColor, statusText, 'finalIonBalanceResults', true);

    // Individual ion breakdown - using reusable function
    content += renderIonBreakdownGrid(cations, anions, totalCations, totalAnions);
  }

  // Always include interpretation guide
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">${i18n.t('interpretingResults')}</h3>
      <ul style="line-height: 1.8;">
        <li><strong>${i18n.t('imbalanceLessThan10')}</strong> ${i18n.t('imbalanceLessThan10Desc')}</li>
        <li><strong>${i18n.t('imbalance10To20')}</strong> ${i18n.t('imbalance10To20Desc')}</li>
        <li><strong>${i18n.t('imbalanceOver20')}</strong> ${i18n.t('imbalanceOver20Desc')}</li>
      </ul>
      <p style="margin-top: 15px;">
        <strong>${i18n.t('whyDoesThisMatter')}</strong> ${i18n.t('whyDoesThisMatterExplanation')}
      </p>
    </div>
  `;

  return content;
}

// ==========================================
// Reverse Calculator Explanation Functions
// ==========================================

// Open PPM explanation for reverse calculator results
function openReversePPMExplanation() {
  const modal = document.getElementById('ppm-modal');
  const modalBody = modal.querySelector('.modal-body');

  modalBody.innerHTML = generateReversePPMExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Open Ion Balance explanation for reverse calculator results
function openReverseIonBalanceExplanation() {
  const modal = document.getElementById('ion-balance-modal');
  const modalBody = modal.querySelector('#ion-balance-modal-body');

  modalBody.innerHTML = generateReverseIonBalanceExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Generate PPM explanation content for reverse calculator
function generateReversePPMExplanation() {
  if (!lastReverseCalculation) {
    return `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>${i18n.t('pleaseRunCalculation')}</p>
      </div>
    `;
  }

  const { result, targets, volume } = lastReverseCalculation;

  // Get active fertilizers from result
  const activeFertilizers = Object.entries(result.formula)
    .filter(([fertId, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { ...fert, grams };
    });

  let content = `
    <!-- What is PPM? -->
    <div class="explanation-section">
      <h3>${i18n.t('whatIsPpm')}</h3>
      <p>
        ${i18n.t('ppmStandsFor')}
        ${i18n.t('thinkOfItLikeThis')}
      </p>
      <p>
        ${i18n.t('ppmExample')}
      </p>
    </div>

    <!-- The Basic Formula -->
    <div class="explanation-section">
      <h3>${i18n.t('theBasicFormula')}</h3>
      <div class="formula-box">
        <div class="formula">${i18n.t('ppmFormulaEquation')}</div>
        <div class="description">${i18n.t('ppmFormulaDescription')}</div>
      </div>
      <p><strong>${i18n.t('whereLabel')}</strong></p>
      <ul style="line-height: 1.8;">
        <li>${i18n.t('formulaPartGrams')}</li>
        <li>${i18n.t('formulaPart1000')}</li>
        <li>${i18n.t('formulaPartPercentage')}</li>
        <li>${i18n.t('formulaPartLiters')}</li>
      </ul>
    </div>
  `;

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noFertilizersInFormula')}</h3>
        <p>${i18n.t('noValidFormulaLong')}</p>
      </div>
    `;
  } else {
    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">${i18n.t('yourCurrentCalculation')}</h3>
        <p><strong>${i18n.t('solutionVolumeLabel')}</strong> ${i18n.formatNumber(volume)} ${i18n.t('litersUnit')}</p>
        <p><strong>${i18n.t('fertilizersUsedLabel')}</strong> ${i18n.formatNumber(activeFertilizers.length)}</p>
      </div>
    `;

    // Calculate contributions from each fertilizer
    const nutrientContributions = {};

    content += `
      <div class="explanation-section">
        <h3>${i18n.t('stepByStepBreakdown')}</h3>
        <p>${i18n.t('howEachFertilizerContributesToAchieved')}</p>
    `;

    activeFertilizers.forEach((fert, index) => {
      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${fert.name}
          </h4>
          <p style="margin: 10px 0 10px 38px;"><strong>Amount calculated:</strong> ${fert.grams.toFixed(2)} grams</p>
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>${i18n.t('nutrientHeader')}</th>
                  <th>${i18n.t('percentInFertilizerHeader')}</th>
                  <th>${i18n.t('calculationHeader')}</th>
                  <th>${i18n.t('ppmHeader')}</th>
                </tr>
              </thead>
              <tbody>
      `;

      Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
        const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;
        const calculation = `(${i18n.formatNumber(fert.grams.toFixed(2))} × ${i18n.formatNumber(1000)} × ${i18n.formatNumber((percentage / 100).toFixed(4))}) ÷ ${i18n.formatNumber(volume)}`;

        // Track contributions for summary
        if (!nutrientContributions[nutrient]) {
          nutrientContributions[nutrient] = [];
        }
        nutrientContributions[nutrient].push({
          fertilizer: fert.name,
          ppm: ppm,
          percentage: percentage
        });

        content += `
          <tr>
            <td data-label="${i18n.t('nutrientHeader')}"><strong>${i18n.formatNutrientLabel(nutrient)}</strong></td>
            <td data-label="${i18n.t('percentInFertilizerHeader')}">${i18n.formatNumber(percentage)}%</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td data-label="${i18n.t('ppmHeader')}"><strong>${i18n.formatNumber(ppm.toFixed(2))} PPM</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary table showing totals
    content += `
      <div class="explanation-section">
        <h3>${i18n.t('nutrientTotalsSummary')}</h3>
        <p>${i18n.t('whenNutrientsFromMultiple')}</p>
        <table class="conversion-table">
          <thead>
            <tr>
              <th>${i18n.t('nutrientHeader')}</th>
              <th>${i18n.t('sourcesHeader')}</th>
              <th>${i18n.t('totalPpmHeader')}</th>
            </tr>
          </thead>
          <tbody>
    `;

    Object.entries(nutrientContributions).forEach(([nutrient, sources]) => {
      const total = sources.reduce((sum, s) => sum + s.ppm, 0);
      const sourceList = sources.map(s => `${s.fertilizer}: ${i18n.formatNumber(s.ppm.toFixed(2))}`).join(' + ');

      content += `
        <tr>
          <td data-label="${i18n.t('nutrientHeader')}"><strong>${i18n.formatNutrientLabel(nutrient)}</strong></td>
          <td data-label="${i18n.t('sourcesHeader')}" style="font-size: 0.85em;">${sourceList}</td>
          <td data-label="${i18n.t('totalPpmHeader')}"><strong>${i18n.formatNumber(total.toFixed(2))} ${i18n.t('ppmUnit')}</strong></td>
        </tr>
      `;
    });

    content += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Oxide conversions info
  // Oxide conversion explanation - using reusable function
  content += renderOxideConversionExplanation();

  return content;
}

// Generate Ion Balance explanation content for reverse calculator
function generateReverseIonBalanceExplanation() {
  if (!lastReverseCalculation) {
    return `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>${i18n.t('pleaseRunCalculation')}</p>
      </div>
    `;
  }

  const { result, volume } = lastReverseCalculation;

  // Get active fertilizers from result
  const activeFertilizers = Object.entries(result.formula)
    .filter(([fertId, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { ...fert, grams };
    });

  // Ion Balance explanation - using reusable function
  let content = renderIonBalanceExplanation();

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noFertilizersInFormula')}</h3>
        <p>${i18n.t('noValidFormulaLong')}</p>
      </div>
    `;
  } else {
    // Calculate ion balance - using reusable function (now returns statusColor/statusText too)
    const { totalCations, totalAnions, ionDetails, fertilizerBreakdown, imbalance, statusColor, statusText } = calculateIonBalanceDetails(activeFertilizers, volume);

    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">${i18n.t('yourCurrentSolution')}</h3>
        <p><strong>${i18n.t('solutionVolumeLabel')}</strong> ${i18n.formatNumber(volume)} ${i18n.t('litersUnit')}</p>
        <p><strong>${i18n.t('fertilizersUsedLabel')}</strong> ${i18n.formatNumber(activeFertilizers.length)}</p>
      </div>

      <!-- Step-by-Step Breakdown -->
      <div class="explanation-section">
        <h3>${i18n.t('stepByStepIonCalculation')}</h3>
        <p>${i18n.t('howEachFertilizerContributesIons')}</p>
    `;

    fertilizerBreakdown.forEach((item, index) => {
      const formulaDisplay = item.ionData.formula ?
        `<span style="background: #e8f4f8; padding: 4px 8px; border-radius: 4px; font-family: monospace; margin-left: 10px; font-size: 0.9em;">${item.ionData.formula}</span>` :
        '';

      const hasHydrationWater = item.ionData.formula && item.ionData.formula.includes('H₂O');

      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${item.fert.name}
            ${formulaDisplay}
          </h4>
          <p style="margin: 10px 0 10px 38px;">
            <strong>${i18n.t('amountLabel')}</strong> ${i18n.formatNumber(item.fert.grams.toFixed(2))} ${i18n.t('gramsUnit')}<br>
            <strong>${i18n.t('molarMassLabel')}</strong> ${i18n.formatNumber(item.ionData.molarMass)} g/mol<br>
            <strong>${i18n.t('molesLabel')}</strong> ${i18n.formatNumber(item.fert.grams.toFixed(2))} ÷ ${i18n.formatNumber(item.ionData.molarMass)} = <strong>${i18n.formatNumber(item.moles.toFixed(4))} mol</strong>
          </p>
      `;

      if (hasHydrationWater) {
        content += `
          <div style="margin: 10px 0 10px 38px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.9em;">
            <strong>${i18n.t('hydrationWaterTitle')}</strong> ${i18n.t('hydrationWaterExplanation')}
          </div>
        `;
      }

      content += `
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>${i18n.t('ionHeader')}</th>
                  <th>${i18n.t('typeHeader')}</th>
                  <th>${i18n.t('calculationHeader')}</th>
                  <th>${i18n.t('meqLHeader')}</th>
                </tr>
              </thead>
              <tbody>
      `;

      item.ions.forEach(ionInfo => {
        const typeColor = ionInfo.type === 'cation' ? '#28a745' : '#dc3545';
        const typeSymbol = ionInfo.type === 'cation' ? '+' : '-';
        content += `
          <tr>
            <td data-label="${i18n.t('ionHeader')}"><strong>${ionInfo.ion}</strong></td>
            <td data-label="${i18n.t('typeHeader')}" style="color: ${typeColor};">${ionInfo.type} (${typeSymbol})</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">
              ${i18n.formatNumber(item.moles.toFixed(4))} × ${i18n.formatNumber(ionInfo.count)} × ${i18n.formatNumber(ionInfo.charge)} × ${i18n.formatNumber(1000)} ÷ ${i18n.formatNumber(volume)}
            </td>
            <td data-label="${i18n.t('meqLHeader')}"><strong>${i18n.formatNumber(ionInfo.meq.toFixed(2))}</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Results summary - status comes from calculateIonBalanceDetails (via unified core)
    const cations = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'cation').sort((a, b) => b[1].meq - a[1].meq);
    const anions = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'anion').sort((a, b) => b[1].meq - a[1].meq);

    // Final Results - using reusable function
    content += renderFinalIonBalanceResults(totalCations, totalAnions, imbalance, statusColor, statusText, 'finalResults', false);

    // Individual ion breakdown - using reusable function
    content += renderIonBreakdownGrid(cations, anions, totalCations, totalAnions);
  }

  // Always include interpretation guide
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">${i18n.t('interpretingResults')}</h3>
      <ul style="line-height: 1.8;">
        <li><strong>${i18n.t('imbalanceLessThan10')}</strong> ${i18n.t('imbalanceLessThan10Desc')}</li>
        <li><strong>${i18n.t('imbalance10To20')}</strong> ${i18n.t('imbalance10To20Desc')}</li>
        <li><strong>${i18n.t('imbalanceOver20')}</strong> ${i18n.t('imbalanceOver20Desc')}</li>
      </ul>
      <p style="margin-top: 15px;">
        <strong>${i18n.t('whyDoesThisMatter')}</strong> ${i18n.t('whyDoesThisMatterExplanation')}
      </p>
    </div>
  `;

  return content;
}

// ==========================================
// Two-Tank View Explanation Functions
// ==========================================

// Open PPM explanation for two-tank view
function openTwoTankPPMExplanation() {
  const modal = document.getElementById('ppm-modal');
  const modalBody = modal.querySelector('.modal-body');

  modalBody.innerHTML = generateTwoTankPPMExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Open Ion Balance explanation for two-tank view
function openTwoTankIonBalanceExplanation() {
  const modal = document.getElementById('ion-balance-modal');
  const modalBody = modal.querySelector('#ion-balance-modal-body');

  modalBody.innerHTML = generateTwoTankIonBalanceExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Helper function to convert tank fertilizers object to array with full fertilizer data
// Used by both PPM and Ion Balance explanation functions
function getTankFertilizerArray(tankFertilizers, tankLabel) {
  return Object.entries(tankFertilizers)
    .filter(([id, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return fert ? { ...fert, grams, tank: tankLabel } : null;
    })
    .filter(f => f !== null);
}

// Generate PPM explanation content for two-tank view
function generateTwoTankPPMExplanation() {
  if (!currentTwoTankData) {
    return `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>${i18n.t('pleaseRunCalculation')}</p>
      </div>
    `;
  }

  const { tankA, tankB, volume } = currentTwoTankData;

  // Use helper function to convert fertilizer objects to arrays with full fertilizer data
  const tankAFerts = getTankFertilizerArray(tankA.fertilizers, 'A');
  const tankBFerts = getTankFertilizerArray(tankB.fertilizers, 'B');
  const allFertilizers = [...tankAFerts, ...tankBFerts];

  let content = `
    <!-- What is PPM? -->
    <div class="explanation-section">
      <h3>${i18n.t('whatIsPpm')}</h3>
      <p>
        ${i18n.t('ppmStandsFor')}
        ${i18n.t('thinkOfItLikeThis')}
      </p>
      <p>
        ${i18n.t('ppmExample')}
      </p>
    </div>

    <!-- The Basic Formula -->
    <div class="explanation-section">
      <h3>${i18n.t('theBasicFormula')}</h3>
      <div class="formula-box">
        <div class="formula">${i18n.t('ppmFormulaEquation')}</div>
        <div class="description">${i18n.t('ppmFormulaDescription')}</div>
      </div>
      <p><strong>${i18n.t('whereLabel')}</strong></p>
      <ul style="line-height: 1.8;">
        <li>${i18n.t('formulaPartGrams')}</li>
        <li>${i18n.t('formulaPart1000')}</li>
        <li>${i18n.t('formulaPartPercentage')}</li>
        <li>${i18n.t('formulaPartLiters')}</li>
      </ul>
    </div>

    <!-- Two-Tank Note -->
    <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
      <h3 style="color: #17a2b8;">Two-Tank System</h3>
      <p><strong>Solution Volume:</strong> ${volume} liters per tank</p>
      <p><strong>Tank A Fertilizers:</strong> ${tankAFerts.length}</p>
      <p><strong>Tank B Fertilizers:</strong> ${tankBFerts.length}</p>
      <p style="margin-top: 10px;">
        <strong>Important:</strong> Each tank is prepared separately with ${volume}L of water.
        When mixed at equal rates, the PPM values from both tanks combine to give your final solution concentration.
      </p>
    </div>
  `;

  if (allFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noFertilizersInFormula')}</h3>
        <p>${i18n.t('noValidFormulaShort')}</p>
      </div>
    `;
  } else {
    // Calculate contributions from each fertilizer
    const nutrientContributions = {};

    content += `
      <div class="explanation-section">
        <h3>${i18n.t('stepByStepBreakdown')}</h3>
        <p>${i18n.t('howEachFertilizerContributesToPpm')}</p>
    `;

    allFertilizers.forEach((fert, index) => {
      const tankLabel = fert.tank === 'A' ?
        '<span style="background: #c8e6c9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">Tank A</span>' :
        '<span style="background: #bbdefb; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">Tank B</span>';

      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${fert.name}
            ${tankLabel}
          </h4>
          <p style="margin: 10px 0 10px 38px;"><strong>Amount:</strong> ${fert.grams.toFixed(2)} grams</p>
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>${i18n.t('nutrientHeader')}</th>
                  <th>${i18n.t('percentInFertilizerHeader')}</th>
                  <th>${i18n.t('calculationHeader')}</th>
                  <th>${i18n.t('ppmHeader')}</th>
                </tr>
              </thead>
              <tbody>
      `;

      Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
        const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;
        const calculation = `(${i18n.formatNumber(fert.grams.toFixed(2))} × ${i18n.formatNumber(1000)} × ${i18n.formatNumber((percentage / 100).toFixed(4))}) ÷ ${i18n.formatNumber(volume)}`;

        // Track contributions for summary
        if (!nutrientContributions[nutrient]) {
          nutrientContributions[nutrient] = { tankA: [], tankB: [] };
        }
        nutrientContributions[nutrient][fert.tank === 'A' ? 'tankA' : 'tankB'].push({
          fertilizer: fert.name,
          ppm: ppm,
          percentage: percentage
        });

        content += `
          <tr>
            <td data-label="${i18n.t('nutrientHeader')}"><strong>${i18n.formatNutrientLabel(nutrient)}</strong></td>
            <td data-label="${i18n.t('percentInFertilizerHeader')}">${i18n.formatNumber(percentage)}%</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td data-label="${i18n.t('ppmHeader')}"><strong>${i18n.formatNumber(ppm.toFixed(2))} PPM</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary table showing totals by tank
    content += `
      <div class="explanation-section">
        <h3>Nutrient Totals by Tank</h3>
        <p>When nutrients come from multiple fertilizers, we add them together:</p>
        <table class="conversion-table">
          <thead>
            <tr>
              <th>${i18n.t('nutrientHeader')}</th>
              <th>${i18n.t('tankAPpmHeader')}</th>
              <th>${i18n.t('tankBPpmHeader')}</th>
              <th>${i18n.t('combinedPpmHeader')}</th>
            </tr>
          </thead>
          <tbody>
    `;

    Object.entries(nutrientContributions).forEach(([nutrient, sources]) => {
      const tankATotal = sources.tankA.reduce((sum, s) => sum + s.ppm, 0);
      const tankBTotal = sources.tankB.reduce((sum, s) => sum + s.ppm, 0);
      const combined = tankATotal + tankBTotal;

      content += `
        <tr>
          <td data-label="${i18n.t('nutrientHeader')}"><strong>${i18n.formatNutrientLabel(nutrient)}</strong></td>
          <td data-label="Tank A PPM" style="color: #2e7d32;">${tankATotal.toFixed(2)}</td>
          <td data-label="Tank B PPM" style="color: #1565c0;">${tankBTotal.toFixed(2)}</td>
          <td data-label="Combined PPM"><strong>${combined.toFixed(2)} PPM</strong></td>
        </tr>
      `;
    });

    content += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Oxide conversions info
  // Oxide conversion explanation - using reusable function
  content += renderOxideConversionExplanation();

  return content;
}

// Generate Ion Balance explanation content for two-tank view
function generateTwoTankIonBalanceExplanation() {
  if (!currentTwoTankData) {
    return `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>${i18n.t('pleaseRunCalculation')}</p>
      </div>
    `;
  }

  const { tankA, tankB, volume } = currentTwoTankData;

  // Combine fertilizers from both tanks using the helper function
  const allFertilizers = [
    ...getTankFertilizerArray(tankA.fertilizers, 'A'),
    ...getTankFertilizerArray(tankB.fertilizers, 'B')
  ];

  // Ion Balance explanation - using reusable function
  let content = renderIonBalanceExplanation();

  content += `
    <!-- Two-Tank Note -->
    <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
      <h3 style="color: #17a2b8;">Two-Tank System Ion Balance</h3>
      <p><strong>Solution Volume:</strong> ${volume} liters per tank</p>
      <p style="margin-top: 10px;">
        <strong>Important:</strong> Each tank has its own ion balance. When mixed at equal rates,
        the ion concentrations combine. The individual tank ion balances shown below help you understand
        each tank's chemistry independently.
      </p>
    </div>
  `;

  if (allFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noFertilizersInFormula')}</h3>
        <p>${i18n.t('noValidFormulaShort')}</p>
      </div>
    `;
  } else {
    // Calculate ion balance for each tank
    const tankResults = { A: { cations: 0, anions: 0, ions: {}, breakdown: [] }, B: { cations: 0, anions: 0, ions: {}, breakdown: [] } };

    allFertilizers.forEach(fert => {
      const ionData = ION_DATA[fert.id];
      if (!ionData) return;

      const tankKey = fert.tank;
      const moles = fert.grams / ionData.molarMass;
      const fertIons = [];

      ionData.ions.forEach(ionInfo => {
        const meq = moles * ionInfo.count * ionInfo.charge * 1000;
        const meqPerLiter = meq / volume;

        fertIons.push({
          ...ionInfo,
          meq: meqPerLiter,
          calculation: { moles, meq, meqPerLiter }
        });

        if (!tankResults[tankKey].ions[ionInfo.ion]) {
          tankResults[tankKey].ions[ionInfo.ion] = { meq: 0, type: ionInfo.type };
        }
        tankResults[tankKey].ions[ionInfo.ion].meq += meqPerLiter;

        if (ionInfo.type === 'cation') {
          tankResults[tankKey].cations += meqPerLiter;
        } else {
          tankResults[tankKey].anions += meqPerLiter;
        }
      });

      tankResults[tankKey].breakdown.push({
        fert: fert,
        ionData: ionData,
        moles: moles,
        ions: fertIons
      });
    });

    // Show breakdown for each tank
    ['A', 'B'].forEach(tankKey => {
      const tank = tankResults[tankKey];
      const tankColor = tankKey === 'A' ? '#2e7d32' : '#1565c0';
      const tankBg = tankKey === 'A' ? '#c8e6c9' : '#bbdefb';

      if (tank.breakdown.length === 0) return;

      const average = (tank.cations + tank.anions) / 2;
      const imbalance = average > 0 ? Math.abs(tank.cations - tank.anions) / average * 100 : 0;
      const { statusColor, statusText } = getIonBalanceStatus(imbalance, false);

      content += `
        <div class="explanation-section" style="background: ${tankBg}40; border-left-color: ${tankColor};">
          <h3 style="color: ${tankColor};">Tank ${tankKey} Ion Calculations</h3>
      `;

      tank.breakdown.forEach((item, index) => {
        const formulaDisplay = item.ionData.formula ?
          `<span style="background: #e8f4f8; padding: 4px 8px; border-radius: 4px; font-family: monospace; margin-left: 10px; font-size: 0.9em;">${item.ionData.formula}</span>` :
          '';

        content += `
          <div class="step">
            <h4 style="margin-top: 0; color: #007bff;">
              <span class="step-number">${index + 1}</span>
              ${item.fert.name}
              ${formulaDisplay}
            </h4>
            <p style="margin: 10px 0 10px 38px;">
              <strong>Amount:</strong> ${item.fert.grams.toFixed(2)} grams<br>
              <strong>Molar Mass:</strong> ${item.ionData.molarMass} g/mol<br>
              <strong>Moles:</strong> ${item.fert.grams.toFixed(2)} ÷ ${item.ionData.molarMass} = <strong>${item.moles.toFixed(4)} mol</strong>
            </p>
            <div style="margin-left: 38px;">
              <table class="conversion-table" style="font-size: 0.9em;">
                <thead>
                  <tr>
                    <th>Ion</th>
                    <th>Type</th>
                    <th>Calculation</th>
                    <th>meq/L</th>
                  </tr>
                </thead>
                <tbody>
        `;

        item.ions.forEach(ionInfo => {
          const typeColor = ionInfo.type === 'cation' ? '#28a745' : '#dc3545';
          const typeSymbol = ionInfo.type === 'cation' ? '+' : '-';
          content += `
            <tr>
              <td data-label="Ion"><strong>${ionInfo.ion}</strong></td>
              <td data-label="Type" style="color: ${typeColor};">${ionInfo.type} (${typeSymbol})</td>
              <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">
                ${item.moles.toFixed(4)} × ${ionInfo.count} × ${ionInfo.charge} × 1000 ÷ ${volume}
              </td>
              <td data-label="meq/L"><strong>${ionInfo.meq.toFixed(2)}</strong></td>
            </tr>
          `;
        });

        content += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      });

      // Tank summary
      content += `
          <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 2px solid ${statusColor};">
            <h4 style="margin-top: 0;">Tank ${tankKey} Summary</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
              <div>
                <div style="font-size: 0.85em; color: #666;">Cations</div>
                <div style="font-size: 1.3em; font-weight: bold;">${tank.cations.toFixed(2)} meq/L</div>
              </div>
              <div>
                <div style="font-size: 0.85em; color: #666;">Anions</div>
                <div style="font-size: 1.3em; font-weight: bold;">${tank.anions.toFixed(2)} meq/L</div>
              </div>
              <div>
                <div style="font-size: 0.85em; color: #666;">Imbalance</div>
                <div style="font-size: 1.3em; font-weight: bold; color: ${statusColor};">${imbalance.toFixed(1)}% ${statusText}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    // Combined totals
    const combinedCations = tankResults.A.cations + tankResults.B.cations;
    const combinedAnions = tankResults.A.anions + tankResults.B.anions;
    const combinedAverage = (combinedCations + combinedAnions) / 2;
    const combinedImbalance = combinedAverage > 0 ? Math.abs(combinedCations - combinedAnions) / combinedAverage * 100 : 0;

    let combinedStatusColor = '#28a745';
    let combinedStatusText = i18n.t('balanced');
    if (combinedImbalance > 20) {
      combinedStatusColor = '#dc3545';
      combinedStatusText = i18n.t('imbalanced');
    } else if (combinedImbalance > 10) {
      combinedStatusColor = '#ffc107';
      combinedStatusText = i18n.t('caution');
    }

    content += `
      <div class="explanation-section" style="background: ${combinedStatusColor}15; border-left-color: ${combinedStatusColor};">
        <h3 style="color: ${combinedStatusColor};">Combined Solution Results</h3>
        <p>When Tank A and Tank B are mixed at equal rates:</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
          <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Cations (+)</div>
            <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${combinedCations.toFixed(2)}</div>
            <div style="font-size: 0.9em; color: #666;">meq/L</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Anions (-)</div>
            <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${combinedAnions.toFixed(2)}</div>
            <div style="font-size: 0.9em; color: #666;">meq/L</div>
          </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid ${combinedStatusColor};">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Combined Imbalance</div>
          <div style="font-size: 2em; font-weight: bold; color: ${combinedStatusColor};">${combinedImbalance.toFixed(1)}%</div>
          <div style="font-size: 1em; color: ${combinedStatusColor}; margin-top: 5px;">${combinedStatusText}</div>
        </div>
      </div>
    `;
  }

  // Interpretation guide
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">${i18n.t('interpretingResults')}</h3>
      <ul style="line-height: 1.8;">
        <li><strong>${i18n.t('imbalanceLessThan10')}</strong> ${i18n.t('imbalanceLessThan10Desc')}</li>
        <li><strong>${i18n.t('imbalance10To20')}</strong> ${i18n.t('imbalance10To20Desc')}</li>
        <li><strong>${i18n.t('imbalanceOver20')}</strong> ${i18n.t('imbalanceOver20Desc')}</li>
      </ul>
      <p style="margin-top: 15px;">
        <strong>${i18n.t('whyDoesThisMatter')}</strong> ${i18n.t('whyDoesThisMatterExplanation')}
      </p>
    </div>
  `;

  return content;
}

// Formula Builder (PPM to Grams) explanation functions
function openFormulaIonBalanceExplanation() {
  const modal = document.getElementById('ion-balance-modal');
  const modalBody = modal.querySelector('#ion-balance-modal-body');

  modalBody.innerHTML = generateFormulaIonBalanceExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Generate Ion Balance explanation content for formula builder
function generateFormulaIonBalanceExplanation() {
  if (!lastFormulaCalculation) {
    return `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noCalculationYet')}</h3>
        <p>${i18n.t('pleaseRunCalculation')}</p>
      </div>
    `;
  }

  const { result, volume } = lastFormulaCalculation;

  // Get active fertilizers from result
  const activeFertilizers = Object.entries(result.formula)
    .filter(([fertId, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { ...fert, grams };
    });

  // Ion Balance explanation - using reusable function
  let content = renderIonBalanceExplanation();

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">${i18n.t('noFertilizersInFormula')}</h3>
        <p>${i18n.t('noValidFormulaLong')}</p>
      </div>
    `;
  } else {
    // Calculate ion balance
    let totalCations = 0;
    let totalAnions = 0;
    const ionDetails = {};
    const fertilizerBreakdown = [];

    activeFertilizers.forEach(fert => {
      const ionData = ION_DATA[fert.id];

      if (!ionData) {
        return;
      }

      const moles = fert.grams / ionData.molarMass;
      const fertIons = [];

      ionData.ions.forEach(ionInfo => {
        const meq = moles * ionInfo.count * ionInfo.charge * 1000;
        const meqPerLiter = meq / volume;

        fertIons.push({
          ...ionInfo,
          meq: meqPerLiter
        });

        if (!ionDetails[ionInfo.ion]) {
          ionDetails[ionInfo.ion] = { meq: 0, type: ionInfo.type };
        }
        ionDetails[ionInfo.ion].meq += meqPerLiter;

        if (ionInfo.type === 'cation') {
          totalCations += meqPerLiter;
        } else {
          totalAnions += meqPerLiter;
        }
      });

      fertilizerBreakdown.push({
        fert: fert,
        ionData: ionData,
        moles: moles,
        ions: fertIons
      });
    });

    const average = (totalCations + totalAnions) / 2;
    const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;

    content += `
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">${i18n.t('yourCurrentSolution')}</h3>
        <p><strong>${i18n.t('solutionVolumeLabel')}</strong> ${i18n.formatNumber(volume)} ${i18n.t('litersUnit')}</p>
        <p><strong>${i18n.t('fertilizersUsedLabel')}</strong> ${i18n.formatNumber(activeFertilizers.length)}</p>
      </div>

      <div class="explanation-section">
        <h3>${i18n.t('stepByStepIonCalculation')}</h3>
        <p>${i18n.t('howEachFertilizerContributesIons')}</p>
    `;

    fertilizerBreakdown.forEach((item, index) => {
      const formulaDisplay = item.ionData.formula ?
        `<span style="background: #e8f4f8; padding: 4px 8px; border-radius: 4px; font-family: monospace; margin-left: 10px; font-size: 0.9em;">${item.ionData.formula}</span>` :
        '';

      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${item.fert.name}
            ${formulaDisplay}
          </h4>
          <p style="margin: 10px 0 10px 38px;">
            <strong>${i18n.t('amountLabel')}</strong> ${i18n.formatNumber(item.fert.grams.toFixed(2))} ${i18n.t('gramsUnit')}<br>
            <strong>${i18n.t('molarMassLabel')}</strong> ${i18n.formatNumber(item.ionData.molarMass)} g/mol<br>
            <strong>${i18n.t('molesLabel')}</strong> ${i18n.formatNumber(item.fert.grams.toFixed(2))} ÷ ${i18n.formatNumber(item.ionData.molarMass)} = <strong>${i18n.formatNumber(item.moles.toFixed(4))} mol</strong>
          </p>
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr><th>${i18n.t('ionHeader')}</th><th>${i18n.t('typeHeader')}</th><th>${i18n.t('calculationHeader')}</th><th>meq/L</th></tr>
              </thead>
              <tbody>
      `;

      item.ions.forEach(ionInfo => {
        const typeColor = ionInfo.type === 'cation' ? '#28a745' : '#dc3545';
        content += `
          <tr>
            <td data-label="Ion"><strong>${ionInfo.ion}</strong></td>
            <td data-label="Type" style="color: ${typeColor};">${ionInfo.type}</td>
            <td data-label="${i18n.t('calculationHeader')}" style="font-family: monospace; font-size: 0.85em;">
              ${i18n.formatNumber(item.moles.toFixed(4))} × ${i18n.formatNumber(ionInfo.count)} × ${i18n.formatNumber(ionInfo.charge)} × ${i18n.formatNumber(1000)} ÷ ${i18n.formatNumber(volume)}
            </td>
            <td data-label="${i18n.t('meqLHeader')}"><strong>${i18n.formatNumber(ionInfo.meq.toFixed(2))}</strong></td>
          </tr>
        `;
      });

      content += `</tbody></table></div></div>`;
    });

    content += `</div>`;

    // Results summary - using unified status helper
    const { statusColor, statusText } = getIonBalanceStatus(imbalance, false);

    // Final Results - using reusable function (without calculation explanation)
    content += renderFinalIonBalanceResults(totalCations, totalAnions, imbalance, statusColor, statusText, 'finalResults', false, false);
  }

  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">${i18n.t('interpretingResults')}</h3>
      <ul style="line-height: 1.8;">
        <li><strong>${i18n.t('imbalanceLessThan10')}</strong> ${i18n.t('imbalanceLessThan10Desc')}</li>
        <li><strong>${i18n.t('imbalance10To20')}</strong> ${i18n.t('imbalance10To20Desc')}</li>
        <li><strong>${i18n.t('imbalanceOver20')}</strong> ${i18n.t('imbalanceOver20Desc')}</li>
      </ul>
    </div>
  `;

  return content;
}

// ==========================================
// Copy Results Functions (WhatsApp Friendly)
// ==========================================

// Helper function to copy text to clipboard and show feedback
async function copyToClipboard(text, button) {
  try {
    await navigator.clipboard.writeText(text);

    // Show feedback
    const originalText = button.innerHTML;
    button.classList.add('copied');
    button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
      Copied!
    `;

    setTimeout(() => {
      button.classList.remove('copied');
      button.innerHTML = originalText;
    }, 2000);
  } catch (err) {
    console.error('Failed to copy:', err);
    alert(i18n.t('alertCopyFailedTryAgain'));
  }
}

// Copy Grams to PPM results (Tab 1)
function copyGramsToPPMResults() {
  if (!lastGramsToPPMCalculation) {
    alert(i18n.t('alertRunCalculationFirst'));
    return;
  }

  const { activeFertilizers, volume, results, ecData, ionBalance, ratios } = lastGramsToPPMCalculation;

  let text = `*${i18n.t('shareTitle')}*\n`;
  text += `━━━━━━━━━━━━━━━━━━━━━\n\n`;

  // Fertilizers used
  text += `*${i18n.t('shareFertilizersUsed')}* ${i18n.t('shareSolutionVolume', {volume: i18n.formatNumber(volume)})}\n`;
  activeFertilizers.forEach(fert => {
    text += `• ${fert.name}: *${i18n.formatNumber(fert.grams.toFixed(2))}g*\n`;
  });
  text += `\n`;

  // PPM Results
  text += `*${i18n.t('shareNutrientConcentrations')}*\n`;

  const displayOrder = [
    { key: 'N_total', label: i18n.formatNutrientLabel('N_total') },
    { key: 'N_NO3', label: i18n.formatNutrientLabel('N_NO3') },
    { key: 'N_NH4', label: i18n.formatNutrientLabel('N_NH4') },
    { key: 'P', label: i18n.formatNutrientLabel('P') },
    { key: 'K', label: i18n.formatNutrientLabel('K') },
    { key: 'Ca', label: i18n.formatNutrientLabel('Ca') },
    { key: 'Mg', label: i18n.formatNutrientLabel('Mg') },
    { key: 'S', label: i18n.formatNutrientLabel('S') },
    { key: 'Fe', label: i18n.formatNutrientLabel('Fe') },
    { key: 'Mn', label: i18n.formatNutrientLabel('Mn') },
    { key: 'Zn', label: i18n.formatNutrientLabel('Zn') },
    { key: 'B', label: i18n.formatNutrientLabel('B') },
    { key: 'Cu', label: i18n.formatNutrientLabel('Cu') },
    { key: 'Mo', label: i18n.formatNutrientLabel('Mo') }
  ];

  displayOrder.forEach(item => {
    if (results[item.key] !== undefined && results[item.key] > 0.01) {
      text += `• ${item.label}: *${i18n.formatNumber(results[item.key].toFixed(2))} ppm*\n`;
    }
  });
  text += `\n`;

  // Ion Balance
  if (ionBalance) {
    text += `*⚖️ ${i18n.t('ionBalance')}*\n`;
    text += `• ${i18n.t('cations')}: *${i18n.formatNumber(ionBalance.totalCations.toFixed(2))} ${i18n.t('meqPerLiter')}*\n`;
    text += `• ${i18n.t('anions')}: *${i18n.formatNumber(ionBalance.totalAnions.toFixed(2))} ${i18n.t('meqPerLiter')}*\n`;
    text += `• ${i18n.t('imbalance')}: *${i18n.formatNumber(ionBalance.imbalance.toFixed(1))}%* (${ionBalance.statusText})\n`;
    text += `\n`;
  }

  // EC Prediction
  if (ecData && ecData.ec) {
    text += `*⚡ ${i18n.t('ecPrediction')}*\n`;
    text += `• ${i18n.t('ecLabel')} *${i18n.formatNumber(ecData.ec.toFixed(2))} ${i18n.t('mScmUnit')}*\n`;
    text += `\n`;
  }

  // Key Ratios
  if (ratios && ratios.length > 0) {
    text += `*${i18n.t('shareKeyRatios')}*\n`;
    ratios.slice(0, 4).forEach(ratio => {
      text += `• ${ratio.name}: *${ratio.ratio}*\n`;
    });
    text += `\n`;
  }

  text += `━━━━━━━━━━━━━━━━━━━━━\n`;
  text += `_${i18n.t('shareGeneratedBy')}_`;

  const button = event.target.closest('.copy-btn');
  copyToClipboard(text, button);
}

// Copy PPM to Grams results (Tab 2 - Formula Builder)
function copyPPMToGramsResults() {
  if (!lastFormulaCalculation) {
    alert(i18n.t('alertRunCalculationFirst'));
    return;
  }

  const { result, targets, volume, mode } = lastFormulaCalculation;

  let text = `*${i18n.t('shareFormulaBuilderTitle')}*\n`;
  text += `━━━━━━━━━━━━━━━━━━━━━\n\n`;

  // Target values
  text += `*${i18n.t('shareTargetPpmValues')}*\n`;
  const targetLabels = mode === 'elemental'
    ? { N: 'N', P: 'P', K: 'K', Ca: 'Ca', Mg: 'Mg', S: 'S' }
    : { N: 'N', P: 'P₂O₅', K: 'K₂O', Ca: 'Ca', Mg: 'Mg', S: 'S' };

  Object.entries(targets).forEach(([key, value]) => {
    if (value > 0) {
      const label = targetLabels[key] || key;
      text += `${i18n.t('shareLabelValuePpm', {label: label, value: i18n.formatNumber(value)})}\n`;
    }
  });
  text += `\n`;

  // Fertilizers to add
  text += `*${i18n.t('shareFertilizersToAddVolume', {volume: i18n.formatNumber(volume)})}*\n`;
  const activeFertilizers = Object.entries(result.formula)
    .filter(([fertId, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { name: fert ? fert.name : fertId, grams };
    });

  if (activeFertilizers.length === 0) {
    text += `_${i18n.t('shareNoSuitableFormula')}_\n`;
  } else {
    activeFertilizers.forEach(fert => {
      text += `${i18n.t('shareFertilizerGrams', {name: fert.name, grams: i18n.formatNumber(fert.grams.toFixed(2))})}\n`;
    });
  }
  text += `\n`;

  // Achieved values
  text += `*${i18n.t('shareAchievedPpm')}*\n`;
  const achievedOrder = mode === 'elemental'
    ? [
        { key: 'N_total', label: 'N' },
        { key: 'P', label: 'P' },
        { key: 'K', label: 'K' },
        { key: 'Ca', label: 'Ca' },
        { key: 'Mg', label: 'Mg' },
        { key: 'S', label: 'S' }
      ]
    : [
        { key: 'N_total', label: 'N' },
        { key: 'P2O5', label: 'P₂O₅' },
        { key: 'K2O', label: 'K₂O' },
        { key: 'Ca', label: 'Ca' },
        { key: 'Mg', label: 'Mg' },
        { key: 'S', label: 'S' }
      ];

  achievedOrder.forEach(item => {
    const value = result.achieved[item.key];
    if (value !== undefined && value > 0.01) {
      text += `${i18n.t('shareLabelValuePpm', {label: item.label, value: i18n.formatNumber(value.toFixed(1))})}\n`;
    }
  });
  text += `\n`;

  // Ion Balance
  const ionBalance = calculateIonBalanceForFormula(
    Object.entries(result.formula).map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { ...fert, grams };
    }),
    volume
  );

  if (ionBalance) {
    text += `*${i18n.t('shareIonBalance')}*\n`;
    text += `${i18n.t('shareCationsValue', {value: i18n.formatNumber(ionBalance.totalCations.toFixed(2))})}\n`;
    text += `${i18n.t('shareAnionsValue', {value: i18n.formatNumber(ionBalance.totalAnions.toFixed(2))})}\n`;
    text += `${i18n.t('shareImbalanceValue', {value: i18n.formatNumber(ionBalance.imbalance.toFixed(1)), status: ionBalance.statusText})}\n`;
    text += `\n`;
  }

  text += `━━━━━━━━━━━━━━━━━━━━━\n`;
  text += `_${i18n.t('shareGeneratedBy')}_`;

  const button = event.target.closest('.copy-btn');
  copyToClipboard(text, button);
}

// Copy NPK Ratio to Grams results (Tab 3 - Reverse Calculator)
function copyNPKRatioResults() {
  if (!lastReverseCalculation) {
    alert(i18n.t('alertRunCalculationFirst'));
    return;
  }

  const { result, targets, volume } = lastReverseCalculation;
  const calculationMode = document.getElementById('reverse-calculation-mode').value;

  let text = `*${i18n.t('shareNpkRatioTitle')}*\n`;
  text += `━━━━━━━━━━━━━━━━━━━━━\n\n`;

  // Target ratios
  text += `*${i18n.t('shareTargetRatios')}*\n`;
  const targetLabels = calculationMode === 'elemental'
    ? { N: 'N', P: 'P', K: 'K', Ca: 'Ca', Mg: 'Mg', S: 'S' }
    : { N: 'N', P: 'P₂O₅', K: 'K₂O', Ca: 'Ca', Mg: 'Mg', S: 'S' };

  const targetParts = [];
  ['N', 'P', 'K', 'Ca', 'Mg', 'S'].forEach(key => {
    if (targets[key] > 0) {
      const label = targetLabels[key] || key;
      targetParts.push(`${label}:${i18n.formatNumber(targets[key])}`);
    }
  });
  text += `${i18n.t('shareRatioValue', {ratio: targetParts.join(' : ')})}\n\n`;

  // Fertilizers to add
  text += `*${i18n.t('shareFertilizersToAddVolume', {volume: i18n.formatNumber(volume)})}*\n`;
  const activeFertilizers = Object.entries(result.formula)
    .filter(([fertId, grams]) => grams > 0.01)
    .map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { name: fert ? fert.name : fertId, grams };
    });

  if (activeFertilizers.length === 0) {
    text += `_${i18n.t('shareNoSuitableFormula')}_\n`;
  } else {
    activeFertilizers.forEach(fert => {
      text += `${i18n.t('shareFertilizerGrams', {name: fert.name, grams: i18n.formatNumber(fert.grams.toFixed(2))})}\n`;
    });
  }
  text += `\n`;

  // Achieved PPM values
  text += `*${i18n.t('shareAchievedPpm')}*\n`;
  const achievedOrder = calculationMode === 'elemental'
    ? [
        { key: 'N_total', label: 'N' },
        { key: 'P', label: 'P' },
        { key: 'K', label: 'K' },
        { key: 'Ca', label: 'Ca' },
        { key: 'Mg', label: 'Mg' },
        { key: 'S', label: 'S' }
      ]
    : [
        { key: 'N_total', label: 'N' },
        { key: 'P2O5', label: 'P₂O₅' },
        { key: 'K2O', label: 'K₂O' },
        { key: 'Ca', label: 'Ca' },
        { key: 'Mg', label: 'Mg' },
        { key: 'S', label: 'S' }
      ];

  achievedOrder.forEach(item => {
    const value = result.achieved[item.key];
    if (value !== undefined && value > 0.01) {
      text += `${i18n.t('shareLabelValuePpm', {label: item.label, value: i18n.formatNumber(value.toFixed(1))})}\n`;
    }
  });
  text += `\n`;

  // Nitrogen breakdown
  if (result.achieved.N_NO3 > 0 || result.achieved.N_NH4 > 0) {
    text += `*${i18n.t('shareNitrogenForms')}*\n`;
    text += `${i18n.t('shareNo3N', {value: i18n.formatNumber(result.achieved.N_NO3.toFixed(1))})}\n`;
    text += `${i18n.t('shareNh4N', {value: i18n.formatNumber(result.achieved.N_NH4.toFixed(1))})}\n`;
    const nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;
    text += `${i18n.t('shareNh4Ratio', {value: i18n.formatNumber(nh4Percent.toFixed(0))})}\n`;
    text += `\n`;
  }

  // Ion Balance
  const ionBalance = calculateIonBalanceForFormula(
    Object.entries(result.formula).map(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      return { ...fert, grams };
    }),
    volume
  );

  if (ionBalance) {
    text += `*${i18n.t('shareIonBalance')}*\n`;
    text += `${i18n.t('shareCationsValue', {value: i18n.formatNumber(ionBalance.totalCations.toFixed(2))})}\n`;
    text += `${i18n.t('shareAnionsValue', {value: i18n.formatNumber(ionBalance.totalAnions.toFixed(2))})}\n`;
    text += `${i18n.t('shareImbalanceValue', {value: i18n.formatNumber(ionBalance.imbalance.toFixed(1)), status: ionBalance.statusText})}\n`;
    text += `\n`;
  }

  text += `━━━━━━━━━━━━━━━━━━━━━\n`;
  text += `_${i18n.t('shareGeneratedBy')}_`;

  const button = event.target.closest('.copy-btn');
  copyToClipboard(text, button);
}

// Initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
