---
layout: default
title: Fertilizer PPM Calculator
permalink: /fertilizer-calculator/
---

<link rel="stylesheet" href="{{ '/assets/css/fertilizer-calculator.css' | relative_url }}">
<style>[v-cloak] { display: none !important; }</style>

{% raw %}
<div class="calculator-container" v-cloak>
  <!-- Language Selection Splash (shown on first visit) -->
  <div class="language-splash-overlay" :class="{ active: showLanguageSplash }">
    <div class="language-splash-modal">
      <h2>Select Your Language</h2>
      <p class="cycling-subtitle">
        <transition name="fade" mode="out-in">
          <span :key="currentSubtitleIndex">{{ currentSubtitle }}</span>
        </transition>
      </p>
      <div class="language-splash-options">
        <button class="language-splash-btn" @click="selectLanguageFromSplash('en')">
          <span class="lang-native">English</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('gu')">
          <span class="lang-native">ગુજરાતી</span>
          <span class="lang-english">(Gujarati)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('hi')">
          <span class="lang-native">हिन्दी</span>
          <span class="lang-english">(Hindi)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('kn')">
          <span class="lang-native">ಕನ್ನಡ</span>
          <span class="lang-english">(Kannada)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('te')">
          <span class="lang-native">తెలుగు</span>
          <span class="lang-english">(Telugu)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('mr')">
          <span class="lang-native">मराठी</span>
          <span class="lang-english">(Marathi)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('bn-sadhu')">
          <span class="lang-native">বাংলা - সাধু</span>
          <span class="lang-english">(Bengali Sadhu)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('bn')">
          <span class="lang-native">বাংলা - চলিত</span>
          <span class="lang-english">(Bengali Cholito)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('ta')">
          <span class="lang-native">தமிழ்</span>
          <span class="lang-english">(Tamil)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('ml')">
          <span class="lang-native">മലയാളം</span>
          <span class="lang-english">(Malayalam)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('pa')">
          <span class="lang-native">ਪੰਜਾਬੀ</span>
          <span class="lang-english">(Punjabi)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('or')">
          <span class="lang-native">ଓଡ଼ିଆ</span>
          <span class="lang-english">(Odia)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('as')">
          <span class="lang-native">অসমীয়া</span>
          <span class="lang-english">(Assamese)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('bho')">
          <span class="lang-native">भोजपुरी</span>
          <span class="lang-english">(Bhojpuri)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('mai')">
          <span class="lang-native">मैथिली</span>
          <span class="lang-english">(Maithili)</span>
        </button>
        <button class="language-splash-btn" @click="selectLanguageFromSplash('awa')">
          <span class="lang-native">अवधी</span>
          <span class="lang-english">(Awadhi)</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Bar Overlay (Vue-powered) - must be inside Vue mount container -->
  <div class="progress-overlay" :class="{ active: progressState.show }">
    <div class="progress-container">
      <h3>{{ progressState.title }}</h3>
      <div class="progress-bar-wrapper">
        <div class="progress-bar" :class="{ indeterminate: progressState.indeterminate }" :style="{ width: progressState.percent + '%' }"></div>
      </div>
      <p class="progress-text">{{ progressState.message }}</p>
      <button class="progress-cancel-btn" @click="progressBar.cancel()">{{ i18n.t('cancel') }}</button>
    </div>
  </div>
  <!-- Vue-powered Unified Modal (placed at top for proper rendering) -->
  <div v-if="activeModal" class="modal-overlay active" style="display: flex !important;" @click="closeModal">
    <div class="modal-content" @click.stop>
      <div class="modal-header">
        <h2>{{ modalTitle }}</h2>
        <button class="modal-close" @click="closeModal">&times;</button>
      </div>
      <div class="modal-body">

        <!-- PPM EXPLANATION MODAL -->
        <template v-if="activeModal === 'ppm'">
          <!-- What is PPM explanation -->
          <div class="explanation-section">
            <h3>{{ i18n.t('whatIsPpm') }}</h3>
            <p v-html="i18n.t('ppmModalDescription1')"></p>
            <p v-html="i18n.t('ppmModalDescription2')"></p>
          </div>

          <!-- The Formula -->
          <div class="explanation-section" style="background: #f0f7ff; border-left-color: #2196f3;">
            <h3 style="color: #1976d2;">{{ i18n.t('theBasicFormula') }}</h3>
            <div class="formula-box" style="margin: 15px 0; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #bbdefb;">
              <div class="formula" style="font-family: monospace; font-size: 1.1em;">{{ i18n.t('ppmFormulaEquation') }}</div>
              <div style="font-size: 0.9em; color: #666; margin-top: 8px;">{{ i18n.t('ppmFormulaDescription') }}</div>
            </div>
            <p style="margin-top: 15px;">{{ i18n.t('breakDownEachPart') }}</p>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li v-html="i18n.t('formulaPartGrams')"></li>
              <li v-html="i18n.t('formulaPart1000')"></li>
              <li v-html="i18n.t('formulaPartPercentage')"></li>
              <li v-html="i18n.t('formulaPartLiters')"></li>
            </ul>
          </div>

          <div v-if="modalData.activeFertilizers.length === 0" class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
            <h3 style="color: #856404;">{{ i18n.t('noCalculationYet') }}</h3>
            <p>{{ i18n.t('addFertilizersToSeeBreakdown') }}</p>
            <p style="color: #856404; margin-top: 10px;">{{ i18n.t('calculatorShowsStepByStep') }}</p>
          </div>
          <template v-else>
            <!-- Current solution info -->
            <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
              <h3 style="color: #17a2b8;">{{ i18n.t('yourCurrentCalculation') }}</h3>
              <p><strong>{{ i18n.t('solutionVolumeLabel') }}</strong> {{ formatNumber(modalData.volume) }} {{ i18n.t('litersUnit') }}</p>
              <p><strong>{{ i18n.t('fertilizersUsedLabel') }}</strong> {{ modalData.activeFertilizers.length }}</p>
            </div>

            <!-- Step-by-step per-fertilizer PPM breakdown -->
            <div class="explanation-section">
              <h3>{{ i18n.t('stepByStepBreakdown') }}</h3>
              <p style="color: #666; margin-bottom: 15px;">{{ i18n.t('howEachFertilizerContributesToPpm') }}</p>

              <template v-for="(fert, index) in modalData.activeFertilizers" :key="fert?.id || index">
                <div v-if="fert && fert.id" class="step" style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 15px 0; color: #007bff; display: flex; align-items: center; gap: 10px;">
                  <span class="step-number" style="background: #007bff; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">{{ index + 1 }}</span>
                  {{ i18n.getFertilizerName(fert) }}
                </h4>

                <!-- Basic info -->
                <div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 6px;">
                  <p style="margin: 0;"><strong>{{ i18n.t('amountUsedLabel') }}</strong> {{ formatNumber(fert.grams) }} {{ i18n.t('gramsUnit') }}</p>
                </div>

                <!-- Nutrient contributions with detailed calculations -->
                <div v-if="getNutrientContributions(fert).length > 0" style="margin-top: 10px;">
                  <p style="font-weight: bold; margin-bottom: 10px; color: #555;">{{ i18n.t('nutrientPpmValues') }}:</p>
                  <div style="display: grid; gap: 10px;">
                    <template v-for="nutrient in getNutrientContributions(fert)" :key="nutrient?.key || Math.random()">
                      <div v-if="nutrient && nutrient.key"
                         style="background: #e8f5e9; padding: 12px 15px; border-radius: 8px; border-left: 3px solid #4caf50;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; font-size: 1.1em; color: #2e7d32;">{{ nutrient.name }}</span>
                        <span style="font-weight: bold; font-size: 1.2em; color: #2e7d32;">{{ formatNumber(nutrient.ppm, 2) }} ppm</span>
                      </div>
                      <div style="font-family: monospace; font-size: 0.85em; color: #666; background: rgba(255,255,255,0.7); padding: 8px; border-radius: 4px;">
                        {{ formatNumber(fert.grams) }} g × {{ formatNumber(1000) }} × ({{ formatNumber(nutrient.percent, 2) }}% ÷ {{ formatNumber(100) }}) ÷ {{ formatNumber(modalData.volume) }} {{ i18n.t('litersUnit') }} = {{ formatNumber(nutrient.ppm, 2) }} ppm
                      </div>
                    </div>
                    </template>
                  </div>
                </div>
              </div>
              </template>
            </div>

            <!-- Oxide conversions info -->
            <div v-if="hasAnyOxides()" class="explanation-section" style="background: #fff3e0; border-left-color: #ff9800;">
              <h3 style="color: #e65100;">{{ i18n.t('aboutOxideConversions') }}</h3>
              <p v-html="i18n.t('oxideConversionsExplanation')"></p>
              <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                <thead>
                  <tr style="background: #ffe0b2;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">{{ i18n.t('oxideFormHeader') }}</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">{{ i18n.t('elementalFormHeader') }}</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">{{ i18n.t('conversionFactorHeader') }}</th>
                  </tr>
                </thead>
                <tbody>
                  <template v-for="conv in oxideConversions" :key="conv.key">
                    <tr v-if="hasOxide(conv.key)" style="border-bottom: 1px solid #ffe0b2;">
                      <td style="padding: 10px;">{{ conv.oxideName }}</td>
                      <td style="padding: 10px;">{{ conv.elementalName }}</td>
                      <td style="padding: 10px; font-family: monospace;">× {{ conv.factor }}</td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Quick tips -->
            <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
              <h3 style="color: #28a745;">{{ i18n.t('quickTips') }}</h3>
              <ul style="line-height: 1.8;">
                <li>{{ i18n.t('tip1PpmEquals') }}</li>
                <li>{{ i18n.t('tip2StartLower') }}</li>
                <li>{{ i18n.t('tip3DifferentPlants') }}</li>
                <li>{{ i18n.t('tip4BalanceIsKey') }}</li>
              </ul>
            </div>
          </template>
        </template>

        <!-- ION BALANCE EXPLANATION MODAL -->
        <template v-if="activeModal === 'ion-balance'">
          <!-- What is Ion Balance explanation -->
          <div class="explanation-section">
            <h3>{{ i18n.t('whatIsIonBalance') }}</h3>
            <p v-html="i18n.t('ionBalanceExplanation')"></p>
            <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
              <li v-html="i18n.t('cationsDescription')"></li>
              <li v-html="i18n.t('anionsDescription')"></li>
            </ul>
            <p v-html="i18n.t('ionBalanceImportance')"></p>
          </div>

          <!-- meq/L explanation -->
          <div class="explanation-section" style="background: #f0f7ff; border-left-color: #2196f3;">
            <h3 style="color: #1976d2;">{{ i18n.t('understandingMeqL') }}</h3>
            <p v-html="i18n.t('meqLDescription')"></p>
            <p style="font-style: italic; color: #666;">{{ i18n.t('meqLAnalogy') }}</p>
            <div class="formula-box" style="margin: 15px 0; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #bbdefb;">
              <div class="formula" style="font-family: monospace; font-size: 1.1em;">{{ i18n.t('meqLFormula') }}</div>
              <div style="font-size: 0.9em; color: #666; margin-top: 8px;">{{ i18n.t('meqLFormulaDesc') }}</div>
            </div>
          </div>

          <div v-if="modalData.activeFertilizers.length === 0" class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
            <h3 style="color: #856404;">{{ i18n.t('noCalculationYet') }}</h3>
            <p>{{ i18n.t('addFertilizersForIonBalance') }}</p>
          </div>
          <template v-else>
            <!-- Current solution info -->
            <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
              <h3 style="color: #17a2b8;">{{ i18n.t('yourCurrentSolution') }}</h3>
              <p><strong>{{ i18n.t('solutionVolumeLabel') }}</strong> {{ formatNumber(modalData.volume) }} {{ i18n.t('litersUnit') }}</p>
              <p><strong>{{ i18n.t('fertilizersUsedLabel') }}</strong> {{ modalData.activeFertilizers.length }}</p>
            </div>

            <!-- Step-by-step per-fertilizer ion breakdown with detailed calculations -->
            <div class="explanation-section">
              <h3>{{ i18n.t('stepByStepIonCalculation') }}</h3>
              <p style="color: #666; margin-bottom: 15px;">{{ i18n.t('howEachFertilizerContributesIons') }}</p>

              <template v-for="(fert, index) in modalData.activeFertilizers" :key="fert?.id || index">
                <div v-if="fert && fert.id" class="step" style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 15px 0; color: #007bff; display: flex; align-items: center; gap: 10px;">
                  <span class="step-number" style="background: #007bff; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">{{ index + 1 }}</span>
                  {{ i18n.getFertilizerName(fert) }}
                </h4>

                <!-- Basic info -->
                <div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 6px;">
                  <p style="margin: 0 0 8px 0;"><strong>{{ i18n.t('amountUsedLabel') }}</strong> {{ formatNumber(fert.grams) }} {{ i18n.t('gramsUnit') }}</p>
                  <p v-if="getIonDataForFert(fert)" style="margin: 0 0 8px 0;"><strong>{{ i18n.t('molarMassLabel') }}</strong> {{ formatNumber(getIonDataForFert(fert).molarMass, 2) }} g/mol</p>
                  <p v-if="getIonDataForFert(fert)" style="margin: 0; font-family: monospace; background: #e3f2fd; padding: 8px 12px; border-radius: 4px;">
                    <strong>{{ i18n.t('molesLabel') }}</strong> {{ formatNumber(fert.grams) }} g ÷ {{ formatNumber(getIonDataForFert(fert).molarMass, 2) }} g/mol = <strong>{{ formatNumber(fert.grams / getIonDataForFert(fert).molarMass, 6) }} mol</strong>
                  </p>
                </div>

                <!-- Ion contributions with detailed calculation -->
                <div v-if="getIonDataForFert(fert)" style="margin-top: 10px;">
                  <p style="font-weight: bold; margin-bottom: 10px; color: #555;">Ion Contributions:</p>
                  <div style="display: grid; gap: 10px;">
                    <div v-for="ionInfo in getIonDataForFert(fert).ions" :key="ionInfo.ion"
                         :style="{
                           background: ionInfo.type === 'cation' ? '#e3f2fd' : '#fce4ec',
                           padding: '12px 15px',
                           borderRadius: '8px',
                           borderLeft: ionInfo.type === 'cation' ? '3px solid #1565c0' : '3px solid #c2185b'
                         }">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span :style="{ fontWeight: 'bold', fontSize: '1.1em', color: ionInfo.type === 'cation' ? '#1565c0' : '#c2185b' }">
                          {{ ionInfo.ion }} <span style="font-size: 0.85em; font-weight: normal;">({{ ionInfo.type === 'cation' ? '+' : '-' }})</span>
                        </span>
                        <span style="font-weight: bold; font-size: 1.2em;" :style="{ color: ionInfo.type === 'cation' ? '#1565c0' : '#c2185b' }">
                          {{ formatNumber(calculateIonMeq(fert, ionInfo), 3) }} meq/L
                        </span>
                      </div>
                      <div style="font-family: monospace; font-size: 0.85em; color: #666; background: rgba(255,255,255,0.7); padding: 8px; border-radius: 4px;">
                        {{ formatNumber(fert.grams / getIonDataForFert(fert).molarMass, 6) }} mol × {{ formatNumber(ionInfo.count) }} {{ i18n.t('ionsUnit') }} × {{ formatNumber(ionInfo.charge) }} {{ i18n.t('chargeUnit') }} × {{ formatNumber(1000) }} ÷ {{ formatNumber(modalData.volume) }} {{ i18n.t('litersUnit') }} = {{ formatNumber(calculateIonMeq(fert, ionInfo), 3) }} meq/L
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Fertilizer subtotal -->
                <div v-if="getIonDataForFert(fert)" style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 6px; display: flex; justify-content: space-between;">
                  <span>
                    <strong style="color: #28a745;">Cations subtotal:</strong>
                    {{ formatNumber(calculateFertCationTotal(fert), 3) }} meq/L
                  </span>
                  <span>
                    <strong style="color: #dc3545;">Anions subtotal:</strong>
                    {{ formatNumber(calculateFertAnionTotal(fert), 3) }} meq/L
                  </span>
                </div>
              </div>
              </template>
            </div>

            <!-- Ion totals breakdown -->
            <div v-if="modalData.ionBalance && modalData.ionBalance.ionDetails" class="explanation-section">
              <h3>{{ i18n.t('nutrientTotalsSummary') }}</h3>
              <p style="color: #666; margin-bottom: 15px;">{{ i18n.t('whenNutrientsFromMultiple') }}</p>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Cations column -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #1565c0;">{{ i18n.t('cations') }} (+)</h4>
                  <template v-for="(data, ion) in modalData.ionBalance.ionDetails" :key="ion">
                    <div v-if="data.type === 'cation'" style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #bbdefb;">
                      <span>{{ ion }}</span>
                      <strong>{{ formatNumber(data.meq, 3) }} meq/L</strong>
                    </div>
                  </template>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 5px; font-weight: bold; color: #1565c0; border-top: 2px solid #1565c0;">
                    <span>{{ i18n.t('totalCations') }}</span>
                    <span>{{ formatNumber(modalData.ionBalance.totalCations, 3) }} meq/L</span>
                  </div>
                </div>
                <!-- Anions column -->
                <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #c2185b;">{{ i18n.t('anions') }} (-)</h4>
                  <template v-for="(data, ion) in modalData.ionBalance.ionDetails" :key="ion">
                    <div v-if="data.type === 'anion'" style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f8bbd9;">
                      <span>{{ ion }}</span>
                      <strong>{{ formatNumber(data.meq, 3) }} meq/L</strong>
                    </div>
                  </template>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 5px; font-weight: bold; color: #c2185b; border-top: 2px solid #c2185b;">
                    <span>{{ i18n.t('totalAnions') }}</span>
                    <span>{{ formatNumber(modalData.ionBalance.totalAnions, 3) }} meq/L</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Final Summary with imbalance calculation -->
            <div v-if="modalData.ionBalance" class="explanation-section" style="background: #f8f9fa; border-left-color: #6c757d;">
              <h3>{{ i18n.t('finalIonBalanceResults') }}</h3>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin: 15px 0;">
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('totalCationsPlus') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ formatNumber(modalData.ionBalance.totalCations, 3) }} meq/L</div>
                </div>
                <div style="font-size: 1.5em; color: #666;">vs</div>
                <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('totalAnionsMinus') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ formatNumber(modalData.ionBalance.totalAnions, 3) }} meq/L</div>
                </div>
                <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: modalData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + modalData.ionBalance.statusColor }">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalancePercentage') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: modalData.ionBalance.statusColor }">{{ formatNumber(modalData.ionBalance.imbalance, 1) }}%</div>
                  <div style="font-size: 0.85em;" :style="{ color: modalData.ionBalance.statusColor }">{{ modalData.ionBalance.statusText }}</div>
                </div>
              </div>

              <!-- Imbalance calculation formula -->
              <div style="margin-top: 15px; padding: 12px; background: #fff; border-radius: 6px; border: 1px solid #dee2e6;">
                <p style="margin: 0 0 8px 0; font-weight: bold; color: #495057;">{{ i18n.t('howWeCalculatedImbalance') }}</p>
                <div style="font-family: monospace; font-size: 0.9em; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                  |{{ formatNumber(modalData.ionBalance.totalCations, 3) }} - {{ formatNumber(modalData.ionBalance.totalAnions, 3) }}| ÷ (({{ formatNumber(modalData.ionBalance.totalCations, 3) }} + {{ formatNumber(modalData.ionBalance.totalAnions, 3) }}) ÷ 2) × 100 = <strong>{{ formatNumber(modalData.ionBalance.imbalance, 1) }}%</strong>
                </div>
              </div>
            </div>

            <!-- Interpretation guide -->
            <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
              <h3 style="color: #28a745;">{{ i18n.t('interpretingResults') }}</h3>
              <ul style="line-height: 1.8;">
                <li><strong>{{ i18n.t('imbalanceLessThan10') }}</strong> {{ i18n.t('imbalanceLessThan10Desc') }}</li>
                <li><strong>{{ i18n.t('imbalance10To20') }}</strong> {{ i18n.t('imbalance10To20Desc') }}</li>
                <li><strong>{{ i18n.t('imbalanceOver20') }}</strong> {{ i18n.t('imbalanceOver20Desc') }}</li>
              </ul>
              <p style="margin-top: 15px; color: #155724;"><strong>{{ i18n.t('whyDoesThisMatter') }}</strong> {{ i18n.t('whyDoesThisMatterExplanation') }}</p>
            </div>
          </template>
        </template>

        <!-- EC EXPLANATION MODAL -->
        <template v-if="activeModal === 'ec'">
          <!-- What is EC explanation -->
          <div class="explanation-section">
            <h3>{{ i18n.t('whatIsEc') }}</h3>
            <p v-html="i18n.t('ecModalDescription1')"></p>
            <p v-html="i18n.t('ecModalDescription2')"></p>
          </div>

          <!-- The Formula -->
          <div class="explanation-section" style="background: #f0f7ff; border-left-color: #2196f3;">
            <h3 style="color: #1976d2;">{{ i18n.t('ecCalculationMethod') }}</h3>
            <div class="formula-box" style="margin: 15px 0; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #bbdefb;">
              <div class="formula" style="font-family: monospace; font-size: 1.1em;">{{ i18n.t('ecFormulaEquation') }}</div>
              <div style="font-size: 0.9em; color: #666; margin-top: 8px;">{{ i18n.t('ecFormulaDescription') }}</div>
            </div>
            <p style="margin-top: 15px;" v-html="i18n.t('ecFormulaExplanation')"></p>
          </div>

          <!-- Lambda Reference Table -->
          <div class="explanation-section" style="background: #e3f2fd; border-left-color: #1976d2;">
            <h3 style="color: #1565c0;">{{ i18n.t('lambdaReferenceTable') }}</h3>
            <p style="color: #666; margin-bottom: 15px;">{{ i18n.t('lambdaTableDescription') }}</p>
            <div class="lambda-tables-grid">
              <!-- Cations -->
              <div>
                <h4 style="color: #1976d2; margin: 0 0 10px 0;">{{ i18n.t('cations') }} (+)</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                  <thead>
                    <tr style="background: #bbdefb;">
                      <th style="text-align: left; padding: 6px;">{{ i18n.t('ionHeader') }}</th>
                      <th style="text-align: right; padding: 6px;">{{ i18n.t('molarMassHeader') }}</th>
                      <th style="text-align: right; padding: 6px;">λ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">K⁺ ({{ i18n.t('potassium') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(39.098) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(73.5) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">NH₄⁺ ({{ i18n.t('ammonium') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(14.007) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(73.5) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Ca²⁺ ({{ i18n.t('calciumSimple') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(40.078) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(119.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Mg²⁺ ({{ i18n.t('magnesiumSimple') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(24.305) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(106.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Fe²⁺ ({{ i18n.t('ironII') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(55.845) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(108.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Fe³⁺ ({{ i18n.t('ironIII') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(55.845) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(204.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Mn²⁺ ({{ i18n.t('manganese') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(54.938) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(107.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #e3f2fd;"><td style="padding: 4px 6px;">Zn²⁺ ({{ i18n.t('zinc') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(65.38) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(105.6) }}</td></tr>
                    <tr><td style="padding: 4px 6px;">Cu²⁺ ({{ i18n.t('copper') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(63.546) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(107.2) }}</td></tr>
                  </tbody>
                </table>
              </div>
              <!-- Anions -->
              <div>
                <h4 style="color: #c2185b; margin: 0 0 10px 0;">{{ i18n.t('anions') }} (-)</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                  <thead>
                    <tr style="background: #fce4ec;">
                      <th style="text-align: left; padding: 6px;">{{ i18n.t('ionHeader') }}</th>
                      <th style="text-align: right; padding: 6px;">{{ i18n.t('molarMassHeader') }}</th>
                      <th style="text-align: right; padding: 6px;">λ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom: 1px solid #fce4ec;"><td style="padding: 4px 6px;">NO₃⁻ ({{ i18n.t('nitrate') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(14.007) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(71.5) }}</td></tr>
                    <tr style="border-bottom: 1px solid #fce4ec;"><td style="padding: 4px 6px;">Cl⁻ ({{ i18n.t('chloride') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(35.453) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(76.3) }}</td></tr>
                    <tr style="border-bottom: 1px solid #fce4ec;"><td style="padding: 4px 6px;">SO₄²⁻ ({{ i18n.t('sulfate') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(32.065) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(160.0) }}</td></tr>
                    <tr style="border-bottom: 1px solid #fce4ec;"><td style="padding: 4px 6px;">H₂PO₄⁻ ({{ i18n.t('dihydrogenPhosphate') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(30.974) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(33.5) }}</td></tr>
                    <tr style="border-bottom: 1px solid #fce4ec;"><td style="padding: 4px 6px;">HPO₄²⁻ ({{ i18n.t('hydrogenPhosphate') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(30.974) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(114.0) }}</td></tr>
                    <tr><td style="padding: 4px 6px;">HCO₃⁻ ({{ i18n.t('bicarbonate') }})</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(61.017) }}</td><td style="text-align: right; padding: 4px 6px;">{{ formatNumber(44.5) }}</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <p style="margin-top: 12px; font-size: 0.85em; color: #666;">{{ i18n.t('lambdaUnitsNote') }}</p>
          </div>

          <!-- EC Ranges -->
          <div class="explanation-section" style="background: #fff3e0; border-left-color: #ff9800;">
            <h3 style="color: #e65100;">{{ i18n.t('ecRangesTitle') }}</h3>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li><strong>&lt; 1.0 mS/cm:</strong> {{ i18n.t('ecRangeLow') }}</li>
              <li><strong>1.0 - 1.5 mS/cm:</strong> {{ i18n.t('ecRangeMild') }}</li>
              <li><strong>1.5 - 2.5 mS/cm:</strong> {{ i18n.t('ecRangeOptimal') }}</li>
              <li><strong>2.5 - 3.0 mS/cm:</strong> {{ i18n.t('ecRangeStrong') }}</li>
              <li><strong>&gt; 3.0 mS/cm:</strong> {{ i18n.t('ecRangeHigh') }}</li>
            </ul>
          </div>

          <!-- EC Breakdown Table -->
          <template v-if="modalData.ecContributions && Object.keys(modalData.ecContributions).length > 0">
            <div class="explanation-section" style="background: #e8f5e9; border-left-color: #4caf50;">
              <h3 style="color: #2e7d32;">{{ i18n.t('ecBreakdownByIon') }}</h3>
              <p style="color: #666; margin-bottom: 15px;">{{ i18n.t('ecBreakdownDescription') }}</p>

              <!-- Column explanations -->
              <div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
                <p style="margin: 0 0 8px 0;"><strong>{{ i18n.t('tableColumnsExplained') }}:</strong></p>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                  <li><strong>{{ i18n.t('ionHeader') }}</strong> - {{ i18n.t('ionColumnDesc') }}</li>
                  <li><strong>{{ i18n.t('concMmolLHeader') }}</strong> - {{ i18n.t('concColumnDesc') }}</li>
                  <li><strong>λ ({{ i18n.t('lambdaHeader') }})</strong> - {{ i18n.t('lambdaColumnDesc') }}</li>
                  <li><strong>{{ i18n.t('ecContribHeader') }}</strong> - {{ i18n.t('contribColumnDesc') }}</li>
                </ul>
              </div>

              <!-- How concentration is calculated -->
              <div style="background: #fff8e1; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                <p style="margin: 0 0 8px 0;"><strong>{{ i18n.t('howConcentrationCalculated') }}:</strong></p>
                <div class="formula-box" style="padding: 10px; background: #fff; border-radius: 4px; font-family: monospace; font-size: 0.9em; margin-bottom: 10px;">
                  {{ i18n.t('concentrationFormula') }}
                </div>
                <p style="margin: 0; font-size: 0.85em; color: #666;">{{ i18n.t('concentrationFormulaDesc') }}</p>
                <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #1976d2;"><strong>{{ i18n.t('ppmLearnMoreNote') }}</strong></p>
              </div>

              <div class="ec-breakdown-table-wrapper">
                <table class="ec-breakdown-table">
                  <thead>
                    <tr style="background: #c8e6c9; border-bottom: 2px solid #4caf50;">
                      <th style="text-align: left; padding: 8px;">{{ i18n.t('ionHeader') }}</th>
                      <th style="text-align: right; padding: 8px;">PPM</th>
                      <th class="calc-column" style="text-align: center; padding: 8px;">{{ i18n.t('concentrationCalcHeader') }}</th>
                      <th style="text-align: right; padding: 8px;">λ</th>
                      <th style="text-align: right; padding: 8px;">{{ i18n.t('ecContribHeader') }}</th>
                      <th style="text-align: right; padding: 8px;">%</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template v-for="(data, ion) in modalData.ecContributions" :key="ion">
                      <tr>
                        <td data-label="Ion"><strong>{{ ion }}</strong></td>
                        <td data-label="PPM">{{ data.ppm ? i18n.formatNumber(data.ppm.toFixed(2)) : '-' }}</td>
                        <td data-label="Concentration" class="calc-column">
                          <span v-if="data.ppm && data.molarMass">{{ i18n.formatNumber(data.ppm.toFixed(2)) }} ÷ {{ i18n.formatNumber(data.molarMass.toFixed(3)) }} = {{ i18n.formatNumber(data.concentration_mmolL.toFixed(3)) }}</span>
                          <span v-else>{{ i18n.formatNumber(data.concentration_mmolL.toFixed(3)) }}</span>
                        </td>
                        <td data-label="λ">{{ i18n.formatNumber(data.lambda) }}</td>
                        <td data-label="EC Contrib">{{ i18n.formatNumber(data.contribution_mS_cm.toFixed(4)) }}</td>
                        <td data-label="%">{{ i18n.formatNumber((data.contribution_mS_cm / modalData.rawEC * 100).toFixed(1)) }}%</td>
                      </tr>
                    </template>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4">{{ i18n.t('totalLabel') }}</td>
                      <td>{{ i18n.formatNumber(modalData.rawEC?.toFixed(4) || 0) }} mS/cm</td>
                      <td>{{ formatNumber(100) }}%</td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <!-- Calculation explanation -->
              <div style="margin-top: 15px; padding: 12px; background: #fff; border-radius: 6px;">
                <p style="margin: 0 0 8px 0;"><strong>{{ i18n.t('howEachRowCalculated') }}:</strong></p>
                <div class="formula-box" style="padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
                  {{ i18n.t('ecContribFormula') }}
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #666;">{{ i18n.t('ecContribFormulaDesc') }}</p>
              </div>

              <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                <p style="margin: 0;"><strong>{{ i18n.t('rawEcLabel') }}:</strong> {{ i18n.formatNumber(modalData.rawEC?.toFixed(3) || 0) }} mS/cm</p>
                <p style="margin: 5px 0 0 0;"><strong>{{ i18n.t('ionicStrength') }}:</strong> {{ i18n.formatNumber(modalData.ionicStrength?.toFixed(4) || 0) }} mol/L</p>
                <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #666;">{{ i18n.t('ionicStrengthCorrectionNote') }}</p>
              </div>
            </div>
          </template>

          <!-- Quick tips -->
          <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
            <h3 style="color: #28a745;">{{ i18n.t('ecTips') }}</h3>
            <ul style="line-height: 1.8;">
              <li>{{ i18n.t('ecTip1') }}</li>
              <li>{{ i18n.t('ecTip2') }}</li>
              <li>{{ i18n.t('ecTip3') }}</li>
              <li>{{ i18n.t('ecTip4') }}</li>
            </ul>
          </div>
        </template>

        <!-- K:CA RATIO EXPLANATION MODAL -->
        <template v-if="activeModal === 'k-ca-ratio'">
          <!-- What is K:Ca ratio -->
          <div class="explanation-section">
            <h3>{{ i18n.t('whatIsKCaRatio') }}</h3>
            <p v-html="i18n.t('kCaRatioExplanation')"></p>
          </div>

          <!-- Your current ratio -->
          <div v-if="modalData.kCaRatio" class="explanation-section" :style="{ background: modalData.kCaStatus?.color + '22', borderLeftColor: modalData.kCaStatus?.color }">
            <h3 :style="{ color: modalData.kCaStatus?.color }">{{ i18n.t('kCaYourCurrentRatio') }}</h3>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="font-size: 2em; font-weight: bold;" :style="{ color: modalData.kCaStatus?.color }">
                {{ i18n.formatNumber(modalData.kCaRatio) }} : 1
              </div>
              <div v-if="modalData.kCaStatus?.text" style="padding: 6px 12px; border-radius: 20px; font-weight: 500;" :style="{ background: modalData.kCaStatus?.color, color: 'white' }">
                {{ modalData.kCaStatus.text }}
              </div>
            </div>
            <p style="margin-top: 10px; color: #666;">{{ i18n.t('kCaOptimalRange') }}</p>
            <p v-if="modalData.kCaStatus?.level === 'kLeaning'" style="margin-top: 8px; padding: 8px 12px; background: #fff3e0; border-radius: 4px; color: #e65100; font-size: 0.9em;">
              {{ i18n.t('kCaContextualWarning') }}
            </p>
          </div>

          <!-- When K:Ca is too high -->
          <div class="explanation-section" style="background: #fff3e0; border-left-color: #ff9800;">
            <h3 style="color: #e65100;">{{ i18n.t('kCaWhenTooHigh') }}</h3>

            <p><strong>{{ i18n.t('kCaHighSymptoms') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaHighSymptom1') }}</li>
              <li>{{ i18n.t('kCaHighSymptom2') }}</li>
              <li>{{ i18n.t('kCaHighSymptom3') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaHighCauses') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaHighCause1') }}</li>
              <li>{{ i18n.t('kCaHighCause2') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaHighFixes') }}</strong></p>
            <ul style="margin: 5px 0 10px 20px; line-height: 1.8;">
              <li v-html="i18n.t('kCaHighFix1')"></li>
              <li>{{ i18n.t('kCaHighFix2') }}</li>
            </ul>
            <p style="padding: 8px 12px; background: #ffebee; border-radius: 4px; color: #c62828; margin: 10px 0 0 0;">
              <strong>{{ i18n.t('kCaHighFixWarning') }}</strong>
            </p>
          </div>

          <!-- When K:Ca is too low -->
          <div class="explanation-section" style="background: #e3f2fd; border-left-color: #2196f3;">
            <h3 style="color: #1565c0;">{{ i18n.t('kCaWhenTooLow') }}</h3>

            <p><strong>{{ i18n.t('kCaLowSymptoms') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaLowSymptom1') }}</li>
              <li>{{ i18n.t('kCaLowSymptom2') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaLowCauses') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaLowCause1') }}</li>
              <li>{{ i18n.t('kCaLowCause2') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaLowFixes') }}</strong></p>
            <ul style="margin: 5px 0 0 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaLowFix1') }}</li>
              <li>{{ i18n.t('kCaLowFix2') }}</li>
            </ul>
          </div>

          <!-- Common mistakes -->
          <div class="explanation-section" style="background: #ffebee; border-left-color: #f44336;">
            <h3 style="color: #c62828;">{{ i18n.t('kCaCommonMistakes') }}</h3>

            <div style="margin-bottom: 15px;">
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('kCaMistake1Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('kCaMistake1Why') }}</p>
            </div>

            <div style="margin-bottom: 15px;">
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('kCaMistake2Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('kCaMistake2Why') }}</p>
            </div>

            <div>
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('kCaMistake3Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('kCaMistake3Why') }}</p>
            </div>
          </div>

          <!-- When to adjust -->
          <div class="explanation-section" style="background: #e8f5e9; border-left-color: #4caf50;">
            <h3 style="color: #2e7d32;">{{ i18n.t('kCaWhenToAdjust') }}</h3>

            <p><strong>{{ i18n.t('kCaIncreaseKWhen') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaIncreaseK1') }}</li>
              <li>{{ i18n.t('kCaIncreaseK2') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaIncreaseCaWhen') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaIncreaseCa1') }}</li>
              <li>{{ i18n.t('kCaIncreaseCa2') }}</li>
            </ul>

            <p><strong>{{ i18n.t('kCaReduceKWhen') }}</strong></p>
            <ul style="margin: 5px 0 0 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaReduceK1') }}</li>
            </ul>
          </div>

          <!-- Reality check -->
          <div class="explanation-section" style="background: #f3e5f5; border-left-color: #9c27b0;">
            <h3 style="color: #7b1fa2;">{{ i18n.t('kCaRealityCheck') }}</h3>
            <p>{{ i18n.t('kCaRealityCheckText') }}</p>
            <ul style="margin: 5px 0 10px 20px; line-height: 1.8;">
              <li>{{ i18n.t('kCaRealityCheck1') }}</li>
              <li>{{ i18n.t('kCaRealityCheck2') }}</li>
              <li>{{ i18n.t('kCaRealityCheck3') }}</li>
            </ul>
            <p style="font-weight: 500; color: #7b1fa2;">{{ i18n.t('kCaRealityCheckConclusion') }}</p>
          </div>
        </template>

        <!-- NO3:NH4 RATIO EXPLANATION MODAL -->
        <template v-if="activeModal === 'no3-nh4-ratio'">
          <!-- What is NO₃:NH₄ ratio -->
          <div class="explanation-section">
            <h3>{{ i18n.t('whatIsNo3Nh4Ratio') }}</h3>
            <p v-html="i18n.t('no3Nh4RatioExplanation')"></p>
          </div>

          <!-- Your current ratio -->
          <div v-if="typeof modalData.no3Nh4Ratio === 'number' && isFinite(modalData.no3Nh4Ratio)" class="explanation-section" :style="{ background: modalData.no3Nh4Status?.color + '22', borderLeftColor: modalData.no3Nh4Status?.color }">
            <h3 :style="{ color: modalData.no3Nh4Status?.color }">{{ i18n.t('no3Nh4YourCurrentRatio') }}</h3>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="font-size: 2em; font-weight: bold;" :style="{ color: modalData.no3Nh4Status?.color }">
                {{ i18n.formatNumber(modalData.no3Nh4Ratio?.toFixed(1) || '0') }} : 1
              </div>
              <div v-if="modalData.no3Nh4Status?.text" style="padding: 6px 12px; border-radius: 20px; font-weight: 500;" :style="{ background: modalData.no3Nh4Status?.color, color: 'white' }">
                {{ modalData.no3Nh4Status.text }}
              </div>
            </div>
            <p style="margin-top: 10px; color: #666;">{{ i18n.t('no3Nh4OptimalRange') }}</p>
            <p v-if="modalData.no3Nh4Status?.level === 'watch'" style="margin-top: 8px; padding: 8px 12px; background: #fff3e0; border-radius: 4px; color: #e65100; font-size: 0.9em;">
              {{ i18n.t('no3Nh4ContextualWarning') }}
            </p>
          </div>

          <!-- All nitrate (Infinity) case -->
          <div v-else-if="modalData.no3Nh4Ratio === Infinity || (typeof modalData.no3Nh4Ratio === 'number' && !isFinite(modalData.no3Nh4Ratio))" class="explanation-section" style="background: #e0f7fa; border-left-color: #17a2b8;">
            <h3 style="color: #0097a7;">{{ i18n.t('no3Nh4YourCurrentRatio') }}</h3>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="font-size: 2em; font-weight: bold; color: #0097a7;">
                100% NO₃
              </div>
              <div style="padding: 6px 12px; border-radius: 20px; font-weight: 500; background: #17a2b8; color: white;">
                {{ i18n.t('no3Nh4StatusVeryHigh') }}
              </div>
            </div>
            <p style="margin-top: 10px; color: #666;">{{ i18n.t('no3Nh4VeryHighNote') }}</p>
          </div>

          <!-- Ratio guidelines -->
          <div class="explanation-section" style="background: #e8f5e9; border-left-color: #4caf50;">
            <h3 style="color: #2e7d32;">{{ i18n.t('no3Nh4ThresholdsTitle') }}</h3>
            <ul style="margin: 5px 0 0 20px; line-height: 2;">
              <li><span style="color: #17a2b8; font-weight: bold;">{{ i18n.t('no3Nh4Threshold1') }}</span></li>
              <li><span style="color: #28a745; font-weight: bold;">{{ i18n.t('no3Nh4Threshold2') }}</span></li>
              <li><span style="color: #fd7e14; font-weight: bold;">{{ i18n.t('no3Nh4Threshold3') }}</span></li>
              <li><span style="color: #dc3545; font-weight: bold;">{{ i18n.t('no3Nh4Threshold4') }}</span></li>
            </ul>
          </div>

          <!-- When ratio is too low (NH₄-heavy) -->
          <div class="explanation-section" style="background: #fff3e0; border-left-color: #ff9800;">
            <h3 style="color: #e65100;">{{ i18n.t('no3Nh4WhenTooLow') }}</h3>

            <p><strong>{{ i18n.t('no3Nh4LowSymptoms') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4LowSymptom1') }}</li>
              <li>{{ i18n.t('no3Nh4LowSymptom2') }}</li>
              <li>{{ i18n.t('no3Nh4LowSymptom3') }}</li>
              <li>{{ i18n.t('no3Nh4LowSymptom4') }}</li>
            </ul>

            <p><strong>{{ i18n.t('no3Nh4LowCauses') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4LowCause1') }}</li>
              <li>{{ i18n.t('no3Nh4LowCause2') }}</li>
              <li>{{ i18n.t('no3Nh4LowCause3') }}</li>
            </ul>

            <p><strong>{{ i18n.t('no3Nh4LowFixes') }}</strong></p>
            <ul style="margin: 5px 0 10px 20px; line-height: 1.8;">
              <li v-html="i18n.t('no3Nh4LowFix1')"></li>
              <li v-html="i18n.t('no3Nh4LowFix2')"></li>
            </ul>
            <p style="padding: 8px 12px; background: #ffebee; border-radius: 4px; color: #c62828; margin: 10px 0 0 0;">
              <strong>{{ i18n.t('no3Nh4LowFixWarning') }}</strong>
            </p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">{{ i18n.t('no3Nh4LowWhenToAct') }}</p>
          </div>

          <!-- When ratio is very high (all-nitrate) -->
          <div class="explanation-section" style="background: #e0f7fa; border-left-color: #00bcd4;">
            <h3 style="color: #0097a7;">{{ i18n.t('no3Nh4WhenVeryHigh') }}</h3>
            <p style="margin-bottom: 15px; padding: 8px 12px; background: #e8f5e9; border-radius: 4px; color: #2e7d32;">
              {{ i18n.t('no3Nh4VeryHighNote') }}
            </p>

            <p><strong>{{ i18n.t('no3Nh4VeryHighSymptoms') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4VeryHighSymptom1') }}</li>
              <li>{{ i18n.t('no3Nh4VeryHighSymptom2') }}</li>
              <li>{{ i18n.t('no3Nh4VeryHighSymptom3') }}</li>
            </ul>

            <p><strong>{{ i18n.t('no3Nh4VeryHighCauses') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4VeryHighCause1') }}</li>
            </ul>

            <p><strong>{{ i18n.t('no3Nh4VeryHighFixes') }}</strong></p>
            <ul style="margin: 5px 0 10px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4VeryHighFix1') }}</li>
              <li>{{ i18n.t('no3Nh4VeryHighFix2') }}</li>
            </ul>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">{{ i18n.t('no3Nh4VeryHighWhenToAct') }}</p>
          </div>

          <!-- Common mistakes -->
          <div class="explanation-section" style="background: #ffebee; border-left-color: #f44336;">
            <h3 style="color: #c62828;">{{ i18n.t('no3Nh4CommonMistakes') }}</h3>

            <div style="margin-bottom: 15px;">
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('no3Nh4Mistake1Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('no3Nh4Mistake1Why') }}</p>
            </div>

            <div style="margin-bottom: 15px;">
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('no3Nh4Mistake2Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('no3Nh4Mistake2Why') }}</p>
            </div>

            <div>
              <p style="font-weight: bold; margin-bottom: 5px;">{{ i18n.t('no3Nh4Mistake3Title') }}</p>
              <p style="color: #666; margin: 0;">{{ i18n.t('no3Nh4Mistake3Why') }}</p>
            </div>
          </div>

          <!-- When to prefer nitrate vs ammonium -->
          <div class="explanation-section" style="background: #e8f5e9; border-left-color: #4caf50;">
            <h3 style="color: #2e7d32;">{{ i18n.t('no3Nh4TimingTitle') }}</h3>

            <p><strong>{{ i18n.t('no3Nh4PreferNitrate') }}</strong></p>
            <ul style="margin: 5px 0 15px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4PreferNitrate1') }}</li>
              <li>{{ i18n.t('no3Nh4PreferNitrate2') }}</li>
              <li>{{ i18n.t('no3Nh4PreferNitrate3') }}</li>
            </ul>

            <p><strong>{{ i18n.t('no3Nh4AllowNh4') }}</strong></p>
            <ul style="margin: 5px 0 0 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4AllowNh41') }}</li>
              <li>{{ i18n.t('no3Nh4AllowNh42') }}</li>
              <li>{{ i18n.t('no3Nh4AllowNh43') }}</li>
            </ul>
          </div>

          <!-- Reality check -->
          <div class="explanation-section" style="background: #f3e5f5; border-left-color: #9c27b0;">
            <h3 style="color: #7b1fa2;">{{ i18n.t('no3Nh4RealityCheck') }}</h3>
            <p>{{ i18n.t('no3Nh4RealityCheckText') }}</p>
            <ul style="margin: 5px 0 10px 20px; line-height: 1.8;">
              <li>{{ i18n.t('no3Nh4RealityCheck1') }}</li>
              <li>{{ i18n.t('no3Nh4RealityCheck2') }}</li>
              <li>{{ i18n.t('no3Nh4RealityCheck3') }}</li>
              <li>{{ i18n.t('no3Nh4RealityCheck4') }}</li>
            </ul>
            <p style="font-weight: 500; color: #7b1fa2;">{{ i18n.t('no3Nh4RealityCheckConclusion') }}</p>
          </div>
        </template>

      </div>
    </div>
  </div>

  <h1 @click="goToModeSelector()" style="cursor: pointer;" title="Return to calculator selection">Fertilizer Calculator</h1>

  <!-- Global Language Selector (visible on all wizard steps) -->
  <div class="language-selector" style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
    <label for="language-select" style="font-size: 0.85em; color: #666; margin-right: 8px; display: flex; align-items: center;" data-i18n="language">Language</label>
    <select id="language-select" v-model="language" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
      <option value="en">English</option>
      <option value="gu">ગુજરાતી (Gujarati)</option>
      <option value="hi">हिन्दी (Hindi)</option>
      <option value="kn">ಕನ್ನಡ (Kannada)</option>
      <option value="te">తెలుగు (Telugu)</option>
      <option value="mr">मराठी (Marathi)</option>
      <option value="bn-sadhu">বাংলা - সাধু (Bengali Sadhu)</option>
      <option value="bn">বাংলা - চলিত (Bengali Cholito)</option>
      <option value="ta">தமிழ் (Tamil)</option>
      <option value="ml">മലയാളം (Malayalam)</option>
      <option value="pa">ਪੰਜਾਬੀ (Punjabi)</option>
      <option value="or">ଓଡ଼ିଆ (Odia)</option>
      <option value="as">অসমীয়া (Assamese)</option>
      <option value="bho">भोजपुरी (Bhojpuri)</option>
      <option value="mai">मैथिली (Maithili)</option>
      <option value="awa">अवधी (Awadhi)</option>
    </select>
  </div>

  <!-- Mode Selector (Wizard Step 1) -->
  <div id="mode-selector" class="mode-selector" v-show="wizardStep === 'mode-selector'">
    <h2 data-i18n="whatWouldYouLikeToDo">What would you like to do?</h2>
    <p data-i18n="chooseModeDescription">Choose a calculator mode based on what information you have.</p>

    <div class="mode-cards">
      <!-- Grams to PPM -->
      <div class="mode-card" @click="selectMode('ppm-calc')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L6 8"></path>
            <path d="M18 2L18 8"></path>
            <path d="M6 8C6 8 6 22 12 22C18 22 18 8 18 8"></path>
            <path d="M6 8H18"></path>
          </svg>
          <span data-i18n="gramsToPpm">Grams → PPM</span>
        </h3>
        <p class="description" data-i18n="gramsToPpmDescription">
          Calculate what nutrient concentrations (PPM) you'll get from specific amounts of fertilizers.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="gramsToPpmUseCase">You have fertilizers weighed out and want to know the resulting nutrient levels in your solution.</span>
        </div>
      </div>

      <!-- PPM to Grams -->
      <div class="mode-card" @click="selectMode('formula-builder')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          <span data-i18n="ppmToGrams">PPM → Grams</span>
        </h3>
        <p class="description" data-i18n="ppmToGramsDescription">
          Enter your target PPM values and get the exact fertilizer amounts needed to achieve them.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="ppmToGramsUseCase">You have specific PPM targets (e.g., from a recipe or plant requirements) and need to know how much of each fertilizer to use.</span>
        </div>
      </div>

      <!-- NPK Ratio to Grams -->
      <div class="mode-card" @click="selectMode('reverse-calc')">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v18h18"></path>
            <path d="M18 17V9"></path>
            <path d="M13 17V5"></path>
            <path d="M8 17v-3"></path>
          </svg>
          <span data-i18n="npkRatioToGrams">NPK Ratio → Grams</span>
        </h3>
        <p class="description" data-i18n="npkRatioToGramsDescription">
          Enter nutrient ratios (like 3-1-2) and a target EC to get fertilizer amounts that match your desired balance.
        </p>
        <div class="use-case">
          <strong data-i18n="bestFor">Best for:</strong>
          <span data-i18n="npkRatioUseCase">You know the nutrient ratio you want (e.g., for a specific growth stage) and want to scale it to your desired EC/strength.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Volume Selection -->
  <div id="volume-step" class="volume-step" :class="{ active: wizardStep === 'volume-step' }" @keydown.enter="wizardStep === 'volume-step' && proceedFromVolumeStep()">
    <div class="step-indicator">{{ getStepIndicator('volume-step') }}</div>
    <h3 data-i18n="howMuchSolution">How much solution are you making?</h3>
    <p data-i18n="volumeDescription">Enter the total volume of water you'll be mixing your fertilizers into.</p>

    <div class="volume-step-input">
      <input type="number" id="wizard-volume" ref="wizardVolumeInput" v-model.number="wizardVolume" min="0.1" step="0.1" required @keydown.enter="proceedFromVolumeStep()">
      <span data-i18n="liters">liters</span>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" @click="proceedFromVolumeStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" @click="backToModeSelector()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step 3: Calculation Mode (only for PPM→Grams and NPK Ratio→Grams) -->
  <div id="calc-mode-step" class="calc-mode-step" :class="{ active: wizardStep === 'calc-mode-step' }" @keydown.enter="wizardStep === 'calc-mode-step' && proceedFromCalcModeStep()">
    <div class="step-indicator">{{ getStepIndicator('calc-mode-step') }}</div>
    <h3 data-i18n="howToEnterValues">How do you want to enter values?</h3>
    <p data-i18n="calcModeDescription">Choose between commercial fertilizer notation or pure elemental values.</p>

    <div class="calc-mode-options">
      <label class="calc-mode-option" :class="{ selected: wizardCalcMode === 'oxide' }" @click="selectCalcMode('oxide')">
        <input type="radio" name="wizard-calc-mode" value="oxide" :checked="wizardCalcMode === 'oxide'">
        <div class="calc-mode-option-content">
          <strong data-i18n="oxideForms">Oxide Forms (P₂O₅, K₂O)</strong>
          <span data-i18n="oxideFormsDescription">Commercial standard - matches fertilizer bag labels</span>
        </div>
      </label>
      <label class="calc-mode-option" :class="{ selected: wizardCalcMode === 'elemental' }" @click="selectCalcMode('elemental')">
        <input type="radio" name="wizard-calc-mode" value="elemental" :checked="wizardCalcMode === 'elemental'">
        <div class="calc-mode-option-content">
          <strong data-i18n="elementalForms">Elemental Forms (P, K)</strong>
          <span data-i18n="elementalFormsDescription">Pure elements - for scientific calculations</span>
        </div>
      </label>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" @click="proceedFromCalcModeStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" @click="backToVolumeStep()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step 4: Target EC (only for NPK Ratio→Grams) -->
  <div id="ec-step" class="ec-step" :class="{ active: wizardStep === 'ec-step' }" @keydown.enter="wizardStep === 'ec-step' && proceedFromECStep()">
    <div class="step-indicator">{{ getStepIndicator('ec-step') }}</div>
    <h3 data-i18n="whatStrengthSolution">What strength solution do you want?</h3>
    <p data-i18n="ecDescription">Choose the EC (electrical conductivity) you want the mix to reach. It tells us how concentrated the nutrients should be, and we'll scale the fertilizer amounts to hit that strength for your batch.</p>

    <div class="ec-step-select">
      <select id="wizard-ec" v-model="wizardSelectedEC">
        <option value="ec:0.2" data-i18n="ecOption02">0.2 mS/cm - Plain Water Supplement</option>
        <option value="ec:0.4" data-i18n="ecOption04">0.4 mS/cm - Recovery/Flush</option>
        <option value="ec:0.6" data-i18n="ecOption06">0.6 mS/cm - Fresh Clones/Cuttings</option>
        <option value="ec:0.8" data-i18n="ecOption08">0.8 mS/cm - Rooted Cuttings</option>
        <option value="ec:1.0" data-i18n="ecOption10">1.0 mS/cm - Seedlings/Young Plants</option>
        <option value="ec:1.2" data-i18n="ecOption12">1.2 mS/cm - General Purpose</option>
        <option value="ec:1.5" data-i18n="ecOption15">1.5 mS/cm - Vegetative Growth</option>
        <option value="ec:1.8" data-i18n="ecOption18">1.8 mS/cm - Active Growth</option>
        <option value="ec:2.0" data-i18n="ecOption20">2.0 mS/cm - Heavy Feeders</option>
        <option value="ec:2.5" data-i18n="ecOption25">2.5 mS/cm - Flowering/Fruiting</option>
        <option value="ec:3.0" data-i18n="ecOption30">3.0 mS/cm - Maximum (experienced growers)</option>
      </select>
      <p class="ec-description" id="ec-description">{{ wizardECDescription }}</p>
    </div>

    <div class="volume-step-buttons">
      <button class="btn-continue" @click="proceedFromECStep()" data-i18n="continue">
        Continue →
      </button>
      <button class="btn-back" @click="backToCalcModeStep()" data-i18n="back">
        ← Back
      </button>
    </div>
  </div>

  <!-- Step: Fertilizer Selection + Quantities (for Grams→PPM) -->
  <div id="grams-input-step" class="wizard-input-step" :class="{ active: wizardStep === 'grams-input-step' }" @keydown.enter="handleGramsInputEnter($event)">
    <div class="step-indicator">{{ getStepIndicator('grams-input-step') }}</div>
    <h3 data-i18n="selectFertilizersAndEnterAmounts">Select Fertilizers & Enter Amounts</h3>
    <p data-i18n="selectFertilizersDescription">Check the fertilizers you're using and enter how many grams of each you'll add to your solution.</p>

    <div class="wizard-fertilizer-section">
      <div class="wizard-fertilizer-search">
        <input type="text" v-model="wizardGramsSearchTerm" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers...">
      </div>
      <div class="wizard-selection-controls">
        <button @click="clearWizardGramsSelectionsVue" data-i18n="clearAll">Clear All</button>
      </div>
      <div class="wizard-fertilizer-list">
        <div v-for="fert in filteredWizardGramsFertilizers" :key="fert.id" class="wizard-fertilizer-item">
          <input type="checkbox"
                 :id="'wizard-grams-check-' + fert.id"
                 class="wizard-fert-checkbox"
                 :checked="wizardGramsFertilizers[fert.id]?.checked"
                 @change="toggleWizardGramsFertilizer(fert.id)">
          <label :for="'wizard-grams-check-' + fert.id" class="wizard-fert-label">
            <span class="wizard-fert-name">{{ i18n.getFertilizerName(fert) }}</span>
            <span v-if="fert.aliases && fert.aliases.length" class="wizard-fert-aliases">{{ i18n.getFertilizerAliases(fert) }}</span>
          </label>
          <input type="number"
                 class="wizard-grams-input"
                 :value="wizardGramsFertilizers[fert.id]?.grams"
                 @input="updateWizardGrams(fert.id, $event.target.value)"
                 data-i18n-placeholder="grams"
                 placeholder="Grams"
                 min="0"
                 step="0.1">
        </div>
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-calculate" @click="calculateFromWizardGrams()" data-i18n="calculatePpm">Calculate PPM</button>
      <button class="btn-back" @click="backToVolumeStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: Target PPM Values (for PPM→Grams) -->
  <div id="ppm-targets-step" class="wizard-input-step" :class="{ active: wizardStep === 'ppm-targets-step' }" @keydown.enter="wizardStep === 'ppm-targets-step' && proceedToFormulaFertilizerStep()">
    <div class="step-indicator">{{ getStepIndicator('ppm-targets-step') }}</div>
    <h3 data-i18n="enterTargetPpmValues">Enter Target PPM Values</h3>
    <p data-i18n="targetPpmDescription">Enter the nutrient concentrations you want to achieve. At least one value is required.</p>

    <div class="input-grid">
      <div class="input-field">
        <label for="wizard-target-n" data-i18n="nitrogen">Nitrogen (N)</label>
        <input type="number" id="wizard-target-n" v-model="wizardTargets.N" min="0" step="1" data-i18n-placeholder="exampleN" placeholder="e.g., 150">
      </div>
      <div class="input-field">
        <label for="wizard-target-p" id="wizard-target-p-label">{{ wizardPLabel }}</label>
        <input type="number" id="wizard-target-p" v-model="wizardTargets.P" min="0" step="1" data-i18n-placeholder="exampleP" placeholder="e.g., 50">
      </div>
      <div class="input-field">
        <label for="wizard-target-k" id="wizard-target-k-label">{{ wizardKLabel }}</label>
        <input type="number" id="wizard-target-k" v-model="wizardTargets.K" min="0" step="1" data-i18n-placeholder="exampleK" placeholder="e.g., 200">
      </div>
      <div class="input-field">
        <label for="wizard-target-ca" data-i18n="calcium">Calcium (Ca)</label>
        <input type="number" id="wizard-target-ca" v-model="wizardTargets.Ca" min="0" step="1" data-i18n-placeholder="exampleCa" placeholder="e.g., 150">
      </div>
      <div class="input-field">
        <label for="wizard-target-mg" data-i18n="magnesium">Magnesium (Mg)</label>
        <input type="number" id="wizard-target-mg" v-model="wizardTargets.Mg" min="0" step="1" data-i18n-placeholder="exampleMg" placeholder="e.g., 50">
      </div>
      <div class="input-field">
        <label for="wizard-target-s" data-i18n="sulfur">Sulfur (S)</label>
        <input type="number" id="wizard-target-s" v-model="wizardTargets.S" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-target-si" data-i18n="silicon">Silicon (Si)</label>
        <input type="number" id="wizard-target-si" v-model="wizardTargets.Si" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-continue" @click="proceedToFormulaFertilizerStep()" data-i18n="continue">Continue →</button>
      <button class="btn-back" @click="backToCalcModeStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: NPK Ratios (for NPK Ratio→Grams) -->
  <div id="npk-ratios-step" class="wizard-input-step" :class="{ active: wizardStep === 'npk-ratios-step' }" @keydown.enter="wizardStep === 'npk-ratios-step' && proceedToReverseFertilizerStep()">
    <div class="step-indicator">{{ getStepIndicator('npk-ratios-step') }}</div>
    <h3 data-i18n="enterNutrientRatios">Enter Nutrient Ratios</h3>
    <p data-i18n="nutrientRatiosDescription">Enter your desired nutrient ratios (e.g., N:P:K = 3:1:2). At least one must be greater than zero.</p>

    <div class="input-grid">
      <div class="input-field">
        <label for="wizard-ratio-n" data-i18n="nitrogen">Nitrogen (N)</label>
        <input type="number" id="wizard-ratio-n" v-model="wizardRatios.N" min="0" step="1" data-i18n-placeholder="exampleRatioN" placeholder="e.g., 3">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-p" data-i18n="phosphorusElemental">Phosphorus (P)</label>
        <input type="number" id="wizard-ratio-p" v-model="wizardRatios.P" min="0" step="1" data-i18n-placeholder="exampleRatioP" placeholder="e.g., 1">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-k" data-i18n="potassiumElemental">Potassium (K)</label>
        <input type="number" id="wizard-ratio-k" v-model="wizardRatios.K" min="0" step="1" data-i18n-placeholder="exampleRatioK" placeholder="e.g., 2">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-ca" data-i18n="calcium">Calcium (Ca)</label>
        <input type="number" id="wizard-ratio-ca" v-model="wizardRatios.Ca" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-mg" data-i18n="magnesium">Magnesium (Mg)</label>
        <input type="number" id="wizard-ratio-mg" v-model="wizardRatios.Mg" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-s" data-i18n="sulfur">Sulfur (S)</label>
        <input type="number" id="wizard-ratio-s" v-model="wizardRatios.S" min="0" step="1" data-i18n-placeholder="optional" placeholder="Optional">
      </div>
      <div class="input-field">
        <label for="wizard-ratio-si" data-i18n="siliconPpm">Silicon (Si) PPM</label>
        <input type="number" id="wizard-ratio-si" v-model="wizardRatios.Si" min="0" step="1" data-i18n-placeholder="targetPpm" placeholder="Target PPM">
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-continue" @click="proceedToReverseFertilizerStep()" data-i18n="continue">Continue →</button>
      <button class="btn-back" @click="backToECStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Step: Select Available Fertilizers (for PPM→Grams and NPK Ratio→Grams) -->
  <div id="fertilizer-select-step" class="wizard-input-step" :class="{ active: wizardStep === 'fertilizer-select-step' }" @keydown.enter="handleFertilizerSelectEnter($event)">
    <div class="step-indicator">{{ getStepIndicator('fertilizer-select-step') }}</div>
    <h3 data-i18n="selectAvailableFertilizers">Select Available Fertilizers</h3>
    <p data-i18n="selectAvailableFertilizersDescription">Choose the fertilizers you have on hand. The calculator will use only these to build your formula.</p>

    <div class="wizard-fertilizer-section">
      <div class="wizard-fertilizer-search">
        <input type="text" v-model="wizardAvailSearchTerm" data-i18n-placeholder="searchFertilizers" placeholder="Search fertilizers...">
      </div>
      <div class="wizard-selection-controls">
        <button @click="selectAllWizardFertilizersVue" data-i18n="selectAll">Select All</button>
        <button @click="deselectAllWizardFertilizersVue" data-i18n="deselectAll">Deselect All</button>
        <button @click="selectCommonWizardFertilizersVue" data-i18n="commonOnly">Common Only</button>
      </div>
      <div class="wizard-fertilizer-list">
        <div v-for="fert in filteredWizardAvailFertilizers" :key="fert.id" class="wizard-fertilizer-item">
          <input type="checkbox"
                 :id="'wizard-avail-check-' + fert.id"
                 class="wizard-fert-checkbox"
                 :checked="wizardAvailFertilizers[fert.id]"
                 @change="toggleWizardAvailFertilizer(fert.id)">
          <label :for="'wizard-avail-check-' + fert.id" class="wizard-fert-label">
            <span class="wizard-fert-name">{{ i18n.getFertilizerName(fert) }}</span>
            <span v-if="fert.aliases && fert.aliases.length" class="wizard-fert-aliases">{{ i18n.getFertilizerAliases(fert) }}</span>
          </label>
        </div>
      </div>
    </div>

    <div class="wizard-step-buttons">
      <button class="btn-calculate" id="fertilizer-select-calc-btn" @click="calculateFromWizardFertilizerSelectVue()" data-i18n="calculate">Calculate</button>
      <button class="btn-back" id="fertilizer-select-back-btn" @click="backFromFertilizerSelectStep()" data-i18n="back">← Back</button>
    </div>
  </div>

  <!-- Two-Tank Question Step (shown when incompatible fertilizers detected) -->
  <div id="two-tank-question-step" class="wizard-input-step" :class="{ active: wizardStep === 'two-tank-question-step' }">
    <p class="step-indicator">{{ getTwoTankStepIndicator() }}</p>
    <h3 data-i18n="twoTankQuestionTitle">Would you like to see a two-tank view?</h3>
    <div class="two-tank-explanation">
      <div class="incompatibility-warning">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <span data-i18n="incompatibleFertilizersDetected">Incompatible fertilizers detected in your selection</span>
      </div>
      <p data-i18n="twoTankExplanation">Your formula contains fertilizers that can react with each other when mixed at high concentrations (stock solutions). Specifically, calcium sources can precipitate when combined with sulfates, phosphates, or silicates at the wrong pH.</p>
      <div class="two-tank-info">
        <h4 data-i18n="whatIsTwoTankTitle">What is a Two-Tank System?</h4>
        <p data-i18n="whatIsTwoTankDescription">A two-tank system separates incompatible fertilizers into two concentrated stock solutions:</p>
        <ul>
          <li><strong data-i18n="tankALabel">Tank A (Calcium)</strong>: <span data-i18n="tankADescription">Contains calcium-based fertilizers like Calcium Nitrate</span></li>
          <li><strong data-i18n="tankBLabel">Tank B (Sulfates/Phosphates)</strong>: <span data-i18n="tankBDescription">Contains sulfate, phosphate, and silicate sources</span></li>
        </ul>
        <p data-i18n="twoTankMixingNote">Each tank is diluted separately, then combined in the final reservoir at working strength where the diluted concentrations are safe.</p>
      </div>
    </div>
    <div class="wizard-step-buttons two-tank-buttons">
      <button class="btn-continue btn-two-tank" @click="showTwoTankView()" data-i18n="yesShowTwoTanks">Yes, show two-tank view</button>
      <button class="btn-back" @click="skipTwoTankView()" data-i18n="noShowRegularResults">No, show regular results</button>
    </div>
  </div>

  <!-- Wizard Results View (shown after calculation from wizard) -->
  <div id="wizard-results" class="wizard-results" :class="{ active: wizardStep === 'wizard-results' }">
    <div class="wizard-header">
      <button class="wizard-back-btn" @click="backFromWizardResults()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        <span data-i18n="changeSettings">Change Settings</span>
      </button>
      <span class="wizard-current-mode" id="wizard-results-mode" v-html="wizardResultsModeText"></span>
    </div>
    <div id="wizard-results-container">
      <!-- Grams to PPM Results (when wizardResultsSource === 'ppm-calc') -->
      <template v-if="wizardResultsSource === 'ppm-calc' && gramsToPpmDisplayData.show && !twoTankDisplayData.show">
        <div class="results-section" id="wizard-selected-fertilizers-section">
          <div class="results-header">
            <h2>{{ i18n.t('selectedFertilizers') }}</h2>
            <div style="display: flex; gap: 10px;">
              <button class="copy-btn" :class="{ copied: copiedButtonId === 'grams-to-ppm' }" @click="copyGramsToPPMResultsVue()" :title="i18n.t('copyToClipboard')">
                <svg v-if="copiedButtonId !== 'grams-to-ppm'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <span>{{ copiedButtonId === 'grams-to-ppm' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
              </button>
            </div>
          </div>
          <div>
            <div v-for="fert in gramsToPpmDisplayData.fertilizers" :key="fert.id" class="selected-fertilizer-item">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name"><span class="fertilizer-number">{{ fert.index }}.</span> {{ i18n.getFertilizerName(fert) }}</div>
                <div class="selected-fertilizer-composition">{{ fert.composition }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <div v-if="gramsToPpmDisplayData.fertilizers.length > 0" class="selected-fertilizer-item selected-fertilizer-total">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name">{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(gramsToPpmDisplayData.fertilizers.length) }) }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(gramsToPpmDisplayData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <!-- Total g/L summary -->
            <div v-if="gramsToPpmDisplayData.fertilizers.length > 0 && gramsToPpmDisplayData.volume > 0" style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
              <strong>{{ i18n.formatNumber((gramsToPpmDisplayData.totalGrams / gramsToPpmDisplayData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
              <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
            </div>
          </div>
        </div>
        <div class="results-section" style="margin-top: 20px;">
          <h2>
            <span>{{ i18n.t('resultsPpm') }}</span>
            <span class="info-icon" @click="openPPMExplanation()" :title="i18n.t('clickToLearnPpm')">?</span>
          </h2>
          <div class="results-grid">
            <div v-for="item in gramsToPpmDisplayData.displayOrder" :key="item.key" class="result-card" :class="{ zero: item.isZero }">
              <div class="result-label">{{ item.label }}</div>
              <div class="result-value">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</div>
            </div>
          </div>
        </div>
        <div class="results-section" v-if="gramsToPpmDisplayData.ionBalance" style="margin-top: 20px;">
          <h2>
            <span>{{ i18n.t('ionBalance') }}</span>
            <span class="info-icon" @click="openIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
          </h2>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalCations.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="font-size: 1.5em; color: #666;">vs</div>
            <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalAnions.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ionBalance.statusColor }">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
              <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.imbalance.toFixed(1)) }}%</div>
              <div style="font-size: 0.85em;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ gramsToPpmDisplayData.ionBalance.statusText }}</div>
            </div>
          </div>
        </div>
        <div class="results-section" v-if="gramsToPpmDisplayData.ratios && gramsToPpmDisplayData.ratios.length > 0" style="margin-top: 20px;">
          <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <ratio-card v-for="(ratio, idx) in gramsToPpmDisplayData.ratios" :key="idx" :ratio="ratio" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
          </div>
        </div>
        <div class="results-section" v-if="gramsToPpmDisplayData.ecPrediction && gramsToPpmDisplayData.ecPrediction.ec > 0" style="margin-top: 20px;">
          <h2>{{ i18n.t('achievedEc') }} <span class="info-icon" @click="openEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
          <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ecPrediction.color + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ecPrediction.color }">
              <div style="font-size: 2em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ec.toFixed(2)) }}</div>
              <div style="font-size: 0.9em; color: #666;">mS/cm</div>
              <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ gramsToPpmDisplayData.ecPrediction.text }}</div>
            </div>
            <div v-if="gramsToPpmDisplayData.ecPrediction.ionicStrength" class="ionic-strength-card" style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('ionicStrength') }}</div>
              <div style="font-size: 1.2em; font-weight: bold;">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ionicStrength.toFixed(4)) }} mol/L</div>
            </div>
          </div>
        </div>
        <div class="results-section" v-if="gramsToPpmDisplayData.warnings && gramsToPpmDisplayData.warnings.length > 0" style="margin-top: 20px;">
          <h2>{{ i18n.t('warningsAndRecommendations') }}</h2>
          <div v-for="(warning, idx) in gramsToPpmDisplayData.warnings" :key="idx" :class="warning.level === 'warning' ? 'warning-box' : warning.level === 'error' ? 'error-box' : 'conversion-note'" style="margin-bottom: 10px;">
            <strong>{{ warning.level === 'warning' ? '⚠️' : warning.level === 'error' ? '❌' : 'ℹ️' }} {{ warning.category }}</strong><br>
            {{ warning.message }}
          </div>
        </div>
      </template>

      <!-- Formula Builder Results (when wizardResultsSource === 'formula-builder') -->
      <template v-if="wizardResultsSource === 'formula-builder' && formulaResultsData.show && !twoTankDisplayData.show">
        <div class="results-section">
          <div class="results-header">
            <h2>{{ i18n.t('recommendedFormula') }}</h2>
            <div style="display: flex; gap: 10px;">
              <button class="copy-btn" :class="{ copied: copiedButtonId === 'ppm-to-grams' }" @click="copyPPMToGramsResultsVue()" :title="i18n.t('copyToClipboard')">
                <svg v-if="copiedButtonId !== 'ppm-to-grams'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <span>{{ copiedButtonId === 'ppm-to-grams' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
              </button>
            </div>
          </div>
          <div>
            <div v-for="fert in formulaResultsData.fertilizers" :key="fert.id" class="selected-fertilizer-item">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name">{{ i18n.getFertilizerName(fert) }}</div>
                <div class="selected-fertilizer-composition">{{ fert.composition }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <div v-if="formulaResultsData.fertilizers.length > 0" class="selected-fertilizer-item selected-fertilizer-total">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name">{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(formulaResultsData.fertilizers.length) }) }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(formulaResultsData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <!-- Total g/L summary -->
            <div v-if="formulaResultsData.fertilizers.length > 0 && formulaResultsData.volume > 0" style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
              <strong>{{ i18n.formatNumber((formulaResultsData.totalGrams / formulaResultsData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
              <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
            </div>
          </div>
        </div>
        <!-- Target Deviation Warnings - Shown prominently at top -->
        <div v-if="!formulaResultsData.allGood" class="error-box" style="margin-top: 15px;">
          <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
          <ul>
            <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
          </ul>
          <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
        </div>
        <div v-else-if="formulaResultsData.warnings && formulaResultsData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
          <strong>{{ i18n.t('note') }}</strong>
          <ul>
            <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
          </ul>
        </div>
        <div class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('targetVsAchieved') || 'Target vs Achieved' }}</h2>
          <div class="results-grid">
            <div v-for="item in formulaResultsData.comparison" :key="item.key" class="result-card" :style="{ borderLeft: '4px solid ' + (item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : item.className === 'miss' ? '#dc3545' : '#ddd') }">
              <div class="result-label">{{ item.label }}</div>
              <div class="result-value">{{ i18n.formatNumber((item.achieved || 0).toFixed(2)) }} <span :style="{ color: item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : '#dc3545', fontWeight: 'bold' }">{{ item.status }}</span></div>
              <div v-if="item.target" class="result-target" style="font-size: 0.85em; color: #666;">{{ i18n.t('targetLabel') || 'Target:' }} {{ i18n.formatNumber(item.target.toFixed(2)) }}</div>
            </div>
          </div>
        </div>
        <div class="results-section" v-if="formulaResultsData.ionBalance" style="margin-top: 20px;">
          <h2>
            <span>{{ i18n.t('ionBalance') }}</span>
            <span class="info-icon" @click="openFormulaIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
          </h2>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="font-size: 1.5em; color: #666;">vs</div>
            <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + formulaResultsData.ionBalance.statusColor }">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
              <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(formulaResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
              <div style="font-size: 0.85em;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ formulaResultsData.ionBalance.statusText }}</div>
            </div>
          </div>
        </div>
        <!-- EC Prediction Section -->
        <div class="results-section" v-if="formulaResultsData.ecPrediction && formulaResultsData.ecPrediction.ec > 0" style="margin-top: 20px;">
          <h2>{{ i18n.t('predictedEc') }} <span class="info-icon" @click="openFormulaEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
          <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + formulaResultsData.ecPrediction.color }">
              <div style="font-size: 2em; font-weight: bold;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ i18n.formatNumber(formulaResultsData.ecPrediction.ec.toFixed(2)) }}</div>
              <div style="font-size: 0.9em; color: #666;">mS/cm</div>
              <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ formulaResultsData.ecPrediction.text }}</div>
            </div>
          </div>
        </div>
        <!-- Nutrient Ratio Analysis -->
        <div v-if="formulaResultsData.ratios && formulaResultsData.ratios.length > 0" class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <ratio-card v-for="(ratioObj, index) in formulaResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
          </div>
        </div>
        <!-- Nutritional Warnings -->
        <div v-if="formulaResultsData.nutritionalWarnings && formulaResultsData.nutritionalWarnings.length > 0" class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('warningsAndRecommendations') }}</h2>
          <div class="warning-box">
            <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
            <ul>
              <li v-for="(warning, idx) in formulaResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
                <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
              </li>
            </ul>
          </div>
        </div>
      </template>

      <!-- Reverse Calculator Results (when wizardResultsSource === 'reverse-calc') -->
      <template v-if="wizardResultsSource === 'reverse-calc' && reverseResultsData.show && !twoTankDisplayData.show">
        <div class="results-section">
          <div class="results-header">
            <h2>{{ i18n.t('requiredFertilizers') }}</h2>
            <div style="display: flex; gap: 10px;">
              <button class="copy-btn" :class="{ copied: copiedButtonId === 'npk-ratio' }" @click="copyNPKRatioResultsVue()" :title="i18n.t('copyToClipboard')">
                <svg v-if="copiedButtonId !== 'npk-ratio'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <span>{{ copiedButtonId === 'npk-ratio' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
              </button>
            </div>
          </div>
          <div>
            <div v-for="fert in reverseResultsData.fertilizers" :key="fert.id" class="selected-fertilizer-item">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name">{{ i18n.getFertilizerName(fert) }}</div>
                <div class="selected-fertilizer-composition">{{ fert.composition }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <div v-if="reverseResultsData.fertilizers.length > 0" class="selected-fertilizer-item selected-fertilizer-total">
              <div class="selected-fertilizer-info">
                <div class="selected-fertilizer-name">{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(reverseResultsData.fertilizers.length) }) }}</div>
              </div>
              <div class="selected-fertilizer-amount">{{ i18n.formatNumber(reverseResultsData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
            </div>
            <!-- Total g/L summary -->
            <div v-if="reverseResultsData.fertilizers.length > 0 && reverseResultsData.volume > 0" style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
              <strong>{{ i18n.formatNumber((reverseResultsData.totalGrams / reverseResultsData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
              <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
            </div>
          </div>
        </div>
        <!-- Target Deviation Warnings - Shown prominently at top -->
        <div v-if="!reverseResultsData.allGood" class="error-box" style="margin-top: 15px;">
          <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
          <ul>
            <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
          </ul>
          <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
        </div>
        <div v-else-if="reverseResultsData.warnings && reverseResultsData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
          <strong>{{ i18n.t('note') }}</strong>
          <ul>
            <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
          </ul>
        </div>
        <div class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('targetVsAchievedRatios') || 'Achieved PPM' }}</h2>
          <div class="results-grid">
            <div v-for="item in reverseResultsData.comparison" :key="item.key" class="result-card" :style="{ borderLeft: '4px solid ' + (item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : item.className === 'miss' ? '#dc3545' : '#ddd') }">
              <div class="result-label">{{ item.label }}</div>
              <div class="result-value">{{ i18n.formatNumber((item.achievedPPM || 0).toFixed(2)) }} <span :style="{ color: item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : '#dc3545', fontWeight: 'bold' }">{{ item.status }}</span></div>
              <div class="result-target" style="font-size: 0.85em; color: #666;">{{ i18n.t('ratioLabel') || 'Ratio:' }} {{ item.userInput }} → {{ i18n.formatNumber((item.achievedRatio || 0).toFixed(2)) }}</div>
            </div>
          </div>
        </div>
        <!-- Nitrogen Forms Breakdown -->
        <div class="conversion-note" style="margin-top: 15px;" v-if="reverseResultsData.result && reverseResultsData.result.achieved">
          <strong>{{ i18n.t('nitrogenFormLabel') }}</strong>
          {{ i18n.formatNumber(reverseResultsData.result.achieved.N_NH4.toFixed(1)) }} ppm NH₄-N
          ({{ i18n.formatNumber(reverseResultsData.nh4Percent.toFixed(1)) }}% {{ i18n.t('ofTotalN') }}),
          {{ i18n.formatNumber(reverseResultsData.result.achieved.N_NO3.toFixed(1)) }} ppm NO₃-N
          ({{ i18n.formatNumber((100 - reverseResultsData.nh4Percent).toFixed(1)) }}% {{ i18n.t('ofTotalN') }})
          <span v-if="reverseResultsData.result.achieved.N_Urea > 0">
            , {{ i18n.formatNumber(reverseResultsData.result.achieved.N_Urea.toFixed(1)) }} ppm {{ i18n.t('ureaN') || 'Urea-N' }}
          </span>
        </div>
        <div class="results-section" v-if="reverseResultsData.ionBalance" style="margin-top: 20px;">
          <h2>
            <span>{{ i18n.t('ionBalance') }}</span>
            <span class="info-icon" @click="openReverseIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
          </h2>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="font-size: 1.5em; color: #666;">vs</div>
            <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
              <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
              <div style="font-size: 0.75em; color: #888;">meq/L</div>
            </div>
            <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + reverseResultsData.ionBalance.statusColor }">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
              <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(reverseResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
              <div style="font-size: 0.85em;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ reverseResultsData.ionBalance.statusText }}</div>
            </div>
          </div>
        </div>
        <!-- EC Prediction Section -->
        <div class="results-section" v-if="reverseResultsData.ecPrediction && reverseResultsData.ecPrediction.ec > 0" style="margin-top: 20px;">
          <h2>{{ i18n.t('estimatedEC') }} <span class="info-icon" @click="openReverseEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
          <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + reverseResultsData.ecPrediction.color }">
              <div style="font-size: 2em; font-weight: bold;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ i18n.formatNumber(reverseResultsData.ecPrediction.ec.toFixed(2)) }}</div>
              <div style="font-size: 0.9em; color: #666;">mS/cm</div>
              <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ reverseResultsData.ecPrediction.text }}</div>
            </div>
            <div v-if="reverseResultsData.ecPrediction.targetEC" class="ec-target" style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
              <div style="font-size: 0.85em; color: #666;">{{ i18n.t('targetEC') }}</div>
              <div style="font-size: 1.5em; font-weight: bold;">{{ i18n.formatNumber(reverseResultsData.ecPrediction.targetEC) }} mS/cm</div>
              <div v-if="reverseResultsData.ecPrediction.ecScaling" style="font-size: 0.85em; color: #28a745;">{{ i18n.t('scaledToMatch') }}</div>
            </div>
          </div>
        </div>
        <!-- Nutrient Ratio Analysis -->
        <div v-if="reverseResultsData.ratios && reverseResultsData.ratios.length > 0" class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <ratio-card v-for="(ratioObj, index) in reverseResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
          </div>
        </div>
        <!-- Nutritional Warnings -->
        <div v-if="reverseResultsData.nutritionalWarnings && reverseResultsData.nutritionalWarnings.length > 0" class="results-section" style="margin-top: 20px;">
          <h2>{{ i18n.t('warningsAndRecommendations') }}</h2>
          <div class="warning-box">
            <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
            <ul>
              <li v-for="(warning, idx) in reverseResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
                <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
              </li>
            </ul>
          </div>
        </div>
      </template>

      <!-- Two-Tank Results (shown in wizard when twoTankDisplayData.show is true) -->
      <template v-if="wizardResultsSource && twoTankDisplayData.show">
        <div class="results-section two-tank-results" style="margin-top: 20px;">
          <!-- Header with copy button and back button -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #007bff;">{{ i18n.t('twoTankStockSolutionSystem') }}</h3>
            <div style="display: flex; gap: 10px;">
              <button class="copy-btn" :class="{ copied: copiedButtonId === 'two-tank' }" @click="copyTwoTankResultsVue()" :title="i18n.t('copyToClipboard')">
                <svg v-if="copiedButtonId !== 'two-tank'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                {{ copiedButtonId === 'two-tank' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}
              </button>
              <button class="btn-secondary" @click="hideTwoTankView()" style="padding: 8px 16px;">
                {{ i18n.t('backToNormalView') || 'Back to Normal View' }}
              </button>
            </div>
          </div>

          <p style="margin-bottom: 20px; color: #666;">{{ i18n.t('twoTankSeparationNote') }}</p>

          <!-- Tank A Section -->
          <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #007bff;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <h4 style="margin: 0; color: #007bff;">{{ twoTankDisplayData.tankA.name }}</h4>
              <button v-if="twoTankDisplayData.tankA.fertilizers.length > 0" @click="toggleTankDetailsVue('A')" style="padding: 5px 12px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                {{ twoTankDisplayData.tankA.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
              </button>
            </div>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankA.description }}</p>

            <!-- Fertilizers list -->
            <div v-if="twoTankDisplayData.tankA.fertilizers.length === 0" style="color: #999; font-style: italic;">
              {{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}
            </div>
            <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
              <div v-for="fert in twoTankDisplayData.tankA.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
                <span>{{ fert.name }}</span>
                <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
              </div>
              <div v-if="twoTankDisplayData.tankA.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #007bff20; border-radius: 4px; border-top: 2px solid #007bff; margin-top: 5px;">
                <span style="color: #007bff;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankA.fertilizers.length) }) }}</strong></span>
                <strong style="color: #007bff; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
              </div>
            </div>

            <!-- Quick summary badges -->
            <div v-if="twoTankDisplayData.tankA.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
              <span v-if="twoTankDisplayData.tankA.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankA.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankA.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankA.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankA.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankA.ionBalance.statusColor }">
                <strong :style="{ color: twoTankDisplayData.tankA.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankA.ionBalance.statusText }}</strong>
              </span>
              <span v-if="twoTankDisplayData.tankA.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankA.ecPrediction.color }">
                <strong :style="{ color: twoTankDisplayData.tankA.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ecPrediction.ec.toFixed(2)) }}</strong>
              </span>
            </div>

            <!-- Collapsible Details -->
            <div v-if="twoTankDisplayData.tankA.detailsExpanded && twoTankDisplayData.tankA.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #007bff;">
              <!-- PPM Table -->
              <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
                <tr style="background: white;">
                  <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
                  <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
                </tr>
                <tr v-for="item in twoTankDisplayData.tankA.ppmData" :key="item.label" style="background: white;">
                  <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
                  <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
                </tr>
              </table>

              <!-- Nitrogen forms -->
              <div v-if="twoTankDisplayData.tankA.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
                <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.no3Percent.toFixed(1)) }}%)</span>
              </div>

              <!-- Ratios -->
              <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
              <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <div v-if="twoTankDisplayData.tankA.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.target.label }) }}</div>
                  <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankA.ratios.target.values }}</div>
                </div>
                <div v-if="twoTankDisplayData.tankA.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.contribution.label }) }}</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankA.ratios.contribution.values }}</div>
                </div>
                <div v-if="twoTankDisplayData.tankA.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.caMg.ratio) }} : 1</div>
                </div>
                <div v-if="twoTankDisplayData.tankA.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">N:Ca</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.nCa.ratio) }} : 1</div>
                </div>
                <div v-if="twoTankDisplayData.tankA.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankA.ratios.kCa.status.color } : {}">
                  <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    {{ twoTankDisplayData.tankA.ratios.kCa.kLabel }}:Ca
                    <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankA.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
                  </div>
                  <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankA.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.kCa.ratio) }} : 1</div>
                  <div v-if="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status.color }">{{ twoTankDisplayData.tankA.ratios.kCa.status.text }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tank B Section -->
          <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #fff7f0; border-radius: 8px; border-left: 4px solid #fd7e14;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <h4 style="margin: 0; color: #fd7e14;">{{ twoTankDisplayData.tankB.name }}</h4>
              <button v-if="twoTankDisplayData.tankB.fertilizers.length > 0" @click="toggleTankDetailsVue('B')" style="padding: 5px 12px; font-size: 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
                {{ twoTankDisplayData.tankB.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
              </button>
            </div>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankB.description }}</p>

            <!-- Fertilizers list -->
            <div v-if="twoTankDisplayData.tankB.fertilizers.length === 0" style="color: #999; font-style: italic;">
              {{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}
            </div>
            <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
              <div v-for="fert in twoTankDisplayData.tankB.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
                <span>{{ fert.name }}</span>
                <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
              </div>
              <div v-if="twoTankDisplayData.tankB.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #fd7e1420; border-radius: 4px; border-top: 2px solid #fd7e14; margin-top: 5px;">
                <span style="color: #fd7e14;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankB.fertilizers.length) }) }}</strong></span>
                <strong style="color: #fd7e14; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
              </div>
            </div>

            <!-- Quick summary badges -->
            <div v-if="twoTankDisplayData.tankB.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
              <span v-if="twoTankDisplayData.tankB.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankB.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankB.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankB.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span v-if="twoTankDisplayData.tankB.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankB.ionBalance.statusColor }">
                <strong :style="{ color: twoTankDisplayData.tankB.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankB.ionBalance.statusText }}</strong>
              </span>
              <span v-if="twoTankDisplayData.tankB.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankB.ecPrediction.color }">
                <strong :style="{ color: twoTankDisplayData.tankB.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ecPrediction.ec.toFixed(2)) }}</strong>
              </span>
            </div>

            <!-- Collapsible Details -->
            <div v-if="twoTankDisplayData.tankB.detailsExpanded && twoTankDisplayData.tankB.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #fd7e14;">
              <!-- PPM Table -->
              <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
                <tr style="background: white;">
                  <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
                  <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
                </tr>
                <tr v-for="item in twoTankDisplayData.tankB.ppmData" :key="item.label" style="background: white;">
                  <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
                  <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
                </tr>
              </table>

              <!-- Nitrogen forms -->
              <div v-if="twoTankDisplayData.tankB.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
                <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.no3Percent.toFixed(1)) }}%)</span>
              </div>

              <!-- Ratios -->
              <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
              <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <div v-if="twoTankDisplayData.tankB.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.target.label }) }}</div>
                  <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankB.ratios.target.values }}</div>
                </div>
                <div v-if="twoTankDisplayData.tankB.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.contribution.label }) }}</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankB.ratios.contribution.values }}</div>
                </div>
                <div v-if="twoTankDisplayData.tankB.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.caMg.ratio) }} : 1</div>
                </div>
                <div v-if="twoTankDisplayData.tankB.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
                  <div style="font-size: 0.8em; color: #666;">N:Ca</div>
                  <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.nCa.ratio) }} : 1</div>
                </div>
                <div v-if="twoTankDisplayData.tankB.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankB.ratios.kCa.status.color } : {}">
                  <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    {{ twoTankDisplayData.tankB.ratios.kCa.kLabel }}:Ca
                    <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankB.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
                  </div>
                  <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankB.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.kCa.ratio) }} : 1</div>
                  <div v-if="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status.color }">{{ twoTankDisplayData.tankB.ratios.kCa.status.text }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Combined Solution Section -->
          <div v-if="twoTankDisplayData.combinedNutrients" class="combined-note" style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #007bff;">
            <h4 style="margin-bottom: 10px;">{{ i18n.t('combinedSolutionWhenMixed') }}</h4>
            <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">{{ i18n.t('combinedSolutionDescription') }}</p>

            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.N }}:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.P : twoTankDisplayData.combinedNutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.K : twoTankDisplayData.combinedNutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
              <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
            </div>

            <!-- EC and Totals row -->
            <div style="display: flex; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px dashed #007bff;">
              <span v-if="twoTankDisplayData.combinedEc" style="padding: 5px 10px; border-radius: 4px;" :style="{ background: twoTankDisplayData.combinedEc.color + '15', border: '1px solid ' + twoTankDisplayData.combinedEc.color }">
                <strong :style="{ color: twoTankDisplayData.combinedEc.color }">{{ i18n.t('combinedEcLabel') }} {{ i18n.formatNumber(twoTankDisplayData.combinedEc.ec.toFixed(2)) }} {{ i18n.t('mScmUnit') }} ({{ twoTankDisplayData.combinedEc.text }})</strong>
              </span>
              <span style="padding: 5px 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;">
                <strong style="color: #2e7d32;">{{ i18n.t('total') || 'Total' }}: {{ i18n.formatNumber(twoTankDisplayData.grandTotalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
                <span style="color: #666; font-size: 0.85em;"> (Tank A: {{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }} + Tank B: {{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }})</span>
              </span>
            </div>
          </div>

          <!-- Target vs Achieved Section -->
          <template v-if="wizardResultsSource === 'formula-builder' && formulaResultsData.comparison && formulaResultsData.comparison.length > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('targetVsAchieved') || 'Target vs Achieved' }}</h2>
              <div class="results-grid">
                <div v-for="item in formulaResultsData.comparison" :key="item.key" class="result-card" :style="{ borderLeft: '4px solid ' + (item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : item.className === 'miss' ? '#dc3545' : '#ddd') }">
                  <div class="result-label">{{ item.label }}</div>
                  <div class="result-value">{{ i18n.formatNumber((item.achieved || 0).toFixed(2)) }} <span :style="{ color: item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : '#dc3545', fontWeight: 'bold' }">{{ item.status }}</span></div>
                  <div v-if="item.target" class="result-target" style="font-size: 0.85em; color: #666;">{{ i18n.t('targetLabel') || 'Target:' }} {{ i18n.formatNumber(item.target.toFixed(2)) }}</div>
                </div>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'reverse-calc' && reverseResultsData.comparison && reverseResultsData.comparison.length > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('targetVsAchievedRatios') || 'Achieved PPM' }} <span class="info-icon" @click="openReversePPMExplanation()" :title="i18n.t('clickToLearnPpm')">?</span></h2>
              <div class="results-grid">
                <div v-for="item in reverseResultsData.comparison" :key="item.key" class="result-card" :style="{ borderLeft: '4px solid ' + (item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : item.className === 'miss' ? '#dc3545' : '#ddd') }">
                  <div class="result-label">{{ item.label }}</div>
                  <div class="result-value">{{ i18n.formatNumber((item.achievedPPM || 0).toFixed(2)) }} <span :style="{ color: item.className === 'match' ? '#28a745' : item.className === 'close' ? '#ffc107' : '#dc3545', fontWeight: 'bold' }">{{ item.status }}</span></div>
                  <div class="result-target" style="font-size: 0.85em; color: #666;">{{ i18n.t('ratioLabel') || 'Ratio:' }} {{ item.userInput }} → {{ i18n.formatNumber((item.achievedRatio || 0).toFixed(2)) }}</div>
                </div>
              </div>
            </div>
          </template>

          <!-- Ion Balance Section -->
          <template v-if="wizardResultsSource === 'formula-builder' && formulaResultsData.ionBalance">
            <div class="results-section" style="margin-top: 20px;">
              <h2>
                <span>{{ i18n.t('ionBalance') }}</span>
                <span class="info-icon" @click="openFormulaIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
              </h2>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="font-size: 1.5em; color: #666;">vs</div>
                <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + formulaResultsData.ionBalance.statusColor }">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(formulaResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
                  <div style="font-size: 0.85em;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ formulaResultsData.ionBalance.statusText }}</div>
                </div>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'reverse-calc' && reverseResultsData.ionBalance">
            <div class="results-section" style="margin-top: 20px;">
              <h2>
                <span>{{ i18n.t('ionBalance') }}</span>
                <span class="info-icon" @click="openReverseIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
              </h2>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="font-size: 1.5em; color: #666;">vs</div>
                <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + reverseResultsData.ionBalance.statusColor }">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(reverseResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
                  <div style="font-size: 0.85em;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ reverseResultsData.ionBalance.statusText }}</div>
                </div>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'ppm-calc' && gramsToPpmDisplayData.ionBalance">
            <div class="results-section" style="margin-top: 20px;">
              <h2>
                <span>{{ i18n.t('ionBalance') }}</span>
                <span class="info-icon" @click="openFormulaIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
              </h2>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalCations.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="font-size: 1.5em; color: #666;">vs</div>
                <div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalAnions.toFixed(2)) }}</div>
                  <div style="font-size: 0.75em; color: #888;">meq/L</div>
                </div>
                <div style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ionBalance.statusColor }">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
                  <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.imbalance.toFixed(1)) }}%</div>
                  <div style="font-size: 0.85em;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ gramsToPpmDisplayData.ionBalance.statusText }}</div>
                </div>
              </div>
            </div>
          </template>

          <!-- EC Prediction Section -->
          <template v-if="wizardResultsSource === 'formula-builder' && formulaResultsData.ecPrediction && formulaResultsData.ecPrediction.ec > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('predictedEc') }} <span class="info-icon" @click="openFormulaEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
              <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + formulaResultsData.ecPrediction.color }">
                  <div style="font-size: 2em; font-weight: bold;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ i18n.formatNumber(formulaResultsData.ecPrediction.ec.toFixed(2)) }}</div>
                  <div style="font-size: 0.9em; color: #666;">mS/cm</div>
                  <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ formulaResultsData.ecPrediction.text }}</div>
                </div>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'reverse-calc' && reverseResultsData.ecPrediction && reverseResultsData.ecPrediction.ec > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('estimatedEC') }} <span class="info-icon" @click="openReverseEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
              <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + reverseResultsData.ecPrediction.color }">
                  <div style="font-size: 2em; font-weight: bold;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ i18n.formatNumber(reverseResultsData.ecPrediction.ec.toFixed(2)) }}</div>
                  <div style="font-size: 0.9em; color: #666;">mS/cm</div>
                  <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ reverseResultsData.ecPrediction.text }}</div>
                </div>
                <div v-if="reverseResultsData.ecPrediction.targetEC" class="ec-target" style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('targetEcLabel') }}</div>
                  <div style="font-size: 1.5em; font-weight: bold;">{{ i18n.formatNumber(reverseResultsData.ecPrediction.targetEC) }} mS/cm</div>
                  <div v-if="reverseResultsData.ecPrediction.ecScaling" style="font-size: 0.85em; color: #28a745;">{{ i18n.t('scaledToMatch') }}</div>
                </div>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'ppm-calc' && gramsToPpmDisplayData.ecPrediction && gramsToPpmDisplayData.ecPrediction.ec > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('predictedEc') }} <span class="info-icon" @click="openFormulaEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
              <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ecPrediction.color + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ecPrediction.color }">
                  <div style="font-size: 2em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ec.toFixed(2)) }}</div>
                  <div style="font-size: 0.9em; color: #666;">mS/cm</div>
                  <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ gramsToPpmDisplayData.ecPrediction.text }}</div>
                </div>
                <div v-if="gramsToPpmDisplayData.ecPrediction.ionicStrength" class="ionic-strength-card" style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div style="font-size: 0.85em; color: #666;">{{ i18n.t('ionicStrength') }}</div>
                  <div style="font-size: 1.2em; font-weight: bold;">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ionicStrength.toFixed(4)) }} mol/L</div>
                </div>
              </div>
            </div>
          </template>

          <!-- Nutrient Ratio Analysis Section -->
          <template v-if="wizardResultsSource === 'formula-builder' && formulaResultsData.ratios && formulaResultsData.ratios.length > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <ratio-card v-for="(ratioObj, index) in formulaResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'reverse-calc' && reverseResultsData.ratios && reverseResultsData.ratios.length > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <ratio-card v-for="(ratioObj, index) in reverseResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
              </div>
            </div>
          </template>
          <template v-if="wizardResultsSource === 'ppm-calc' && gramsToPpmDisplayData.ratios && gramsToPpmDisplayData.ratios.length > 0">
            <div class="results-section" style="margin-top: 20px;">
              <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <ratio-card v-for="(ratioObj, index) in gramsToPpmDisplayData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
              </div>
            </div>
          </template>

          <!-- Target Deviation Warnings (for formula-builder) -->
          <template v-if="wizardResultsSource === 'formula-builder'">
            <div v-if="!formulaResultsData.allGood" class="error-box" style="margin-top: 15px;">
              <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
              <ul>
                <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
              </ul>
              <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
            </div>
            <div v-if="formulaResultsData.nutritionalWarnings && formulaResultsData.nutritionalWarnings.length > 0" class="warning-box" style="margin-top: 15px;">
              <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
              <ul>
                <li v-for="(warning, idx) in formulaResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
                  <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
                </li>
              </ul>
            </div>
          </template>

          <!-- Target Deviation Warnings (for reverse-calc) -->
          <template v-if="wizardResultsSource === 'reverse-calc'">
            <div v-if="!reverseResultsData.allGood" class="error-box" style="margin-top: 15px;">
              <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
              <ul>
                <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
              </ul>
              <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
            </div>
            <div v-if="reverseResultsData.nutritionalWarnings && reverseResultsData.nutritionalWarnings.length > 0" class="warning-box" style="margin-top: 15px;">
              <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
              <ul>
                <li v-for="(warning, idx) in reverseResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
                  <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
                </li>
              </ul>
            </div>
          </template>

          <!-- Warnings (for ppm-calc/grams-to-ppm) -->
          <template v-if="wizardResultsSource === 'ppm-calc'">
            <div v-if="gramsToPpmDisplayData.warnings && gramsToPpmDisplayData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
              <strong>{{ i18n.t('warningsAndRecommendations') }}</strong>
              <ul>
                <li v-for="(warning, idx) in gramsToPpmDisplayData.warnings" :key="idx" :class="warning.level">
                  <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
                </li>
              </ul>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>

  <!-- Calculator Content (hidden in wizard flow, used for direct access) -->
  <div id="calculator-content" class="calculator-content" :class="{ active: wizardStep === 'calculator-content' }">
    <div class="wizard-header">
      <button class="wizard-back-btn" @click="backFromCalculator()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        <span data-i18n="changeSettings">Change Settings</span>
      </button>
      <span class="wizard-current-mode" id="wizard-current-mode" v-html="modeIndicatorText"></span>
    </div>

    <div class="tabs">
      <button class="tab" :class="{ active: currentTab === 'ppm-calc' }" @click="switchTab('ppm-calc')" data-i18n="tabGramsToPpm">Grams to PPM</button>
      <button class="tab" :class="{ active: currentTab === 'formula-builder' }" @click="switchTab('formula-builder')" data-i18n="tabPpmToGrams">PPM to Grams</button>
      <button class="tab" :class="{ active: currentTab === 'reverse-calc' }" @click="switchTab('reverse-calc')" data-i18n="tabNpkRatioToGrams">NPK Ratio to Grams</button>
    </div>

    <!-- PPM Calculator Tab -->
  <div id="ppm-calc" class="tab-content" :class="{ active: currentTab === 'ppm-calc' }">
    <!-- Vue-powered Grams to PPM Calculator -->
    <div id="vue-grams-to-ppm">
      <div class="input-section">
        <div class="volume-control-row">
          <div class="volume-field">
            <label for="volume">Solution Volume:</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" id="volume" v-model.number="volume" min="0.1" step="0.1">
              <span>liters</span>
            </div>
          </div>
          <div class="button-group">
            <button @click="calculatePPM" class="btn btn-primary">
              Calculate PPM
            </button>
            <button @click="clearAll" class="btn btn-danger">
              Clear All
            </button>
          </div>
        </div>

        <div class="fertilizer-selector">
          <h3>Select Fertilizers and Enter Amounts</h3>
          <div class="search-box">
            <input type="text"
                   v-model="searchTerm"
                   data-i18n-placeholder="searchFertilizers"
                   placeholder="Search fertilizers...">
          </div>

          <!-- Vue-rendered fertilizer list -->
          <div id="fertilizer-list">
            <div v-for="fert in filteredFertilizers"
                 :key="fert.id"
                 class="fertilizer-item"
                 :class="{ active: fertilizerAmounts[fert.id]?.checked }">
              <div class="fertilizer-checkbox">
                <input type="checkbox"
                       :id="'check-' + fert.id"
                       :checked="fertilizerAmounts[fert.id]?.checked"
                       @change="toggleFertilizer(fert.id)">
              </div>
              <div class="fertilizer-info">
                <div class="fertilizer-name">
                  <label :for="'check-' + fert.id">{{ i18n.getFertilizerName(fert) }}</label>
                </div>
                <div class="fertilizer-composition">{{ formatComposition(fert) }}</div>
              </div>
              <div class="fertilizer-input">
                <input type="number"
                       :id="'grams-' + fert.id"
                       :value="fertilizerAmounts[fert.id]?.grams || 0"
                       @input="updateGrams(fert.id, $event.target.value)"
                       min="0"
                       step="0.1"
                       placeholder="0">
                <label :for="'grams-' + fert.id">g</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Vue-powered Grams to PPM Results Sections -->
  <div class="results-section" id="selected-fertilizers-section" v-if="gramsToPpmDisplayData.show && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')">
    <div class="results-header">
      <h2>{{ i18n.t('selectedFertilizers') }}</h2>
      <div id="grams-to-ppm-header-buttons" style="display: flex; gap: 10px;">
        <button class="copy-btn" :class="{ copied: copiedButtonId === 'grams-to-ppm' }" @click="copyGramsToPPMResultsVue()" :title="i18n.t('copyToClipboard')">
          <svg v-if="copiedButtonId !== 'grams-to-ppm'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          <span>{{ copiedButtonId === 'grams-to-ppm' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
        </button>
      </div>
    </div>
    <div id="selected-fertilizers-list">
      <div v-for="fert in gramsToPpmDisplayData.fertilizers" :key="fert.id" class="selected-fertilizer-item">
        <div class="selected-fertilizer-info">
          <div class="selected-fertilizer-name"><span class="fertilizer-number">{{ fert.index }}.</span> {{ i18n.getFertilizerName(fert) }}</div>
          <div class="selected-fertilizer-composition">{{ fert.composition }}</div>
        </div>
        <div class="selected-fertilizer-amount">{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
      </div>
      <div v-if="gramsToPpmDisplayData.fertilizers.length > 0" class="selected-fertilizer-item selected-fertilizer-total">
        <div class="selected-fertilizer-info">
          <div class="selected-fertilizer-name">{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(gramsToPpmDisplayData.fertilizers.length) }) }}</div>
        </div>
        <div class="selected-fertilizer-amount">{{ i18n.formatNumber(gramsToPpmDisplayData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
      </div>
      <!-- Total g/L summary -->
      <div v-if="gramsToPpmDisplayData.fertilizers.length > 0 && gramsToPpmDisplayData.volume > 0" style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
        <strong>{{ i18n.formatNumber((gramsToPpmDisplayData.totalGrams / gramsToPpmDisplayData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
        <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
      </div>
    </div>
  </div>

  <div class="results-section" id="results" v-if="gramsToPpmDisplayData.show && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')" style="margin-top: 20px;">
    <h2>
      <span>{{ i18n.t('resultsPpm') }}</span>
      <span class="info-icon" @click="openPPMExplanation()" :title="i18n.t('clickToLearnPpm')">?</span>
    </h2>
    <div class="results-grid" id="results-grid">
      <div v-for="item in gramsToPpmDisplayData.displayOrder" :key="item.key" class="result-card" :class="{ zero: item.isZero }">
        <div class="result-label">{{ item.label }}</div>
        <div class="result-value">
          {{ i18n.formatNumber((item.value || 0).toFixed(2)) }}
          <span class="result-unit">ppm</span>
        </div>
      </div>
    </div>
    <div class="conversion-note">
      <strong>{{ i18n.t('noteLabel') }}</strong> {{ i18n.t('oxideConversionNote') }}
    </div>
  </div>

  <div class="results-section" id="ion-balance-section" v-if="gramsToPpmDisplayData.show && gramsToPpmDisplayData.ionBalance && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')" style="margin-top: 20px;">
    <h2>
      <span>{{ i18n.t('ionBalance') }}</span>
      <span class="info-icon" @click="openIonBalanceExplanation()" :title="i18n.t('clickToLearnIonBalance')">?</span>
    </h2>
    <div class="ion-balance-card" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
      <div class="ion-box" style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
        <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalCations.toFixed(2)) }}</div>
        <div style="font-size: 0.75em; color: #888;">meq/L</div>
      </div>
      <div style="font-size: 1.5em; color: #666;">vs</div>
      <div class="ion-box" style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
        <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.totalAnions.toFixed(2)) }}</div>
        <div style="font-size: 0.75em; color: #888;">meq/L</div>
      </div>
      <div class="ion-box" style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ionBalance.statusColor }">
        <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
        <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ i18n.formatNumber(gramsToPpmDisplayData.ionBalance.imbalance.toFixed(1)) }}%</div>
        <div style="font-size: 0.85em;" :style="{ color: gramsToPpmDisplayData.ionBalance.statusColor }">{{ gramsToPpmDisplayData.ionBalance.statusText }}</div>
      </div>
    </div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong>{{ i18n.t('whatIsIonBalanceQuestion') }}</strong> {{ i18n.t('ionBalanceExplanationFull') }}
    </div>
  </div>

  <div class="results-section" id="ratio-analysis-section" v-if="gramsToPpmDisplayData.show && gramsToPpmDisplayData.ratios && gramsToPpmDisplayData.ratios.length > 0 && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')" style="margin-top: 20px;">
    <h2>{{ i18n.t('nutrientRatioAnalysis') }}</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
      <ratio-card v-for="(ratio, idx) in gramsToPpmDisplayData.ratios" :key="idx" :ratio="ratio" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
    </div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong>{{ i18n.t('whatAreNutrientRatios') }}</strong> {{ i18n.t('nutrientRatioExplanationFull') }}
    </div>
  </div>

  <div class="results-section" id="ec-tds-section" v-if="gramsToPpmDisplayData.show && gramsToPpmDisplayData.ecPrediction && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')" style="margin-top: 20px;">
    <h2>{{ i18n.t('achievedEc') }} <span class="info-icon" @click="openEcExplanation()" :title="i18n.t('showEcBreakdownByIon')">?</span></h2>
    <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
      <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: gramsToPpmDisplayData.ecPrediction.color + '22', borderLeft: '4px solid ' + gramsToPpmDisplayData.ecPrediction.color }">
        <div style="font-size: 2em; font-weight: bold;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ec.toFixed(2)) }}</div>
        <div style="font-size: 0.9em; color: #666;">mS/cm</div>
        <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: gramsToPpmDisplayData.ecPrediction.color }">{{ gramsToPpmDisplayData.ecPrediction.text }}</div>
      </div>
      <div v-if="gramsToPpmDisplayData.ecPrediction.ionicStrength" class="ionic-strength-card" style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <div style="font-size: 0.85em; color: #666;">{{ i18n.t('ionicStrength') }}</div>
        <div style="font-size: 1.2em; font-weight: bold;">{{ i18n.formatNumber(gramsToPpmDisplayData.ecPrediction.ionicStrength.toFixed(4)) }} mol/L</div>
      </div>
    </div>
  </div>

  <div class="results-section" id="warnings-section" v-if="gramsToPpmDisplayData.show && gramsToPpmDisplayData.warnings && gramsToPpmDisplayData.warnings.length > 0 && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')" style="margin-top: 20px;">
    <h2>{{ i18n.t('warningsAndRecommendations') }}</h2>
    <div v-for="(warning, idx) in gramsToPpmDisplayData.warnings" :key="idx" :class="warning.level === 'warning' ? 'warning-box' : warning.level === 'error' ? 'error-box' : 'conversion-note'" style="margin-bottom: 10px;">
      <strong>{{ warning.level === 'warning' ? '⚠️' : warning.level === 'error' ? '❌' : 'ℹ️' }} {{ warning.category }}</strong><br>
      {{ warning.message }}
    </div>
  </div>

  <!-- Vue-powered Two-Tank Results Section for Grams to PPM -->
  <div class="results-section two-tank-results" v-if="twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm'" style="margin-top: 20px;">
    <!-- Header with copy button and back button -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0; color: #007bff;">{{ i18n.t('twoTankStockSolutionSystem') }}</h3>
      <div style="display: flex; gap: 10px;">
        <button class="copy-btn" :class="{ copied: copiedButtonId === 'two-tank' }" @click="copyTwoTankResultsVue()" :title="i18n.t('copyToClipboard')">
          <svg v-if="copiedButtonId !== 'two-tank'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          {{ copiedButtonId === 'two-tank' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}
        </button>
        <button class="btn-secondary" @click="hideTwoTankView()" style="padding: 8px 16px;">
          {{ i18n.t('backToNormalView') || 'Back to Normal View' }}
        </button>
      </div>
    </div>

    <p style="margin-bottom: 20px; color: #666;">{{ i18n.t('twoTankSeparationNote') }}</p>

    <!-- Tank A Section -->
    <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #007bff;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <h4 style="margin: 0; color: #007bff;">{{ twoTankDisplayData.tankA.name }}</h4>
        <button v-if="twoTankDisplayData.tankA.fertilizers.length > 0" @click="toggleTankDetailsVue('A')" style="padding: 5px 12px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          {{ twoTankDisplayData.tankA.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
        </button>
      </div>
      <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankA.description }}</p>

      <!-- Fertilizers list -->
      <div v-if="twoTankDisplayData.tankA.fertilizers.length === 0" style="color: #999; font-style: italic;">
        {{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}
      </div>
      <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
        <div v-for="fert in twoTankDisplayData.tankA.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
          <span>{{ i18n.getFertilizerName(fert) }}</span>
          <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
        </div>
        <div v-if="twoTankDisplayData.tankA.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #007bff20; border-radius: 4px; border-top: 2px solid #007bff; margin-top: 5px;">
          <span style="color: #007bff;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankA.fertilizers.length) }) }}</strong></span>
          <strong style="color: #007bff; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
        </div>
      </div>

      <!-- Quick summary badges -->
      <div v-if="twoTankDisplayData.tankA.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
        <span v-if="twoTankDisplayData.tankA.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankA.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankA.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankA.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankA.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankA.ionBalance.statusColor }">
          <strong :style="{ color: twoTankDisplayData.tankA.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankA.ionBalance.statusText }}</strong>
        </span>
        <span v-if="twoTankDisplayData.tankA.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankA.ecPrediction.color }">
          <strong :style="{ color: twoTankDisplayData.tankA.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ecPrediction.ec.toFixed(2)) }}</strong>
        </span>
      </div>

      <!-- Collapsible Details -->
      <div v-if="twoTankDisplayData.tankA.detailsExpanded && twoTankDisplayData.tankA.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #007bff;">
        <!-- PPM Table -->
        <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
          <tr style="background: white;">
            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
          </tr>
          <tr v-for="item in twoTankDisplayData.tankA.ppmData" :key="item.label" style="background: white;">
            <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
          </tr>
        </table>

        <!-- Nitrogen forms -->
        <div v-if="twoTankDisplayData.tankA.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
          <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
          <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.no3Percent.toFixed(1)) }}%)</span>
        </div>

        <!-- Ratios -->
        <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <div v-if="twoTankDisplayData.tankA.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.target.label }) }}</div>
            <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankA.ratios.target.values }}</div>
          </div>
          <div v-if="twoTankDisplayData.tankA.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.contribution.label }) }}</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankA.ratios.contribution.values }}</div>
          </div>
          <div v-if="twoTankDisplayData.tankA.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.caMg.ratio) }} : 1</div>
          </div>
          <div v-if="twoTankDisplayData.tankA.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">N:Ca</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.nCa.ratio) }} : 1</div>
          </div>
          <div v-if="twoTankDisplayData.tankA.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankA.ratios.kCa.status.color } : {}">
            <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
              {{ twoTankDisplayData.tankA.ratios.kCa.kLabel }}:Ca
              <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankA.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
            </div>
            <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankA.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.kCa.ratio) }} : 1</div>
            <div v-if="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status.color }">{{ twoTankDisplayData.tankA.ratios.kCa.status.text }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tank B Section -->
    <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #fff7f0; border-radius: 8px; border-left: 4px solid #fd7e14;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <h4 style="margin: 0; color: #fd7e14;">{{ twoTankDisplayData.tankB.name }}</h4>
        <button v-if="twoTankDisplayData.tankB.fertilizers.length > 0" @click="toggleTankDetailsVue('B')" style="padding: 5px 12px; font-size: 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
          {{ twoTankDisplayData.tankB.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
        </button>
      </div>
      <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankB.description }}</p>

      <!-- Fertilizers list -->
      <div v-if="twoTankDisplayData.tankB.fertilizers.length === 0" style="color: #999; font-style: italic;">
        {{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}
      </div>
      <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
        <div v-for="fert in twoTankDisplayData.tankB.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
          <span>{{ i18n.getFertilizerName(fert) }}</span>
          <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
        </div>
        <div v-if="twoTankDisplayData.tankB.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #fd7e1420; border-radius: 4px; border-top: 2px solid #fd7e14; margin-top: 5px;">
          <span style="color: #fd7e14;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankB.fertilizers.length) }) }}</strong></span>
          <strong style="color: #fd7e14; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
        </div>
      </div>

      <!-- Quick summary badges -->
      <div v-if="twoTankDisplayData.tankB.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
        <span v-if="twoTankDisplayData.tankB.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="(twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankB.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankB.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankB.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span v-if="twoTankDisplayData.tankB.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankB.ionBalance.statusColor }">
          <strong :style="{ color: twoTankDisplayData.tankB.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankB.ionBalance.statusText }}</strong>
        </span>
        <span v-if="twoTankDisplayData.tankB.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankB.ecPrediction.color }">
          <strong :style="{ color: twoTankDisplayData.tankB.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ecPrediction.ec.toFixed(2)) }}</strong>
        </span>
      </div>

      <!-- Collapsible Details -->
      <div v-if="twoTankDisplayData.tankB.detailsExpanded && twoTankDisplayData.tankB.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #fd7e14;">
        <!-- PPM Table -->
        <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
          <tr style="background: white;">
            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
          </tr>
          <tr v-for="item in twoTankDisplayData.tankB.ppmData" :key="item.label" style="background: white;">
            <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
          </tr>
        </table>

        <!-- Nitrogen forms -->
        <div v-if="twoTankDisplayData.tankB.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
          <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
          <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.no3Percent.toFixed(1)) }}%)</span>
        </div>

        <!-- Ratios -->
        <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <div v-if="twoTankDisplayData.tankB.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.target.label }) }}</div>
            <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankB.ratios.target.values }}</div>
          </div>
          <div v-if="twoTankDisplayData.tankB.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.contribution.label }) }}</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankB.ratios.contribution.values }}</div>
          </div>
          <div v-if="twoTankDisplayData.tankB.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.caMg.ratio) }} : 1</div>
          </div>
          <div v-if="twoTankDisplayData.tankB.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.8em; color: #666;">N:Ca</div>
            <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.nCa.ratio) }} : 1</div>
          </div>
          <div v-if="twoTankDisplayData.tankB.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankB.ratios.kCa.status.color } : {}">
            <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
              {{ twoTankDisplayData.tankB.ratios.kCa.kLabel }}:Ca
              <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankB.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
            </div>
            <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankB.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.kCa.ratio) }} : 1</div>
            <div v-if="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status.color }">{{ twoTankDisplayData.tankB.ratios.kCa.status.text }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Combined Solution Section -->
    <div v-if="twoTankDisplayData.combinedNutrients" class="combined-note" style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #007bff;">
      <h4 style="margin-bottom: 10px;">{{ i18n.t('combinedSolutionWhenMixed') }}</h4>
      <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">{{ i18n.t('combinedSolutionDescription') }}</p>

      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.N }}:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.P : twoTankDisplayData.combinedNutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.K : twoTankDisplayData.combinedNutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
      </div>

      <!-- EC and Totals row -->
      <div style="display: flex; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px dashed #007bff;">
        <span v-if="twoTankDisplayData.combinedEc" style="padding: 5px 10px; border-radius: 4px;" :style="{ background: twoTankDisplayData.combinedEc.color + '15', border: '1px solid ' + twoTankDisplayData.combinedEc.color }">
          <strong :style="{ color: twoTankDisplayData.combinedEc.color }">{{ i18n.t('combinedEcLabel') }} {{ i18n.formatNumber(twoTankDisplayData.combinedEc.ec.toFixed(2)) }} {{ i18n.t('mScmUnit') }} ({{ twoTankDisplayData.combinedEc.text }})</strong>
        </span>
        <span style="padding: 5px 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;">
          <strong style="color: #2e7d32;">{{ i18n.t('total') || 'Total' }}: {{ i18n.formatNumber(twoTankDisplayData.grandTotalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          <span style="color: #666; font-size: 0.85em;"> (Tank A: {{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }} + Tank B: {{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }})</span>
        </span>
      </div>
    </div>

    <!-- Warnings -->
    <div v-if="gramsToPpmDisplayData.warnings && gramsToPpmDisplayData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
      <strong>{{ i18n.t('warningsAndRecommendations') }}</strong>
      <ul>
        <li v-for="(warning, idx) in gramsToPpmDisplayData.warnings" :key="idx" :class="warning.level">
          <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
        </li>
      </ul>
    </div>
  </div>
  </div>

  <!-- Formula Builder Tab (Vue-powered) -->
  <div id="formula-builder" class="tab-content" :class="{ active: currentTab === 'formula-builder' }">
    <div class="input-section">
      <h3>Target PPM Values</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient concentrations (at least one required). The calculator will find the best fertilizer combination to match your targets.</p>

      <div style="margin-bottom: 20px;">
        <label for="formula-calculation-mode" style="display: block; margin-bottom: 8px; font-weight: bold;">Input Mode</label>
        <select id="formula-calculation-mode" v-model="formulaCalcMode" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
          <option value="oxide">Oxide Forms (P₂O₅, K₂O) - Commercial Standard</option>
          <option value="elemental">Elemental Forms (P, K) - Pure Elements</option>
        </select>
        <p style="margin-top: 5px; margin-bottom: 15px; color: #666; font-size: 0.85em;">
          <strong>Oxide mode:</strong> Enter P₂O₅ and K₂O values (matches fertilizer labels and NPK Ratio to Grams output)<br>
          <strong>Elemental mode:</strong> Enter pure P and K values (scientific calculations)
        </p>
      </div>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="target-n">Nitrogen (N)</label>
          <input type="number" id="target-n" v-model="formulaTargets.N" min="0" step="1" placeholder="e.g., 150">
        </div>
        <div class="target-input-field">
          <label for="target-p">{{ formulaCalcMode === 'oxide' ? 'Phosphorus (P₂O₅)' : 'Phosphorus (P)' }}</label>
          <input type="number" id="target-p" v-model="formulaTargets.P" min="0" step="1" placeholder="e.g., 50">
        </div>
        <div class="target-input-field">
          <label for="target-k">{{ formulaCalcMode === 'oxide' ? 'Potassium (K₂O)' : 'Potassium (K)' }}</label>
          <input type="number" id="target-k" v-model="formulaTargets.K" min="0" step="1" placeholder="e.g., 200">
        </div>
        <div class="target-input-field">
          <label for="target-ca">Calcium (Ca)</label>
          <input type="number" id="target-ca" v-model="formulaTargets.Ca" min="0" step="1" placeholder="e.g., 150">
        </div>
        <div class="target-input-field">
          <label for="target-mg">Magnesium (Mg)</label>
          <input type="number" id="target-mg" v-model="formulaTargets.Mg" min="0" step="1" placeholder="e.g., 50">
        </div>
        <div class="target-input-field">
          <label for="target-s">Sulfur (S)</label>
          <input type="number" id="target-s" v-model="formulaTargets.S" min="0" step="1" placeholder="Optional">
        </div>
        <div class="target-input-field">
          <label for="target-si">Silicon (Si) <small style="color:#666">PPM</small></label>
          <input type="number" id="target-si" v-model="formulaTargets.Si" min="0" step="1" placeholder="Target PPM">
        </div>
      </div>

      <div class="fertilizer-selection">
        <h4>Available Fertilizers</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Select the fertilizers you have available. The calculator will use only these to build your formula.</p>
        <div class="fertilizer-search">
          <input type="text" v-model="formulaSearchTerm" placeholder="Search fertilizers...">
        </div>
        <div class="selection-controls">
          <button @click="selectAllAvailable">Select All</button>
          <button @click="deselectAllAvailable">Deselect All</button>
          <button @click="selectCommonAvailable">Select Common Only</button>
        </div>
        <div class="fertilizer-grid">
          <div v-for="fert in filteredAvailableFertilizers" :key="fert.id" class="fertilizer-checkbox-item">
            <input type="checkbox"
                   :id="'available-' + fert.id"
                   :checked="availableFertilizers[fert.id]"
                   @change="toggleAvailableFertilizer(fert.id)">
            <label :for="'available-' + fert.id">
              <span class="fertilizer-label-name">{{ i18n.getFertilizerName(fert) }}</span>
              <span v-if="fert.aliases && fert.aliases.length" class="fertilizer-label-aliases">{{ i18n.getFertilizerAliases(fert) }}</span>
            </label>
          </div>
        </div>
      </div>

      <div class="volume-input">
        <label for="formula-volume">Solution Volume:</label>
        <input type="number" id="formula-volume" v-model.number="formulaVolume" min="0.1" step="0.1">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button @click="buildFormulaVue" :disabled="formulaIsCalculating" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          {{ formulaIsCalculating ? 'Calculating...' : 'Build Formula' }}
        </button>
        <button @click="clearFormulaBuilderVue" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <!-- Vue-powered Formula Builder Results Section -->
    <div class="results-section" id="formula-results" v-if="formulaResultsData.show && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'formula')">
      <div class="results-header" id="formula-results-header">
        <h2>{{ i18n.t('recommendedFormula') }}</h2>
        <div id="formula-header-buttons" style="display: flex; gap: 10px;">
          <button class="copy-btn" :class="{ copied: copiedButtonId === 'ppm-to-grams' }" @click="copyPPMToGramsResultsVue()" :title="i18n.t('copyToClipboard')">
            <svg v-if="copiedButtonId !== 'ppm-to-grams'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <span>{{ copiedButtonId === 'ppm-to-grams' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
          </button>
        </div>
      </div>

      <!-- Fertilizers to Add -->
      <div class="formula-result">
        <h3>{{ i18n.t('fertilizersToAddPer', { volume: i18n.formatNumber(formulaResultsData.volume), unit: i18n.t('litersShort') }) }}</h3>

        <!-- Fertilizer list -->
        <div v-for="fert in formulaResultsData.fertilizers" :key="fert.id" class="formula-fertilizer">
          <div class="formula-fertilizer-info">
            <div class="formula-fertilizer-name">{{ i18n.getFertilizerName(fert) }}</div>
            <div class="formula-fertilizer-composition">{{ fert.composition }}</div>
          </div>
          <div class="formula-fertilizer-amount">{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
        </div>

        <!-- Total (if > 1 fertilizer) -->
        <div v-if="formulaResultsData.fertilizers.length > 1" class="formula-fertilizer" style="background: #e8f5e9; border-left: 4px solid #4caf50; margin-top: 10px;">
          <div class="formula-fertilizer-info">
            <div class="formula-fertilizer-name" style="color: #2e7d32; font-weight: bold;">{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(formulaResultsData.fertilizers.length) }) }}</div>
          </div>
          <div class="formula-fertilizer-amount" style="color: #2e7d32; font-size: 1.2em;">{{ i18n.formatNumber(formulaResultsData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</div>
        </div>
        <!-- Total g/L summary -->
        <div v-if="formulaResultsData.fertilizers.length > 0 && formulaResultsData.volume > 0" style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
          <strong>{{ i18n.formatNumber((formulaResultsData.totalGrams / formulaResultsData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
          <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
        </div>
      </div>

      <!-- Target Deviation Warnings - Shown prominently at top -->
      <div v-if="!formulaResultsData.allGood" class="error-box" style="margin-top: 15px;">
        <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
        <ul>
          <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
        <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
      </div>
      <div v-else-if="formulaResultsData.warnings && formulaResultsData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
        <strong>{{ i18n.t('note') }}</strong>
        <ul>
          <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
      </div>

      <!-- Comparison Table: Target vs Achieved -->
      <h3>{{ i18n.t('targetVsAchieved') }}</h3>
      <div class="comparison-table-wrapper">
        <table class="comparison-table">
          <tr>
            <th>{{ i18n.t('nutrient') }}</th>
            <th>{{ i18n.t('targetPpmHeader') }}</th>
            <th>{{ i18n.t('achievedPpmHeader') }}</th>
            <th>{{ i18n.t('difference') }}</th>
          </tr>
          <tr v-for="item in formulaResultsData.comparison" :key="item.key">
            <td>{{ item.label }}</td>
            <td>{{ i18n.formatNumber(item.target.toFixed(1)) }}</td>
            <td :class="item.className">{{ i18n.formatNumber(item.achieved.toFixed(1)) }} {{ item.status }}</td>
            <td :class="item.className">{{ item.diff >= 0 ? '+' : '' }}{{ i18n.formatNumber(item.diff.toFixed(1)) }} ({{ i18n.formatNumber(item.percentDiff.toFixed(1)) }}%)</td>
          </tr>
        </table>
      </div>

      <!-- Mode-specific conversion note -->
      <div class="conversion-note" style="margin-top: 15px;">
        <template v-if="formulaResultsData.mode === 'elemental'">
          <strong>{{ i18n.t('elementalModeLabel') }}</strong> {{ i18n.t('elementalModeNote') }}
          <br>
          {{ i18n.t('elementalToOxideConversion') }}
        </template>
        <template v-else>
          <strong>{{ i18n.t('oxideModeLabel') }}</strong> {{ i18n.t('oxideModeNote') }}
          <br>
          {{ i18n.t('oxideToElementalConversion') }}
        </template>
      </div>

      <!-- NH4-N Percentage -->
      <div class="conversion-note" style="margin-top: 15px;" v-if="formulaResultsData.result">
        <strong>{{ i18n.t('nitrogenFormLabel') }}</strong>
        {{ i18n.formatNumber(formulaResultsData.result.achieved.N_NH4.toFixed(1)) }} ppm NH₄-N
        ({{ i18n.formatNumber(formulaResultsData.nh4Percent.toFixed(1)) }}% {{ i18n.t('ofTotalN') }}),
        {{ i18n.formatNumber(formulaResultsData.result.achieved.N_NO3.toFixed(1)) }} ppm NO₃-N
        ({{ i18n.formatNumber((100 - formulaResultsData.nh4Percent).toFixed(1)) }}% {{ i18n.t('ofTotalN') }})
      </div>

      <!-- Ion Balance Section -->
      <div v-if="formulaResultsData.ionBalance" class="ion-balance-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('ionBalance') }} <span class="info-icon" @click="openFormulaIonBalanceExplanation()" title="Click to learn about ion balance">?</span></h3>
        <div class="ion-balance-card" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <div class="ion-box" style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
            <div style="font-size: 0.75em; color: #888;">meq/L</div>
          </div>
          <div style="font-size: 1.5em; color: #666;">vs</div>
          <div class="ion-box" style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(formulaResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
            <div style="font-size: 0.75em; color: #888;">meq/L</div>
          </div>
          <div class="ion-box" style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + formulaResultsData.ionBalance.statusColor }">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
            <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(formulaResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
            <div style="font-size: 0.85em;" :style="{ color: formulaResultsData.ionBalance.statusColor }">{{ formulaResultsData.ionBalance.statusText }}</div>
          </div>
        </div>
      </div>

      <!-- EC Prediction Section -->
      <div v-if="formulaResultsData.ecPrediction" class="ec-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('predictedEc') }}</h3>
        <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
          <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: formulaResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + formulaResultsData.ecPrediction.color }">
            <div style="font-size: 2em; font-weight: bold;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ i18n.formatNumber(formulaResultsData.ecPrediction.ec.toFixed(2)) }}</div>
            <div style="font-size: 0.9em; color: #666;">mS/cm</div>
            <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: formulaResultsData.ecPrediction.color }">{{ formulaResultsData.ecPrediction.text }}</div>
          </div>
        </div>
      </div>

      <!-- Nutrient Ratio Analysis -->
      <div v-if="formulaResultsData.ratios && formulaResultsData.ratios.length > 0" class="results-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('nutrientRatioAnalysis') }}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
          <ratio-card v-for="(ratioObj, index) in formulaResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
        </div>
      </div>

      <!-- Nutritional Warnings -->
      <div v-if="formulaResultsData.nutritionalWarnings && formulaResultsData.nutritionalWarnings.length > 0" class="nutritional-warnings" style="margin-top: 20px;">
        <div class="warning-box">
          <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
          <ul>
            <li v-for="(warning, idx) in formulaResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
              <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Vue-powered Two-Tank Results Section for Formula Builder -->
    <div class="results-section two-tank-results" v-if="twoTankDisplayData.show && twoTankDisplayData.sourceType === 'formula'" style="margin-top: 20px;">
      <!-- Header with copy button and back button -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; color: #007bff;">{{ i18n.t('twoTankStockSolutionSystem') }}</h3>
        <div style="display: flex; gap: 10px;">
          <button class="copy-btn" :class="{ copied: copiedButtonId === 'two-tank' }" @click="copyTwoTankResultsVue()" :title="i18n.t('copyToClipboard')">
            <svg v-if="copiedButtonId !== 'two-tank'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            {{ copiedButtonId === 'two-tank' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}
          </button>
          <button class="btn-secondary" @click="hideTwoTankView()" style="padding: 8px 16px;">
            {{ i18n.t('backToNormalView') || 'Back to Normal View' }}
          </button>
        </div>
      </div>
      <p style="margin-bottom: 20px; color: #666;">{{ i18n.t('twoTankSeparationNote') }}</p>

      <!-- Tank A Section -->
      <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #007bff;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h4 style="margin: 0; color: #007bff;">{{ twoTankDisplayData.tankA.name }}</h4>
          <button v-if="twoTankDisplayData.tankA.fertilizers.length > 0" @click="toggleTankDetailsVue('A')" style="padding: 5px 12px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            {{ twoTankDisplayData.tankA.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
          </button>
        </div>
        <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankA.description }}</p>

        <!-- Fertilizers list -->
        <div v-if="twoTankDisplayData.tankA.fertilizers.length === 0" style="color: #999; font-style: italic;">{{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}</div>
        <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
          <div v-for="fert in twoTankDisplayData.tankA.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
            <span>{{ i18n.getFertilizerName(fert) }}</span>
            <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
          <div v-if="twoTankDisplayData.tankA.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #007bff20; border-radius: 4px; border-top: 2px solid #007bff; margin-top: 5px;">
            <span style="color: #007bff;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankA.fertilizers.length) }) }}</strong></span>
            <strong style="color: #007bff; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
        </div>

        <!-- Quick summary badges -->
        <div v-if="twoTankDisplayData.tankA.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <span v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankA.ionBalance.statusColor }">
            <strong :style="{ color: twoTankDisplayData.tankA.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankA.ionBalance.statusText }}</strong>
          </span>
          <span v-if="twoTankDisplayData.tankA.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankA.ecPrediction.color }">
            <strong :style="{ color: twoTankDisplayData.tankA.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ecPrediction.ec.toFixed(2)) }}</strong>
          </span>
        </div>
      </div>

      <!-- Tank B Section -->
      <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #fff7f0; border-radius: 8px; border-left: 4px solid #fd7e14;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h4 style="margin: 0; color: #fd7e14;">{{ twoTankDisplayData.tankB.name }}</h4>
          <button v-if="twoTankDisplayData.tankB.fertilizers.length > 0" @click="toggleTankDetailsVue('B')" style="padding: 5px 12px; font-size: 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            {{ twoTankDisplayData.tankB.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
          </button>
        </div>
        <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankB.description }}</p>

        <!-- Fertilizers list -->
        <div v-if="twoTankDisplayData.tankB.fertilizers.length === 0" style="color: #999; font-style: italic;">{{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}</div>
        <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
          <div v-for="fert in twoTankDisplayData.tankB.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
            <span>{{ i18n.getFertilizerName(fert) }}</span>
            <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
          <div v-if="twoTankDisplayData.tankB.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #fd7e1420; border-radius: 4px; border-top: 2px solid #fd7e14; margin-top: 5px;">
            <span style="color: #fd7e14;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankB.fertilizers.length) }) }}</strong></span>
            <strong style="color: #fd7e14; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
        </div>

        <!-- Quick summary badges -->
        <div v-if="twoTankDisplayData.tankB.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <span v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankB.ionBalance.statusColor }">
            <strong :style="{ color: twoTankDisplayData.tankB.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankB.ionBalance.statusText }}</strong>
          </span>
          <span v-if="twoTankDisplayData.tankB.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankB.ecPrediction.color }">
            <strong :style="{ color: twoTankDisplayData.tankB.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ecPrediction.ec.toFixed(2)) }}</strong>
          </span>
        </div>
      </div>

      <!-- Combined Solution Section -->
      <div v-if="twoTankDisplayData.combinedNutrients" class="combined-note" style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #007bff;">
        <h4 style="margin-bottom: 10px;">{{ i18n.t('combinedSolutionWhenMixed') }}</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">{{ i18n.t('combinedSolutionDescription') }}</p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.N }}:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.P : twoTankDisplayData.combinedNutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.K : twoTankDisplayData.combinedNutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px dashed #007bff;">
          <span v-if="twoTankDisplayData.combinedEc" style="padding: 5px 10px; border-radius: 4px;" :style="{ background: twoTankDisplayData.combinedEc.color + '15', border: '1px solid ' + twoTankDisplayData.combinedEc.color }">
            <strong :style="{ color: twoTankDisplayData.combinedEc.color }">{{ i18n.t('combinedEcLabel') }} {{ i18n.formatNumber(twoTankDisplayData.combinedEc.ec.toFixed(2)) }} {{ i18n.t('mScmUnit') }} ({{ twoTankDisplayData.combinedEc.text }})</strong>
          </span>
          <span style="padding: 5px 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;">
            <strong style="color: #2e7d32;">{{ i18n.t('total') || 'Total' }}: {{ i18n.formatNumber(twoTankDisplayData.grandTotalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
            <span style="color: #666; font-size: 0.85em;"> (Tank A: {{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }} + Tank B: {{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }})</span>
          </span>
        </div>
      </div>

      <!-- Target Deviation Warnings -->
      <div v-if="!formulaResultsData.allGood" class="error-box" style="margin-top: 15px;">
        <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
        <ul>
          <li v-for="(w, idx) in formulaResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
        <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
      </div>

      <!-- Nutritional Warnings -->
      <div v-if="formulaResultsData.nutritionalWarnings && formulaResultsData.nutritionalWarnings.length > 0" class="warning-box" style="margin-top: 15px;">
        <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
        <ul>
          <li v-for="(warning, idx) in formulaResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
            <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Reverse Calculator Tab (Vue-powered) -->
  <div id="reverse-calc" class="tab-content" :class="{ active: currentTab === 'reverse-calc' }">
    <div class="input-section">
      <h3>Target Nutrient Ratios</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient ratios (e.g., N:P:K = 3:1:2). At least one nutrient must be greater than zero. The calculator will find fertilizer amounts that match these ratios.</p>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="reverse-n">Nitrogen (N)</label>
          <input type="number" id="reverse-n" v-model="ratioTargets.N" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-p">Phosphorus (P)</label>
          <input type="number" id="reverse-p" v-model="ratioTargets.P" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-k">Potassium (K)</label>
          <input type="number" id="reverse-k" v-model="ratioTargets.K" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-ca">Calcium (Ca)</label>
          <input type="number" id="reverse-ca" v-model="ratioTargets.Ca" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-mg">Magnesium (Mg)</label>
          <input type="number" id="reverse-mg" v-model="ratioTargets.Mg" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-s">Sulfur (S)</label>
          <input type="number" id="reverse-s" v-model="ratioTargets.S" min="0" step="1" placeholder="Optional (0 or more)">
        </div>
        <div class="target-input-field">
          <label for="reverse-si">Silicon (Si) <small style="color:#666">PPM</small></label>
          <input type="number" id="reverse-si" v-model="ratioTargets.Si" min="0" step="1" placeholder="Target PPM (not ratio)">
        </div>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-calculation-mode" style="display: block; margin-bottom: 8px; font-weight: bold;">Calculation Mode</label>
        <select id="reverse-calculation-mode" v-model="ratioCalcMode" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
          <option value="oxide">Oxide Forms (P₂O₅, K₂O) - Commercial Standard</option>
          <option value="elemental">Elemental Forms (P, K) - Pure Elements</option>
        </select>
        <p style="margin-top: 5px; margin-bottom: 15px; color: #666; font-size: 0.85em;">
          <strong>Oxide mode:</strong> Uses P₂O₅ and K₂O (standard fertilizer labels)<br>
          <strong>Elemental mode:</strong> Uses pure P and K (scientific calculations)
        </p>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-concentration" style="display: block; margin-bottom: 8px; font-weight: bold;">Target EC (mS/cm)</label>
        <select id="reverse-concentration" v-model="ratioTargetEC" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="ec:0.2">0.2 mS/cm - Plain Water Supplement</option>
          <option value="ec:0.4">0.4 mS/cm - Recovery/Flush</option>
          <option value="ec:0.6">0.6 mS/cm - Fresh Clones/Cuttings</option>
          <option value="ec:0.8">0.8 mS/cm - Rooted Cuttings</option>
          <option value="ec:1.0">1.0 mS/cm - Seedlings/Young Plants</option>
          <option value="ec:1.2">1.2 mS/cm - General Purpose</option>
          <option value="ec:1.5">1.5 mS/cm - Vegetative Growth</option>
          <option value="ec:1.8">1.8 mS/cm - Active Growth</option>
          <option value="ec:2.0">2.0 mS/cm - Heavy Feeders</option>
          <option value="ec:2.5">2.5 mS/cm - Flowering/Fruiting</option>
          <option value="ec:3.0">3.0 mS/cm - Maximum (experienced growers)</option>
        </select>
        <p style="margin-top: 5px; color: #666; font-size: 0.85em;">
          Select your target EC. Fertilizer amounts will be scaled to achieve this conductivity.<br>
          <strong>Ratios are preserved</strong> while adjusting overall concentration.
        </p>
      </div>

      <div class="fertilizer-selection">
        <h4>Select Fertilizers to Use</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Choose which fertilizers you want to use. The calculator will find the best combination from your selection.<br>
        <strong>Priority:</strong> Lower values (1-10) = more preferred. The solver will try to use higher-priority fertilizers first.</p>
        <div class="fertilizer-search">
          <input type="text" v-model="ratioSearchTerm" placeholder="Search fertilizers...">
        </div>
        <div class="selection-controls">
          <button @click="selectAllReverse">Select All</button>
          <button @click="deselectAllReverse">Deselect All</button>
          <button @click="selectCommonReverse">Select Common Only</button>
        </div>
        <div class="fertilizer-grid">
          <div v-for="fert in filteredReverseFertilizers" :key="fert.id" class="fertilizer-checkbox-item">
            <input type="checkbox"
                   :id="'reverse-' + fert.id"
                   :checked="reverseFertilizers[fert.id]?.checked"
                   @change="toggleReverseFertilizer(fert.id)">
            <label :for="'reverse-' + fert.id">
              <span class="fertilizer-label-name">{{ i18n.getFertilizerName(fert) }}</span>
              <span v-if="fert.aliases && fert.aliases.length" class="fertilizer-label-aliases">{{ i18n.getFertilizerAliases(fert) }}</span>
            </label>
            <div class="fertilizer-priority">
              <input type="number"
                     :id="'priority-' + fert.id"
                     :value="reverseFertilizers[fert.id]?.priority || 5"
                     @change="updateReversePriority(fert.id, $event.target.value)"
                     min="1"
                     max="100"
                     title="Priority (1-100, lower = more preferred)">
              <label :for="'priority-' + fert.id" title="Lower value = higher priority (more preferred)">priority</label>
            </div>
          </div>
        </div>
      </div>

      <div class="volume-input">
        <label for="reverse-volume">Solution Volume:</label>
        <input type="number" id="reverse-volume" v-model.number="ratioVolume" min="0.1" step="0.1">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button @click="calculateReverseVue" :disabled="ratioIsCalculating" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          {{ ratioIsCalculating ? 'Calculating...' : 'Calculate Fertilizers' }}
        </button>
        <button @click="clearReverseVue" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <!-- Vue-powered Reverse Results Section -->
    <div class="results-section" id="reverse-results" v-if="reverseResultsData.show && !(twoTankDisplayData.show && twoTankDisplayData.sourceType === 'reverse')">
      <div class="results-header" id="reverse-results-header">
        <h2>{{ i18n.t('requiredFertilizers') }}</h2>
        <div id="reverse-header-buttons" style="display: flex; gap: 10px;">
          <button class="copy-btn" :class="{ copied: copiedButtonId === 'npk-ratio' }" @click="copyNPKRatioResultsVue()" :title="i18n.t('copyToClipboard')">
            <svg v-if="copiedButtonId !== 'npk-ratio'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <span>{{ copiedButtonId === 'npk-ratio' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}</span>
          </button>
        </div>
      </div>

      <!-- Fertilizers to Add -->
      <div class="formula-result">
        <h3>{{ i18n.t('fertilizersToAddPer', { volume: i18n.formatNumber(reverseResultsData.volume), unit: i18n.t('litersShort') }) }}</h3>

        <!-- Error: No formula found -->
        <div v-if="reverseResultsData.fertilizers.length === 0" class="error-box">
          <strong>Unable to calculate formula</strong>
          <p>The selected fertilizers cannot achieve the target nutrient ratios. Try selecting different fertilizers or adjusting your targets.</p>
        </div>

        <!-- Fertilizer list -->
        <template v-else>
          <div v-for="fert in reverseResultsData.fertilizers" :key="fert.id" class="formula-fertilizer">
            <div class="formula-fertilizer-info">
              <div class="formula-fertilizer-name">{{ i18n.getFertilizerName(fert) }}</div>
              <div class="formula-fertilizer-composition">{{ fert.composition }}</div>
            </div>
            <div class="formula-fertilizer-amount">
              {{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}
            </div>
          </div>

          <!-- Total (if > 1 fertilizer) -->
          <div v-if="reverseResultsData.fertilizers.length > 1" class="formula-fertilizer" style="border-top: 2px solid #007bff; margin-top: 10px; padding-top: 10px; background: #e3f2fd;">
            <div class="formula-fertilizer-info">
              <div class="formula-fertilizer-name" style="color: #007bff;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(reverseResultsData.fertilizers.length) }) }}</strong></div>
              <div class="formula-fertilizer-composition">{{ i18n.formatNumber((reverseResultsData.totalGrams / reverseResultsData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</div>
            </div>
            <div class="formula-fertilizer-amount" style="color: #007bff; font-size: 1.2em;"><strong>{{ i18n.formatNumber(reverseResultsData.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong></div>
          </div>
          <!-- Average g/L per fertilizer (only for 2+) -->
          <div v-if="reverseResultsData.fertilizers.length > 1" style="text-align: center; margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 6px; font-size: 0.9em; color: #666;">
            {{ i18n.t('averagePerFertilizer') || 'Average per fertilizer' }}: <strong>{{ i18n.formatNumber((reverseResultsData.totalGrams / reverseResultsData.volume / reverseResultsData.fertilizers.length).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
          </div>
          <!-- Total g/L summary (always shown) -->
          <div style="text-align: center; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
            <strong>{{ i18n.formatNumber((reverseResultsData.totalGrams / reverseResultsData.volume).toFixed(3)) }} {{ i18n.t('gramsPerLiter') }}</strong>
            <span style="color: #666; font-size: 0.9em;"> ({{ i18n.t('totalConcentration') }})</span>
          </div>
        </template>
      </div>

      <!-- Target Deviation Warnings - Shown prominently at top -->
      <div v-if="!reverseResultsData.allGood" class="error-box" style="margin-top: 15px;">
        <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
        <ul>
          <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
        <p>{{ i18n.t('cannotAchieveExactTargetsConsider') }}</p>
        <ul>
          <li>{{ i18n.t('considerSelectingAdditionalFertilizers') }}</li>
          <li>{{ i18n.t('considerAdjustingTargetValues') }}</li>
          <li>{{ i18n.t('considerAcceptingDeviations') }}</li>
        </ul>
      </div>
      <div v-else-if="reverseResultsData.warnings && reverseResultsData.warnings.length > 0" class="warning-box" style="margin-top: 15px;">
        <strong>{{ i18n.t('note') }}</strong>
        <ul>
          <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
      </div>
      <div v-else style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 4px; margin-top: 15px;">
        <strong style="color: #28a745;">✓ {{ i18n.t('targetsSuccessfullyAchieved') }}</strong>
        <p style="margin: 5px 0 0 0;">{{ i18n.t('allNutrientValuesWithinRange') }}</p>
      </div>

      <!-- Comparison Table: Target vs Achieved -->
      <h3>{{ i18n.t('targetVsAchievedRatios') }} <span class="info-icon" @click="openReversePPMExplanation()" title="Click to learn how we calculate PPM">?</span></h3>
      <div class="comparison-table-wrapper">
        <table class="comparison-table">
          <tr>
            <th>{{ i18n.t('nutrient') }}</th>
            <th>{{ i18n.t('yourInput') }}</th>
            <th>{{ i18n.t('achievedRatio') }}</th>
            <th>{{ i18n.t('ppmAchieved') }}</th>
          </tr>
          <tr v-for="item in reverseResultsData.comparison" :key="item.key">
            <td>
              {{ item.label }}
              <small v-if="item.isPPM" style="color:#666">{{ i18n.t('ppmLabel') }}</small>
            </td>
            <td>
              <template v-if="item.isPPM">{{ i18n.formatNumber(Number(item.userInput || 0).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</template>
              <template v-else>{{ i18n.formatNumber(Number(item.userInput || 0).toFixed(2)) }}</template>
            </td>
            <td :class="item.className">
              <template v-if="item.isPPM">{{ i18n.formatNumber(Number(item.achievedRatio || 0).toFixed(1)) }} {{ i18n.t('ppmUnit') }} {{ item.status }}</template>
              <template v-else>{{ i18n.formatNumber(Number(item.achievedRatio || 0).toFixed(2)) }} {{ item.status }}</template>
            </td>
            <td>{{ i18n.formatNumber(Number(item.achievedPPM || 0).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</td>
          </tr>
        </table>
      </div>

      <!-- Mode-specific conversion note -->
      <div class="conversion-note" style="margin-top: 15px;">
        <template v-if="reverseResultsData.mode === 'elemental'">
          <strong>{{ i18n.t('elementalModeLabel') }}</strong> {{ i18n.t('elementalModeNote') }}
          <br>
          {{ i18n.t('elementalToOxideConversion') }}
        </template>
        <template v-else>
          <strong>{{ i18n.t('oxideModeLabel') }}</strong> {{ i18n.t('oxideModeNote') }}
          <br>
          {{ i18n.t('oxideToElementalConversion') }}
        </template>
      </div>

      <!-- NH4-N Percentage -->
      <div class="conversion-note" style="margin-top: 15px;" v-if="reverseResultsData.result">
        <strong>{{ i18n.t('nitrogenFormLabel') }}</strong>
        {{ i18n.formatNumber(reverseResultsData.result.achieved.N_NH4.toFixed(1)) }} ppm NH₄-N
        ({{ i18n.formatNumber(reverseResultsData.nh4Percent.toFixed(1)) }}% {{ i18n.t('ofTotalN') }}),
        {{ i18n.formatNumber(reverseResultsData.result.achieved.N_NO3.toFixed(1)) }} ppm NO₃-N
        ({{ i18n.formatNumber((100 - reverseResultsData.nh4Percent).toFixed(1)) }}% {{ i18n.t('ofTotalN') }})
      </div>

      <!-- Ion Balance Section -->
      <div v-if="reverseResultsData.ionBalance" class="ion-balance-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('ionBalance') }} <span class="info-icon" @click="openReverseIonBalanceExplanation()" title="Click to learn about ion balance">?</span></h3>
        <div class="ion-balance-card" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <div class="ion-box" style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('cations') }} (+)</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalCations.toFixed(2)) }}</div>
            <div style="font-size: 0.75em; color: #888;">meq/L</div>
          </div>
          <div style="font-size: 1.5em; color: #666;">vs</div>
          <div class="ion-box" style="background: #fce4ec; padding: 10px 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('anions') }} (-)</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #c2185b;">{{ i18n.formatNumber(reverseResultsData.ionBalance.totalAnions.toFixed(2)) }}</div>
            <div style="font-size: 0.75em; color: #888;">meq/L</div>
          </div>
          <div class="ion-box" style="padding: 10px 15px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ionBalance.statusColor + '22', borderLeft: '4px solid ' + reverseResultsData.ionBalance.statusColor }">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('imbalance') }}</div>
            <div style="font-size: 1.3em; font-weight: bold;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ i18n.formatNumber(reverseResultsData.ionBalance.imbalance.toFixed(1)) }}%</div>
            <div style="font-size: 0.85em;" :style="{ color: reverseResultsData.ionBalance.statusColor }">{{ reverseResultsData.ionBalance.statusText }}</div>
          </div>
        </div>
      </div>

      <!-- EC Prediction Section -->
      <div v-if="reverseResultsData.ecPrediction" class="ec-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('estimatedEC') }}</h3>
        <div class="ec-display" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
          <div class="ec-value" style="padding: 15px 25px; border-radius: 8px; text-align: center;" :style="{ background: reverseResultsData.ecPrediction.color + '22', borderLeft: '4px solid ' + reverseResultsData.ecPrediction.color }">
            <div style="font-size: 2em; font-weight: bold;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ i18n.formatNumber(reverseResultsData.ecPrediction.ec.toFixed(2)) }}</div>
            <div style="font-size: 0.9em; color: #666;">mS/cm</div>
            <div style="font-size: 0.85em; margin-top: 5px;" :style="{ color: reverseResultsData.ecPrediction.color }">{{ reverseResultsData.ecPrediction.text }}</div>
          </div>
          <div v-if="reverseResultsData.ecPrediction.targetEC" class="ec-target" style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
            <div style="font-size: 0.85em; color: #666;">{{ i18n.t('targetEC') }}</div>
            <div style="font-size: 1.5em; font-weight: bold;">{{ i18n.formatNumber(reverseResultsData.ecPrediction.targetEC) }} mS/cm</div>
            <div v-if="reverseResultsData.ecPrediction.ecScaling" style="font-size: 0.85em; color: #28a745;">{{ i18n.t('scaledToMatch') }}</div>
          </div>
        </div>
      </div>

      <!-- Nutrient Ratio Analysis -->
      <div v-if="reverseResultsData.ratios && reverseResultsData.ratios.length > 0" class="results-section" style="margin-top: 20px;">
        <h3>{{ i18n.t('nutrientRatioAnalysis') }}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
          <ratio-card v-for="(ratioObj, index) in reverseResultsData.ratios" :key="index" :ratio="ratioObj" @info-click="openKCaExplanation" @no3nh4-info-click="openNo3Nh4Explanation"></ratio-card>
        </div>
      </div>

      <!-- Nutritional Warnings -->
      <div v-if="reverseResultsData.nutritionalWarnings && reverseResultsData.nutritionalWarnings.length > 0" class="nutritional-warnings" style="margin-top: 20px;">
        <div class="warning-box">
          <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
          <ul>
            <li v-for="(warning, idx) in reverseResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
              <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Vue-powered Two-Tank Results Section for Reverse Calculator -->
    <div class="results-section two-tank-results" v-if="twoTankDisplayData.show && twoTankDisplayData.sourceType === 'reverse'" style="margin-top: 20px;">
      <!-- Header with copy button and back button -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; color: #007bff;">{{ i18n.t('twoTankStockSolutionSystem') }}</h3>
        <div style="display: flex; gap: 10px;">
          <button class="copy-btn" :class="{ copied: copiedButtonId === 'two-tank' }" @click="copyTwoTankResultsVue()" :title="i18n.t('copyToClipboard')">
            <svg v-if="copiedButtonId !== 'two-tank'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            {{ copiedButtonId === 'two-tank' ? i18n.t('copied') || 'Copied!' : i18n.t('copyResults') }}
          </button>
          <button class="btn-secondary" @click="hideTwoTankView()" style="padding: 8px 16px;">
            {{ i18n.t('backToNormalView') || 'Back to Normal View' }}
          </button>
        </div>
      </div>
      <p style="margin-bottom: 20px; color: #666;">{{ i18n.t('twoTankSeparationNote') }}</p>

      <!-- Tank A Section -->
      <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #007bff;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h4 style="margin: 0; color: #007bff;">{{ twoTankDisplayData.tankA.name }}</h4>
          <button v-if="twoTankDisplayData.tankA.fertilizers.length > 0" @click="toggleTankDetailsVue('A')" style="padding: 5px 12px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            {{ twoTankDisplayData.tankA.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
          </button>
        </div>
        <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankA.description }}</p>

        <!-- Fertilizers list -->
        <div v-if="twoTankDisplayData.tankA.fertilizers.length === 0" style="color: #999; font-style: italic;">{{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}</div>
        <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
          <div v-for="fert in twoTankDisplayData.tankA.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
            <span>{{ i18n.getFertilizerName(fert) }}</span>
            <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
          <div v-if="twoTankDisplayData.tankA.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #007bff20; border-radius: 4px; border-top: 2px solid #007bff; margin-top: 5px;">
            <span style="color: #007bff;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankA.fertilizers.length) }) }}</strong></span>
            <strong style="color: #007bff; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
        </div>

        <!-- Quick summary badges -->
        <div v-if="twoTankDisplayData.tankA.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <span v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.nutrients && (twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.P : twoTankDisplayData.tankA.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.nutrients && (twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankA.nutrients.K : twoTankDisplayData.tankA.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankA.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankA.ionBalance.statusColor }">
            <strong :style="{ color: twoTankDisplayData.tankA.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankA.ionBalance.statusText }}</strong>
          </span>
          <span v-if="twoTankDisplayData.tankA.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankA.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankA.ecPrediction.color }">
            <strong :style="{ color: twoTankDisplayData.tankA.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankA.ecPrediction.ec.toFixed(2)) }}</strong>
          </span>
        </div>

        <!-- Collapsible Details -->
        <div v-if="twoTankDisplayData.tankA.detailsExpanded && twoTankDisplayData.tankA.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #007bff;">
          <!-- PPM Table -->
          <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
            <tr style="background: white;">
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
              <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
            </tr>
            <tr v-for="item in twoTankDisplayData.tankA.ppmData" :key="item.label" style="background: white;">
              <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
              <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
            </tr>
          </table>

          <!-- Nitrogen forms -->
          <div v-if="twoTankDisplayData.tankA.nutrients && twoTankDisplayData.tankA.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
            <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
            <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankA.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankA.no3Percent.toFixed(1)) }}%)</span>
          </div>

          <!-- Ratios -->
          <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <div v-if="twoTankDisplayData.tankA.ratios && twoTankDisplayData.tankA.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.target.label }) }}</div>
              <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankA.ratios.target.values }}</div>
            </div>
            <div v-if="twoTankDisplayData.tankA.ratios && twoTankDisplayData.tankA.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankA.ratios.contribution.label }) }}</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankA.ratios.contribution.values }}</div>
            </div>
            <div v-if="twoTankDisplayData.tankA.ratios && twoTankDisplayData.tankA.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.caMg.ratio) }} : 1</div>
            </div>
            <div v-if="twoTankDisplayData.tankA.ratios && twoTankDisplayData.tankA.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">N:Ca</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.nCa.ratio) }} : 1</div>
            </div>
            <div v-if="twoTankDisplayData.tankA.ratios && twoTankDisplayData.tankA.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankA.ratios.kCa.status.color } : {}">
              <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
                {{ twoTankDisplayData.tankA.ratios.kCa.kLabel }}:Ca
                <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankA.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
              </div>
              <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankA.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankA.ratios.kCa.ratio) }} : 1</div>
              <div v-if="twoTankDisplayData.tankA.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankA.ratios.kCa.status.color }">{{ twoTankDisplayData.tankA.ratios.kCa.status.text }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tank B Section -->
      <div class="tank-section" style="margin-bottom: 20px; padding: 20px; background: #fff7f0; border-radius: 8px; border-left: 4px solid #fd7e14;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h4 style="margin: 0; color: #fd7e14;">{{ twoTankDisplayData.tankB.name }}</h4>
          <button v-if="twoTankDisplayData.tankB.fertilizers.length > 0" @click="toggleTankDetailsVue('B')" style="padding: 5px 12px; font-size: 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            {{ twoTankDisplayData.tankB.detailsExpanded ? (i18n.t('hideDetails') || 'Hide Details') : (i18n.t('showDetails') || 'Show Details') }}
          </button>
        </div>
        <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">{{ twoTankDisplayData.tankB.description }}</p>

        <!-- Fertilizers list -->
        <div v-if="twoTankDisplayData.tankB.fertilizers.length === 0" style="color: #999; font-style: italic;">{{ i18n.t('noFertilizersInTank') || 'No fertilizers in this tank' }}</div>
        <div v-else class="tank-fertilizers" style="margin-bottom: 15px;">
          <div v-for="fert in twoTankDisplayData.tankB.fertilizers" :key="fert.id" style="display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 4px; margin-bottom: 5px;">
            <span>{{ i18n.getFertilizerName(fert) }}</span>
            <strong>{{ i18n.formatNumber(fert.grams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
          <div v-if="twoTankDisplayData.tankB.fertilizers.length > 1" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #fd7e1420; border-radius: 4px; border-top: 2px solid #fd7e14; margin-top: 5px;">
            <span style="color: #fd7e14;"><strong>{{ i18n.t('totalFertilizers', { count: i18n.formatNumber(twoTankDisplayData.tankB.fertilizers.length) }) }}</strong></span>
            <strong style="color: #fd7e14; font-size: 1.1em;">{{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
          </div>
        </div>

        <!-- Quick summary badges -->
        <div v-if="twoTankDisplayData.tankB.fertilizers.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <span v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.N_total > 0.1" class="tank-nutrient-badge"><strong>N:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.nutrients && (twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.P : twoTankDisplayData.tankB.nutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.nutrients && (twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O) > 0.1" class="tank-nutrient-badge"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.tankB.nutrients.K : twoTankDisplayData.tankB.nutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.Ca > 0.1" class="tank-nutrient-badge"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.Mg > 0.1" class="tank-nutrient-badge"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.S > 0.1" class="tank-nutrient-badge"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span v-if="twoTankDisplayData.tankB.ionBalance" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ionBalance.statusColor + '20', border: '1px solid ' + twoTankDisplayData.tankB.ionBalance.statusColor }">
            <strong :style="{ color: twoTankDisplayData.tankB.ionBalance.statusColor }">{{ i18n.t('ionLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ionBalance.imbalance.toFixed(1)) }}% {{ twoTankDisplayData.tankB.ionBalance.statusText }}</strong>
          </span>
          <span v-if="twoTankDisplayData.tankB.ecPrediction" class="tank-status-badge" :style="{ background: twoTankDisplayData.tankB.ecPrediction.color + '15', border: '1px solid ' + twoTankDisplayData.tankB.ecPrediction.color }">
            <strong :style="{ color: twoTankDisplayData.tankB.ecPrediction.color }">{{ i18n.t('ecLabel') }} {{ i18n.formatNumber(twoTankDisplayData.tankB.ecPrediction.ec.toFixed(2)) }}</strong>
          </span>
        </div>

        <!-- Collapsible Details -->
        <div v-if="twoTankDisplayData.tankB.detailsExpanded && twoTankDisplayData.tankB.fertilizers.length > 0" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #fd7e14;">
          <!-- PPM Table -->
          <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientPpmValues') }}</h5>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
            <tr style="background: white;">
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">{{ i18n.t('nutrientHeader') }}</th>
              <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">{{ i18n.t('ppmHeader') }}</th>
            </tr>
            <tr v-for="item in twoTankDisplayData.tankB.ppmData" :key="item.label" style="background: white;">
              <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ item.label }}</td>
              <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ i18n.formatNumber((item.value || 0).toFixed(2)) }}</td>
            </tr>
          </table>

          <!-- Nitrogen forms -->
          <div v-if="twoTankDisplayData.tankB.nutrients && twoTankDisplayData.tankB.nutrients.N_total > 0.1" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
            <strong style="font-size: 0.9em;">{{ i18n.t('nitrogenFormsLabel') }}</strong><br>
            <span style="font-size: 0.85em;">NH₄-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NH4.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.nh4Percent.toFixed(1)) }}%) | NO₃-N: {{ i18n.formatNumber(twoTankDisplayData.tankB.nutrients.N_NO3.toFixed(2)) }} {{ i18n.t('ppmUnit') }} ({{ i18n.formatNumber(twoTankDisplayData.tankB.no3Percent.toFixed(1)) }}%)</span>
          </div>

          <!-- Ratios -->
          <h5 style="margin-bottom: 10px; color: #333;">{{ i18n.t('nutrientRatiosRelative') }}</h5>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <div v-if="twoTankDisplayData.tankB.ratios && twoTankDisplayData.tankB.ratios.target" style="padding: 10px 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #2e7d32;">{{ i18n.t('targetRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.target.label }) }}</div>
              <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;">{{ twoTankDisplayData.tankB.ratios.target.values }}</div>
            </div>
            <div v-if="twoTankDisplayData.tankB.ratios && twoTankDisplayData.tankB.ratios.contribution" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">{{ i18n.t('thisTankRatioLabel', { ratio: twoTankDisplayData.tankB.ratios.contribution.label }) }}</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ twoTankDisplayData.tankB.ratios.contribution.values }}</div>
            </div>
            <div v-if="twoTankDisplayData.tankB.ratios && twoTankDisplayData.tankB.ratios.caMg" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">Ca:Mg</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.caMg.ratio) }} : 1</div>
            </div>
            <div v-if="twoTankDisplayData.tankB.ratios && twoTankDisplayData.tankB.ratios.nCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #666;">N:Ca</div>
              <div style="font-size: 1.1em; font-weight: bold;">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.nCa.ratio) }} : 1</div>
            </div>
            <div v-if="twoTankDisplayData.tankB.ratios && twoTankDisplayData.tankB.ratios.kCa" style="padding: 10px 15px; background: white; border-radius: 4px; text-align: center; position: relative;" :style="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? { borderLeft: '3px solid ' + twoTankDisplayData.tankB.ratios.kCa.status.color } : {}">
              <div style="font-size: 0.8em; color: #666; display: flex; align-items: center; justify-content: center; gap: 4px;">
                {{ twoTankDisplayData.tankB.ratios.kCa.kLabel }}:Ca
                <span class="info-icon" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px;" @click="openKCaExplanation(twoTankDisplayData.tankB.ratios.kCa)" :title="i18n.t('clickToLearnKCa')">?</span>
              </div>
              <div style="font-size: 1.1em; font-weight: bold;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status?.showWarning ? twoTankDisplayData.tankB.ratios.kCa.status.color : 'inherit' }">{{ i18n.formatNumber(twoTankDisplayData.tankB.ratios.kCa.ratio) }} : 1</div>
              <div v-if="twoTankDisplayData.tankB.ratios.kCa.status?.showWarning" style="font-size: 0.7em; margin-top: 2px; font-weight: 500;" :style="{ color: twoTankDisplayData.tankB.ratios.kCa.status.color }">{{ twoTankDisplayData.tankB.ratios.kCa.status.text }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Combined Solution Section -->
      <div v-if="twoTankDisplayData.combinedNutrients" class="combined-note" style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #007bff;">
        <h4 style="margin-bottom: 10px;">{{ i18n.t('combinedSolutionWhenMixed') }}</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">{{ i18n.t('combinedSolutionDescription') }}</p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.N }}:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.N_total.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.P }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.P : twoTankDisplayData.combinedNutrients.P2O5).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>{{ twoTankDisplayData.nutrientLabels.K }}:</strong> {{ i18n.formatNumber((twoTankDisplayData.mode === 'elemental' ? twoTankDisplayData.combinedNutrients.K : twoTankDisplayData.combinedNutrients.K2O).toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Ca:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Ca.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>Mg:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.Mg.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
          <span style="padding: 5px 10px; background: #fff; border-radius: 4px;"><strong>S:</strong> {{ i18n.formatNumber(twoTankDisplayData.combinedNutrients.S.toFixed(1)) }} {{ i18n.t('ppmUnit') }}</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px dashed #007bff;">
          <span v-if="twoTankDisplayData.combinedEc" style="padding: 5px 10px; border-radius: 4px;" :style="{ background: twoTankDisplayData.combinedEc.color + '15', border: '1px solid ' + twoTankDisplayData.combinedEc.color }">
            <strong :style="{ color: twoTankDisplayData.combinedEc.color }">{{ i18n.t('combinedEcLabel') }} {{ i18n.formatNumber(twoTankDisplayData.combinedEc.ec.toFixed(2)) }} {{ i18n.t('mScmUnit') }} ({{ twoTankDisplayData.combinedEc.text }})</strong>
          </span>
          <span style="padding: 5px 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;">
            <strong style="color: #2e7d32;">{{ i18n.t('total') || 'Total' }}: {{ i18n.formatNumber(twoTankDisplayData.grandTotalGrams.toFixed(2)) }} {{ i18n.t('gramsShort') }}</strong>
            <span style="color: #666; font-size: 0.85em;"> (Tank A: {{ i18n.formatNumber(twoTankDisplayData.tankA.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }} + Tank B: {{ i18n.formatNumber(twoTankDisplayData.tankB.totalGrams.toFixed(2)) }}{{ i18n.t('gramsShort') }})</span>
          </span>
        </div>
      </div>

      <!-- Target Deviation Warnings -->
      <div v-if="!reverseResultsData.allGood" class="error-box" style="margin-top: 15px;">
        <strong>⚠ {{ i18n.t('cannotAchieveExactTargets') }}</strong>
        <ul>
          <li v-for="(w, idx) in reverseResultsData.warnings" :key="idx">{{ w }}</li>
        </ul>
        <p>{{ i18n.t('cannotAchieveExactTargetsDescription') }}</p>
      </div>

      <!-- Nutritional Warnings -->
      <div v-if="reverseResultsData.nutritionalWarnings && reverseResultsData.nutritionalWarnings.length > 0" class="warning-box" style="margin-top: 15px;">
        <strong>{{ i18n.t('nutritionalConsiderations') }}</strong>
        <ul>
          <li v-for="(warning, idx) in reverseResultsData.nutritionalWarnings" :key="idx" :class="warning.level">
            <strong v-if="warning.category">{{ warning.category }}:</strong> {{ warning.message }}
          </li>
        </ul>
      </div>
    </div>
  </div>

  </div><!-- End calculator-content -->

  <!-- Version footer -->
  <div style="text-align: center; padding: 20px 0 10px 0; margin-top: 30px; border-top: 1px solid #eee; color: #999; font-size: 0.8em;">
    v1.3.0
  </div>

</div>
{% endraw %}

<!-- Legacy static modals removed - now using Vue modal component -->

<!-- MILP dependencies -->
<script src="/assets/vendor/lp-model/lp-model.min.js"></script>
<script src="/assets/vendor/highs/highs.js"></script>

<!-- Fertilizer core calculations and data -->
<script src="/scripts/fertilizer-data.js"></script>
<script src="/scripts/fertilizer-core.js"></script>
<script src="/scripts/fertilizer-copy.js"></script>
<script src="/scripts/fertilizer-warnings.js"></script>

<!-- i18n module - locale files are lazy-loaded based on user's language selection -->
<script src="/scripts/i18n.js"></script>

<!-- Vue 3 CDN (using dev build for better error messages - switch back to .prod.js for production) -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<script>
// =============================================================================
// IMPORT CORE CALCULATIONS AND DATA FROM EXTERNAL MODULE
// =============================================================================
const {
  FERTILIZERS,
  OXIDE_CONVERSIONS,
  MOLAR_MASSES,
  IONIC_CHARGES,
  EC_CONTRIBUTIONS,
  IONIC_MOLAR_CONDUCTIVITY,
  ION_CHARGES,
  ION_DATA,
  COMMON_FERTILIZERS,
  FERTILIZER_COMPATIBILITY,
  hasCaContent,
  hasSulfateContent,
  hasPhosphateContent,
  hasSilicateContent,
  hasIncompatibleFertilizers,
  solveMilpBrowser,
  estimateEC,
  ppmToIonsForEC,
  estimateECFromPPM,
  calculateNutrientRatios,
  solveNonNegativeLeastSquares,
  pruneSolution,
  optimizeFormula
} = window.FertilizerCore;
// Note: getIonBalanceStatus and calculateIonBalanceCore are defined locally as they use i18n

// Reference to i18n module (loaded from /scripts/i18n.js)
const i18n = window.i18n;

// Wrapper for checkWarnings that passes local dependencies
function checkWarnings(results, activeFertilizers, ionBalance = null) {
  return window.FertilizerWarnings.checkWarnings(results, activeFertilizers, ionBalance, {
    i18n,
    estimateECFromPPM
  });
}

// Progress bar helper functions
// progressBar is now Vue-powered - access via window.vueApp.progressBar
// This getter provides backwards compatibility for existing code
const progressBar = {
  get _vueProgressBar() {
    return window.vueApp?.progressBar;
  },
  show(title) {
    this._vueProgressBar?.show(title);
  },
  update(percent, message) {
    this._vueProgressBar?.update(percent, message);
  },
  setIndeterminate(message) {
    this._vueProgressBar?.setIndeterminate(message);
  },
  hide() {
    this._vueProgressBar?.hide();
  },
  cancel() {
    this._vueProgressBar?.cancel();
  },
  isCancelled() {
    return this._vueProgressBar?.isCancelled() ?? false;
  }
};



// Validation functions (validateVolumeInput, validateGramsInput, validateTargetInput)
// removed - were unused, validation now handled inline in Vue or form validation

// Wizard Mode Selection
// Returns localized mode names
function getModeName(mode) {
  const modeKeys = {
    'ppm-calc': 'gramsToPpm',
    'formula-builder': 'ppmToGrams',
    'reverse-calc': 'npkRatioToGrams'
  };
  return i18n.t(modeKeys[mode]) || mode;
}

// Modes that need the calculation mode step (step 3)
const MODES_WITH_CALC_MODE = ['formula-builder', 'reverse-calc'];

// Modes that need the EC step (step 4)
const MODES_WITH_EC = ['reverse-calc'];

// EC descriptions for the dropdown (maps to i18n translation keys)
const EC_DESCRIPTIONS = {
  'ec:0.2': 'ecDesc02',
  'ec:0.4': 'ecDesc04',
  'ec:0.6': 'ecDesc06',
  'ec:0.8': 'ecDesc08',
  'ec:1.0': 'ecDesc10',
  'ec:1.2': 'ecDesc12',
  'ec:1.5': 'ecDesc15',
  'ec:1.8': 'ecDesc18',
  'ec:2.0': 'ecDesc20',
  'ec:2.5': 'ecDesc25',
  'ec:3.0': 'ecDesc30'
};

// State accessor functions - always read from Vue state (single source of truth)
function getSelectedMode() {
  return window.vueApp?.currentMode ?? null;
}
function getSelectedCalcMode() {
  // Use mode-specific calc mode based on current mode
  const mode = getSelectedMode();
  if (mode === 'formula-builder') {
    return window.vueApp?.formulaCalcMode ?? 'oxide';
  } else if (mode === 'reverse-calc') {
    return window.vueApp?.ratioCalcMode ?? 'oxide';
  }
  return window.vueApp?.wizardCalcMode ?? 'oxide';
}
function getSelectedEC() {
  return window.vueApp?.ratioTargetEC ?? 'ec:1.2';
}
// Setter functions - update Vue state directly
function setSelectedMode(mode) {
  if (window.vueApp) window.vueApp.currentMode = mode;
}
function setSelectedCalcMode(mode) {
  if (window.vueApp) window.vueApp.wizardCalcMode = mode;
}
function setSelectedEC(ec) {
  if (window.vueApp) window.vueApp.ratioTargetEC = ec;
}

// getStepCount removed - step counts now in Vue computed (getStepIndicator, getTwoTankStepIndicator)

// =============================================================================
// CENTRALIZED WIZARD STEP MANAGEMENT
// Step indicators now computed via Vue (getStepIndicator, getTwoTankStepIndicator)
// =============================================================================

/**
 * Show a specific wizard step and hide all others
 * @param {string} stepId - The ID of the step to show
 * @param {Object} options - Optional configuration
 * @param {boolean} options.scroll - Whether to scroll to top (default: true)
 */
function showWizardStep(stepId, options = {}) {
  // Delegate to Vue method for proper reactivity
  if (window.vueApp?.showWizardStepVue) {
    window.vueApp.showWizardStepVue(stepId, options);
  }
}

// =============================================================================
// END CENTRALIZED WIZARD STEP MANAGEMENT
// =============================================================================

function selectMode(tabId) {
  // Store the selected mode in Vue state (single source of truth)
  setSelectedMode(tabId);

  // Show volume step (also updates wizardStep via Vue)
  showWizardStep('volume-step');

  // Focus on the volume input via Vue
  if (window.vueApp?.focusWizardVolume) {
    window.vueApp.focusWizardVolume();
  }
}

function proceedFromVolumeStep() {
  // Validate volume via Vue
  if (window.vueApp?.validateWizardVolume && !window.vueApp.validateWizardVolume()) {
    return;
  }

  // Check if this mode needs the calculation mode step
  const mode = getSelectedMode();
  if (MODES_WITH_CALC_MODE.includes(mode)) {
    showWizardStep('calc-mode-step');
  } else if (mode === 'ppm-calc') {
    showWizardStep('grams-input-step');
    // Vue renders the fertilizer list reactively
  } else {
    // Skip directly to calculator (fallback)
    proceedToCalculator();
  }
}

function selectCalcMode(mode) {
  // Update Vue state directly (single source of truth)
  setSelectedCalcMode(mode);
}

function proceedFromCalcModeStep() {
  // Check if this mode needs the EC step (NPK Ratio → Grams)
  const mode = getSelectedMode();
  if (MODES_WITH_EC.includes(mode)) {
    showWizardStep('ec-step');
  } else if (mode === 'formula-builder') {
    // P and K labels are now handled by Vue computed properties (wizardPLabel, wizardKLabel)
    showWizardStep('ppm-targets-step');
  } else {
    // Skip to calculator (fallback)
    proceedToCalculator();
  }
}

// updateWizardPPMLabels - removed, now handled by Vue computed properties (wizardPLabel, wizardKLabel)

// updateECDescription - now handled by Vue computed property wizardECDescription

function proceedFromECStep() {
  // EC step is only for NPK Ratio → Grams, go to npk-ratios-step
  showWizardStep('npk-ratios-step');
}

function proceedToCalculator() {
  // Get the volume from Vue state
  const wizardVolumeValue = window.vueApp?.wizardVolume || 10;

  // Get current mode and calc mode from Vue state
  const mode = getSelectedMode();
  const calcMode = getSelectedCalcMode();
  const ec = getSelectedEC();

  // Update volume in all calculator tabs via Vue state (v-model handles DOM sync)
  if (window.vueApp) {
    window.vueApp.volume = wizardVolumeValue;
    window.vueApp.formulaVolume = wizardVolumeValue;
    window.vueApp.ratioVolume = wizardVolumeValue;
  }

  // Apply calculation mode if applicable via Vue state
  // v-model on selects and Vue template expressions for labels handle DOM sync automatically
  if (MODES_WITH_CALC_MODE.includes(mode) && window.vueApp) {
    if (mode === 'formula-builder') {
      window.vueApp.formulaCalcMode = calcMode;
    } else if (mode === 'reverse-calc') {
      window.vueApp.ratioCalcMode = calcMode;
    }
  }

  // Apply EC setting if applicable via Vue state
  if (MODES_WITH_EC.includes(mode) && window.vueApp) {
    window.vueApp.ratioTargetEC = ec;
  }

  // Show the calculator content (hides all wizard steps)
  showWizardStep('calculator-content', { updateIndicator: false });

  // Mode indicator is now updated via Vue computed property (modeIndicatorText)
  // which reacts to currentMode, wizardVolume, formulaCalcMode/ratioCalcMode, ratioTargetEC

  // Switch to the selected tab
  switchTab(mode);

  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function backToECStep() {
  showWizardStep('ec-step');
}

function backToCalcModeStep() {
  showWizardStep('calc-mode-step');
}

function backToVolumeStep() {
  showWizardStep('volume-step');
}

function backFromCalculator() {
  // Go back to the appropriate step based on mode
  const mode = getSelectedMode();
  if (mode === 'ppm-calc') {
    showWizardStep('grams-input-step');
  } else if (mode === 'formula-builder' || mode === 'reverse-calc') {
    showWizardStep('fertilizer-select-step');
  } else {
    showWizardStep('volume-step');
  }
}

function backFromWizardResults() {
  // Go back to the appropriate step based on mode
  const mode = getSelectedMode();
  if (mode === 'ppm-calc') {
    showWizardStep('grams-input-step');
  } else if (mode === 'formula-builder' || mode === 'reverse-calc') {
    showWizardStep('fertilizer-select-step');
  } else {
    showWizardStep('volume-step');
  }
}

// Go to mode selector (callable from anywhere, e.g., clicking the title)
function goToModeSelector() {
  // Show the mode selector (updates wizardStep via Vue)
  showWizardStep('mode-selector');

  // Reset all Vue state (single source of truth)
  if (window.vueApp) {
    window.vueApp.currentMode = null;
    window.vueApp.calculationMode = 'oxide';
    window.vueApp.wizardCalcMode = 'oxide';
    window.vueApp.ratioTargetEC = 'ec:1.2';
    // Clear pending two-tank calculation
    window.vueApp.pendingWizardCalculation = null;
    // Reset results display state (controls v-if visibility)
    window.vueApp.gramsToPpmDisplayData.show = false;
    window.vueApp.formulaResultsData.show = false;
    window.vueApp.reverseResultsData.show = false;
    window.vueApp.twoTankDisplayData.show = false;
    // Clear wizard results source
    window.vueApp.wizardResultsSource = null;
  }
}

function backToModeSelector() {
  // Clear pending two-tank calculation
  if (window.vueApp) window.vueApp.pendingWizardCalculation = null;

  // Show the mode selector (updates wizardStep via Vue)
  showWizardStep('mode-selector');

  // Reset all Vue state (single source of truth)
  if (window.vueApp) {
    window.vueApp.currentMode = null;
    window.vueApp.wizardCalcMode = 'oxide';
    window.vueApp.ratioTargetEC = 'ec:1.2';
    // Clear wizard results source
    window.vueApp.wizardResultsSource = null;
  }

  // Reset wizard inputs
  if (window.vueApp && window.vueApp.clearWizardGramsSelectionsVue) {
    window.vueApp.clearWizardGramsSelectionsVue();
  }
  clearWizardPPMTargets();
  clearWizardNPKRatios();

  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==========================================
// WIZARD STEP FUNCTIONS
// ==========================================

// --- Grams → PPM Wizard Functions ---
// NOTE: renderWizardGramsFertilizerList, filterWizardGramsFertilizers, and clearWizardGramsSelections
// have been replaced with Vue reactive templates and methods (see Vue app section)

// pendingWizardCalculation is now a Vue ref - access via window.vueApp.pendingWizardCalculation

async function calculateFromWizardGrams() {
  // Get the volume from wizard input
  const wizardVolume = window.vueApp?.wizardVolume || 10;

  // Update volume in Vue state (v-model syncs to DOM automatically)
  if (window.vueApp) {
    window.vueApp.volume = wizardVolume;
  }

  // Clear all existing fertilizer selections via Vue state
  if (window.vueApp && window.vueApp.fertilizerAmounts) {
    Object.keys(window.vueApp.fertilizerAmounts).forEach(id => {
      window.vueApp.fertilizerAmounts[id].checked = false;
      window.vueApp.fertilizerAmounts[id].grams = 0;
    });
  }

  // Transfer wizard selections to Vue state and build formula for compatibility check
  let hasSelection = false;
  const formula = {};

  // Use Vue state directly if available
  if (window.vueApp && window.vueApp.wizardGramsFertilizers) {
    FERTILIZERS.forEach(fert => {
      const wizardState = window.vueApp.wizardGramsFertilizers[fert.id];
      if (wizardState && wizardState.checked) {
        const grams = parseFloat(wizardState.grams) || 0;
        if (grams > 0) {
          // Update Vue state for main calculator
          if (window.vueApp.fertilizerAmounts && window.vueApp.fertilizerAmounts[fert.id]) {
            window.vueApp.fertilizerAmounts[fert.id].checked = true;
            window.vueApp.fertilizerAmounts[fert.id].grams = grams;
          }
          hasSelection = true;
          formula[fert.id] = grams;
        }
      }
    });
  }

  if (!hasSelection) {
    alert(i18n.t('alertSelectFertilizerAndAmount'));
    return;
  }

  // Run the calculation (this renders results in the main calculator)
  await calculate();

  // Set wizard results source to show results via Vue template (no innerHTML copying needed)
  if (window.vueApp) {
    window.vueApp.wizardResultsSource = 'ppm-calc';
  }

  // Build mode indicator text
  const mode = getSelectedMode();
  const indicatorText = i18n.t('currentLabel') + ' <strong>' + getModeName(mode) + '</strong> · ' + wizardVolume + i18n.t('litersShort');

  // Check for incompatible fertilizers
  if (hasIncompatibleFertilizers(formula)) {
    // Store pending calculation for later (via Vue ref)
    if (window.vueApp) {
      window.vueApp.pendingWizardCalculation = {
        type: 'grams-to-ppm',
        formula: formula,
        volume: wizardVolume,
        indicatorText: indicatorText,
        previousStep: 'grams-input-step'
      };
    }

    // Show two-tank question step (step indicator computed by Vue getTwoTankStepIndicator)
    showWizardStep('two-tank-question-step');
  } else {
    // No incompatibilities - show results directly
    if (window.vueApp) {
      window.vueApp.wizardResultsModeText = indicatorText;
    }
    showWizardStep('wizard-results', { updateIndicator: false });
  }
}

// --- PPM → Grams Wizard Functions ---

function clearWizardPPMTargets() {
  // Clear via Vue state
  if (window.vueApp?.wizardTargets) {
    Object.keys(window.vueApp.wizardTargets).forEach(key => {
      window.vueApp.wizardTargets[key] = '';
    });
  }
}

function proceedToFormulaFertilizerStep() {
  // Validate that at least one target is entered (via Vue state)
  const targets = window.vueApp?.wizardTargets || {};
  const fields = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
  const hasTarget = fields.some(field => parseFloat(targets[field]) > 0);

  if (!hasTarget) {
    alert(i18n.t('alertEnterTargetPpm'));
    return;
  }

  // Vue renders the fertilizer selection list reactively

  // Show fertilizer select step
  showWizardStep('fertilizer-select-step');
}

// --- NPK Ratio → Grams Wizard Functions ---

function clearWizardNPKRatios() {
  // Clear via Vue state
  if (window.vueApp?.wizardRatios) {
    Object.keys(window.vueApp.wizardRatios).forEach(key => {
      window.vueApp.wizardRatios[key] = '';
    });
  }
}

function proceedToReverseFertilizerStep() {
  // Validate that at least one ratio is entered (via Vue state)
  const ratios = window.vueApp?.wizardRatios || {};
  const fields = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
  const hasRatio = fields.some(field => parseFloat(ratios[field]) > 0);

  if (!hasRatio) {
    alert(i18n.t('alertEnterRatioValue'));
    return;
  }

  // Vue renders the fertilizer selection list reactively

  // Show fertilizer select step
  showWizardStep('fertilizer-select-step');
}

// --- Shared Fertilizer Selection Functions ---
// NOTE: renderWizardAvailableFertilizerList, filterWizardAvailableFertilizers, selectAllWizardFertilizers,
// deselectAllWizardFertilizers, and selectCommonWizardFertilizers have been replaced with
// Vue reactive templates and methods (see Vue app section)

function backFromFertilizerSelectStep() {
  const mode = getSelectedMode();
  if (mode === 'formula-builder') {
    // Go back to PPM targets step
    showWizardStep('ppm-targets-step');
  } else if (mode === 'reverse-calc') {
    // Go back to NPK ratios step
    showWizardStep('npk-ratios-step');
  }
}

async function calculateFromWizardFertilizerSelect() {
  // Get the volume from Vue state
  const wizardVolume = window.vueApp?.wizardVolume || 10;

  // Get current mode, calc mode, and EC from Vue state
  const mode = getSelectedMode();
  const calcMode = getSelectedCalcMode();
  const ec = getSelectedEC();

  // Get selected fertilizers from Vue state
  const selectedFerts = [];
  if (window.vueApp && window.vueApp.wizardAvailFertilizers) {
    FERTILIZERS.forEach(fert => {
      if (window.vueApp.wizardAvailFertilizers[fert.id]) {
        selectedFerts.push(fert.id);
      }
    });
  }

  if (selectedFerts.length === 0) {
    alert(i18n.t('alertSelectFertilizer'));
    return;
  }

  // Build mode indicator text
  let indicatorText = i18n.t('currentLabel') + ' <strong>' + getModeName(mode) + '</strong> · ' + wizardVolume + i18n.t('litersShort');
  indicatorText += ' · ' + (calcMode === 'oxide' ? i18n.t('oxideShort') : i18n.t('elementalShort'));

  let calculatedFormula = null;

  if (mode === 'formula-builder') {
    // PPM → Grams calculation
    // Transfer target PPM values from wizard Vue state to main calculator Vue state
    const wTargets = window.vueApp?.wizardTargets || {};

    // Sync to Vue state (v-model syncs to DOM automatically)
    if (window.vueApp && window.vueApp.formulaTargets) {
      window.vueApp.formulaTargets.N = wTargets.N || '';
      window.vueApp.formulaTargets.P = wTargets.P || '';
      window.vueApp.formulaTargets.K = wTargets.K || '';
      window.vueApp.formulaTargets.Ca = wTargets.Ca || '';
      window.vueApp.formulaTargets.Mg = wTargets.Mg || '';
      window.vueApp.formulaTargets.S = wTargets.S || '';
      window.vueApp.formulaTargets.Si = wTargets.Si || '0';
    }

    // Sync volume and calculation mode to Vue state
    // v-model on selects and Vue template expressions for labels handle DOM sync automatically
    if (window.vueApp) {
      window.vueApp.formulaVolume = wizardVolume;
      window.vueApp.formulaCalcMode = calcMode;
    }

    // Transfer fertilizer selections to main calculator Vue state
    if (window.vueApp && window.vueApp.availableFertilizers) {
      FERTILIZERS.forEach(fert => {
        window.vueApp.availableFertilizers[fert.id] = selectedFerts.includes(fert.id);
      });
    }

    // Run the calculation and wait for it to complete
    await buildFormula();

    // Set wizard results source to show results via Vue template (no innerHTML copying needed)
    if (window.vueApp) {
      window.vueApp.wizardResultsSource = 'formula-builder';
    }

    // Get the calculated formula for incompatibility check
    const lastFormula = window.vueApp?.lastFormulaCalculation;
    if (lastFormula && lastFormula.result) {
      calculatedFormula = lastFormula.result.formula;
    }

  } else if (mode === 'reverse-calc') {
    // NPK Ratio → Grams calculation
    // Transfer ratio values from wizard Vue state to main calculator Vue state
    const wRatios = window.vueApp?.wizardRatios || {};

    // Sync to Vue state (v-model syncs to DOM automatically)
    if (window.vueApp && window.vueApp.ratioTargets) {
      window.vueApp.ratioTargets.N = wRatios.N || '';
      window.vueApp.ratioTargets.P = wRatios.P || '';
      window.vueApp.ratioTargets.K = wRatios.K || '';
      window.vueApp.ratioTargets.Ca = wRatios.Ca || '';
      window.vueApp.ratioTargets.Mg = wRatios.Mg || '';
      window.vueApp.ratioTargets.S = wRatios.S || '';
      window.vueApp.ratioTargets.Si = wRatios.Si || '0';
    }

    // Sync volume, EC, and calculation mode to Vue state
    // v-model on selects and Vue template expressions for labels handle DOM sync automatically
    if (window.vueApp) {
      window.vueApp.ratioVolume = wizardVolume;
      window.vueApp.ratioTargetEC = ec;
      window.vueApp.ratioCalcMode = calcMode;
    }

    // Transfer fertilizer selections to main calculator Vue state
    if (window.vueApp && window.vueApp.reverseFertilizers) {
      FERTILIZERS.forEach(fert => {
        // reverseFertilizers uses { checked: boolean, priority: number } structure
        if (window.vueApp.reverseFertilizers[fert.id]) {
          window.vueApp.reverseFertilizers[fert.id].checked = selectedFerts.includes(fert.id);
        }
      });
    }

    // Add EC to indicator
    const ecValue = ec.replace('ec:', '');
    indicatorText += ' · ' + ecValue + ' mS/cm';

    // Run the calculation and wait for it to complete
    await calculateReverse();

    // Set wizard results source to show results via Vue template (no innerHTML copying needed)
    if (window.vueApp) {
      window.vueApp.wizardResultsSource = 'reverse-calc';
    }

    // Get the calculated formula for incompatibility check
    const lastReverse = window.vueApp?.lastReverseCalculation;
    if (lastReverse && lastReverse.result) {
      calculatedFormula = lastReverse.result.formula;
    }
  }

  // Check for incompatible fertilizers
  if (calculatedFormula && hasIncompatibleFertilizers(calculatedFormula)) {
    // Store pending calculation for later (via Vue ref)
    if (window.vueApp) {
      window.vueApp.pendingWizardCalculation = {
        type: mode === 'formula-builder' ? 'ppm-to-grams' : 'npk-ratio-to-grams',
        formula: calculatedFormula,
        volume: wizardVolume,
        indicatorText: indicatorText,
        previousStep: 'fertilizer-select-step'
      };
    }

    // Show two-tank question step (step indicator computed by Vue getTwoTankStepIndicator)
    showWizardStep('two-tank-question-step');
  } else {
    // No incompatibilities - show results directly
    if (window.vueApp) {
      window.vueApp.wizardResultsModeText = indicatorText;
    }
    showWizardStep('wizard-results', { updateIndicator: false });
  }
}

// --- Two-Tank Question Step Functions ---

// Skip two-tank view and show regular results
function skipTwoTankView() {
  const pendingCalc = window.vueApp?.pendingWizardCalculation;
  // Update the mode indicator in wizard results
  if (pendingCalc && window.vueApp) {
    window.vueApp.wizardResultsModeText = pendingCalc.indicatorText;

    // Set wizard results source based on calculation type (Vue template handles rendering)
    if (pendingCalc.type === 'grams-to-ppm') {
      window.vueApp.wizardResultsSource = 'ppm-calc';
    }
  }

  // Clear pending calculation
  if (window.vueApp) window.vueApp.pendingWizardCalculation = null;

  // Show wizard results
  showWizardStep('wizard-results', { updateIndicator: false });
}

// Show two-tank view
function showTwoTankView() {
  const pendingCalc = window.vueApp?.pendingWizardCalculation;
  if (!pendingCalc) {
    alert(i18n.t('alertNoCalculationData'));
    return;
  }

  const { type, indicatorText } = pendingCalc;

  // Call the appropriate two-tank display function based on calculation type
  if (type === 'grams-to-ppm') {
    displayTwoTankGramsToPPMResults();
  } else if (type === 'ppm-to-grams') {
    displayTwoTankFormulaResults();
  } else if (type === 'npk-ratio-to-grams') {
    displayTwoTankReverseResults();
  }

  // Set wizard results source based on calculation type (Vue template handles rendering)
  if (window.vueApp) {
    if (type === 'grams-to-ppm') {
      window.vueApp.wizardResultsSource = 'ppm-calc';
    } else if (type === 'ppm-to-grams') {
      window.vueApp.wizardResultsSource = 'formula-builder';
    } else if (type === 'npk-ratio-to-grams') {
      window.vueApp.wizardResultsSource = 'reverse-calc';
    }
    // Update the mode indicator in wizard results via Vue state
    window.vueApp.wizardResultsModeText = indicatorText + ' · <span style="color: #17a2b8;">' + i18n.t('twoTankView') + '</span>';
  }

  // Clear pending calculation
  if (window.vueApp) window.vueApp.pendingWizardCalculation = null;

  // Show wizard results
  showWizardStep('wizard-results', { updateIndicator: false });
}

// backFromTwoTankQuestion - removed, was unused

// refreshWizardResults - no longer needed
// Vue templates in wizard-results-container react directly to state changes and i18n updates
// Kept as no-op for backwards compatibility with i18n.js calls
function refreshWizardResults() {
  // No-op: Vue templates handle reactivity automatically
}

// Expose refreshWizardResults globally for i18n backwards compatibility
window.refreshWizardResults = refreshWizardResults;

// ==========================================
// END WIZARD STEP FUNCTIONS
// ==========================================

// Initialize the page
function init() {
  // Fertilizer lists are now rendered by Vue
  // Enter key support for wizard steps is now handled by Vue @keydown.enter directives

  // Initialize i18n (update UI with current language)
  i18n.updateUI();

  // Language selector is now initialized via Vue v-model binding to language ref
}

// setupWizardKeyboardNavigation - removed, now handled by Vue @keydown.enter directives on each step

// Legacy DOM functions removed - now handled by Vue

// Legacy display functions removed - now handled by Vue via setGramsToPpmResults

// lastGramsToPPMCalculation is now a Vue ref - access via window.vueApp.lastGramsToPPMCalculation

// Main calculation function
async function calculate() {
  // Now handled by Vue
  if (window.vueApp && window.vueApp.calculatePPM) {
    window.vueApp.calculatePPM();
    // Wait for Vue to render the results
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}


// ============================================================
// REUSABLE RENDER FUNCTIONS (to reduce code duplication)
// ============================================================

/**
 * Renders EC breakdown by ion table (collapsible)
 * @param {Object} ecPrediction - EC prediction data with contributions
 * @returns {string} HTML string
 */
function renderEcBreakdownTable(ecPrediction) {
  if (!ecPrediction || !ecPrediction.contributions) return '';

  const ionContributions = Object.entries(ecPrediction.contributions)
    .sort((a, b) => b[1].contribution_mS_cm - a[1].contribution_mS_cm);

  if (ionContributions.length === 0) return '';

  let html = `<details style="margin-top: 10px;">
    <summary style="cursor: pointer; color: #007bff; font-size: 0.9em;">${i18n.t('showEcBreakdownByIon')}</summary>
    <div style="margin-top: 10px; background: #f8f9fa; padding: 15px; border-radius: 4px;">
      <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="text-align: left; padding: 8px;">${i18n.t('ionHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('concMmolLHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('lambdaHeader')}</th>
            <th style="text-align: right; padding: 8px;">${i18n.t('ecContribHeader')}</th>
          </tr>
        </thead>
        <tbody>`;

  ionContributions.forEach(([ion, data]) => {
    const percentage = i18n.formatNumber((data.contribution_mS_cm / ecPrediction.rawEC * 100).toFixed(1));
    html += `
          <tr style="border-bottom: 1px solid #dee2e6;">
            <td style="padding: 8px;">${ion}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.concentration_mmolL.toFixed(2))}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.lambda)}</td>
            <td style="text-align: right; padding: 8px;">${i18n.formatNumber(data.contribution_mS_cm.toFixed(3))} ${i18n.t('mScmUnit')} (${percentage}%)</td>
          </tr>`;
  });

  html += `
        </tbody>
      </table>
      <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
        <strong>${i18n.t('ecBreakdownNote')}</strong> ${i18n.t('rawEcLabel')} = ${i18n.formatNumber(ecPrediction.rawEC.toFixed(3))} ${i18n.t('mScmUnit')}.
        ${i18n.t('ionicStrengthCorrectionApplied', { factor: i18n.formatNumber((ecPrediction.rawEC / ecPrediction.ec_mS_cm).toFixed(3)) })}
      </div>
    </div>
  </details>`;

  return html;
}

// Removed unused render functions (now handled by Vue templates):
// - renderNutrientRatioCards
// - renderNutritionalWarnings
// - renderIonBalanceExplanation
// - renderOxideConversionTable
// - renderOxideConversionExplanation

/**
 * Determines EC status color and text based on EC value
 * @param {number} ecValue - EC value in mS/cm
 * @returns {Object} {color, text} - Status color and localized text
 */
function getEcStatus(ecValue) {
  if (ecValue < 0.8) {
    return { color: '#17a2b8', text: i18n.t('ecVeryLight') };
  } else if (ecValue < 1.2) {
    return { color: '#28a745', text: i18n.t('ecLight') };
  } else if (ecValue < 1.8) {
    return { color: '#28a745', text: i18n.t('ecModerate') };
  } else if (ecValue < 2.5) {
    return { color: '#ffc107', text: i18n.t('ecStrong') };
  } else if (ecValue < 3.5) {
    return { color: '#fd7e14', text: i18n.t('ecVeryStrong') };
  } else {
    return { color: '#dc3545', text: i18n.t('ecVeryHigh') };
  }
}

/**
 * Determines ion balance status color and text based on imbalance percentage
 * @param {number} imbalance - Imbalance percentage
 * @param {boolean} useSymbols - Whether to use symbols (✓, ⚠, ✗) in status text
 * @returns {Object} {statusColor, statusText} - Status color and localized text
 */
function getIonBalanceStatus(imbalance, useSymbols = true) {
  let statusColor, statusText;
  if (imbalance <= 10) {
    statusColor = '#28a745';
    statusText = useSymbols ? i18n.t('balancedCheck') : i18n.t('balanced');
  } else if (imbalance <= 20) {
    statusColor = '#ffc107';
    statusText = useSymbols ? i18n.t('cautionWarning') : i18n.t('caution');
  } else {
    statusColor = '#dc3545';
    statusText = useSymbols ? i18n.t('imbalancedX') : i18n.t('imbalanced');
  }
  return { statusColor, statusText };
}

/**
 * Determines K:Ca ratio warning status based on ratio value
 * Returns status info including color, text, and level for UI display
 *
 * Thresholds based on agronomic guidance:
 * - 0.7:1 to 1.5:1 → generally balanced for many feeds
 * - 1.5:1 to 2.0:1 → K-leaning (watch quality/new growth)
 * - > 2.0:1 → K-skewed / K-heavy (higher risk of Ca uptake suppression)
 * - < 0.6:1 → Ca-skewed / Ca-heavy (can limit K-driven performance)
 *
 * Note: Even 1.5-2.0:1 can behave like "too K-heavy" when:
 * - EC/salts are high, media dries between irrigations
 * - Heat stress periods, low root activity
 *
 * @param {number} ratio - K:Ca ratio value (K divided by Ca)
 * @returns {Object} {color, text, level, showWarning} - Status info
 */
function getKCaWarningStatus(ratio) {
  if (ratio === null || ratio === undefined || isNaN(ratio)) {
    return { color: '#6c757d', text: '', level: 'unknown', showWarning: false };
  }

  // Ca-heavy / Ca-skewed (< 0.6) - can limit K-driven performance
  if (ratio < 0.6) {
    return {
      color: '#fd7e14',
      text: i18n.t('kCaRatioStatusLow'),
      level: 'low',
      showWarning: true
    };
  }
  // Borderline Ca-heavy (0.6 - 0.7)
  if (ratio < 0.7) {
    return {
      color: '#ffc107',
      text: i18n.t('kCaRatioStatusLow'),
      level: 'lowBorderline',
      showWarning: true
    };
  }
  // Good range (0.7 - 1.5) - Balanced for many feeds
  if (ratio <= 1.5) {
    return {
      color: '#28a745',
      text: i18n.t('kCaRatioStatusGood'),
      level: 'good',
      showWarning: false
    };
  }
  // K-leaning (1.5 - 2.0) - Watch quality/new growth
  if (ratio <= 2.0) {
    return {
      color: '#ffc107',
      text: i18n.t('kCaRatioStatusKLeaning'),
      level: 'kLeaning',
      showWarning: true
    };
  }
  // K-heavy / K-skewed (> 2.0) - Higher risk of Ca uptake suppression
  return {
    color: '#dc3545',
    text: i18n.t('kCaRatioStatusHigh'),
    level: 'high',
    showWarning: true
  };
}

/**
 * Helper function to get warning status for NO3:NH4 ratio.
 * Thresholds based on nitrogen form research:
 * - ≥ 10:1 — Very nitrate-dominant (usually safest)
 * - 4:1 to 10:1 — Generally OK
 * - 2:1 to 4:1 — Getting NH₄-heavy (watch closely)
 * - < 2:1 — Ammonium-heavy (higher risk)
 *
 * @param {number} ratio - NO3:NH4 ratio value (NO3 divided by NH4)
 * @returns {Object} {color, text, level, showWarning} - Status info
 */
function getNo3Nh4WarningStatus(ratio) {
  if (ratio === null || ratio === undefined || isNaN(ratio)) {
    return { color: '#6c757d', text: '', level: 'unknown', showWarning: false };
  }

  // Ammonium-heavy (< 2:1) - Higher risk
  if (ratio < 2) {
    return {
      color: '#dc3545',
      text: i18n.t('no3Nh4StatusDanger'),
      level: 'danger',
      showWarning: true
    };
  }
  // Getting NH4-heavy (2:1 to 4:1) - Watch closely
  if (ratio < 4) {
    return {
      color: '#fd7e14',
      text: i18n.t('no3Nh4StatusWatch'),
      level: 'watch',
      showWarning: true
    };
  }
  // Generally OK (4:1 to 10:1)
  if (ratio < 10) {
    return {
      color: '#28a745',
      text: i18n.t('no3Nh4StatusGood'),
      level: 'good',
      showWarning: false
    };
  }
  // Very nitrate-dominant (≥ 10:1) - Usually safest
  return {
    color: '#17a2b8',
    text: i18n.t('no3Nh4StatusVeryHigh'),
    level: 'veryHigh',
    showWarning: false
  };
}

/**
 * Core ion balance calculation - unified function for all modes
 * @param {Object|Array} fertilizers - Either array of {id, grams} or object {fertId: grams}
 * @param {number} volume - Solution volume in liters
 * @param {Object} options - Optional settings
 * @param {boolean} options.includeBreakdown - Include per-fertilizer breakdown (default false)
 * @param {boolean} options.useSymbols - Use symbols in status text (default true)
 * @returns {Object} Complete ion balance data
 */
function calculateIonBalanceCore(fertilizers, volume, options = {}) {
  const { includeBreakdown = false, useSymbols = true } = options;

  let totalCations = 0;
  let totalAnions = 0;
  const ionDetails = {};
  const fertilizerBreakdown = [];

  // Normalize input: convert object to array if needed
  const fertArray = Array.isArray(fertilizers)
    ? fertilizers
    : Object.entries(fertilizers).map(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        return fert ? { ...fert, grams } : { id: fertId, grams };
      });

  fertArray.forEach(fert => {
    const ionData = ION_DATA[fert.id];
    if (!ionData || !fert.grams || fert.grams <= 0) return;

    const moles = fert.grams / ionData.molarMass;
    const fertIons = [];

    ionData.ions.forEach(ionInfo => {
      const meq = moles * ionInfo.count * ionInfo.charge * 1000;
      const meqPerLiter = meq / volume;

      if (includeBreakdown) {
        fertIons.push({
          ...ionInfo,
          meq: meqPerLiter,
          calculation: { moles, meq, meqPerLiter }
        });
      }

      // Track by ion name
      if (!ionDetails[ionInfo.ion]) {
        ionDetails[ionInfo.ion] = { meq: 0, type: ionInfo.type };
      }
      ionDetails[ionInfo.ion].meq += meqPerLiter;

      // Add to totals
      if (ionInfo.type === 'cation') {
        totalCations += meqPerLiter;
      } else {
        totalAnions += meqPerLiter;
      }
    });

    if (includeBreakdown) {
      fertilizerBreakdown.push({
        fert,
        ionData,
        moles,
        ions: fertIons
      });
    }
  });

  const average = (totalCations + totalAnions) / 2;
  const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;
  const { statusColor, statusText } = getIonBalanceStatus(imbalance, useSymbols);

  const result = {
    totalCations,
    totalAnions,
    imbalance,
    statusColor,
    statusText,
    ionDetails
  };

  if (includeBreakdown) {
    result.fertilizerBreakdown = fertilizerBreakdown;
  }

  return result;
}

/**
 * Renders ion balance breakdown showing individual cations and anions
 * @param {Object} ionDetails - Ion details from calculateIonBalanceCore
 * @param {number} totalCations - Total cations in meq/L
 * @param {number} totalAnions - Total anions in meq/L
 * @param {boolean} compact - If true, renders a compact inline view (default false)
 * @returns {string} HTML string
 */
function renderIonBalanceBreakdown(ionDetails, totalCations, totalAnions, compact = false) {
  const cations = Object.entries(ionDetails).filter(([, data]) => data.type === 'cation');
  const anions = Object.entries(ionDetails).filter(([, data]) => data.type === 'anion');

  if (cations.length === 0 && anions.length === 0) return '';

  if (compact) {
    // Compact inline view - ions as small badges in a flex row
    let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">';

    // Cations
    html += `<span style="font-size: 0.75em; color: #28a745; font-weight: bold;">${i18n.t('cationsPlus')}:</span>`;
    cations.forEach(([ion, data]) => {
      html += `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${ion} <strong>${i18n.formatNumber(data.meq.toFixed(1))}</strong></span>`;
    });

    // Separator
    html += `<span style="color: #ccc; margin: 0 4px;">|</span>`;

    // Anions
    html += `<span style="font-size: 0.75em; color: #dc3545; font-weight: bold;">${i18n.t('anionsMinus')}:</span>`;
    anions.forEach(([ion, data]) => {
      html += `<span style="background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${ion} <strong>${i18n.formatNumber(data.meq.toFixed(1))}</strong></span>`;
    });

    html += '</div>';
    return html;
  }

  // Full breakdown view - two columns
  let html = '<div class="ion-balance-breakdown">';

  // Cations column
  html += `<div><h4 style="margin-top: 0; color: #007bff;">${i18n.t('cationsPlus')}</h4>`;
  cations.forEach(([ion, data]) => {
    const percentage = totalCations > 0 ? (data.meq / totalCations * 100).toFixed(1) : 0;
    html += `
      <div class="ion-list-item">
        <span>${ion}</span>
        <span><strong>${i18n.formatNumber(data.meq.toFixed(2))}</strong> meq/L (${i18n.formatNumber(percentage)}%)</span>
      </div>
    `;
  });
  html += '</div>';

  // Anions column
  html += `<div><h4 style="margin-top: 0; color: #007bff;">${i18n.t('anionsMinus')}</h4>`;
  anions.forEach(([ion, data]) => {
    const percentage = totalAnions > 0 ? (data.meq / totalAnions * 100).toFixed(1) : 0;
    html += `
      <div class="ion-list-item">
        <span>${ion}</span>
        <span><strong>${i18n.formatNumber(data.meq.toFixed(2))}</strong> meq/L (${i18n.formatNumber(percentage)}%)</span>
      </div>
    `;
  });
  html += '</div></div>';

  return html;
}

/**
 * Renders ion balance summary cards (cations, anions, imbalance)
 * @param {Object} ionBalance - Ion balance data with totalCations, totalAnions, imbalance, statusColor, statusText
 * @returns {string} HTML string
 */
function renderIonBalanceSummary(ionBalance) {
  return `<div class="ion-balance-summary" style="margin-top: 10px;">
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('cations')}</div>
      <div style="font-size: 1.3em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalCations.toFixed(2))} ${i18n.t('meqPerLiter')}</div>
    </div>
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('anions')}</div>
      <div style="font-size: 1.3em; font-weight: bold;">${i18n.formatNumber(ionBalance.totalAnions.toFixed(2))} ${i18n.t('meqPerLiter')}</div>
    </div>
    <div class="ion-balance-card status" style="background: ${ionBalance.statusColor}20; border-color: ${ionBalance.statusColor};">
      <div style="font-size: 0.9em; color: #666;">${i18n.t('imbalance')}</div>
      <div style="font-size: 1.3em; font-weight: bold; color: ${ionBalance.statusColor};">${i18n.formatNumber(ionBalance.imbalance.toFixed(1))}%</div>
      <div style="font-size: 0.9em; color: ${ionBalance.statusColor};">${ionBalance.statusText}</div>
    </div>
  </div>`;
}

/**
 * Renders individual ion card for breakdown display
 * @param {string} ion - Ion name
 * @param {number} meq - meq/L value
 * @param {number} percentage - Percentage of total
 * @param {string} percentageKey - i18n key for percentage label
 * @returns {string} HTML string
 */
function renderIonCard(ion, meq, percentage, percentageKey) {
  return `
    <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
      <div style="display: flex; justify-content: space-between;">
        <strong>${ion}</strong>
        <span>${i18n.formatNumber(meq.toFixed(2))} meq/L</span>
      </div>
      <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${i18n.t(percentageKey, {percentage})}</div>
    </div>
  `;
}

/**
 * Calculates ion balance details for a list of fertilizers - uses unified core
 * Returns all calculated data including per-fertilizer breakdown
 * @param {Array} activeFertilizers - Array of fertilizer objects with grams
 * @param {number} volume - Solution volume in liters
 * @returns {Object} {totalCations, totalAnions, ionDetails, fertilizerBreakdown, imbalance, statusColor, statusText}
 */
function calculateIonBalanceDetails(activeFertilizers, volume) {
  return calculateIonBalanceCore(activeFertilizers, volume, { includeBreakdown: true, useSymbols: true });
}

// ============================================================
// END OF REUSABLE RENDER FUNCTIONS
// ============================================================

// Calculate ion balance (uses unified core function)
// Display is now handled by Vue via gramsToPpmDisplayData.ionBalance
function calculateIonBalance(activeFertilizers, volume) {
  // Use unified core calculation
  const ionBalance = calculateIonBalanceCore(activeFertilizers, volume, { useSymbols: true });

  // Return ion balance data for copy function and Vue display (with clean status text)
  return {
    totalCations: ionBalance.totalCations,
    totalAnions: ionBalance.totalAnions,
    imbalance: ionBalance.imbalance,
    statusText: ionBalance.statusText.replace(/[✓⚠✗]/g, '').trim(),
    statusColor: ionBalance.statusColor,
    ionDetails: ionBalance.ionDetails
  };
}

// Clear all selections and reset the form
function clearAll() {
  // Now handled by Vue
  if (window.vueApp && window.vueApp.clearAll) {
    window.vueApp.clearAll();
  }
}

// Tab switching - now uses Vue reactive state
function switchTab(tabId) {
  // Update Vue state - visibility is handled by :class bindings
  // Mode indicator is updated via Vue computed property (modeIndicatorText)
  if (window.vueApp) {
    window.vueApp.currentTab = tabId;
    window.vueApp.currentMode = tabId;
  }
}

// clearFormulaBuilder - removed, use clearFormulaBuilderVue directly

// Formula builder - main function
async function buildFormula() {
  // Now handled by Vue
  if (window.vueApp && window.vueApp.buildFormulaVue) {
    await window.vueApp.buildFormulaVue();
  }
}


// lastFormulaCalculation is now a Vue ref - access via window.vueApp.lastFormulaCalculation

// displayFormulaResults removed - now handled by Vue template with setFormulaResults

// Calculate ion balance for formula (returns summary data) - uses unified core
function calculateIonBalanceForFormula(activeFertilizers, volume) {
  return calculateIonBalanceCore(activeFertilizers, volume, { useSymbols: true });
}

// ============================================================================
// TWO-TANK SYSTEM FUNCTIONS
// ============================================================================

// Split fertilizers into two compatible tanks
// Tank A: Calcium-containing fertilizers + compatible neutrals
// Tank B: Sulfate/Phosphate-containing fertilizers + compatible neutrals
// Neutral fertilizers can be split between tanks to help balance ions
function splitIntoTwoTanks(formula, volume) {
  const tankA = { fertilizers: {}, name: i18n.t('tankALabel'), description: i18n.t('tankADescription') };
  const tankB = { fertilizers: {}, name: i18n.t('tankBLabel'), description: i18n.t('tankBDescription') };

  const neutralFertilizers = [];

  // First pass: categorize fertilizers
  Object.entries(formula).forEach(([fertId, grams]) => {
    if (grams <= 0) return;

    const hasCa = hasCaContent(fertId);
    const hasS = hasSulfateContent(fertId);
    const hasP = hasPhosphateContent(fertId);
    const hasSi = hasSilicateContent(fertId);

    if (hasCa && !hasS && !hasSi) {
      // Pure calcium source -> Tank A
      tankA.fertilizers[fertId] = grams;
    } else if (hasS && !hasCa) {
      // Sulfate source (no calcium) -> Tank B
      tankB.fertilizers[fertId] = grams;
    } else if (hasP && !hasCa && !hasS) {
      // Pure phosphate source -> Tank B (safer with sulfates than calcium at high conc)
      tankB.fertilizers[fertId] = grams;
    } else if (hasSi && !hasCa) {
      // Silicate source (no calcium) -> Tank B (silicates precipitate with calcium)
      tankB.fertilizers[fertId] = grams;
    } else if (hasCa && hasS) {
      // Contains both Ca and S - problematic, put in Tank A with warning
      tankA.fertilizers[fertId] = grams;
    } else if (hasCa && hasSi) {
      // Contains both Ca and Si - problematic, put in Tank A with warning
      tankA.fertilizers[fertId] = grams;
    } else {
      // Neutral fertilizer - will be assigned to help balance
      neutralFertilizers.push({ fertId, grams });
    }
  });

  // Calculate initial ion balance for each tank
  let tankABalance = calculateTankIonBalance(tankA.fertilizers, volume);
  let tankBBalance = calculateTankIonBalance(tankB.fertilizers, volume);

  // Second pass: distribute neutral fertilizers to help balance tanks
  neutralFertilizers.forEach(({ fertId, grams }) => {
    // Get ion contribution of this fertilizer
    const ionData = ION_DATA[fertId];

    // Determine which tank needs more help with balance
    // Also consider if one tank is empty
    const tankAEmpty = Object.keys(tankA.fertilizers).length === 0;
    const tankBEmpty = Object.keys(tankB.fertilizers).length === 0;

    if (tankAEmpty && tankBEmpty) {
      // Both empty, put in Tank A
      tankA.fertilizers[fertId] = grams;
    } else if (tankAEmpty) {
      // Tank A is empty, put there to give it something
      tankA.fertilizers[fertId] = grams;
    } else if (tankBEmpty) {
      // Tank B is empty, put there
      tankB.fertilizers[fertId] = grams;
    } else {
      // Both tanks have items - assign to the one with worse balance
      // or split if both are similar
      const tankAImbalance = tankABalance.imbalance;
      const tankBImbalance = tankBBalance.imbalance;

      if (Math.abs(tankAImbalance - tankBImbalance) < 5) {
        // Similar imbalance - check which direction each tank leans
        // and assign to help correct it
        const tankAExcess = tankABalance.totalCations - tankABalance.totalAnions;
        const tankBExcess = tankBBalance.totalCations - tankBBalance.totalAnions;

        // Check if this fertilizer contributes more cations or anions
        let fertCations = 0, fertAnions = 0;
        if (ionData) {
          const testFert = [{ id: fertId, grams: grams }];
          const testBalance = calculateTankIonBalance({ [fertId]: grams }, volume);
          fertCations = testBalance.totalCations;
          fertAnions = testBalance.totalAnions;
        }

        const fertExcess = fertCations - fertAnions;

        // Assign to tank where it helps balance
        if (tankAExcess > 0 && fertExcess < 0) {
          tankA.fertilizers[fertId] = grams;
        } else if (tankBExcess > 0 && fertExcess < 0) {
          tankB.fertilizers[fertId] = grams;
        } else if (tankAExcess < 0 && fertExcess > 0) {
          tankA.fertilizers[fertId] = grams;
        } else if (tankBExcess < 0 && fertExcess > 0) {
          tankB.fertilizers[fertId] = grams;
        } else {
          // Can't help balance either way - put in tank with higher imbalance
          if (tankAImbalance >= tankBImbalance) {
            tankA.fertilizers[fertId] = grams;
          } else {
            tankB.fertilizers[fertId] = grams;
          }
        }
      } else if (tankAImbalance > tankBImbalance) {
        tankA.fertilizers[fertId] = grams;
      } else {
        tankB.fertilizers[fertId] = grams;
      }
    }

    // Recalculate balances after assignment
    tankABalance = calculateTankIonBalance(tankA.fertilizers, volume);
    tankBBalance = calculateTankIonBalance(tankB.fertilizers, volume);
  });

  // Final balance calculation
  tankA.ionBalance = calculateTankIonBalance(tankA.fertilizers, volume);
  tankB.ionBalance = calculateTankIonBalance(tankB.fertilizers, volume);

  // Calculate nutrient contributions for each tank
  tankA.nutrients = calculateTankNutrients(tankA.fertilizers, volume);
  tankB.nutrients = calculateTankNutrients(tankB.fertilizers, volume);

  return { tankA, tankB };
}

// Calculate ion balance for a single tank - uses unified core
function calculateTankIonBalance(fertilizers, volume) {
  // Use unified core with useSymbols: false for tank display (no ✓/⚠/✗)
  return calculateIonBalanceCore(fertilizers, volume, { useSymbols: false });
}

// Calculate nutrient PPM contributions for a tank
function calculateTankNutrients(fertilizers, volume) {
  const nutrients = {
    N_total: 0, N_NO3: 0, N_NH4: 0,
    P2O5: 0, P: 0, K2O: 0, K: 0,
    Ca: 0, Mg: 0, S: 0
  };

  Object.entries(fertilizers).forEach(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    if (!fert) return;

    Object.keys(nutrients).forEach(nutrient => {
      if (fert.pct[nutrient]) {
        nutrients[nutrient] += (grams * fert.pct[nutrient] / 100) / volume * 1000;
      }
    });
  });

  // Calculate total N
  nutrients.N_total = nutrients.N_NO3 + nutrients.N_NH4;

  // Calculate elemental from oxide if not directly available
  if (nutrients.P2O5 > 0 && nutrients.P === 0) {
    nutrients.P = nutrients.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P;
  }
  if (nutrients.K2O > 0 && nutrients.K === 0) {
    nutrients.K = nutrients.K2O * OXIDE_CONVERSIONS.K2O_to_K;
  }

  return nutrients;
}

// Display two-tank results for formula builder
function displayTwoTankFormulaResults() {
  const lastCalc = window.vueApp?.lastFormulaCalculation;
  if (!lastCalc) {
    alert(i18n.t('alertNoFormulaResults'));
    return;
  }

  const { result, targets, volume, mode } = lastCalc;
  const { tankA, tankB } = splitIntoTwoTanks(result.formula, volume);

  // Header buttons visibility is now handled by Vue v-if on parent container
  // (hides when twoTankDisplayData.show && twoTankDisplayData.sourceType === 'formula')

  // Use Vue-powered display
  if (window.vueApp && window.vueApp.setTwoTankResults) {
    window.vueApp.setTwoTankResults(tankA, tankB, volume, mode, 'formula', result.achieved, targets);
  }
}

// Display two-tank results for reverse calculator
function displayTwoTankReverseResults() {
  const lastCalc = window.vueApp?.lastReverseCalculation;
  if (!lastCalc) {
    alert(i18n.t('alertNoCalculationResults'));
    return;
  }

  const { result, targets, volume, mode } = lastCalc;
  const { tankA, tankB } = splitIntoTwoTanks(result.formula, volume);

  // Header buttons visibility is now handled by Vue v-if on parent container
  // (hides when twoTankDisplayData.show && twoTankDisplayData.sourceType === 'reverse')

  // Use Vue-powered display
  if (window.vueApp && window.vueApp.setTwoTankResults) {
    window.vueApp.setTwoTankResults(tankA, tankB, volume, mode, 'reverse', result.achieved, targets);
  }
}

// Display two-tank results for Grams to PPM calculator (Tab 1)
function displayTwoTankGramsToPPMResults() {
  const lastCalc = window.vueApp?.lastGramsToPPMCalculation;
  if (!lastCalc) {
    alert(i18n.t('alertNoCalculationResultsPpm'));
    return;
  }

  const { activeFertilizers, volume, results } = lastCalc;

  // Convert activeFertilizers array to formula object format
  const formula = {};
  activeFertilizers.forEach(fert => {
    formula[fert.id] = fert.grams;
  });

  const { tankA, tankB } = splitIntoTwoTanks(formula, volume);

  // Header buttons visibility is now handled by Vue v-if on parent container
  // (hides when twoTankDisplayData.show && twoTankDisplayData.sourceType === 'grams-to-ppm')

  // Use Vue-powered display
  // For Grams to PPM, we use elemental mode and no specific targets
  if (window.vueApp && window.vueApp.setTwoTankResults) {
    window.vueApp.setTwoTankResults(tankA, tankB, volume, 'elemental', 'grams-to-ppm', results, null);
  }
}

// currentTwoTankData is now a Vue ref - access via window.vueApp.currentTwoTankData

// i18n formatter for FertilizerCore copy text builders
function getI18nFormatter() {
  return {
    t: (key, params) => i18n.t(key, params),
    formatNumber: (num) => i18n.formatNumber(num),
    formatNutrientLabel: (key) => i18n.formatNutrientLabel(key)
  };
}

// Copy two-tank results to clipboard (thin wrapper using FertilizerCore)
// copyTwoTankResults removed - now handled by Vue (copyTwoTankResultsVue)

// ============================================================================
// REVERSE CALCULATOR FUNCTIONS
// ============================================================================

// Legacy DOM functions removed - now handled by Vue
// updateFormulaCalculationMode - removed, v-model and Vue template expressions handle sync
// updateReverseCalculationMode - removed, v-model and Vue template expressions handle sync
// clearReverseCalculator - removed, use clearReverseVue directly

// Main reverse calculator function
async function calculateReverse() {
  // Now handled by Vue
  if (window.vueApp && window.vueApp.calculateReverseVue) {
    await window.vueApp.calculateReverseVue();
  }
}

// lastReverseCalculation is now a Vue ref - access via window.vueApp.lastReverseCalculation

// displayReverseResults removed - now handled by Vue template with setReverseResults

// PPM Explanation Modal Functions - Now uses Vue modal
function openPPMExplanation() {
  if (window.vueApp && window.vueApp.openModal) {
    window.vueApp.openModal('ppm');
  }
}

// closePPMExplanation - removed, modal closing is handled by Vue

// Ion Balance Explanation Modal Functions - Now uses Vue modal
function openIonBalanceExplanation() {
  if (window.vueApp && window.vueApp.openModal) {
    window.vueApp.openModal('ion-balance');
  }
}

// closeIonBalanceExplanation - removed, modal closing is handled by Vue

// generateIonBalanceExplanation removed - now handled by Vue modal

// ==========================================
// Reverse Calculator Explanation Functions - Now use Vue modal
// ==========================================

function openReversePPMExplanation() {
  if (window.vueApp && window.vueApp.openModal) {
    // Pass reverse calculation data to Vue modal
    const lastCalc = window.vueApp.lastReverseCalculation;
    const data = lastCalc ? {
      volume: lastCalc.volume,
      activeFertilizers: lastCalc.result?.fertilizers?.map(f => ({
        ...FERTILIZERS.find(fert => fert.id === f.id),
        grams: f.grams
      })).filter(Boolean) || [],
      calculationType: 'ratio-to-grams'
    } : {};
    window.vueApp.openModal('ppm', data);
    return;
  }
}

function openReverseIonBalanceExplanation() {
  if (window.vueApp && window.vueApp.openModal) {
    const lastCalc = window.vueApp.lastReverseCalculation;
    const data = lastCalc ? {
      volume: lastCalc.volume,
      activeFertilizers: lastCalc.result?.fertilizers?.map(f => ({
        ...FERTILIZERS.find(fert => fert.id === f.id),
        grams: f.grams
      })).filter(Boolean) || [],
      calculationType: 'ratio-to-grams'
    } : {};
    window.vueApp.openModal('ion-balance', data);
    return;
  }
}

// generateReversePPMExplanation removed - now handled by Vue modal
// generateReverseIonBalanceExplanation removed - now handled by Vue modal

// ==========================================
// Two-Tank View Explanation Functions
// getTankFertilizerArray, openTwoTankPPMExplanation, openTwoTankIonBalanceExplanation
// removed - were unused

// Formula Builder (PPM to Grams) explanation functions
// Open Ion Balance explanation for formula builder - Now uses Vue modal
function openFormulaIonBalanceExplanation() {
  const lastCalc = window.vueApp?.lastFormulaCalculation;
  if (window.vueApp && window.vueApp.openModal && lastCalc) {
    const { result, volume } = lastCalc;
    const activeFertilizers = Object.entries(result.formula)
      .filter(([fertId, grams]) => grams > 0.01)
      .map(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        return fert ? { ...fert, grams } : null;
      })
      .filter(Boolean);
    window.vueApp.openModal('ion-balance', {
      volume: volume,
      activeFertilizers: activeFertilizers,
      calculationType: 'formula-builder'
    });
  }
}

// generateFormulaIonBalanceExplanation removed - now handled by Vue modal

// Copy functions removed - now handled by Vue (copyGramsToPPMResultsVue, copyPPMToGramsResultsVue, etc.)

// Initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// =============================================================================
// VUE 3 APPLICATION
// =============================================================================
// This Vue app is being incrementally integrated. During migration, some
// functionality remains in vanilla JS while new features use Vue reactivity.

const { createApp, ref, computed, reactive, watch, onMounted } = Vue;

// =============================================================================
// RATIO CARD COMPONENT - Reusable component for displaying nutrient ratios
// =============================================================================
const RatioCard = {
  props: {
    ratio: {
      type: Object,
      required: true
    }
  },
  emits: ['info-click', 'no3nh4-info-click'],
  setup(props, { emit }) {
    // Create explicit computed properties for all ratio data
    const ratioName = computed(() => props.ratio?.name || '');
    const ratioDisplayValue = computed(() => props.ratio?.ratio || ''); // This is a string like "1 : 1.2"
    const ratioLabels = computed(() => props.ratio?.labels || []);
    const ratioValues = computed(() => props.ratio?.values || []);
    const ratioUnit = computed(() => props.ratio?.unit);

    // K:Ca ratio detection
    const isKCaRatio = computed(() => {
      const name = ratioName.value;
      return name && name.includes('K') && name.includes('Ca') && !name.includes('Mg');
    });

    // NO₃:NH₄ ratio detection
    const isNo3Nh4Ratio = computed(() => {
      const name = ratioName.value;
      return name && (name.includes('NO₃') || name.includes('NO3')) && (name.includes('NH₄') || name.includes('NH4'));
    });

    // For K:Ca, calculate the numeric ratio from the values array (K ppm / Ca ppm)
    const kCaNumericRatio = computed(() => {
      if (!isKCaRatio.value) return null;
      const values = ratioValues.value;
      // K:Ca ratio - values[0] is K, values[1] is Ca
      if (values && values.length >= 2 && values[1] > 0) {
        return values[0] / values[1];
      }
      return null;
    });

    // For NO₃:NH₄, calculate the numeric ratio from the values array (NO₃ / NH₄)
    const no3Nh4NumericRatio = computed(() => {
      if (!isNo3Nh4Ratio.value) return null;
      const values = ratioValues.value;
      // NO₃:NH₄ ratio - values[0] is NO₃, values[1] is NH₄
      if (values && values.length >= 2 && values[1] > 0) {
        return values[0] / values[1];
      }
      // If NH₄ is 0, return a high value to indicate "all nitrate"
      if (values && values.length >= 2 && values[1] === 0 && values[0] > 0) {
        return Infinity;
      }
      return null;
    });

    const kCaStatus = computed(() => {
      if (!isKCaRatio.value || kCaNumericRatio.value === null) return null;
      return getKCaWarningStatus(kCaNumericRatio.value);
    });

    const no3Nh4Status = computed(() => {
      if (!isNo3Nh4Ratio.value || no3Nh4NumericRatio.value === null) return null;
      return getNo3Nh4WarningStatus(no3Nh4NumericRatio.value);
    });

    const borderColor = computed(() => {
      if (isKCaRatio.value && kCaStatus.value) {
        return kCaStatus.value.color;
      }
      if (isNo3Nh4Ratio.value && no3Nh4Status.value) {
        return no3Nh4Status.value.color;
      }
      return '#007bff';
    });

    const textColor = computed(() => {
      if (isKCaRatio.value && kCaStatus.value) {
        return kCaStatus.value.color;
      }
      if (isNo3Nh4Ratio.value && no3Nh4Status.value) {
        return no3Nh4Status.value.color;
      }
      return '#007bff';
    });

    const currentStatus = computed(() => {
      if (isKCaRatio.value && kCaStatus.value) return kCaStatus.value;
      if (isNo3Nh4Ratio.value && no3Nh4Status.value) return no3Nh4Status.value;
      return null;
    });

    const handleInfoClick = () => {
      if (isKCaRatio.value) {
        emit('info-click', { ratio: kCaNumericRatio.value, status: kCaStatus.value });
      } else if (isNo3Nh4Ratio.value) {
        emit('no3nh4-info-click', { ratio: no3Nh4NumericRatio.value, status: no3Nh4Status.value });
      }
    };

    const infoTooltip = computed(() => {
      if (isKCaRatio.value) return i18n.t('clickToLearnKCa');
      if (isNo3Nh4Ratio.value) return i18n.t('clickToLearnNo3Nh4');
      return '';
    });

    const showInfoButton = computed(() => {
      return isKCaRatio.value || isNo3Nh4Ratio.value;
    });

    return {
      ratioName,
      ratioDisplayValue,
      ratioLabels,
      ratioValues,
      ratioUnit,
      isKCaRatio,
      kCaNumericRatio,
      kCaStatus,
      isNo3Nh4Ratio,
      no3Nh4NumericRatio,
      no3Nh4Status,
      borderColor,
      textColor,
      currentStatus,
      handleInfoClick,
      infoTooltip,
      showInfoButton,
      i18n
    };
  },
  template: `{% raw %}<div style="background: #f8f9fa; padding: 15px; border-radius: 4px;" :style="{ borderLeft: '4px solid ' + borderColor }">
      <div style="font-weight: bold; margin-bottom: 8px; font-size: 1.1em; display: flex; align-items: center; gap: 6px;" :style="{ color: textColor }">
        {{ ratioName }}
        <span v-if="showInfoButton" class="info-icon" style="width: 18px; height: 18px; font-size: 11px; line-height: 18px;" @click="handleInfoClick" :title="infoTooltip">?</span>
      </div>
      <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
        {{ ratioDisplayValue }}
        <span v-if="currentStatus && currentStatus.text" style="font-size: 0.6em; margin-left: 8px;" :style="{ color: currentStatus.color }">{{ currentStatus.text }}</span>
      </div>
      <div style="font-size: 0.85em; color: #666;">
        <span v-for="(label, idx) in ratioLabels" :key="idx">
          {{ label }}: {{ i18n.formatNumber((ratioValues[idx] || 0).toFixed(1)) }} {{ ratioUnit || i18n.t('ppmUnit') }}<span v-if="idx < ratioLabels.length - 1"> | </span>
        </span>
      </div>
    </div>{% endraw %}`
};

const FertilizerApp = {
  setup() {
    // =========================================================================
    // REACTIVE STATE
    // =========================================================================

    // Wizard state
    const currentMode = ref(null); // 'ppm-calc', 'formula-builder', 'reverse-calc'
    const wizardStep = ref('mode-selector');
    const wizardVolume = ref(10);
    const wizardSelectedEC = ref('ec:1.2');
    const wizardCalcMode = ref('oxide');

    // Template refs
    const wizardVolumeInput = ref(null);

    // Progress bar state (Vue-powered)
    const progressState = reactive({
      show: false,
      title: 'Calculating...',
      message: 'Initializing...',
      percent: 0,
      indeterminate: false,
      cancelled: false,
      onCancel: null
    });

    // Copy button feedback state (Vue-powered)
    const copiedButtonId = ref(null); // Which copy button is showing "Copied!" feedback

    // Wizard PPM target inputs (for PPM → Grams mode)
    const wizardTargets = reactive({
      N: '', P: '', K: '', Ca: '', Mg: '', S: '', Si: '0'
    });

    // Wizard ratio inputs (for NPK Ratio → Grams mode)
    const wizardRatios = reactive({
      N: '', P: '', K: '', Ca: '', Mg: '', S: '', Si: '0'
    });

    // Wizard Grams Fertilizer List state
    const wizardGramsFertilizers = reactive({}); // { fertilizer_id: { checked: false, grams: '' } }
    const wizardGramsSearchTerm = ref('');

    // Wizard Available Fertilizers List state (for formula/reverse)
    const wizardAvailFertilizers = reactive({}); // { fertilizer_id: checked }
    const wizardAvailSearchTerm = ref('');

    // Shared inputs
    const volume = ref(10);
    const calculationMode = ref('oxide'); // 'oxide' or 'elemental'
    const language = ref(i18n?.currentLanguage || 'en');
    const currentTab = ref('ppm-calc'); // 'ppm-calc', 'formula-builder', 'reverse-calc'
    const wizardResultsModeText = ref(''); // Dynamic text for wizard results mode indicator
    const wizardResultsSource = ref(null); // 'ppm-calc', 'formula-builder', 'reverse-calc', or null - controls which results show in wizard

    // Language splash for first-time visitors
    const showLanguageSplash = ref(!localStorage.getItem('fertCalcLanguage'));

    // Cycling subtitle translations for language splash
    const subtitleTranslations = [
      'Choose your preferred language',      // English
      'अपनी पसंदीदा भाषा चुनें',              // Hindi
      'તમારી પસંદગીની ભાષા પસંદ કરો',         // Gujarati
      'ನಿಮ್ಮ ಆದ್ಯತೆಯ ಭಾಷೆಯನ್ನು ಆಯ್ಕೆಮಾಡಿ',    // Kannada
      'మీ ఇష్టమైన భాషను ఎంచుకోండి',           // Telugu
      'तुमची पसंतीची भाषा निवडा',             // Marathi
      'আপনার পছন্দের ভাষা নির্বাচন করুন',     // Bengali
      'உங்கள் விருப்பமான மொழியைத் தேர்ந்தெடுக்கவும்', // Tamil
      'നിങ്ങളുടെ ഇഷ്ടഭാഷ തിരഞ്ഞെടുക്കുക',     // Malayalam
      'ਆਪਣੀ ਪਸੰਦੀਦਾ ਭਾਸ਼ਾ ਚੁਣੋ',              // Punjabi
      'ଆପଣଙ୍କ ପସନ୍ଦର ଭାଷା ବାଛନ୍ତୁ',           // Odia
      'আপোনাৰ পছন্দৰ ভাষা বাছনি কৰক',        // Assamese
      'अपना पसंदीदा भाषा चुनीं',              // Bhojpuri
      'अपन पसिन्न भाषा चुनू',                 // Maithili
      'अपनी पसंद की भाषा चुनो'                // Awadhi
    ];
    const currentSubtitleIndex = ref(0);
    const currentSubtitle = computed(() => subtitleTranslations[currentSubtitleIndex.value]);
    let subtitleInterval = null;

    // Start cycling when splash is shown
    watch(showLanguageSplash, (isVisible) => {
      if (isVisible) {
        subtitleInterval = setInterval(() => {
          currentSubtitleIndex.value = (currentSubtitleIndex.value + 1) % subtitleTranslations.length;
        }, 2500);
      } else {
        if (subtitleInterval) {
          clearInterval(subtitleInterval);
          subtitleInterval = null;
        }
      }
    }, { immediate: true });

    // Watch language changes and sync with i18n
    watch(language, (newLang) => {
      if (i18n && i18n.setLanguage) {
        i18n.setLanguage(newLang);
      }
    });

    // Modal state (declared early for use in watchers)
    const activeModal = ref(null); // 'ppm', 'ion-balance', 'reverse-ppm', 'reverse-ion', 'formula-ion', 'two-tank-ppm', 'two-tank-ion'

    // Watch for modal/progress overlay/language splash and control body scroll
    watch([activeModal, () => progressState.show, showLanguageSplash], ([modal, progress, splash]) => {
      document.body.style.overflow = (modal || progress || splash) ? 'hidden' : '';
    }, { immediate: true });

    // Grams to PPM state
    const fertilizerAmounts = reactive({}); // { fertilizer_id: { checked: false, grams: 0 } }
    const searchTerm = ref('');

    // PPM to Grams (formula builder) state
    const formulaTargets = reactive({
      N: '', P: '', K: '', Ca: '', Mg: '', S: '', Si: '0'
    });
    const formulaVolume = ref(10);
    const formulaCalcMode = ref('oxide'); // 'oxide' or 'elemental'
    const availableFertilizers = reactive({}); // { fertilizer_id: checked }
    const formulaSearchTerm = ref('');
    const formulaResults = ref(null);
    const formulaIsCalculating = ref(false);

    // Ratio to Grams (reverse calc) state
    const ratioTargets = reactive({
      N: '', P: '', K: '', Ca: '', Mg: '', S: '', Si: '0'
    });
    const ratioVolume = ref(10);
    const ratioCalcMode = ref('oxide'); // 'oxide' or 'elemental'
    const ratioTargetEC = ref('ec:1.2');
    const reverseFertilizers = reactive({}); // { fertilizer_id: { checked, priority } }
    const ratioSearchTerm = ref('');
    const ratioResults = ref(null);
    const ratioIsCalculating = ref(false);

    // Reverse Results Display Data (Vue-powered)
    const reverseResultsData = reactive({
      show: false,
      volume: 0,
      mode: 'oxide', // 'oxide' or 'elemental'
      targetEC: null,
      result: null,  // Raw result from calculation
      targets: null, // Original targets
      // Derived data (populated by setReverseResults)
      fertilizers: [], // { name, composition, grams }
      totalGrams: 0,
      comparison: [], // { key, label, userInput, achievedRatio, achievedPPM, status, className }
      nh4Percent: 0,
      ionBalance: { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' },
      ecPrediction: { ec: 0, color: '#666', text: '' },
      ratios: null,
      warnings: [],
      nutritionalWarnings: [],
      allGood: true
    });

    // Formula Builder Results Display Data (Vue-powered)
    const formulaResultsData = reactive({
      show: false,
      volume: 0,
      mode: 'oxide', // 'oxide' or 'elemental'
      result: null,  // Raw result from calculation
      targets: null, // Original targets
      // Derived data (populated by setFormulaResults)
      fertilizers: [], // { id, name, composition, grams }
      totalGrams: 0,
      comparison: [], // { key, label, target, achieved, diff, percentDiff, status, className }
      nh4Percent: 0,
      ionBalance: { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' },
      ecPrediction: { ec: 0, color: '#666', text: '' },
      ratios: null,
      warnings: [],
      nutritionalWarnings: [],
      allGood: true
    });

    // Grams to PPM Results Display Data (Vue-powered)
    const gramsToPpmDisplayData = reactive({
      show: false,
      volume: 0,
      // Derived data (populated by setGramsToPpmResults)
      fertilizers: [], // { id, name, composition, grams }
      totalGrams: 0,
      results: null, // PPM results object
      displayOrder: [], // Array of { key, label, value } for display
      ionBalance: { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' },
      ecPrediction: { ec: 0, color: '#666', text: '' },
      ratios: [], // Array of { name, ratio, labels, values, unit }
      warnings: [] // Array of { level, category, message }
    });

    // Two-Tank Display Data (Vue-powered)
    const twoTankDisplayData = reactive({
      show: false,
      sourceType: '', // 'grams-to-ppm', 'formula', 'reverse'
      volume: 0,
      mode: 'elemental', // 'elemental' or 'oxide'
      targets: null, // Original targets (for formula/reverse)
      // Tank data (populated by setTwoTankResults)
      tankA: {
        name: '',
        description: '',
        fertilizers: [], // { id, name, grams }
        totalGrams: 0,
        nutrients: { N_total: 0, N_NO3: 0, N_NH4: 0, P: 0, P2O5: 0, K: 0, K2O: 0, Ca: 0, Mg: 0, S: 0 },
        ionBalance: { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' },
        ecPrediction: { ec: 0, color: '#666', text: '' },
        ppmData: [], // { label, value }
        nh4Percent: 0,
        no3Percent: 0,
        ratios: {
          target: null, // { label, values }
          contribution: null, // { label, values }
          caMg: null, // { ratio }
          nCa: null, // { ratio }
          kCa: null // { ratio, kLabel }
        },
        detailsExpanded: false
      },
      tankB: {
        name: '',
        description: '',
        fertilizers: [], // { id, name, grams }
        totalGrams: 0,
        nutrients: { N_total: 0, N_NO3: 0, N_NH4: 0, P: 0, P2O5: 0, K: 0, K2O: 0, Ca: 0, Mg: 0, S: 0 },
        ionBalance: { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' },
        ecPrediction: { ec: 0, color: '#666', text: '' },
        ppmData: [], // { label, value }
        nh4Percent: 0,
        no3Percent: 0,
        ratios: {
          target: null,
          contribution: null,
          caMg: null,
          nCa: null,
          kCa: null
        },
        detailsExpanded: false
      },
      // Combined data
      combinedNutrients: { N_total: 0, P: 0, P2O5: 0, K: 0, K2O: 0, Ca: 0, Mg: 0, S: 0 },
      combinedEc: { ec: 0, color: '#666', text: '' },
      grandTotalGrams: 0,
      nutrientLabels: { N: 'N', P: 'P', K: 'K', Ca: 'Ca', Mg: 'Mg', S: 'S' }
    });

    // Results
    const gramsToPpmResults = ref(null);
    const showResults = ref(false);

    // Modal data (activeModal declared earlier for use in watchers)
    const modalData = reactive({
      volume: 0,
      activeFertilizers: [],
      nutrientContributions: {},
      ionBalance: null,
      calculationType: '', // 'grams-to-ppm', 'ppm-to-grams', 'ratio-to-grams'
      // EC modal specific data
      ecContributions: null,
      rawEC: 0,
      ionicStrength: 0,
      ec: 0
    });

    // Oxide conversion data for templates
    const oxideConversions = [
      { key: 'P2O5', oxideLabel: 'phosphateOxide', oxideName: 'P₂O₅', elementalLabel: 'phosphorusElemental', elementalName: 'P', factor: 0.436 },
      { key: 'K2O', oxideLabel: 'potassiumOxide', oxideName: 'K₂O', elementalLabel: 'potassiumElemental', elementalName: 'K', factor: 0.830 },
      { key: 'MgO', oxideLabel: 'magnesiumOxide', oxideName: 'MgO', elementalLabel: 'magnesiumElemental', elementalName: 'Mg', factor: 0.603 },
      { key: 'CaO', oxideLabel: 'calciumOxide', oxideName: 'CaO', elementalLabel: 'calciumElemental', elementalName: 'Ca', factor: 0.715 }
    ];

    // Pending wizard calculation state (for two-tank decision)
    const pendingWizardCalculation = ref(null);

    // Last calculation results (for copy/export and modal functions)
    const lastGramsToPPMCalculation = ref(null);
    const lastFormulaCalculation = ref(null);
    const lastReverseCalculation = ref(null);
    const currentTwoTankData = ref(null);

    // =========================================================================
    // COMPUTED PROPERTIES
    // =========================================================================

    // EC description based on selected EC level
    // Note: language.value is included to trigger recomputation on language change
    const wizardECDescription = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      const descKey = EC_DESCRIPTIONS[wizardSelectedEC.value];
      return descKey ? i18n.t(descKey) : '';
    });

    // P and K labels based on calculation mode
    // Note: language.value is included to trigger recomputation on language change
    const wizardPLabel = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      return wizardCalcMode.value === 'elemental' ? i18n.t('phosphorusElemental') : i18n.t('phosphorusOxide');
    });

    const wizardKLabel = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      return wizardCalcMode.value === 'elemental' ? i18n.t('potassiumElemental') : i18n.t('potassiumOxide');
    });

    // Mode indicator text for wizard header (computed from Vue state)
    // Note: language.value is included to trigger recomputation on language change
    const modeIndicatorText = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      if (!currentMode.value) return '';

      const modeKeys = {
        'ppm-calc': 'gramsToPpm',
        'formula-builder': 'ppmToGrams',
        'reverse-calc': 'npkRatioToGrams'
      };
      const modeName = i18n.t(modeKeys[currentMode.value]) || currentMode.value;

      let text = i18n.t('currentLabel') + ' <strong>' + modeName + '</strong>';
      text += ' · ' + wizardVolume.value + i18n.t('litersShort');

      // Add calc mode for formula-builder and reverse-calc
      if (currentMode.value === 'formula-builder' || currentMode.value === 'reverse-calc') {
        const calcMode = currentMode.value === 'formula-builder' ? formulaCalcMode.value : ratioCalcMode.value;
        text += ' · ' + (calcMode === 'oxide' ? i18n.t('oxideShort') : i18n.t('elementalShort'));
      }

      // Add EC for reverse-calc
      if (currentMode.value === 'reverse-calc') {
        const ecValue = ratioTargetEC.value.replace('ec:', '');
        text += ' · ' + ecValue + ' mS/cm';
      }

      return text;
    });

    // Step indicator text computed from current step and mode
    // Note: language.value is included to trigger recomputation on language change
    const stepIndicatorText = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      const step = wizardStep.value;
      const mode = currentMode.value;
      if (!mode) return '';

      // Step counts per mode
      const STEP_COUNTS = {
        'ppm-calc': 3,
        'formula-builder': 5,
        'reverse-calc': 6
      };

      // Step numbers per step and mode
      const STEP_NUMBERS = {
        'volume-step': { 'ppm-calc': 2, 'formula-builder': 2, 'reverse-calc': 2 },
        'calc-mode-step': { 'formula-builder': 3, 'reverse-calc': 3 },
        'ec-step': { 'reverse-calc': 4 },
        'grams-input-step': { 'ppm-calc': 3 },
        'ppm-targets-step': { 'formula-builder': 4 },
        'npk-ratios-step': { 'reverse-calc': 5 },
        'fertilizer-select-step': { 'formula-builder': 5, 'reverse-calc': 6 },
        'two-tank-question-step': null // Dynamic
      };

      const stepConfig = STEP_NUMBERS[step];
      if (!stepConfig) return '';

      const stepNumber = stepConfig[mode];
      const totalSteps = STEP_COUNTS[mode];

      if (stepNumber && totalSteps) {
        return i18n.t('stepOf', { current: stepNumber, total: totalSteps });
      }
      return '';
    });

    // Get step indicator for a specific step (for template binding)
    function getStepIndicator(stepId) {
      const mode = currentMode.value;
      if (!mode) return '';

      const STEP_COUNTS = {
        'ppm-calc': 3,
        'formula-builder': 5,
        'reverse-calc': 6
      };

      const STEP_NUMBERS = {
        'volume-step': { 'ppm-calc': 2, 'formula-builder': 2, 'reverse-calc': 2 },
        'calc-mode-step': { 'formula-builder': 3, 'reverse-calc': 3 },
        'ec-step': { 'reverse-calc': 4 },
        'grams-input-step': { 'ppm-calc': 3 },
        'ppm-targets-step': { 'formula-builder': 4 },
        'npk-ratios-step': { 'reverse-calc': 5 },
        'fertilizer-select-step': { 'formula-builder': 5, 'reverse-calc': 6 }
      };

      const stepConfig = STEP_NUMBERS[stepId];
      if (!stepConfig) return '';

      const stepNumber = stepConfig[mode];
      const totalSteps = STEP_COUNTS[mode];

      if (stepNumber && totalSteps) {
        return i18n.t('stepOf', { current: stepNumber, total: totalSteps });
      }
      return '';
    }

    // Get two-tank question step indicator (dynamic - always total + 1)
    function getTwoTankStepIndicator() {
      const mode = currentMode.value;
      if (!mode) return '';

      const STEP_COUNTS = {
        'ppm-calc': 3,
        'formula-builder': 5,
        'reverse-calc': 6
      };

      const totalSteps = STEP_COUNTS[mode] || 0;
      return i18n.t('stepOf', { current: totalSteps + 1, total: totalSteps + 1 });
    }

    // Filter fertilizers based on search
    const filteredFertilizers = computed(() => {
      if (!searchTerm.value.trim()) return FERTILIZERS;
      const term = searchTerm.value.toLowerCase();
      return FERTILIZERS.filter(f =>
        f.name.toLowerCase().includes(term) ||
        i18n.getFertilizerName(f).toLowerCase().includes(term) ||
        (f.aliases && f.aliases.some(a => a.toLowerCase().includes(term))) ||
        i18n.getFertilizerAliases(f).toLowerCase().includes(term)
      );
    });

    // Get active fertilizers (checked with amount > 0)
    const activeFertilizers = computed(() => {
      return FERTILIZERS.filter(f => {
        const state = fertilizerAmounts[f.id];
        return state && state.checked && state.grams > 0;
      }).map(f => ({
        ...f,
        grams: fertilizerAmounts[f.id].grams
      }));
    });

    // Filter available fertilizers for formula builder
    const filteredAvailableFertilizers = computed(() => {
      if (!formulaSearchTerm.value.trim()) return FERTILIZERS;
      const term = formulaSearchTerm.value.toLowerCase();
      return FERTILIZERS.filter(f =>
        f.name.toLowerCase().includes(term) ||
        i18n.getFertilizerName(f).toLowerCase().includes(term) ||
        (f.aliases && f.aliases.some(a => a.toLowerCase().includes(term))) ||
        i18n.getFertilizerAliases(f).toLowerCase().includes(term)
      );
    });

    // Get selected available fertilizers for formula building
    const selectedAvailableFertilizers = computed(() => {
      return FERTILIZERS.filter(f => availableFertilizers[f.id]);
    });

    // Filter reverse fertilizers based on search
    const filteredReverseFertilizers = computed(() => {
      if (!ratioSearchTerm.value.trim()) return FERTILIZERS;
      const term = ratioSearchTerm.value.toLowerCase();
      return FERTILIZERS.filter(f =>
        f.name.toLowerCase().includes(term) ||
        i18n.getFertilizerName(f).toLowerCase().includes(term) ||
        (f.aliases && f.aliases.some(a => a.toLowerCase().includes(term))) ||
        i18n.getFertilizerAliases(f).toLowerCase().includes(term)
      );
    });

    // Get selected reverse fertilizers for ratio calculation
    const selectedReverseFertilizers = computed(() => {
      return FERTILIZERS.filter(f => {
        const state = reverseFertilizers[f.id];
        return state && state.checked;
      }).map(f => ({
        ...f,
        priority: reverseFertilizers[f.id]?.priority || 5
      }));
    });

    // Wizard: Filter grams fertilizers based on search
    const filteredWizardGramsFertilizers = computed(() => {
      if (!wizardGramsSearchTerm.value.trim()) return FERTILIZERS;
      const term = wizardGramsSearchTerm.value.toLowerCase();
      return FERTILIZERS.filter(f =>
        f.name.toLowerCase().includes(term) ||
        i18n.getFertilizerName(f).toLowerCase().includes(term) ||
        (f.aliases && f.aliases.some(a => a.toLowerCase().includes(term))) ||
        i18n.getFertilizerAliases(f).toLowerCase().includes(term)
      );
    });

    // Wizard: Filter available fertilizers based on search
    const filteredWizardAvailFertilizers = computed(() => {
      if (!wizardAvailSearchTerm.value.trim()) return FERTILIZERS;
      const term = wizardAvailSearchTerm.value.toLowerCase();
      return FERTILIZERS.filter(f =>
        f.name.toLowerCase().includes(term) ||
        i18n.getFertilizerName(f).toLowerCase().includes(term) ||
        (f.aliases && f.aliases.some(a => a.toLowerCase().includes(term))) ||
        i18n.getFertilizerAliases(f).toLowerCase().includes(term)
      );
    });

    // Wizard: Get active grams fertilizers (checked with amount > 0)
    const activeWizardGramsFertilizers = computed(() => {
      return FERTILIZERS.filter(f => {
        const state = wizardGramsFertilizers[f.id];
        return state && state.checked && parseFloat(state.grams) > 0;
      }).map(f => ({
        ...f,
        grams: parseFloat(wizardGramsFertilizers[f.id].grams)
      }));
    });

    // Sorted EC contributions for breakdown table
    const sortedEcContributions = computed(() => {
      const contributions = gramsToPpmDisplayData.ecPrediction?.contributions;
      if (!contributions) return [];
      return Object.entries(contributions)
        .sort((a, b) => b[1].contribution_mS_cm - a[1].contribution_mS_cm)
        .reduce((obj, [key, value]) => {
          obj[key] = value;
          return obj;
        }, {});
    });

    // Wizard: Get selected available fertilizers
    const selectedWizardAvailFertilizers = computed(() => {
      return FERTILIZERS.filter(f => wizardAvailFertilizers[f.id]);
    });

    // =========================================================================
    // METHODS
    // =========================================================================

    // Initialize fertilizer amounts state (for Grams to PPM)
    function initFertilizerAmounts() {
      FERTILIZERS.forEach(f => {
        fertilizerAmounts[f.id] = {
          checked: COMMON_FERTILIZERS.includes(f.id),
          grams: 0
        };
      });
    }

    // Initialize available fertilizers state (for PPM to Grams)
    function initAvailableFertilizers() {
      FERTILIZERS.forEach(f => {
        availableFertilizers[f.id] = COMMON_FERTILIZERS.includes(f.id);
      });
    }

    // Initialize wizard grams fertilizers state
    function initWizardGramsFertilizers() {
      FERTILIZERS.forEach(f => {
        wizardGramsFertilizers[f.id] = {
          checked: false,
          grams: ''
        };
      });
      wizardGramsSearchTerm.value = '';
    }

    // Initialize wizard available fertilizers state
    function initWizardAvailFertilizers() {
      FERTILIZERS.forEach(f => {
        wizardAvailFertilizers[f.id] = COMMON_FERTILIZERS.includes(f.id);
      });
      wizardAvailSearchTerm.value = '';
    }

    // Clear wizard grams selections
    function clearWizardGramsSelectionsVue() {
      FERTILIZERS.forEach(f => {
        wizardGramsFertilizers[f.id] = {
          checked: false,
          grams: ''
        };
      });
      wizardGramsSearchTerm.value = '';
    }

    // Update wizard grams - auto-check when user enters value
    function updateWizardGrams(id, value) {
      if (wizardGramsFertilizers[id]) {
        wizardGramsFertilizers[id].grams = value;
        if (parseFloat(value) > 0) {
          wizardGramsFertilizers[id].checked = true;
        }
      }
    }

    // Toggle wizard grams fertilizer checkbox
    function toggleWizardGramsFertilizer(id) {
      if (wizardGramsFertilizers[id]) {
        wizardGramsFertilizers[id].checked = !wizardGramsFertilizers[id].checked;
      }
    }

    // Toggle wizard available fertilizer checkbox
    function toggleWizardAvailFertilizer(id) {
      wizardAvailFertilizers[id] = !wizardAvailFertilizers[id];
    }

    // Select all wizard available fertilizers
    function selectAllWizardFertilizersVue() {
      FERTILIZERS.forEach(f => {
        wizardAvailFertilizers[f.id] = true;
      });
    }

    // Deselect all wizard available fertilizers
    function deselectAllWizardFertilizersVue() {
      FERTILIZERS.forEach(f => {
        wizardAvailFertilizers[f.id] = false;
      });
    }

    // Select only common wizard available fertilizers
    function selectCommonWizardFertilizersVue() {
      FERTILIZERS.forEach(f => {
        wizardAvailFertilizers[f.id] = COMMON_FERTILIZERS.includes(f.id);
      });
    }

    // Toggle fertilizer checkbox
    function toggleFertilizer(id) {
      if (fertilizerAmounts[id]) {
        fertilizerAmounts[id].checked = !fertilizerAmounts[id].checked;
      }
    }

    // Update fertilizer grams
    function updateGrams(id, value) {
      if (fertilizerAmounts[id]) {
        fertilizerAmounts[id].grams = parseFloat(value) || 0;
      }
    }

    // Format composition string for display
    function formatComposition(fert) {
      if (!fert.pct) return '';
      return Object.entries(fert.pct)
        .map(([key, val]) => `${key}: ${val}%`)
        .join(', ');
    }

    // Calculate PPM from grams
    async function calculatePPM() {
      if (volume.value <= 0) {
        alert(i18n.t('alertEnterValidVolume'));
        return;
      }

      if (activeFertilizers.value.length === 0) {
        alert(i18n.t('alertSelectFertilizerWithAmount'));
        return;
      }

      // Show progress bar
      progressBar.show(i18n.t('calculatingPPM') || 'Calculating PPM...');
      progressBar.update(10, i18n.t('validatingInputs'));

      try {
        // Allow UI to update before calculation
        await new Promise(resolve => setTimeout(resolve, 50));

        if (progressBar.isCancelled()) return;

        progressBar.update(30, i18n.t('calculatingNutrients') || 'Calculating nutrients...');

        // Calculate PPM for each nutrient using the pct structure
        const ppmResults = {};

        activeFertilizers.value.forEach(fert => {
          if (!fert.pct) return;

          Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
            // ppm = (grams × 1000 × (pct/100)) / liters
            const ppm = (fert.grams * 1000 * (percentage / 100)) / volume.value;

            if (!ppmResults[nutrient]) {
              ppmResults[nutrient] = 0;
            }

            // Handle nitrogen forms properly to avoid double counting
            if (nutrient === 'N_NO3' || nutrient === 'N_NH4') {
              ppmResults[nutrient] += ppm;
              // Also add to N_total
              if (!ppmResults.N_total) ppmResults.N_total = 0;
              ppmResults.N_total += ppm;
            } else if (nutrient === 'N_total') {
              // Only use N_total if there are no specific nitrogen forms
              if (!fert.pct.N_NO3 && !fert.pct.N_NH4) {
                ppmResults[nutrient] += ppm;
              }
            } else {
              ppmResults[nutrient] += ppm;
            }
          });
        });

        if (progressBar.isCancelled()) return;

        progressBar.update(60, i18n.t('convertingOxides') || 'Converting oxides...');

        // Convert oxides to elements
        const finalResults = { ...ppmResults };

        // P from P2O5
        if (ppmResults.P2O5) {
          finalResults.P = (finalResults.P || 0) + (ppmResults.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P);
        }

        // K from K2O
        if (ppmResults.K2O) {
          finalResults.K = (finalResults.K || 0) + (ppmResults.K2O * OXIDE_CONVERSIONS.K2O_to_K);
        }

        // Ca from CaO
        if (ppmResults.CaO) {
          finalResults.Ca = (finalResults.Ca || 0) + (ppmResults.CaO * OXIDE_CONVERSIONS.CaO_to_Ca);
        }

        // Mg from MgO
        if (ppmResults.MgO) {
          finalResults.Mg = (finalResults.Mg || 0) + (ppmResults.MgO * OXIDE_CONVERSIONS.MgO_to_Mg);
        }

        if (progressBar.isCancelled()) return;

        progressBar.update(80, i18n.t('calculatingDerivedData') || 'Calculating derived data...');

        gramsToPpmResults.value = finalResults;
        showResults.value = true;

        // Calculate derived data
        const oldStyleFerts = activeFertilizers.value;
        const vol = volume.value;
        const ecData = estimateECFromPPM(finalResults);
        const ionBalance = calculateIonBalance(oldStyleFerts, vol);
        const warnings = checkWarnings(finalResults, oldStyleFerts, ionBalance);
        const ratios = calculateNutrientRatios(finalResults);

        if (progressBar.isCancelled()) return;

        progressBar.update(100, i18n.t('complete'));

        // Display using Vue-powered function
        setGramsToPpmResults(oldStyleFerts, vol, finalResults, ecData, ionBalance, ratios, warnings);

        // lastGramsToPPMCalculation is set inside setGramsToPpmResults
        // Legacy reference for copy function
        lastGramsToPPMCalculation.value = {
          activeFertilizers: oldStyleFerts,
          volume: vol,
          results: finalResults,
          ecData,
          ionBalance,
          ratios,
          warnings
        };
      } catch (error) {
        console.error('PPM calculation error:', error);
        alert(i18n.t('alertCalculationError'));
      } finally {
        progressBar.hide();
      }
    }

    // Clear all inputs
    function clearAll() {
      Object.keys(fertilizerAmounts).forEach(id => {
        fertilizerAmounts[id].checked = COMMON_FERTILIZERS.includes(id);
        fertilizerAmounts[id].grams = 0;
      });
      searchTerm.value = '';
      gramsToPpmResults.value = null;
      showResults.value = false;

      // Hide result sections (Vue-powered)
      gramsToPpmDisplayData.show = false;
      twoTankDisplayData.show = false;
    }

    // =========================================================================
    // PPM TO GRAMS (FORMULA BUILDER) METHODS
    // =========================================================================

    // Toggle available fertilizer checkbox
    function toggleAvailableFertilizer(id) {
      availableFertilizers[id] = !availableFertilizers[id];
    }

    // Select all available fertilizers
    function selectAllAvailable() {
      FERTILIZERS.forEach(f => {
        availableFertilizers[f.id] = true;
      });
    }

    // Deselect all available fertilizers
    function deselectAllAvailable() {
      FERTILIZERS.forEach(f => {
        availableFertilizers[f.id] = false;
      });
    }

    // Select only common fertilizers
    function selectCommonAvailable() {
      FERTILIZERS.forEach(f => {
        availableFertilizers[f.id] = COMMON_FERTILIZERS.includes(f.id);
      });
    }

    // Build formula (PPM to Grams calculation)
    async function buildFormulaVue() {
      // Validate volume
      if (!formulaVolume.value || formulaVolume.value <= 0) {
        alert(i18n.t('alertEnterValidSolutionVolume'));
        return;
      }

      // Build targets object
      const targets = {
        N: parseFloat(formulaTargets.N) || 0,
        P: parseFloat(formulaTargets.P) || 0,
        K: parseFloat(formulaTargets.K) || 0,
        Ca: parseFloat(formulaTargets.Ca) || 0,
        Mg: parseFloat(formulaTargets.Mg) || 0,
        S: parseFloat(formulaTargets.S) || 0,
        Si: parseFloat(formulaTargets.Si) || 0
      };

      // Check at least one target
      const hasTarget = Object.values(targets).some(v => v > 0);
      if (!hasTarget) {
        alert(i18n.t('alertEnterPositiveNutrientTarget'));
        return;
      }

      // Get selected fertilizers
      const selected = selectedAvailableFertilizers.value;
      if (selected.length === 0) {
        alert(i18n.t('alertSelectAvailableFertilizer'));
        return;
      }

      formulaIsCalculating.value = true;

      // Show progress bar
      progressBar.show(i18n.t('buildingFormula'));
      progressBar.update(10, i18n.t('validatingInputs'));

      try {
        if (progressBar.isCancelled()) return;

        progressBar.update(50, i18n.t('runningSolver'));
        progressBar.setIndeterminate(i18n.t('optimizingCombination'));

        // Run optimization
        const result = await optimizeFormula(
          targets,
          formulaVolume.value,
          selected,
          75,
          formulaCalcMode.value,
          { useAbsoluteTargets: true, useMilp: true }
        );

        if (progressBar.isCancelled()) return;

        progressBar.update(100, i18n.t('complete'));

        formulaResults.value = result;

        // Display using Vue-powered function
        setFormulaResults(result, targets, formulaVolume.value, formulaCalcMode.value);

      } catch (error) {
        console.error('Formula build error:', error);
        alert(i18n.t('alertCalculationError'));
      } finally {
        formulaIsCalculating.value = false;
        progressBar.hide();
      }
    }

    // Clear formula builder
    function clearFormulaBuilderVue() {
      Object.keys(formulaTargets).forEach(key => {
        formulaTargets[key] = key === 'Si' ? '0' : '';
      });
      formulaVolume.value = 10;
      formulaSearchTerm.value = '';
      formulaResults.value = null;
      selectCommonAvailable();

      // Hide results (Vue-powered)
      formulaResultsData.show = false;
      twoTankDisplayData.show = false;
    }

    // =========================================================================
    // RATIO TO GRAMS (REVERSE CALC) METHODS
    // =========================================================================

    // Initialize reverse fertilizers state
    function initReverseFertilizers() {
      FERTILIZERS.forEach(f => {
        reverseFertilizers[f.id] = {
          checked: COMMON_FERTILIZERS.includes(f.id),
          priority: 5
        };
      });
    }

    // Toggle reverse fertilizer checkbox
    function toggleReverseFertilizer(id) {
      if (reverseFertilizers[id]) {
        reverseFertilizers[id].checked = !reverseFertilizers[id].checked;
      }
    }

    // Update reverse fertilizer priority
    function updateReversePriority(id, priority) {
      if (reverseFertilizers[id]) {
        reverseFertilizers[id].priority = parseInt(priority) || 5;
      }
    }

    // Select all reverse fertilizers
    function selectAllReverse() {
      FERTILIZERS.forEach(f => {
        if (reverseFertilizers[f.id]) {
          reverseFertilizers[f.id].checked = true;
        }
      });
    }

    // Deselect all reverse fertilizers
    function deselectAllReverse() {
      FERTILIZERS.forEach(f => {
        if (reverseFertilizers[f.id]) {
          reverseFertilizers[f.id].checked = false;
        }
      });
    }

    // Select only common reverse fertilizers
    function selectCommonReverse() {
      FERTILIZERS.forEach(f => {
        if (reverseFertilizers[f.id]) {
          reverseFertilizers[f.id].checked = COMMON_FERTILIZERS.includes(f.id);
        }
      });
    }

    // Calculate reverse (Ratio to Grams)
    async function calculateReverseVue() {
      // Build targets object
      const targets = {
        N: parseFloat(ratioTargets.N) || 0,
        P: parseFloat(ratioTargets.P) || 0,
        K: parseFloat(ratioTargets.K) || 0,
        Ca: parseFloat(ratioTargets.Ca) || 0,
        Mg: parseFloat(ratioTargets.Mg) || 0,
        S: parseFloat(ratioTargets.S) || 0,
        Si: parseFloat(ratioTargets.Si) || 0
      };

      const volume = ratioVolume.value;
      const concentrationValue = ratioTargetEC.value;

      // Check at least one nutrient
      const hasAtLeastOneNutrient = Object.values(targets).some(val => val > 0);
      if (!hasAtLeastOneNutrient) {
        alert(i18n.t('alertEnterNutrientValue'));
        return;
      }

      // Validate volume
      if (!volume || volume <= 0) {
        alert(i18n.t('alertEnterValidSolutionVolume'));
        return;
      }

      // Get selected fertilizers
      const selected = selectedReverseFertilizers.value;
      if (selected.length === 0) {
        alert(i18n.t('alertSelectFertilizer'));
        return;
      }

      // Parse EC target
      let targetEC = null;
      let concentration = 100;
      if (concentrationValue.startsWith('ec:')) {
        targetEC = parseFloat(concentrationValue.substring(3));
      } else {
        concentration = parseFloat(concentrationValue) || 75;
      }

      ratioIsCalculating.value = true;

      // Show progress bar
      progressBar.show(i18n.t('calculatingFertilizers'));
      progressBar.update(10, i18n.t('validatingInputs'));

      try {
        if (progressBar.isCancelled()) return;

        progressBar.update(50, i18n.t('runningSolver'));
        progressBar.setIndeterminate(i18n.t('optimizingCombination'));

        // Run optimization
        const result = await optimizeFormula(
          targets,
          volume,
          selected,
          concentration,
          ratioCalcMode.value,
          { targetEC, useMilp: true }
        );

        if (progressBar.isCancelled()) return;

        progressBar.update(100, i18n.t('complete'));

        ratioResults.value = result;

        // Display using Vue-powered function
        setReverseResults(result, targets, volume, targetEC);

      } catch (error) {
        console.error('Reverse calculation error:', error);
        alert(i18n.t('alertCalculationError'));
      } finally {
        ratioIsCalculating.value = false;
        progressBar.hide();
      }
    }

    // Clear reverse calculator
    function clearReverseVue() {
      Object.keys(ratioTargets).forEach(key => {
        ratioTargets[key] = key === 'Si' ? '0' : '';
      });
      ratioVolume.value = 10;
      ratioTargetEC.value = 'ec:1.2';
      ratioSearchTerm.value = '';
      ratioResults.value = null;
      selectCommonReverse();

      // Hide results
      reverseResultsData.show = false;
      twoTankDisplayData.show = false;
    }

    // Set reverse results data (Vue-powered replacement for displayReverseResults)
    function setReverseResults(result, targets, volume, targetEC = null) {
      const mode = ratioCalcMode.value;

      // Store raw data
      reverseResultsData.result = result;
      reverseResultsData.targets = targets;
      reverseResultsData.volume = volume;
      reverseResultsData.mode = mode;
      reverseResultsData.targetEC = targetEC;

      // Store for modal/copy functions (legacy compatibility)
      lastReverseCalculation.value = { result, targets, volume, mode, targetEC };

      // Process fertilizers
      const ferts = [];
      let totalGrams = 0;
      Object.entries(result.formula).forEach(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        if (fert && grams > 0.01) {
          totalGrams += grams;
          ferts.push({
            id: fertId,
            name: i18n.getFertilizerName(fert),
            composition: Object.entries(fert.pct).map(([k, v]) => `${k}: ${v}%`).join(', '),
            grams: grams
          });
        }
      });
      reverseResultsData.fertilizers = ferts;
      reverseResultsData.totalGrams = totalGrams;

      // Calculate achieved ratios (commercial N:P2O5:K2O)
      const achievedPPM = {
        N: result.achieved.N_total,
        P2O5: result.achieved.P2O5,
        K2O: result.achieved.K2O,
        Ca: result.achieved.Ca,
        Mg: result.achieved.Mg,
        S: result.achieved.S
      };
      const achievedValues = Object.values(achievedPPM).filter(v => v > 0);
      const minAchieved = achievedValues.length > 0 ? Math.min(...achievedValues) : 1;
      const achievedRatios = {};
      Object.keys(achievedPPM).forEach(k => {
        achievedRatios[k] = achievedPPM[k] > 0 ? achievedPPM[k] / minAchieved : 0;
      });

      // Calculate target ratios
      const targetNutrients = { N: targets.N, P: targets.P, K: targets.K, Ca: targets.Ca, Mg: targets.Mg, S: targets.S };
      const targetValues = Object.values(targetNutrients).filter(v => v > 0);
      const minTarget = targetValues.length > 0 ? Math.min(...targetValues) : 1;
      const targetRatios = {
        N: targets.N > 0 ? targets.N / minTarget : 0,
        P2O5: targets.P > 0 ? targets.P / minTarget : 0,
        K2O: targets.K > 0 ? targets.K / minTarget : 0,
        Ca: targets.Ca > 0 ? targets.Ca / minTarget : 0,
        Mg: targets.Mg > 0 ? targets.Mg / minTarget : 0,
        S: targets.S > 0 ? targets.S / minTarget : 0
      };

      // Build comparison data
      const displayNutrients = mode === 'elemental'
        ? [
            { key: 'N', label: i18n.t('nitrogen'), ratioKey: 'N', ppmKey: 'N_total', targetKey: 'N' },
            { key: 'P', label: i18n.t('phosphorusElemental'), ratioKey: 'P2O5', ppmKey: 'P', targetKey: 'P' },
            { key: 'K', label: i18n.t('potassiumElemental'), ratioKey: 'K2O', ppmKey: 'K', targetKey: 'K' },
            { key: 'Ca', label: i18n.t('calcium'), ratioKey: 'Ca', ppmKey: 'Ca', targetKey: 'Ca' },
            { key: 'Mg', label: i18n.t('magnesium'), ratioKey: 'Mg', ppmKey: 'Mg', targetKey: 'Mg' },
            { key: 'S', label: i18n.t('sulfur'), ratioKey: 'S', ppmKey: 'S', targetKey: 'S' },
            { key: 'Si', label: i18n.t('silicon'), isPPM: true }
          ]
        : [
            { key: 'N', label: i18n.t('nitrogen'), ratioKey: 'N', ppmKey: 'N_total', targetKey: 'N' },
            { key: 'P2O5', label: i18n.t('phosphorusOxide'), ratioKey: 'P2O5', ppmKey: 'P2O5', targetKey: 'P' },
            { key: 'K2O', label: i18n.t('potassiumOxide'), ratioKey: 'K2O', ppmKey: 'K2O', targetKey: 'K' },
            { key: 'Ca', label: i18n.t('calcium'), ratioKey: 'Ca', ppmKey: 'Ca', targetKey: 'Ca' },
            { key: 'Mg', label: i18n.t('magnesium'), ratioKey: 'Mg', ppmKey: 'Mg', targetKey: 'Mg' },
            { key: 'S', label: i18n.t('sulfur'), ratioKey: 'S', ppmKey: 'S', targetKey: 'S' },
            { key: 'Si', label: i18n.t('silicon'), isPPM: true }
          ];

      const comparison = [];
      const warnings = [];
      let allGood = true;

      displayNutrients.forEach(n => {
        // Silicon is PPM-based, not ratio-based
        if (n.isPPM) {
          const targetPPM = targets.Si || 0;
          const achievedPPMVal = result.achieved.Si || 0;
          if (targetPPM === 0 && achievedPPMVal === 0) return;
          const diff = targetPPM > 0 ? Math.abs((achievedPPMVal - targetPPM) / targetPPM * 100) : 0;
          let status = '✓', className = 'match';
          if (diff > 20) { status = '✗'; className = 'miss'; allGood = false; warnings.push(`${n.label} is ${diff.toFixed(1)}% off target PPM`); }
          else if (diff > 10) { status = '⚠'; className = 'close'; warnings.push(`${n.label} is ${diff.toFixed(1)}% off target PPM (acceptable)`); }
          comparison.push({ key: n.key, label: n.label, isPPM: true, userInput: targetPPM, achievedRatio: achievedPPMVal, achievedPPM: achievedPPMVal, status, className });
          return;
        }

        const tRatio = targetRatios[n.ratioKey] || 0;
        const aRatio = achievedRatios[n.ratioKey] || 0;
        const aPPM = result.achieved[n.ppmKey] || 0;
        const userInput = targets[n.targetKey] || 0;
        if (tRatio === 0 && aRatio === 0) return;

        const diff = tRatio > 0 ? Math.abs((aRatio - tRatio) / tRatio * 100) : 0;
        let status = '✓', className = 'match';
        if (diff > 15) { status = '✗'; className = 'miss'; allGood = false; warnings.push(i18n.t('ratioOffTarget', { nutrient: n.label, percent: i18n.formatNumber(diff.toFixed(1)) })); }
        else if (diff > 5) { status = '⚠'; className = 'close'; warnings.push(i18n.t('ratioOffTargetAcceptable', { nutrient: n.label, percent: i18n.formatNumber(diff.toFixed(1)) })); }
        comparison.push({ key: n.key, label: n.label, isPPM: false, userInput, achievedRatio: aRatio, achievedPPM: aPPM, status, className });
      });

      reverseResultsData.comparison = comparison;
      reverseResultsData.warnings = warnings;
      reverseResultsData.allGood = allGood;

      // NH4 percentage
      reverseResultsData.nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;

      // Ion balance
      const activeFerts = Object.entries(result.formula).map(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        return { ...fert, grams };
      });
      reverseResultsData.ionBalance = calculateIonBalanceForFormula(activeFerts, volume);

      // EC prediction - transform raw ecData to display format
      const rawEcDataReverse = estimateECFromPPM(result.achieved);
      if (rawEcDataReverse && rawEcDataReverse.ec_mS_cm !== undefined) {
        const ecStatusReverse = getEcStatus(rawEcDataReverse.ec_mS_cm);
        reverseResultsData.ecPrediction = {
          ec: rawEcDataReverse.ec_mS_cm,
          color: ecStatusReverse.color,
          text: ecStatusReverse.text,
          targetEC: targetEC,
          ecScaling: result.ecScaling,
          contributions: rawEcDataReverse.contributions || {},
          rawEC: rawEcDataReverse.rawEC || 0,
          ionicStrength: rawEcDataReverse.ionicStrength || 0
        };
      } else {
        reverseResultsData.ecPrediction = { ec: 0, color: '#666', text: '', targetEC: targetEC, ecScaling: result.ecScaling };
      }

      // Nutrient ratios
      reverseResultsData.ratios = calculateNutrientRatios(result.achieved);

      // Nutritional warnings
      reverseResultsData.nutritionalWarnings = checkWarnings(result.achieved, activeFerts);

      // Show results
      reverseResultsData.show = true;
    }

    // Set formula builder results data (Vue-powered replacement for displayFormulaResults)
    function setFormulaResults(result, targets, volume, mode = 'oxide') {
      // Store for modal/copy functions (legacy compatibility)
      lastFormulaCalculation.value = { result, targets, volume, mode };

      // Store raw data
      formulaResultsData.result = result;
      formulaResultsData.targets = targets;
      formulaResultsData.volume = volume;
      formulaResultsData.mode = mode;

      // Process fertilizers
      const ferts = [];
      let totalGrams = 0;
      Object.entries(result.formula).forEach(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        if (fert) {
          totalGrams += grams;
          ferts.push({
            id: fertId,
            name: i18n.getFertilizerName(fert),
            composition: Object.entries(fert.pct).map(([k, v]) => `${k}: ${v}%`).join(', '),
            grams: grams
          });
        }
      });
      formulaResultsData.fertilizers = ferts;
      formulaResultsData.totalGrams = totalGrams;

      // Build comparison data based on mode
      const nutrients = mode === 'elemental'
        ? [
            { key: 'N_total', label: i18n.t('nitrogen'), targetKey: 'N' },
            { key: 'P', label: i18n.t('phosphorusElemental'), targetKey: 'P' },
            { key: 'K', label: i18n.t('potassiumElemental'), targetKey: 'K' },
            { key: 'Ca', label: i18n.t('calcium'), targetKey: 'Ca' },
            { key: 'Mg', label: i18n.t('magnesium'), targetKey: 'Mg' },
            { key: 'S', label: i18n.t('sulfur'), targetKey: 'S' },
            { key: 'Si', label: i18n.t('silicon'), targetKey: 'Si' }
          ]
        : [
            { key: 'N_total', label: i18n.t('nitrogen'), targetKey: 'N' },
            { key: 'P2O5', label: i18n.t('phosphorusOxide'), targetKey: 'P' },
            { key: 'K2O', label: i18n.t('potassiumOxide'), targetKey: 'K' },
            { key: 'Ca', label: i18n.t('calcium'), targetKey: 'Ca' },
            { key: 'Mg', label: i18n.t('magnesium'), targetKey: 'Mg' },
            { key: 'S', label: i18n.t('sulfur'), targetKey: 'S' },
            { key: 'Si', label: i18n.t('silicon'), targetKey: 'Si' }
          ];

      const comparison = [];
      const warnings = [];
      let allGood = true;

      nutrients.forEach(n => {
        const target = targets[n.targetKey] || 0;
        const achieved = result.achieved[n.key] || 0;

        // Skip S/Si if not specified
        if (target === 0 && (n.key === 'S' || n.key === 'Si')) return;

        const diff = achieved - target;
        const percentDiff = target > 0 ? (Math.abs(diff) / target * 100) : 0;

        let status = '✓', className = 'match';
        if (percentDiff > 20) {
          status = '✗'; className = 'miss'; allGood = false;
          warnings.push(i18n.t('nutrientOffTarget', { nutrient: n.label, percent: i18n.formatNumber(percentDiff.toFixed(1)) }));
        } else if (percentDiff > 10) {
          status = '⚠'; className = 'close';
          warnings.push(i18n.t('nutrientOffTargetAcceptable', { nutrient: n.label, percent: i18n.formatNumber(percentDiff.toFixed(1)) }));
        }

        comparison.push({ key: n.key, label: n.label, target, achieved, diff, percentDiff, status, className });
      });

      formulaResultsData.comparison = comparison;
      formulaResultsData.warnings = warnings;
      formulaResultsData.allGood = allGood;

      // NH4 percentage
      formulaResultsData.nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;

      // Ion balance
      const activeFerts = Object.entries(result.formula).map(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        return { ...fert, grams };
      });
      formulaResultsData.ionBalance = calculateIonBalanceForFormula(activeFerts, volume);

      // EC prediction - transform raw ecData to display format
      const rawEcData = estimateECFromPPM(result.achieved);
      if (rawEcData && rawEcData.ec_mS_cm !== undefined) {
        const ecStatus = getEcStatus(rawEcData.ec_mS_cm);
        formulaResultsData.ecPrediction = {
          ec: rawEcData.ec_mS_cm,
          color: ecStatus.color,
          text: ecStatus.text,
          contributions: rawEcData.contributions || {},
          rawEC: rawEcData.rawEC || 0,
          ionicStrength: rawEcData.ionicStrength || 0
        };
      } else {
        formulaResultsData.ecPrediction = { ec: 0, color: '#666', text: '', contributions: {}, rawEC: 0, ionicStrength: 0 };
      }

      // Nutrient ratios
      formulaResultsData.ratios = calculateNutrientRatios(result.achieved);

      // Nutritional warnings
      formulaResultsData.nutritionalWarnings = checkWarnings(result.achieved, activeFerts);

      // Show results
      formulaResultsData.show = true;
    }

    // Set Grams to PPM results data (Vue-powered replacement for display functions)
    function setGramsToPpmResults(activeFerts, vol, results, ecData, ionBalanceData, ratioData, warningsData) {
      // Store for modal/copy functions (legacy compatibility)
      lastGramsToPPMCalculation.value = {
        activeFertilizers: activeFerts,
        volume: vol,
        results: results,
        ecData: ecData,
        ionBalance: ionBalanceData,
        ratios: ratioData,
        warnings: warningsData
      };

      gramsToPpmDisplayData.volume = vol;

      // Process fertilizers
      const ferts = [];
      let totalGrams = 0;
      activeFerts.forEach((fert, index) => {
        totalGrams += fert.grams;
        ferts.push({
          id: fert.id,
          index: index + 1,
          name: i18n.getFertilizerName(fert),
          composition: Object.entries(fert.pct).map(([k, v]) => `${k}: ${v}%`).join(', '),
          grams: fert.grams
        });
      });
      gramsToPpmDisplayData.fertilizers = ferts;
      gramsToPpmDisplayData.totalGrams = totalGrams;

      // Store raw results
      gramsToPpmDisplayData.results = results;

      // Build display order for PPM results
      const displayOrderConfig = [
        { key: 'N_total', label: i18n.t('totalNitrogenN') },
        { key: 'N_NO3', label: i18n.t('nitrateN') },
        { key: 'N_NH4', label: i18n.t('ammoniumN') },
        { key: 'N_Urea', label: 'Urea-N' },
        { key: 'P', label: i18n.t('phosphorusElemental') },
        { key: 'P2O5', label: i18n.t('phosphorusOxide') },
        { key: 'K', label: i18n.t('potassiumElemental') },
        { key: 'K2O', label: i18n.t('potassiumOxide') },
        { key: 'Ca', label: i18n.t('calcium') },
        { key: 'Mg', label: i18n.t('magnesium') },
        { key: 'S', label: i18n.t('sulfur') },
        { key: 'Fe', label: 'Iron (Fe)' },
        { key: 'B', label: 'Boron (B)' },
        { key: 'Zn', label: 'Zinc (Zn)' },
        { key: 'Mn', label: 'Manganese (Mn)' },
        { key: 'Cu', label: 'Copper (Cu)' },
        { key: 'Mo', label: 'Molybdenum (Mo)' },
        { key: 'Cl', label: 'Chlorine (Cl)' },
        { key: 'Si', label: i18n.t('silicon') }
      ];

      const displayOrder = [];
      displayOrderConfig.forEach(item => {
        if (results[item.key] !== undefined) {
          displayOrder.push({
            key: item.key,
            label: item.label,
            value: results[item.key],
            isZero: results[item.key] < 0.01
          });
        }
      });
      gramsToPpmDisplayData.displayOrder = displayOrder;

      // Ion balance (merge with defaults to ensure all properties exist)
      const defaultIonBalance = { totalCations: 0, totalAnions: 0, imbalance: 0, statusColor: '#666', statusText: '' };
      gramsToPpmDisplayData.ionBalance = ionBalanceData && typeof ionBalanceData === 'object'
        ? { ...defaultIonBalance, ...ionBalanceData }
        : defaultIonBalance;

      // EC prediction - transform raw ecData (with ec_mS_cm) to display format (with ec, color, text)
      // Also preserve contributions for breakdown display
      const defaultEcPrediction = { ec: 0, color: '#666', text: '', contributions: null, rawEC: 0, ionicStrength: 0 };
      if (ecData && typeof ecData === 'object' && ecData.ec_mS_cm !== undefined) {
        const ecStatus = getEcStatus(ecData.ec_mS_cm);
        gramsToPpmDisplayData.ecPrediction = {
          ec: ecData.ec_mS_cm,
          color: ecStatus.color,
          text: ecStatus.text,
          contributions: ecData.contributions || null,
          rawEC: ecData.rawEC || ecData.ec_mS_cm,
          ionicStrength: ecData.ionicStrength || 0
        };
      } else {
        gramsToPpmDisplayData.ecPrediction = defaultEcPrediction;
      }

      // Nutrient ratios (array format)
      gramsToPpmDisplayData.ratios = ratioData || [];

      // Warnings
      gramsToPpmDisplayData.warnings = warningsData || [];

      // Show results
      gramsToPpmDisplayData.show = true;
    }

    // Set Two-Tank results data (Vue-powered replacement for displayTwoTankResults)
    function setTwoTankResults(tankA, tankB, volume, mode, sourceType, achieved, targets) {
      // Store data for copy function (legacy compatibility)
      currentTwoTankData.value = { tankA, tankB, volume, mode, sourceType, achieved, targets };

      // Calculate combined nutrients
      const combinedNutrients = {
        N_total: tankA.nutrients.N_total + tankB.nutrients.N_total,
        P2O5: tankA.nutrients.P2O5 + tankB.nutrients.P2O5,
        P: tankA.nutrients.P + tankB.nutrients.P,
        K2O: tankA.nutrients.K2O + tankB.nutrients.K2O,
        K: tankA.nutrients.K + tankB.nutrients.K,
        Ca: tankA.nutrients.Ca + tankB.nutrients.Ca,
        Mg: tankA.nutrients.Mg + tankB.nutrients.Mg,
        S: tankA.nutrients.S + tankB.nutrients.S,
        N_NH4: tankA.nutrients.N_NH4 + tankB.nutrients.N_NH4,
        N_NO3: tankA.nutrients.N_NO3 + tankB.nutrients.N_NO3
      };

      // Set basic data
      twoTankDisplayData.volume = volume;
      twoTankDisplayData.mode = mode;
      twoTankDisplayData.sourceType = sourceType;
      twoTankDisplayData.targets = targets;
      twoTankDisplayData.combinedNutrients = combinedNutrients;

      // Set nutrient labels based on mode
      twoTankDisplayData.nutrientLabels = mode === 'elemental'
        ? { N: 'N', P: 'P', K: 'K', Ca: 'Ca', Mg: 'Mg', S: 'S' }
        : { N: 'N', P: 'P₂O₅', K: 'K₂O', Ca: 'Ca', Mg: 'Mg', S: 'S' };

      // Process tank data
      processTankData(twoTankDisplayData.tankA, tankA, volume, mode, targets, combinedNutrients, 'A');
      processTankData(twoTankDisplayData.tankB, tankB, volume, mode, targets, combinedNutrients, 'B');

      // Calculate combined EC
      const combinedEcPrediction = estimateECFromPPM(combinedNutrients);
      const combinedEcStatus = getEcStatus(combinedEcPrediction.ec_mS_cm);
      twoTankDisplayData.combinedEc = {
        ec: combinedEcPrediction.ec_mS_cm,
        color: combinedEcStatus.color,
        text: combinedEcStatus.text
      };

      // Calculate grand total
      twoTankDisplayData.grandTotalGrams = twoTankDisplayData.tankA.totalGrams + twoTankDisplayData.tankB.totalGrams;

      // Show results and hide normal results for the source type
      twoTankDisplayData.show = true;
    }

    // Helper function to process tank data for Vue display
    function processTankData(displayTank, sourceTank, volume, mode, targets, combinedNutrients, tankLetter) {
      displayTank.name = sourceTank.name;
      displayTank.description = sourceTank.description;
      displayTank.nutrients = sourceTank.nutrients;
      displayTank.ionBalance = sourceTank.ionBalance;
      displayTank.detailsExpanded = false;

      // Process fertilizers
      const fertEntries = Object.entries(sourceTank.fertilizers);
      const ferts = [];
      let totalGrams = 0;

      fertEntries.forEach(([fertId, grams]) => {
        const fert = FERTILIZERS.find(f => f.id === fertId);
        if (fert) {
          totalGrams += grams;
          ferts.push({ id: fertId, name: i18n.getFertilizerName(fert), grams: grams });
        }
      });

      displayTank.fertilizers = ferts;
      displayTank.totalGrams = totalGrams;

      // Calculate EC for tank
      const tankEcPrediction = estimateECFromPPM(sourceTank.nutrients);
      const tankEcStatus = getEcStatus(tankEcPrediction.ec_mS_cm);
      displayTank.ecPrediction = {
        ec: tankEcPrediction.ec_mS_cm,
        color: tankEcStatus.color,
        text: tankEcStatus.text
      };

      // Calculate nutrient values based on mode
      const nutrients = sourceTank.nutrients;
      const pVal = mode === 'elemental' ? nutrients.P : nutrients.P2O5;
      const kVal = mode === 'elemental' ? nutrients.K : nutrients.K2O;
      const pLabel = mode === 'elemental' ? i18n.t('phosphorusElemental') : i18n.t('phosphorusOxide');
      const kLabel = mode === 'elemental' ? i18n.t('potassiumElemental') : i18n.t('potassiumOxide');

      // Build PPM data for table
      displayTank.ppmData = [
        { label: i18n.t('nitrogen'), value: nutrients.N_total },
        { label: pLabel, value: pVal },
        { label: kLabel, value: kVal },
        { label: i18n.t('calcium'), value: nutrients.Ca },
        { label: i18n.t('magnesium'), value: nutrients.Mg },
        { label: i18n.t('sulfur'), value: nutrients.S }
      ].filter(item => item.value > 0.01);

      // Calculate nitrogen form percentages
      displayTank.nh4Percent = nutrients.N_total > 0.1 ? (nutrients.N_NH4 / nutrients.N_total * 100) : 0;
      displayTank.no3Percent = nutrients.N_total > 0.1 ? (nutrients.N_NO3 / nutrients.N_total * 100) : 0;

      // Calculate ratios
      displayTank.ratios = {
        target: null,
        contribution: null,
        caMg: null,
        nCa: null,
        kCa: null
      };

      // Ca:Mg ratio
      if (nutrients.Ca > 0.1 && nutrients.Mg > 0.1) {
        displayTank.ratios.caMg = { ratio: (nutrients.Ca / nutrients.Mg).toFixed(2) };
      }

      // N:Ca ratio
      if (nutrients.N_total > 0.1 && nutrients.Ca > 0.1) {
        displayTank.ratios.nCa = { ratio: (nutrients.N_total / nutrients.Ca).toFixed(2) };
      }

      // K:Ca ratio with warning status
      if (kVal > 0.1 && nutrients.Ca > 0.1) {
        const kCaRatio = kVal / nutrients.Ca;
        const kCaStatus = getKCaWarningStatus(kCaRatio);
        displayTank.ratios.kCa = {
          ratio: kCaRatio.toFixed(2),
          kLabel: mode === 'elemental' ? 'K' : 'K₂O',
          status: kCaStatus
        };
      }

      // Calculate target ratios and contributions (only for formula/reverse modes with targets)
      if (targets && combinedNutrients) {
        const nTarget = targets.N || 0;
        const pTarget = targets.P || 0;
        const kTarget = targets.K || 0;
        const caTarget = targets.Ca || 0;
        const mgTarget = targets.Mg || 0;

        // Build ratio label and values based on what user entered
        let ratioLabel = 'N';
        let targetRatioValues = i18n.formatNumber(nTarget);
        const targetParts = [nTarget];

        if (pTarget > 0) {
          const pLbl = mode === 'elemental' ? 'P' : 'P₂O₅';
          ratioLabel += `:${pLbl}`;
          targetRatioValues += ` : ${i18n.formatNumber(pTarget)}`;
          targetParts.push(pTarget);
        }
        if (kTarget > 0) {
          const kLbl = mode === 'elemental' ? 'K' : 'K₂O';
          ratioLabel += `:${kLbl}`;
          targetRatioValues += ` : ${i18n.formatNumber(kTarget)}`;
          targetParts.push(kTarget);
        }
        if (caTarget > 0) {
          ratioLabel += ':Ca';
          targetRatioValues += ` : ${i18n.formatNumber(caTarget)}`;
          targetParts.push(caTarget);
        }
        if (mgTarget > 0) {
          ratioLabel += ':Mg';
          targetRatioValues += ` : ${i18n.formatNumber(mgTarget)}`;
          targetParts.push(mgTarget);
        }

        displayTank.ratios.target = { label: ratioLabel, values: targetRatioValues };

        // Calculate tank's contribution as proportion of target
        const combinedP = mode === 'elemental' ? combinedNutrients.P : combinedNutrients.P2O5;
        const combinedK = mode === 'elemental' ? combinedNutrients.K : combinedNutrients.K2O;

        const nContrib = combinedNutrients.N_total > 0 ? (nutrients.N_total / combinedNutrients.N_total) * nTarget : 0;
        const pContrib = combinedP > 0 ? (pVal / combinedP) * pTarget : 0;
        const kContrib = combinedK > 0 ? (kVal / combinedK) * kTarget : 0;
        const caContrib = combinedNutrients.Ca > 0 ? (nutrients.Ca / combinedNutrients.Ca) * caTarget : 0;
        const mgContrib = combinedNutrients.Mg > 0 ? (nutrients.Mg / combinedNutrients.Mg) * mgTarget : 0;

        let tankRatioValues = i18n.formatNumber(nContrib.toFixed(1));
        if (pTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(pContrib.toFixed(1))}`;
        if (kTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(kContrib.toFixed(1))}`;
        if (caTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(caContrib.toFixed(1))}`;
        if (mgTarget > 0) tankRatioValues += ` : ${i18n.formatNumber(mgContrib.toFixed(1))}`;

        displayTank.ratios.contribution = { label: ratioLabel, values: tankRatioValues };
      }
    }

    // Toggle tank details expansion
    function toggleTankDetailsVue(tankLetter) {
      if (tankLetter === 'A') {
        twoTankDisplayData.tankA.detailsExpanded = !twoTankDisplayData.tankA.detailsExpanded;
      } else {
        twoTankDisplayData.tankB.detailsExpanded = !twoTankDisplayData.tankB.detailsExpanded;
      }
    }

    // Hide two-tank view and restore normal results
    function hideTwoTankView() {
      // Header buttons visibility is handled by Vue v-if on parent container
      // (shows when twoTankDisplayData.show becomes false)
      twoTankDisplayData.show = false;
    }

    // =========================================================================
    // MODAL METHODS
    // =========================================================================

    // Open a modal with data
    function openModal(modalType, data = {}) {
      // Get active fertilizers from Vue state or passed data (ensure it's always an array)
      const ferts = data.activeFertilizers || activeFertilizers.value || [];
      const vol = data.volume || volume.value || 1;

      // Reset nutrient contributions
      const contributions = {};

      // Calculate contributions for each fertilizer to track oxides
      if (Array.isArray(ferts)) {
        ferts.forEach(fert => {
          // Nutrients are in fert.pct object
          if (fert && fert.pct) {
            for (const [key, value] of Object.entries(fert.pct)) {
              if (typeof value === 'number' && value > 0) {
                contributions[key] = true;
              }
            }
          }
        });
      }

      // Calculate ion balance if this is an ion balance modal
      let ionBalance = data.ionBalance || null;
      if ((modalType === 'ion-balance' || modalType === 'reverse-ion' || modalType === 'formula-ion') &&
          Array.isArray(ferts) && ferts.length > 0 && typeof calculateIonBalanceDetails === 'function') {
        try {
          ionBalance = calculateIonBalanceDetails(ferts, vol);
        } catch (e) {
          console.error('Error calculating ion balance:', e);
        }
      }

      Object.assign(modalData, {
        volume: vol,
        activeFertilizers: ferts,
        nutrientContributions: contributions,
        ionBalance: ionBalance,
        calculationType: data.calculationType || 'grams-to-ppm',
        // EC modal specific data
        ecContributions: data.ecContributions || null,
        rawEC: data.rawEC || 0,
        ionicStrength: data.ionicStrength || 0,
        ec: data.ec || 0
      });

      // Set modal type AFTER setting data to ensure everything is ready
      activeModal.value = modalType;
      // Body overflow is handled by watcher on activeModal
    }

    // Close modal
    function closeModal() {
      activeModal.value = null;
      // Body overflow is handled by watcher on activeModal
    }

    // Check if nutrients have specific oxide
    function hasOxide(oxideKey) {
      return modalData.nutrientContributions && modalData.nutrientContributions[oxideKey];
    }

    // Check if any oxides are present
    function hasAnyOxides() {
      return oxideConversions.some(o => hasOxide(o.key));
    }

    // Format number for display (handles null/undefined safely)
    function formatNumber(num, decimals = 2) {
      if (num == null) return '0';
      return i18n.formatNumber(typeof num === 'number' ? num.toFixed(decimals) : num);
    }

    // Get modal title based on type
    // Note: language.value is included to trigger recomputation on language change
    const modalTitle = computed(() => {
      const _lang = language.value; // Reactive dependency on language
      const titles = {
        'ppm': i18n.t('understandingPpmCalculations') || 'Understanding PPM Calculations',
        'ion-balance': i18n.t('understandingIonBalance') || 'Understanding Ion Balance',
        'reverse-ppm': i18n.t('understandingPpmCalculations') || 'Understanding PPM Calculations',
        'reverse-ion': i18n.t('understandingIonBalance') || 'Understanding Ion Balance',
        'formula-ion': i18n.t('understandingIonBalance') || 'Understanding Ion Balance',
        'ec': i18n.t('ecExplanationTitle') || 'EC Prediction Explained',
        'k-ca-ratio': i18n.t('understandingKCaRatio') || 'Understanding K:Ca Ratio',
        'no3-nh4-ratio': i18n.t('understandingNo3Nh4Ratio') || 'Understanding NO₃:NH₄ Ratio'
      };
      return titles[activeModal.value] || 'Explanation';
    });

    // Get nutrient contributions for a fertilizer (for modal display)
    function getNutrientContributions(fert) {
      const nutrients = [];
      const vol = modalData.volume || 10;

      // Nutrients are stored in fert.pct object
      if (!fert.pct) return nutrients;

      // Check each nutrient in the fertilizer's pct object
      for (const [key, value] of Object.entries(fert.pct)) {
        if (typeof value === 'number' && value > 0) {
          const ppm = (fert.grams * 1000 * (value / 100)) / vol;
          nutrients.push({
            name: i18n.formatNutrientLabel ? i18n.formatNutrientLabel(key) : key,
            key: key,
            percent: value,
            ppm: ppm
          });

          // Track for oxide detection
          if (modalData.nutrientContributions) {
            modalData.nutrientContributions[key] = true;
          }
        }
      }

      return nutrients;
    }

    // Calculate ion balance for modal display
    function calculateIonBalanceForModal() {
      if (modalData.activeFertilizers.length === 0) return null;

      // Use the existing calculateIonBalanceDetails function if available
      if (typeof calculateIonBalanceDetails === 'function') {
        return calculateIonBalanceDetails(modalData.activeFertilizers, modalData.volume);
      }

      return null;
    }

    // Helper function to get ION_DATA for a fertilizer
    function getIonDataForFert(fert) {
      if (!fert || !fert.id) return null;
      return ION_DATA[fert.id] || null;
    }

    // Calculate meq/L for a specific ion from a fertilizer
    function calculateIonMeq(fert, ionInfo) {
      const ionData = getIonDataForFert(fert);
      if (!ionData || !fert.grams || !modalData.volume) return 0;
      const moles = fert.grams / ionData.molarMass;
      const meq = moles * ionInfo.count * ionInfo.charge * 1000;
      return meq / modalData.volume;
    }

    // Calculate total cations for a fertilizer
    function calculateFertCationTotal(fert) {
      const ionData = getIonDataForFert(fert);
      if (!ionData) return 0;
      let total = 0;
      ionData.ions.forEach(ionInfo => {
        if (ionInfo.type === 'cation') {
          total += calculateIonMeq(fert, ionInfo);
        }
      });
      return total;
    }

    // Calculate total anions for a fertilizer
    function calculateFertAnionTotal(fert) {
      const ionData = getIonDataForFert(fert);
      if (!ionData) return 0;
      let total = 0;
      ionData.ions.forEach(ionInfo => {
        if (ionInfo.type === 'anion') {
          total += calculateIonMeq(fert, ionInfo);
        }
      });
      return total;
    }

    // =========================================================================
    // WIZARD VOLUME HELPERS (Vue-powered)
    // =========================================================================
    function focusWizardVolume() {
      Vue.nextTick(() => {
        if (wizardVolumeInput.value) {
          wizardVolumeInput.value.focus();
          wizardVolumeInput.value.select();
        }
      });
    }

    function validateWizardVolume() {
      const volume = wizardVolume.value;
      if (isNaN(volume) || volume <= 0) {
        if (wizardVolumeInput.value) {
          wizardVolumeInput.value.focus();
          wizardVolumeInput.value.reportValidity();
        }
        return false;
      }
      return true;
    }

    // Scroll wizard step into view (Vue-powered replacement for getElementById scroll)
    function scrollToWizardStep(stepId) {
      Vue.nextTick(() => {
        const step = document.getElementById(stepId);
        if (step) {
          step.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    // Check if event target is a search input (for @keydown.enter handlers)
    function isSearchInput(event) {
      return event?.target?.classList?.contains('wizard-fertilizer-search') || false;
    }

    // Handle keydown.enter for grams input step
    function handleGramsInputEnter(event) {
      if (wizardStep.value === 'grams-input-step' && !isSearchInput(event)) {
        calculateFromWizardGrams();
      }
    }

    // Handle keydown.enter for fertilizer select step
    function handleFertilizerSelectEnter(event) {
      if (wizardStep.value === 'fertilizer-select-step' && !isSearchInput(event)) {
        calculateFromWizardFertilizerSelectVue();
      }
    }

    // Wrapper for global calculateFromWizardFertilizerSelect
    async function calculateFromWizardFertilizerSelectVue() {
      // Call the global function which handles the complex logic
      await calculateFromWizardFertilizerSelect();
    }

    // Show two-tank view (Vue version)
    function showTwoTankView() {
      const pendingCalc = pendingWizardCalculation.value;
      if (!pendingCalc) {
        alert(i18n.t('alertNoCalculationData'));
        return;
      }

      const { type } = pendingCalc;

      // Call the appropriate two-tank display function based on calculation type
      if (type === 'grams-to-ppm') {
        displayTwoTankGramsToPPMResults();
      } else if (type === 'ppm-to-grams') {
        displayTwoTankFormulaResults();
      } else if (type === 'npk-ratio-to-grams') {
        displayTwoTankReverseResults();
      }

      // Set wizard results source
      if (type === 'grams-to-ppm') {
        wizardResultsSource.value = 'ppm-calc';
      } else if (type === 'ppm-to-grams') {
        wizardResultsSource.value = 'formula-builder';
      } else if (type === 'npk-ratio-to-grams') {
        wizardResultsSource.value = 'reverse-calc';
      }
      wizardResultsModeText.value = pendingCalc.indicatorText;

      // Clear pending calculation
      pendingWizardCalculation.value = null;

      // Show wizard results
      showWizardStepVue('wizard-results', { updateIndicator: false });
    }

    // Skip two-tank view (Vue version)
    function skipTwoTankView() {
      const pendingCalc = pendingWizardCalculation.value;
      if (pendingCalc) {
        wizardResultsModeText.value = pendingCalc.indicatorText;

        // Set wizard results source based on calculation type
        if (pendingCalc.type === 'grams-to-ppm') {
          wizardResultsSource.value = 'ppm-calc';
        } else if (pendingCalc.type === 'ppm-to-grams') {
          wizardResultsSource.value = 'formula-builder';
        } else if (pendingCalc.type === 'npk-ratio-to-grams') {
          wizardResultsSource.value = 'reverse-calc';
        }
      }

      // Clear pending calculation
      pendingWizardCalculation.value = null;

      // Reset two-tank view state (in case it was shown previously)
      twoTankDisplayData.show = false;

      // Show wizard results
      showWizardStepVue('wizard-results', { updateIndicator: false });
    }

    // Tab switching (Vue version)
    function switchTab(tabId) {
      currentTab.value = tabId;
      currentMode.value = tabId;
    }

    // Language selection from splash screen
    function selectLanguageFromSplash(langCode) {
      // Hide splash
      showLanguageSplash.value = false;
      // Set the language (this also saves to localStorage via the watcher)
      language.value = langCode;
    }

    // Modal opening functions (wrappers that use openModal)
    function openPPMExplanation() {
      // Get data from the last calculation
      const lastCalc = lastGramsToPPMCalculation.value;
      const data = lastCalc ? {
        volume: lastCalc.volume,
        activeFertilizers: lastCalc.activeFertilizers || [],
        calculationType: 'grams-to-ppm'
      } : {};

      openModal('ppm', data);
    }

    function openIonBalanceExplanation() {
      // Get data from the last calculation
      const lastCalc = lastGramsToPPMCalculation.value;
      const data = lastCalc ? {
        volume: lastCalc.volume,
        activeFertilizers: lastCalc.activeFertilizers || [],
        calculationType: 'grams-to-ppm'
      } : {};
      openModal('ion-balance', data);
    }

    function openEcExplanation() {
      // Get EC data from current display
      const ecPrediction = gramsToPpmDisplayData.ecPrediction;
      const data = {
        ecContributions: ecPrediction?.contributions || {},
        rawEC: ecPrediction?.rawEC || 0,
        ionicStrength: ecPrediction?.ionicStrength || 0,
        ec: ecPrediction?.ec || 0
      };
      openModal('ec', data);
    }

    // Open K:Ca ratio explanation modal with current ratio data
    function openKCaExplanation(kCaData) {
      const ratio = kCaData?.ratio ? parseFloat(kCaData.ratio) : null;
      const status = kCaData?.status || (ratio ? getKCaWarningStatus(ratio) : null);
      openModal('k-ca-ratio', {
        kCaRatio: ratio,
        kCaStatus: status
      });
    }

    // Open NO₃:NH₄ ratio explanation modal with current ratio data
    function openNo3Nh4Explanation(no3Nh4Data) {
      const ratio = no3Nh4Data?.ratio !== undefined ? no3Nh4Data.ratio : null;
      const status = no3Nh4Data?.status || (ratio !== null ? getNo3Nh4WarningStatus(ratio) : null);
      openModal('no3-nh4-ratio', {
        no3Nh4Ratio: ratio,
        no3Nh4Status: status
      });
    }

    function openReversePPMExplanation() {
      const lastCalc = lastReverseCalculation.value;
      let data = {};
      if (lastCalc) {
        const { result, volume } = lastCalc;
        // Fertilizers are in result.formula (same structure as formula builder)
        const activeFertilizers = Object.entries(result.formula)
          .filter(([fertId, grams]) => grams > 0.01)
          .map(([fertId, grams]) => {
            const fert = FERTILIZERS.find(f => f.id === fertId);
            return fert ? { ...fert, grams } : null;
          })
          .filter(Boolean);
        data = { volume, activeFertilizers, calculationType: 'ratio-to-grams' };
      }
      openModal('ppm', data);
    }

    function openReverseIonBalanceExplanation() {
      const lastCalc = lastReverseCalculation.value;
      let data = {};
      if (lastCalc) {
        const { result, volume } = lastCalc;
        // Fertilizers are in result.formula (same structure as formula builder)
        const activeFertilizers = Object.entries(result.formula)
          .filter(([fertId, grams]) => grams > 0.01)
          .map(([fertId, grams]) => {
            const fert = FERTILIZERS.find(f => f.id === fertId);
            return fert ? { ...fert, grams } : null;
          })
          .filter(Boolean);
        data = { volume, activeFertilizers, calculationType: 'ratio-to-grams' };
      }
      openModal('ion-balance', data);
    }

    function openFormulaIonBalanceExplanation() {
      const lastCalc = lastFormulaCalculation.value;
      let data = {};
      if (lastCalc) {
        const { result, volume } = lastCalc;
        const activeFertilizers = Object.entries(result.formula)
          .filter(([fertId, grams]) => grams > 0.01)
          .map(([fertId, grams]) => {
            const fert = FERTILIZERS.find(f => f.id === fertId);
            return fert ? { ...fert, grams } : null;
          })
          .filter(Boolean);
        data = { volume, activeFertilizers, calculationType: 'ppm-to-grams' };
      }
      openModal('ion-balance', data);
    }

    function openReverseEcExplanation() {
      // Get EC data from reverseResultsData
      const ecPrediction = reverseResultsData.ecPrediction;
      const data = {
        ecContributions: ecPrediction?.contributions || {},
        rawEC: ecPrediction?.rawEC || 0,
        ionicStrength: ecPrediction?.ionicStrength || 0,
        ec: ecPrediction?.ec || 0
      };
      openModal('ec', data);
    }

    function openFormulaEcExplanation() {
      // Get EC data from formulaResultsData
      const ecPrediction = formulaResultsData.ecPrediction;
      const data = {
        ecContributions: ecPrediction?.contributions || {},
        rawEC: ecPrediction?.rawEC || 0,
        ionicStrength: ecPrediction?.ionicStrength || 0,
        ec: ecPrediction?.ec || 0
      };
      openModal('ec', data);
    }

    // Show wizard step (Vue-powered replacement for window.vueApp.wizardStep = stepId)
    function showWizardStepVue(stepId, options = {}) {
      const { scroll = true } = options;
      wizardStep.value = stepId;
      if (scroll) {
        scrollToWizardStep(stepId);
      }
    }

    // Select mode (Vue-powered replacement for global selectMode)
    function selectMode(tabId) {
      // Store the selected mode in Vue state (single source of truth)
      currentMode.value = tabId;
      // Show volume step
      showWizardStepVue('volume-step');
      // Focus on the volume input
      focusWizardVolume();
    }

    // Select calculation mode (oxide/elemental)
    function selectCalcMode(mode) {
      wizardCalcMode.value = mode;
    }

    // Proceed from volume step
    function proceedFromVolumeStep() {
      if (!validateWizardVolume()) {
        return;
      }
      const mode = currentMode.value;
      if (MODES_WITH_CALC_MODE.includes(mode)) {
        showWizardStepVue('calc-mode-step');
      } else if (mode === 'ppm-calc') {
        showWizardStepVue('grams-input-step');
      } else {
        proceedToCalculator();
      }
    }

    // Proceed from calculation mode step
    function proceedFromCalcModeStep() {
      const mode = currentMode.value;
      if (MODES_WITH_EC.includes(mode)) {
        showWizardStepVue('ec-step');
      } else if (mode === 'formula-builder') {
        showWizardStepVue('ppm-targets-step');
      } else {
        proceedToCalculator();
      }
    }

    // Proceed from EC step
    function proceedFromECStep() {
      ratioTargetEC.value = wizardSelectedEC.value;
      showWizardStepVue('npk-ratios-step');
    }

    // Proceed to formula fertilizer selection step
    function proceedToFormulaFertilizerStep() {
      const fields = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
      const hasTarget = fields.some(field => parseFloat(wizardTargets[field]) > 0);
      if (!hasTarget) {
        alert(i18n.t('alertEnterTargetPpm'));
        return;
      }
      showWizardStepVue('fertilizer-select-step');
    }

    // Proceed to reverse fertilizer selection step
    function proceedToReverseFertilizerStep() {
      const fields = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
      const hasRatio = fields.some(field => parseFloat(wizardRatios[field]) > 0);
      if (!hasRatio) {
        alert(i18n.t('alertEnterRatioValue'));
        return;
      }
      showWizardStepVue('fertilizer-select-step');
    }

    // Proceed to calculator (final step)
    function proceedToCalculator() {
      const wizardVolumeValue = wizardVolume.value || 10;
      const mode = currentMode.value;
      const calcMode = wizardCalcMode.value;
      const ec = ratioTargetEC.value;

      // Update volume in all calculator tabs
      volume.value = wizardVolumeValue;
      formulaVolume.value = wizardVolumeValue;
      ratioVolume.value = wizardVolumeValue;

      // Apply calculation mode if applicable
      if (MODES_WITH_CALC_MODE.includes(mode)) {
        if (mode === 'formula-builder') {
          formulaCalcMode.value = calcMode;
        } else if (mode === 'reverse-calc') {
          ratioCalcMode.value = calcMode;
        }
      }

      // Show the calculator content
      showWizardStepVue('calculator-content', { updateIndicator: false });

      // Switch to the selected tab
      currentTab.value = mode;

      // Scroll to top smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Back navigation functions
    function backToECStep() {
      showWizardStepVue('ec-step');
    }

    function backToCalcModeStep() {
      showWizardStepVue('calc-mode-step');
    }

    function backToVolumeStep() {
      showWizardStepVue('volume-step');
    }

    function backToModeSelector() {
      showWizardStepVue('mode-selector');
    }

    function backFromCalculator() {
      const mode = currentMode.value;
      if (mode === 'ppm-calc') {
        showWizardStepVue('grams-input-step');
      } else if (mode === 'formula-builder' || mode === 'reverse-calc') {
        showWizardStepVue('fertilizer-select-step');
      } else {
        showWizardStepVue('volume-step');
      }
    }

    function backFromWizardResults() {
      const mode = currentMode.value;

      // Reset two-tank state when going back from results
      twoTankDisplayData.show = false;

      if (mode === 'ppm-calc') {
        showWizardStepVue('grams-input-step');
      } else if (mode === 'formula-builder' || mode === 'reverse-calc') {
        showWizardStepVue('fertilizer-select-step');
      } else {
        showWizardStepVue('volume-step');
      }
    }

    function backFromFertilizerSelectStep() {
      const mode = currentMode.value;
      if (mode === 'formula-builder') {
        showWizardStepVue('ppm-targets-step');
      } else if (mode === 'reverse-calc') {
        showWizardStepVue('npk-ratios-step');
      } else {
        showWizardStepVue('volume-step');
      }
    }

    function goToModeSelector() {
      showWizardStepVue('mode-selector');
      // Reset state
      currentMode.value = null;
      calculationMode.value = 'oxide';
      wizardCalcMode.value = 'oxide';
      ratioTargetEC.value = 'ec:1.2';
      pendingWizardCalculation.value = null;
      gramsToPpmDisplayData.show = false;
      formulaResultsData.show = false;
      reverseResultsData.show = false;
      twoTankDisplayData.show = false;
      wizardResultsSource.value = null;
    }

    // Calculate from wizard grams input step
    async function calculateFromWizardGrams() {
      // Get active fertilizers from wizard state
      const activeFerts = [];
      Object.entries(wizardGramsFertilizers).forEach(([fertId, data]) => {
        if (data.checked && data.grams > 0) {
          const fert = FERTILIZERS.find(f => f.id === fertId);
          if (fert) {
            activeFerts.push({ ...fert, grams: parseFloat(data.grams) });
          }
        }
      });

      if (activeFerts.length === 0) {
        alert(i18n.t('alertSelectFertilizer'));
        return;
      }

      const vol = parseFloat(wizardVolume.value) || 10;

      // Calculate PPM results
      const results = {};
      activeFerts.forEach(fert => {
        Object.entries(fert.pct).forEach(([nutrient, pct]) => {
          if (!results[nutrient]) results[nutrient] = 0;
          results[nutrient] += (fert.grams * pct / 100) / vol * 1000;
        });
      });

      // Calculate totals
      results.N_total = (results.N_NO3 || 0) + (results.N_NH4 || 0);

      // Convert oxides to elemental forms
      if (results.P2O5) {
        results.P = (results.P || 0) + (results.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P);
      }
      if (results.K2O) {
        results.K = (results.K || 0) + (results.K2O * OXIDE_CONVERSIONS.K2O_to_K);
      }
      if (results.CaO) {
        results.Ca = (results.Ca || 0) + (results.CaO * OXIDE_CONVERSIONS.CaO_to_Ca);
      }
      if (results.MgO) {
        results.Mg = (results.Mg || 0) + (results.MgO * OXIDE_CONVERSIONS.MgO_to_Mg);
      }

      // EC and ion balance
      const ecData = estimateECFromPPM(results);
      const ionBalanceData = calculateIonBalanceForFormula(activeFerts, vol);
      const ratioData = calculateNutrientRatios(results);
      const warningsData = checkWarnings(results, activeFerts);

      // Set display data
      setGramsToPpmResults(activeFerts, vol, results, ecData, ionBalanceData, ratioData, warningsData);

      // Set wizard results source and show results
      wizardResultsSource.value = 'ppm-calc';
      wizardResultsModeText.value = i18n.t('currentLabel') + ' <strong>' + getModeName('ppm-calc') + '</strong> · ' + vol + i18n.t('litersShort');
      showWizardStepVue('wizard-results');
    }

    // =========================================================================
    // COPY TO CLIPBOARD (Vue-powered)
    // =========================================================================
    async function copyToClipboardVue(text, buttonId) {
      try {
        await navigator.clipboard.writeText(text);
        // Show feedback via Vue state
        copiedButtonId.value = buttonId;
        setTimeout(() => {
          if (copiedButtonId.value === buttonId) {
            copiedButtonId.value = null;
          }
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        alert(i18n.t('alertCopyFailedTryAgain'));
      }
    }

    // Copy functions using Vue state for feedback
    function copyGramsToPPMResultsVue() {
      const lastCalc = lastGramsToPPMCalculation.value;
      if (!lastCalc) {
        alert(i18n.t('alertRunCalculationFirst'));
        return;
      }
      const text = FertilizerCore.buildGramsToPpmCopyText(lastCalc, getI18nFormatter());
      copyToClipboardVue(text, 'grams-to-ppm');
    }

    function copyPPMToGramsResultsVue() {
      const lastCalc = lastFormulaCalculation.value;
      if (!lastCalc) {
        alert(i18n.t('alertRunCalculationFirst'));
        return;
      }
      const { result, targets, volume } = lastCalc;
      const calculationMode = formulaCalcMode.value;
      const ionBalance = calculateIonBalanceForFormula(
        Object.entries(result.formula).map(([fertId, grams]) => {
          const fert = FERTILIZERS.find(f => f.id === fertId);
          return { ...fert, grams };
        }),
        volume
      );
      const text = FertilizerCore.buildFormulaCopyText(lastCalc, FERTILIZERS, ionBalance, getI18nFormatter());
      copyToClipboardVue(text, 'ppm-to-grams');
    }

    function copyNPKRatioResultsVue() {
      const lastCalc = lastReverseCalculation.value;
      if (!lastCalc) {
        alert(i18n.t('alertRunCalculationFirst'));
        return;
      }
      const { result, targets, volume } = lastCalc;
      const calcMode = ratioCalcMode.value;
      const ionBalance = calculateIonBalanceForFormula(
        Object.entries(result.formula).map(([fertId, grams]) => {
          const fert = FERTILIZERS.find(f => f.id === fertId);
          return { ...fert, grams };
        }),
        volume
      );
      const data = { result, targets, volume, calculationMode: calcMode };
      const text = FertilizerCore.buildReverseCopyText(data, FERTILIZERS, ionBalance, getI18nFormatter());
      copyToClipboardVue(text, 'npk-ratio');
    }

    function copyTwoTankResultsVue() {
      const twoTankData = currentTwoTankData.value;
      if (!twoTankData) {
        alert(i18n.t('alertNoTwoTankData'));
        return;
      }
      const text = FertilizerCore.buildTwoTankCopyText(twoTankData, FERTILIZERS, getI18nFormatter());
      copyToClipboardVue(text, 'two-tank');
    }

    // =========================================================================
    // PROGRESS BAR METHODS (Vue-powered)
    // =========================================================================
    const progressBar = {
      show(title = 'Calculating...') {
        progressState.cancelled = false;
        progressState.onCancel = null;
        progressState.title = title;
        progressState.percent = 0;
        progressState.indeterminate = false;
        progressState.message = i18n.t('initializingSolver') || 'Initializing...';
        progressState.show = true;
      },

      update(percent, message) {
        progressState.indeterminate = false;
        progressState.percent = Math.min(100, Math.max(0, percent));
        if (message) progressState.message = message;
      },

      setIndeterminate(message) {
        progressState.indeterminate = true;
        if (message) progressState.message = message;
      },

      hide() {
        progressState.show = false;
        progressState.onCancel = null;
      },

      cancel() {
        progressState.cancelled = true;
        if (progressState.onCancel) {
          progressState.onCancel();
        }
        this.hide();
      },

      isCancelled() {
        return progressState.cancelled;
      }
    };

    // Initialize on mount
    onMounted(() => {
      initFertilizerAmounts();
      initAvailableFertilizers();
      initReverseFertilizers();
      initWizardGramsFertilizers();
      initWizardAvailFertilizers();
    });

    // Expose to template
    return {
      // Grams to PPM State
      currentMode,
      wizardStep,
      currentTab,
      volume,
      calculationMode,
      language,
      showLanguageSplash,
      currentSubtitle,
      currentSubtitleIndex,
      fertilizerAmounts,
      searchTerm,
      gramsToPpmResults,
      showResults,

      // Wizard State
      wizardVolume,
      wizardSelectedEC,
      wizardCalcMode,
      wizardTargets,
      wizardRatios,
      wizardGramsFertilizers,
      wizardGramsSearchTerm,
      wizardAvailFertilizers,
      wizardAvailSearchTerm,
      wizardECDescription,
      wizardPLabel,
      wizardKLabel,
      modeIndicatorText,
      wizardResultsModeText,
      wizardResultsSource,

      // PPM to Grams (Formula Builder) State
      formulaTargets,
      formulaVolume,
      formulaCalcMode,
      availableFertilizers,
      formulaSearchTerm,
      formulaResults,
      formulaIsCalculating,

      // Ratio to Grams (Reverse Calc) State
      ratioTargets,
      ratioVolume,
      ratioCalcMode,
      ratioTargetEC,
      reverseFertilizers,
      ratioSearchTerm,
      ratioResults,
      ratioIsCalculating,

      // Computed
      filteredFertilizers,
      activeFertilizers,
      filteredAvailableFertilizers,
      selectedAvailableFertilizers,
      filteredReverseFertilizers,
      selectedReverseFertilizers,
      filteredWizardGramsFertilizers,
      filteredWizardAvailFertilizers,
      activeWizardGramsFertilizers,
      selectedWizardAvailFertilizers,
      sortedEcContributions,

      // Grams to PPM Methods
      toggleFertilizer,
      updateGrams,
      formatComposition,
      calculatePPM,
      clearAll,

      // Grams to PPM Results Display (Vue-powered)
      gramsToPpmDisplayData,
      setGramsToPpmResults,

      // PPM to Grams Methods
      toggleAvailableFertilizer,
      selectAllAvailable,
      deselectAllAvailable,
      selectCommonAvailable,
      buildFormulaVue,
      clearFormulaBuilderVue,

      // Formula Builder Results Display (Vue-powered)
      formulaResultsData,
      setFormulaResults,

      // Ratio to Grams Methods
      toggleReverseFertilizer,
      updateReversePriority,
      selectAllReverse,
      deselectAllReverse,
      selectCommonReverse,
      calculateReverseVue,
      clearReverseVue,

      // Reverse Results Display (Vue-powered)
      reverseResultsData,
      setReverseResults,

      // Two-Tank Display (Vue-powered)
      twoTankDisplayData,
      setTwoTankResults,
      toggleTankDetailsVue,
      hideTwoTankView,

      // Calculation state (for copy/export and two-tank decision)
      pendingWizardCalculation,
      lastGramsToPPMCalculation,
      lastFormulaCalculation,
      lastReverseCalculation,
      currentTwoTankData,

      // Wizard State
      wizardStep,
      wizardVolume,
      wizardVolumeInput,

      // Wizard Volume Helpers
      focusWizardVolume,
      validateWizardVolume,
      scrollToWizardStep,
      isSearchInput,
      handleGramsInputEnter,
      handleFertilizerSelectEnter,
      showWizardStepVue,
      selectMode,
      selectCalcMode,
      proceedFromVolumeStep,
      proceedFromCalcModeStep,
      proceedFromECStep,
      proceedToFormulaFertilizerStep,
      proceedToReverseFertilizerStep,
      proceedToCalculator,
      backToECStep,
      backToCalcModeStep,
      backToVolumeStep,
      backToModeSelector,
      backFromCalculator,
      backFromWizardResults,
      backFromFertilizerSelectStep,
      goToModeSelector,
      calculateFromWizardGrams,
      calculateFromWizardFertilizerSelectVue,
      showTwoTankView,
      skipTwoTankView,
      switchTab,
      selectLanguageFromSplash,
      openPPMExplanation,
      openIonBalanceExplanation,
      openEcExplanation,
      openKCaExplanation,
      getKCaWarningStatus,
      openNo3Nh4Explanation,
      getNo3Nh4WarningStatus,
      openReversePPMExplanation,
      openReverseIonBalanceExplanation,
      openReverseEcExplanation,
      openFormulaEcExplanation,
      openFormulaIonBalanceExplanation,

      // Step Indicator
      stepIndicatorText,
      getStepIndicator,
      getTwoTankStepIndicator,

      // Wizard Methods
      initWizardGramsFertilizers,
      initWizardAvailFertilizers,
      clearWizardGramsSelectionsVue,
      updateWizardGrams,
      toggleWizardGramsFertilizer,
      toggleWizardAvailFertilizer,
      selectAllWizardFertilizersVue,
      deselectAllWizardFertilizersVue,
      selectCommonWizardFertilizersVue,

      // Modal State
      activeModal,
      modalData,
      oxideConversions,
      modalTitle,

      // Modal Methods
      openModal,
      closeModal,
      hasOxide,
      hasAnyOxides,
      formatNumber,
      getNutrientContributions,
      calculateIonBalanceForModal,
      getIonDataForFert,
      calculateIonMeq,
      calculateFertCationTotal,
      calculateFertAnionTotal,

      // Progress Bar State & Methods (Vue-powered)
      progressState,
      progressBar,

      // Copy Button Feedback (Vue-powered)
      copiedButtonId,
      copyGramsToPPMResultsVue,
      copyPPMToGramsResultsVue,
      copyNPKRatioResultsVue,
      copyTwoTankResultsVue,

      // Data references (for template access)
      FERTILIZERS,
      COMMON_FERTILIZERS,
      i18n
    };
  }
};

// Mount Vue app when both DOM and i18n are ready
function mountVueApp() {
  const app = createApp(FertilizerApp);
  app.component('ratio-card', RatioCard);
  window.vueApp = app.mount('.calculator-container');
}

function initializeApp() {
  // Wait for i18n to be ready (locale files loaded) before mounting Vue
  i18n.onReady(() => {
    mountVueApp();
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}
</script>
