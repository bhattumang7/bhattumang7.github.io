---
layout: default
title: Fertilizer PPM Calculator
permalink: /fertilizer-calculator/
---

<style>
  .calculator-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .input-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .volume-input {
    margin-bottom: 20px;
  }

  .volume-input label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .volume-input input {
    padding: 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 200px;
  }

  .volume-control-row {
    display: flex;
    align-items: flex-end;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .volume-field {
    display: flex;
    flex-direction: column;
  }

  .button-group {
    display: flex;
    gap: 10px;
  }

  .btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-primary {
    background: #007bff;
    color: white;
  }

  .btn-primary:hover {
    background: #0056b3;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .input-error {
    border-color: #dc3545 !important;
    background-color: #fff5f5 !important;
  }

  .fertilizer-selector {
    margin-bottom: 20px;
  }

  .fertilizer-selector h3 {
    margin-bottom: 10px;
  }

  .fertilizer-item {
    background: white;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .fertilizer-item.active {
    border-color: #007bff;
    background: #f0f8ff;
  }

  .fertilizer-checkbox {
    flex-shrink: 0;
  }

  .fertilizer-info {
    flex-grow: 1;
  }

  .fertilizer-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .fertilizer-composition {
    font-size: 0.9em;
    color: #666;
  }

  .fertilizer-input {
    flex-shrink: 0;
  }

  .fertilizer-input input {
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100px;
  }

  .fertilizer-input label {
    display: inline-block;
    margin-left: 5px;
    font-size: 0.9em;
  }

  .results-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
  }

  .results-section h2 {
    margin-top: 0;
    color: #007bff;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }

  .result-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    border-left: 4px solid #28a745;
  }

  .result-card.zero {
    opacity: 0.5;
    border-left-color: #ccc;
  }

  .result-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
  }

  .result-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #333;
  }

  .result-unit {
    font-size: 0.8em;
    color: #666;
    margin-left: 4px;
  }

  .search-box {
    margin-bottom: 15px;
  }

  .search-box input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .conversion-note {
    background: #fff3cd;
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 0.9em;
    color: #856404;
  }

  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
  }

  .tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.3s;
  }

  .tab:hover {
    color: #007bff;
    background: #f8f9fa;
  }

  .tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .target-input-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .target-input-field {
    display: flex;
    flex-direction: column;
  }

  .target-input-field label {
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 0.9em;
  }

  .target-input-field input {
    padding: 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .formula-result {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
  }

  .formula-fertilizer {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px;
    background: white;
    margin-bottom: 8px;
    border-radius: 4px;
    border-left: 4px solid #28a745;
    flex-wrap: wrap;
    gap: 5px;
  }

  .formula-fertilizer-info {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
  }

  .formula-fertilizer-name {
    font-weight: bold;
    color: #333;
  }

  .formula-fertilizer-composition {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
  }

  .formula-fertilizer-amount {
    font-weight: bold;
    white-space: nowrap;
    text-align: right;
  }

  .ion-balance-summary {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .ion-balance-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
  }

  .ion-balance-card.status {
    border: 2px solid;
  }

  .ion-balance-breakdown {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .ion-list-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: #f8f9fa;
    margin-bottom: 5px;
    border-radius: 4px;
  }

  .nutrient-ratio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 10px;
  }

  .nutrient-ratio-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    border-left: 4px solid #007bff;
  }

  .comparison-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 15px;
  }

  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
  }

  .comparison-table th,
  .comparison-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
  }

  .comparison-table th {
    background: #f8f9fa;
    font-weight: bold;
  }

  .comparison-table .match {
    color: #28a745;
    font-weight: bold;
  }

  .comparison-table .close {
    color: #ffc107;
    font-weight: bold;
  }

  .comparison-table .miss {
    color: #dc3545;
    font-weight: bold;
  }

  .warning-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    border-radius: 4px;
    margin-top: 15px;
  }

  .error-box {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    padding: 15px;
    border-radius: 4px;
    margin-top: 15px;
  }

  .fertilizer-selection {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
  }

  .fertilizer-selection h4 {
    margin-top: 0;
    margin-bottom: 10px;
  }

  .fertilizer-search {
    margin-bottom: 10px;
  }

  .fertilizer-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }

  .fertilizer-search input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
  }

  .fertilizer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 4px;
  }

  .fertilizer-checkbox-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 5px;
  }

  .fertilizer-checkbox-item input[type="checkbox"] {
    cursor: pointer;
    margin-top: 3px;
  }

  .fertilizer-checkbox-item label {
    cursor: pointer;
    font-size: 0.9em;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  .fertilizer-label-name {
    font-weight: bold;
  }

  .fertilizer-label-aliases {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
  }

  .selection-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .selection-controls button {
    padding: 5px 10px;
    font-size: 0.85em;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .selection-controls button:hover {
    background: #5a6268;
  }

  .selected-fertilizer-item {
    background: #f8f9fa;
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-left: 4px solid #007bff;
    flex-wrap: wrap;
    gap: 5px;
  }

  .selected-fertilizer-info {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
  }

  .selected-fertilizer-name {
    font-weight: bold;
    color: #333;
  }

  .selected-fertilizer-composition {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
  }

  .selected-fertilizer-amount {
    color: #007bff;
    font-weight: bold;
    font-size: 1.1em;
    white-space: nowrap;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .calculator-container {
      padding: 10px;
    }

    h1 {
      font-size: 1.5em;
    }

    h2 {
      font-size: 1.3em;
    }

    h3 {
      font-size: 1.1em;
    }

    .input-section {
      padding: 15px;
    }

    .volume-control-row {
      flex-direction: column;
      align-items: stretch;
    }

    .volume-field {
      width: 100%;
    }

    .volume-field input {
      width: 100%;
    }

    .button-group {
      width: 100%;
      flex-direction: column;
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 14px;
    }

    .fertilizer-item {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      padding: 12px;
    }

    .fertilizer-info {
      width: 100%;
    }

    .fertilizer-input {
      width: 100%;
    }

    .fertilizer-input input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }

    .search-box input {
      width: 100%;
      font-size: 16px;
      padding: 10px;
    }

    .results-section {
      padding: 15px;
    }

    .results-grid {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .result-card {
      padding: 12px;
    }

    .result-value {
      font-size: 1.3em;
    }

    .tabs {
      flex-direction: column;
    }

    .tab {
      width: 100%;
      text-align: center;
    }

    .comparison-table {
      font-size: 14px;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 8px 4px;
      font-size: 12px;
    }

    .comparison-table th:first-child,
    .comparison-table td:first-child {
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }

    .comparison-table th:first-child {
      background: #f8f9fa;
    }

    .ion-balance-summary {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .ion-balance-card {
      padding: 12px;
    }

    .ion-balance-breakdown {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .ion-list-item {
      flex-direction: column;
      gap: 5px;
      text-align: left;
    }

    .nutrient-ratio-grid {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .nutrient-ratio-card {
      padding: 12px;
    }

    .selected-fertilizer-item {
      padding: 10px;
      font-size: 0.9em;
    }

    .selected-fertilizer-amount {
      font-size: 1em;
    }

    .selected-fertilizer-composition,
    .formula-fertilizer-composition {
      font-size: 0.8em;
      word-break: break-word;
    }

    .formula-fertilizer {
      padding: 8px;
    }

    /* Formula Builder Mobile Styles */
    .target-inputs {
      grid-template-columns: 1fr !important;
    }

    .target-input-group {
      width: 100%;
    }

    .target-input-group input {
      width: 100%;
      font-size: 16px;
      padding: 10px;
    }

    .fertilizer-selection-grid {
      grid-template-columns: 1fr !important;
    }

    .available-fert-item {
      padding: 10px;
    }

    /* Ratio and Balance Tables */
    .ratio-table, .balance-table {
      font-size: 0.85em;
      overflow-x: auto;
      display: block;
    }

    .ratio-table td, .ratio-table th,
    .balance-table td, .balance-table th {
      padding: 6px;
    }

    .conversion-note {
      font-size: 0.85em;
      padding: 8px;
    }

    .warning-box {
      font-size: 0.85em;
      padding: 8px;
    }
  }

  @media (max-width: 480px) {
    .calculator-container {
      padding: 5px;
    }

    h1 {
      font-size: 1.3em;
    }

    h2 {
      font-size: 1.1em;
    }

    .input-section, .results-section {
      padding: 10px;
    }

    .btn {
      font-size: 13px;
      padding: 10px;
    }

    .fertilizer-item {
      padding: 10px;
    }

    .fertilizer-name {
      font-size: 0.95em;
    }

    .fertilizer-composition {
      font-size: 0.8em;
    }

    .result-card {
      padding: 10px;
    }

    .result-label {
      font-size: 0.85em;
    }

    .result-value {
      font-size: 1.2em;
    }
  }

  /* Educational Modal Styles */
  .info-icon {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    margin-left: 10px;
    transition: all 0.3s;
    vertical-align: middle;
  }

  .info-icon:hover {
    background: #0056b3;
    transform: scale(1.1);
  }

  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
  }

  .modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 25px;
    border-radius: 12px 12px 0 0;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .modal-header h2 {
    margin: 0;
    color: white;
    font-size: 1.5em;
  }

  .modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-body {
    padding: 30px;
  }

  .explanation-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
  }

  .explanation-section h3 {
    color: #007bff;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
  }

  .explanation-section p {
    margin-bottom: 10px;
    line-height: 1.6;
  }

  .formula-box {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    text-align: center;
  }

  .formula-box .formula {
    font-size: 1.2em;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 10px;
  }

  .formula-box .description {
    font-size: 0.9em;
    color: #666;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .example-box {
    background: #e8f4f8;
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #17a2b8;
  }

  .example-box h4 {
    color: #17a2b8;
    margin-top: 0;
    margin-bottom: 10px;
  }

  .step {
    padding: 15px;
    margin: 10px 0;
    background: white;
    border-radius: 6px;
    border-left: 3px solid #28a745;
  }

  .step-number {
    display: inline-block;
    background: #28a745;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    text-align: center;
    line-height: 28px;
    margin-right: 10px;
    font-weight: bold;
  }

  .conversion-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    background: white;
  }

  .conversion-table th,
  .conversion-table td {
    padding: 12px;
    text-align: left;
    border: 1px solid #dee2e6;
  }

  .conversion-table th {
    background: #007bff;
    color: white;
    font-weight: bold;
  }

  .conversion-table tr:nth-child(even) {
    background: #f8f9fa;
  }

  .highlight {
    background: #fff3cd;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .modal-content {
      margin: 10px;
      max-height: 95vh;
    }

    .modal-header {
      padding: 20px;
    }

    .modal-header h2 {
      font-size: 1.2em;
    }

    .modal-body {
      padding: 20px;
    }

    .explanation-section {
      padding: 15px;
    }

    .formula-box .formula {
      font-size: 1em;
    }
  }
</style>

<div class="calculator-container">
  <h1>Fertilizer PPM Calculator</h1>
  <p>Calculate nutrient concentrations (PPM) from fertilizer additions to water.</p>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('ppm-calc')">PPM Calculator</button>
    <button class="tab" onclick="switchTab('formula-builder')">Formula Builder</button>
    <button class="tab" onclick="switchTab('reverse-calc')">Reverse Calculator</button>
  </div>

  <!-- PPM Calculator Tab -->
  <div id="ppm-calc" class="tab-content active">
    <div class="input-section">
    <div class="volume-control-row">
      <div class="volume-field">
        <label for="volume">Solution Volume:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" id="volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
          <span>liters</span>
        </div>
      </div>
      <div class="button-group">
        <button onclick="calculate()" class="btn btn-primary">
          Calculate PPM
        </button>
        <button onclick="clearAll()" class="btn btn-danger">
          Clear All
        </button>
      </div>
    </div>

    <div class="fertilizer-selector">
      <h3>Select Fertilizers and Enter Amounts</h3>
      <div class="search-box">
        <input type="text" id="search" placeholder="Search fertilizers...">
      </div>
      <div id="fertilizer-list"></div>
    </div>
  </div>

  <div class="results-section" id="selected-fertilizers-section" style="display: none;">
    <h2>Selected Fertilizers</h2>
    <div id="selected-fertilizers-list"></div>
  </div>

  <div class="results-section" id="results" style="display: none; margin-top: 20px;">
    <h2>
      Results (PPM)
      <span class="info-icon" onclick="openPPMExplanation()" title="Click to learn how we calculate PPM">?</span>
    </h2>
    <div class="results-grid" id="results-grid"></div>
    <div class="conversion-note">
      <strong>Note:</strong> Oxide values (P₂O₅, K₂O, etc.) are automatically converted to elemental forms (P, K, etc.) using standard conversion factors.
    </div>
  </div>

  <div class="results-section" id="ion-balance-section" style="display: none; margin-top: 20px;">
    <h2>
      Ion Balance
      <span class="info-icon" onclick="openIonBalanceExplanation()" title="Click to learn how we calculate Ion Balance">?</span>
    </h2>
    <div id="ion-balance-result"></div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong>What is ion balance?</strong> Fertilizers dissolve into charged ions (cations like K⁺, Ca²⁺, NH₄⁺ and anions like NO₃⁻, SO₄²⁻, H₂PO₄⁻). A balanced feed has approximately equal positive and negative charges. Imbalance ≤10% is acceptable; higher values may cause pH swings and nutrient lockouts.
    </div>
  </div>

  <div class="results-section" id="ratio-analysis-section" style="display: none; margin-top: 20px;">
    <h2>Nutrient Ratio Analysis</h2>
    <div id="ratio-analysis-result"></div>
    <div class="conversion-note" style="margin-top: 15px;">
      <strong>What are nutrient ratios?</strong> These ratios show the relative proportions of key nutrients. For example, "1 : 0.5 : 2" for N:P:K means for every 1 part nitrogen, you have 0.5 parts phosphorus and 2 parts potassium. These ratios help compare different fertilizer formulations and match specific crop requirements.
    </div>
  </div>

  <div class="results-section" id="ec-tds-section" style="display: none; margin-top: 20px;">
    <h2>EC Prediction</h2>
    <div id="ec-tds-result"></div>
  </div>

  <div class="results-section" id="warnings-section" style="display: none; margin-top: 20px;">
    <h2>Warnings & Recommendations</h2>
    <div id="warnings-result"></div>
  </div>
  </div>

  <!-- Formula Builder Tab -->
  <div id="formula-builder" class="tab-content">
    <div class="input-section">
      <div class="fertilizer-selection">
        <h4>Available Fertilizers</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Select the fertilizers you have available. The calculator will use only these to build your formula.</p>
        <div class="fertilizer-search">
          <input type="text" id="available-fertilizer-search" placeholder="Search fertilizers..." oninput="filterAvailableFertilizers(this.value)">
        </div>
        <div class="selection-controls">
          <button onclick="selectAllAvailableFertilizers()">Select All</button>
          <button onclick="deselectAllAvailableFertilizers()">Deselect All</button>
          <button onclick="selectCommonFertilizers()">Select Common Only</button>
        </div>
        <div class="fertilizer-grid" id="available-fertilizers-list"></div>
      </div>

      <h3>Target PPM Values</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient concentrations. The calculator will find the best fertilizer combination to match your targets.</p>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="target-n">Nitrogen (N) *</label>
          <input type="number" id="target-n" min="0.1" step="1" placeholder="e.g., 150" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="target-p">Phosphorus (P) *</label>
          <input type="number" id="target-p" min="0.1" step="1" placeholder="e.g., 50" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="target-k">Potassium (K) *</label>
          <input type="number" id="target-k" min="0.1" step="1" placeholder="e.g., 200" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="target-ca">Calcium (Ca) *</label>
          <input type="number" id="target-ca" min="0" step="1" placeholder="e.g., 150" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="target-mg">Magnesium (Mg) *</label>
          <input type="number" id="target-mg" min="0.1" step="1" placeholder="e.g., 50" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="target-s">Sulfur (S)</label>
          <input type="number" id="target-s" min="0" step="1" placeholder="Optional" oninput="validateTargetInput(this, true)">
        </div>
      </div>

      <div class="volume-input">
        <label for="formula-volume">Solution Volume:</label>
        <input type="number" id="formula-volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="buildFormula()" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Build Formula
        </button>
        <button onclick="clearFormulaBuilder()" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <div class="results-section" id="formula-results" style="display: none;">
      <h2>Recommended Formula</h2>
      <div id="formula-output"></div>
    </div>
  </div>

  <!-- Reverse Calculator Tab -->
  <div id="reverse-calc" class="tab-content">
    <div class="input-section">
      <h3>Target Nutrient Ratios</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your desired nutrient ratios (e.g., N:P:K = 3:1:2). At least one nutrient must be greater than zero. The calculator will find fertilizer amounts that match these ratios.</p>

      <div class="target-input-grid">
        <div class="target-input-field">
          <label for="reverse-n">Nitrogen (N)</label>
          <input type="number" id="reverse-n" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-p">Phosphorus (P)</label>
          <input type="number" id="reverse-p" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-k">Potassium (K)</label>
          <input type="number" id="reverse-k" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-ca">Calcium (Ca)</label>
          <input type="number" id="reverse-ca" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-mg">Magnesium (Mg)</label>
          <input type="number" id="reverse-mg" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this)">
        </div>
        <div class="target-input-field">
          <label for="reverse-s">Sulfur (S)</label>
          <input type="number" id="reverse-s" min="0" step="1" placeholder="Optional (0 or more)" oninput="validateTargetInput(this, true)">
        </div>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-calculation-mode" style="display: block; margin-bottom: 8px; font-weight: bold;">Calculation Mode</label>
        <select id="reverse-calculation-mode" onchange="updateReverseCalculationMode()" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
          <option value="oxide" selected>Oxide Forms (P₂O₅, K₂O) - Commercial Standard</option>
          <option value="elemental">Elemental Forms (P, K) - Pure Elements</option>
        </select>
        <p style="margin-top: 5px; margin-bottom: 15px; color: #666; font-size: 0.85em;">
          <strong>Oxide mode:</strong> Uses P₂O₅ and K₂O (standard fertilizer labels)<br>
          <strong>Elemental mode:</strong> Uses pure P and K (scientific calculations)
        </p>
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <label for="reverse-concentration" style="display: block; margin-bottom: 8px; font-weight: bold;">Target Concentration</label>
        <select id="reverse-concentration" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="50">Light (EC ~1.0) - Seedlings/Cuttings</option>
          <option value="75" selected>Moderate (EC ~1.5) - General Purpose</option>
          <option value="100">Strong (EC ~2.0) - Vegetative Growth</option>
          <option value="125">Very Strong (EC ~2.5) - Heavy Feeders</option>
        </select>
        <p style="margin-top: 5px; color: #666; font-size: 0.85em;">This determines the fertilizer amounts while maintaining your ratio.</p>
      </div>

      <div class="fertilizer-selection">
        <h4>Select Fertilizers to Use</h4>
        <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Choose which fertilizers you want to use. The calculator will find the best combination from your selection.</p>
        <div class="fertilizer-search">
          <input type="text" id="reverse-fertilizer-search" placeholder="Search fertilizers..." oninput="filterReverseFertilizers(this.value)">
        </div>
        <div class="selection-controls">
          <button onclick="selectAllReverseFertilizers()">Select All</button>
          <button onclick="deselectAllReverseFertilizers()">Deselect All</button>
          <button onclick="selectCommonReverseFertilizers()">Select Common Only</button>
        </div>
        <div class="fertilizer-grid" id="reverse-fertilizers-list"></div>
      </div>

      <div class="volume-input">
        <label for="reverse-volume">Solution Volume:</label>
        <input type="number" id="reverse-volume" value="10" min="0.1" step="0.1" oninput="validateVolumeInput(this)">
        <span>liters</span>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="calculateReverse()" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Calculate Fertilizers
        </button>
        <button onclick="clearReverseCalculator()" style="padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear
        </button>
      </div>
    </div>

    <div class="results-section" id="reverse-results" style="display: none;">
      <h2>Required Fertilizers</h2>
      <div id="reverse-output"></div>
    </div>
  </div>

</div>

<!-- Educational Modal for PPM Calculation -->
<div id="ppm-modal" class="modal-overlay" onclick="closePPMExplanation(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Understanding PPM Calculations</h2>
      <button class="modal-close" onclick="closePPMExplanation()">&times;</button>
    </div>
    <div class="modal-body">

      <!-- What is PPM? -->
      <div class="explanation-section">
        <h3>What is PPM?</h3>
        <p>
          <strong>PPM stands for "Parts Per Million"</strong> - it's a way to measure very small concentrations, similar to how we use percentages.
          Think of it like this: if you have 1 million drops of water, PPM tells you how many drops of nutrients are mixed in.
        </p>
        <p>
          For example, <span class="highlight">100 PPM of Nitrogen</span> means there are 100 grams of nitrogen in every 1 million grams (1000 liters) of water.
          In simpler terms: <strong>1 PPM = 1 milligram per liter (mg/L)</strong>.
        </p>
      </div>

      <!-- The Basic Formula -->
      <div class="explanation-section">
        <h3>The Basic Formula</h3>
        <p>Here's the formula we use to calculate PPM:</p>

        <div class="formula-box">
          <div class="formula">PPM = (grams × 1000 × percentage) ÷ liters</div>
          <div class="description">This tells us the concentration of nutrients in your solution</div>
        </div>

        <p>Let's break down each part:</p>
        <ul style="line-height: 1.8;">
          <li><strong>grams</strong> = Amount of fertilizer you're adding</li>
          <li><strong>1000</strong> = Converts grams to milligrams (mg)</li>
          <li><strong>percentage</strong> = The nutrient content in the fertilizer (÷ 100)</li>
          <li><strong>liters</strong> = Volume of water in your solution</li>
        </ul>
      </div>

      <!-- Step by Step Example -->
      <div class="explanation-section">
        <h3>Step-by-Step Example</h3>

        <div class="example-box">
          <h4>Real World Scenario:</h4>
          <p>You want to add <strong>2 grams</strong> of Calcium Nitrate (which contains <strong>19% Nitrogen</strong>) to <strong>10 liters</strong> of water.</p>
          <p><em>Question: How much Nitrogen (in PPM) will be in your final solution?</em></p>
        </div>

        <div class="step">
          <span class="step-number">1</span>
          <strong>Identify your values:</strong>
          <ul style="margin: 10px 0 0 38px; line-height: 1.6;">
            <li>Fertilizer amount = 2 grams</li>
            <li>Nitrogen percentage = 19% (or 0.19)</li>
            <li>Water volume = 10 liters</li>
          </ul>
        </div>

        <div class="step">
          <span class="step-number">2</span>
          <strong>Plug into the formula:</strong>
          <div style="margin: 10px 0 0 38px;">
            <code>PPM = (2 grams × 1000 × 0.19) ÷ 10 liters</code>
          </div>
        </div>

        <div class="step">
          <span class="step-number">3</span>
          <strong>Calculate step by step:</strong>
          <ul style="margin: 10px 0 0 38px; line-height: 1.6;">
            <li>2 × 1000 = 2000 mg</li>
            <li>2000 × 0.19 = 380 mg of nitrogen</li>
            <li>380 ÷ 10 = <strong>38 PPM</strong></li>
          </ul>
        </div>

        <div class="step">
          <span class="step-number">4</span>
          <strong>Result:</strong>
          <div style="margin: 10px 0 0 38px;">
            Your solution contains <span class="highlight">38 PPM of Nitrogen</span>
          </div>
        </div>
      </div>

      <!-- Multiple Fertilizers -->
      <div class="explanation-section">
        <h3>Using Multiple Fertilizers</h3>
        <p>
          When you use multiple fertilizers, we calculate the PPM from each one separately and then <strong>add them together</strong>.
        </p>

        <div class="example-box">
          <h4>Example with Two Fertilizers:</h4>
          <p>You add both Calcium Nitrate (2g, 19% N) and Potassium Nitrate (1.5g, 13% N) to 10 liters:</p>

          <ul style="line-height: 1.8; margin-top: 10px;">
            <li><strong>From Calcium Nitrate:</strong> (2 × 1000 × 0.19) ÷ 10 = 38 PPM</li>
            <li><strong>From Potassium Nitrate:</strong> (1.5 × 1000 × 0.13) ÷ 10 = 19.5 PPM</li>
            <li><strong>Total Nitrogen:</strong> 38 + 19.5 = <span class="highlight">57.5 PPM</span></li>
          </ul>
        </div>
      </div>

      <!-- Oxide Conversions -->
      <div class="explanation-section">
        <h3>Understanding Oxide Conversions</h3>
        <p>
          Many fertilizers list nutrients in their <strong>oxide form</strong> (like P₂O₅ for phosphorus or K₂O for potassium),
          but plants actually use the <strong>elemental form</strong>. Don't worry - the calculator handles this automatically!
        </p>

        <table class="conversion-table">
          <thead>
            <tr>
              <th>Oxide Form (on fertilizer label)</th>
              <th>Elemental Form (what plants use)</th>
              <th>Conversion Factor</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>P₂O₅ (Phosphate)</td>
              <td>P (Phosphorus)</td>
              <td>Multiply by 0.436</td>
            </tr>
            <tr>
              <td>K₂O (Potash)</td>
              <td>K (Potassium)</td>
              <td>Multiply by 0.830</td>
            </tr>
            <tr>
              <td>MgO (Magnesium Oxide)</td>
              <td>Mg (Magnesium)</td>
              <td>Multiply by 0.603</td>
            </tr>
            <tr>
              <td>CaO (Calcium Oxide)</td>
              <td>Ca (Calcium)</td>
              <td>Multiply by 0.715</td>
            </tr>
          </tbody>
        </table>

        <div class="example-box" style="margin-top: 15px;">
          <h4>Quick Example:</h4>
          <p>
            If a fertilizer gives you <strong>100 PPM of P₂O₅</strong>, the actual phosphorus available to plants is:<br>
            <strong>100 × 0.436 = 43.6 PPM of P</strong>
          </p>
          <p style="margin-top: 10px; color: #17a2b8; font-weight: bold;">
            ✓ The calculator does this conversion automatically for you!
          </p>
        </div>
      </div>

      <!-- Why This Matters -->
      <div class="explanation-section">
        <h3>Why Does This Matter?</h3>
        <p>
          Understanding PPM helps you:
        </p>
        <ul style="line-height: 1.8;">
          <li><strong>Feed plants properly:</strong> Different plants need different nutrient levels (e.g., tomatoes might need 150-200 PPM nitrogen)</li>
          <li><strong>Avoid over-feeding:</strong> Too much nutrients can burn or damage plants</li>
          <li><strong>Save money:</strong> Use just the right amount of fertilizer</li>
          <li><strong>Compare recipes:</strong> Understand different fertilizer formulations</li>
        </ul>
      </div>

      <!-- Quick Tips -->
      <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
        <h3 style="color: #28a745;">Quick Tips</h3>
        <ul style="line-height: 1.8;">
          <li>Start with lower PPM values and increase gradually</li>
          <li>1 PPM = 1 mg/L (milligram per liter)</li>
          <li>More fertilizer ≠ better growth; balance is key</li>
          <li>Check your water's existing nutrient content if possible</li>
          <li>Different growth stages may need different PPM levels</li>
        </ul>
      </div>

    </div>
  </div>
</div>

<!-- Educational Modal for Ion Balance -->
<div id="ion-balance-modal" class="modal-overlay" onclick="closeIonBalanceExplanation(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Understanding Ion Balance</h2>
      <button class="modal-close" onclick="closeIonBalanceExplanation()">&times;</button>
    </div>
    <div class="modal-body" id="ion-balance-modal-body">
      <!-- Content will be dynamically generated -->
    </div>
  </div>
</div>

<script>
// Fertilizer database
const FERTILIZERS = [
  {
    id: "calcium_nitrate_calcinit_typical",
    name: "Calcium Nitrate - Calcinit type (15.5% N, 19% Ca)",
    aliases: ["YaraLiva Calcinit", "Calcium nitrate 15.5-0-0 + Ca", "Calcinit"],
    pct: { N_total: 15.5, N_NO3: 14.4, N_NH4: 1.1, Ca: 19.0 }
  },
  {
    id: "potassium_nitrate_typical",
    name: "Potassium Nitrate",
    aliases: ["KNO3", "13.7-0-46.3"],
    pct: { N_total: 13.7, N_NO3: 13.7, K2O: 46.3 }
  },
  {
    id: "map_typical",
    name: "Mono Ammonium Phosphate (MAP)",
    aliases: ["NH4H2PO4", "12-61-0", "12 61", "12:61" ],
    pct: { N_total: 12.0, N_NH4: 12.0, P2O5: 61.0 }
  },
  {
    id: "mkp_typical",
    name: "Mono Potassium Phosphate (MKP)",
    aliases: ["KH2PO4", "0-52-34", "0:52:34", "52 34"],
    pct: { P2O5: 52.0, K2O: 34.0 }
  },
  {
    id: "dap_common",
    name: "Di Ammonium Phosphate (DAP)",
    aliases: ["(NH4)2HPO4", "18-46-0"],
    pct: { N_total: 18.0, N_NH4: 18.0, P2O5: 46.0 }
  },
  {
    id: "urea_common",
    name: "Urea",
    aliases: ["CO(NH2)2", "46-0-0"],
    pct: { N_total: 46.0, N_Urea: 46.0 }
  },
  {
    id: "ammonium_sulfate_common",
    name: "Ammonium Sulfate",
    aliases: ["(NH4)2SO4", "21-0-0 + 24S"],
    pct: { N_total: 21.0, N_NH4: 21.0, S: 24.0 }
  },
  {
    id: "ammonium_nitrate_common",
    name: "Ammonium Nitrate - Solid (34% N)",
    aliases: ["NH4NO3", "34-0-0 (typical)", "Ammonium Nitrate solid"],
    pct: { N_total: 34.0, N_NO3: 17.0, N_NH4: 17.0 }
  },
  {
    id: "magnesium_sulfate_heptahydrate_common",
    name: "Magnesium Sulfate - Heptahydrate / Epsom Salt (9.86% Mg)",
    aliases: ["MgSO4·7H2O", "Epsom Salt", "Magnesium Sulfate 7H2O"],
    pct: { Mg: 9.86, S: 13.0 }
  },
  {
    id: "magnesium_sulfate_16mgo",
    name: "Magnesium Sulfate (16% MgO) (~9.6% Mg, ~13% S)",
    aliases: ["MgSO4", "Magnesium Sulphate", "Epsom Salt", "MgSO4·7H2O (if heptahydrate)"],
    pct: { MgO: 16.0, Mg: 9.6, S: 13.0 }
  },
  {
    id: "magnesium_nitrate_hexahydrate_typical",
    name: "Magnesium Nitrate - Hexahydrate (10.9% N, 9.5% Mg)",
    aliases: ["Mg(NO3)2·6H2O", "Magnesium Nitrate 6H2O"],
    pct: { N_total: 10.9, N_NO3: 10.9, Mg: 9.5 }
  },
  {
    id: "potassium_sulfate_common",
    name: "Potassium Sulfate (SOP)",
    aliases: ["K2SO4", "0-0-50 + ~17S"],
    pct: { K2O: 50.0, S: 17.0 }
  },
  {
    id: "potassium_chloride_common",
    name: "Potassium Chloride (MOP)",
    aliases: ["KCl", "0-0-60"],
    pct: { K2O: 60.0, Cl: 47.6 }
  },
  {
    id: "calcium_chloride_dihydrate_common",
    name: "Calcium Chloride - Dihydrate (27.2% Ca)",
    aliases: ["CaCl2·2H2O", "Calcium Chloride 2H2O"],
    pct: { Ca: 27.2, Cl: 48.3 }
  },
  {
    id: "langbeinite_common",
    name: "Langbeinite / Sul-Po-Mag",
    aliases: ["K2SO4·2MgSO4", "0-0-22 + 11Mg + 22S"],
    pct: { K2O: 22.0, Mg: 11.0, S: 22.0 }
  },
  {
    id: "uan32_solution_typical",
    name: "UAN Solution (example: 32-0-0)",
    aliases: ["UAN-32"],
    pct: { N_total: 32.0, N_Urea: 16.0, N_NO3: 8.0, N_NH4: 8.0 }
  },
  {
    id: "ammonium_thiosulfate_common",
    name: "Ammonium Thiosulfate (ATS)",
    aliases: ["12-0-0-26S (common liquid)"],
    pct: { N_total: 12.0, N_NH4: 12.0, S: 26.0 }
  },
  {
    id: "potassium_thiosulfate_common",
    name: "Potassium Thiosulfate (KTS)",
    aliases: ["0-0-25-17S (common liquid)"],
    pct: { K2O: 25.0, S: 17.0 }
  },
  {
    id: "fe_edta_13",
    name: "Iron Chelate - EDTA (13% Fe)",
    aliases: ["Fe-EDTA 13", "Fe-EDTA 13%"],
    pct: { Fe: 13.0 }
  },
  {
    id: "boric_acid_common",
    name: "Boric Acid",
    aliases: ["H3BO3"],
    pct: { B: 17.5 }
  },
  {
    id: "zinc_sulfate_heptahydrate_common",
    name: "Zinc Sulfate - Heptahydrate (22.7% Zn)",
    aliases: ["ZnSO4·7H2O", "Zinc Sulfate 7H2O"],
    pct: { Zn: 22.7, S: 11.2 }
  },
  {
    id: "nitric_acid_38",
    name: "Nitric Acid 38%",
    aliases: ["HNO3 38%"],
    pct: { N_total: 8.4, N_NO3: 8.4 }
  },
  {
    id: "nitric_acid_60",
    name: "Nitric Acid 60%",
    aliases: ["HNO3 60%"],
    pct: { N_total: 13.3, N_NO3: 13.3 }
  },
  {
    id: "phosphoric_acid_49",
    name: "Phosphoric Acid 49%",
    aliases: ["H3PO4 49%"],
    pct: { P: 18.6 }
  },
  {
    id: "potassium_bicarbonate",
    name: "Potassium Bicarbonate",
    aliases: ["KHCO3"],
    pct: { K: 39.0 }
  },
  {
    id: "ammonium_nitrate_liquid",
    name: "Ammonium Nitrate - Liquid (18% N)",
    aliases: ["NH4NO3 liquid", "Ammonium Nitrate liquid"],
    pct: { N_total: 18.0, N_NO3: 9.0, N_NH4: 9.0 }
  },
  {
    id: "urea_phosphate",
    name: "Urea Phosphate",
    aliases: ["CO(NH2)2·H3PO4"],
    pct: { N_total: 17.5, N_Urea: 17.5, P: 19.6 }
  },
  {
    id: "calcium_nitrate_4h2o",
    name: "Calcium Nitrate - Tetrahydrate (11.5% N, 16.5% Ca)",
    aliases: ["Ca(NO3)2·4H2O", "Calcium Nitrate 4H2O"],
    pct: { N_total: 11.5, N_NO3: 11.5, Ca: 16.5 }
  },
  {
    id: "calcium_nitrate_anhydrous",
    name: "Calcium Nitrate - Anhydrous (15.5% N, 18.5% Ca)",
    aliases: ["Ca(NO3)2", "Calcium Nitrate anhydrous"],
    pct: { N_total: 15.5, N_NO3: 15.5, Ca: 18.5 }
  },
  {
    id: "calcium_nitrate_liquid",
    name: "Calcium Nitrate - Liquid (8.7% N, 12.5% Ca)",
    aliases: ["Ca(NO3)2 liquid", "Calcium Nitrate liquid"],
    pct: { N_total: 8.7, N_NO3: 8.7, Ca: 12.5 }
  },
  {
    id: "calcium_chloride_solid",
    name: "Calcium Chloride - Solid (36% Ca)",
    aliases: ["CaCl2 solid", "Calcium Chloride solid"],
    pct: { Ca: 36.0, Cl: 63.9 }
  },
  {
    id: "calcium_chloride_liquid",
    name: "Calcium Chloride - Liquid (11.8% Ca)",
    aliases: ["CaCl2 liquid", "Calcium Chloride liquid"],
    pct: { Ca: 11.8, Cl: 20.9 }
  },
  {
    id: "magnesium_sulfate_anhydrous",
    name: "Magnesium Sulfate - Anhydrous (19.6% Mg)",
    aliases: ["MgSO4", "Magnesium Sulfate anhydrous"],
    pct: { Mg: 19.6, S: 26.5 }
  },
  {
    id: "magnesium_nitrate_liquid",
    name: "Magnesium Nitrate - Liquid (7% N, 6.1% Mg)",
    aliases: ["Mg(NO3)2 liquid", "Magnesium Nitrate liquid"],
    pct: { N_total: 7.0, N_NO3: 7.0, Mg: 6.1 }
  },
  {
    id: "fe_dtpa_12",
    name: "Iron Chelate - DTPA solid (12% Fe)",
    aliases: ["Fe-DTPA 12%", "Fe-DTPA 12"],
    pct: { Fe: 12.0 }
  },
  {
    id: "fe_dtpa_liquid_3",
    name: "Iron Chelate - DTPA liquid (3% Fe)",
    aliases: ["Fe-DTPA 3%", "Fe-DTPA 3"],
    pct: { Fe: 3.0 }
  },
  {
    id: "fe_dtpa_liquid_6",
    name: "Iron Chelate - DTPA liquid (6% Fe)",
    aliases: ["Fe-DTPA 6%", "Fe-DTPA 6"],
    pct: { Fe: 6.0 }
  },
  {
    id: "fe_eddha_6",
    name: "Iron Chelate - EDDHA (6% Fe)",
    aliases: ["Fe-EDDHA 6%", "Fe-EDDHA 6"],
    pct: { Fe: 6.0 }
  },
  {
    id: "fe_hbed_6",
    name: "Iron Chelate - HBED (6% Fe)",
    aliases: ["Fe-HBED 6%", "Fe-HBED 6"],
    pct: { Fe: 6.0 }
  },
  {
    id: "mn_edta_13",
    name: "Manganese Chelate - EDTA (13% Mn)",
    aliases: ["Mn-EDTA 13%", "Mn-EDTA 13"],
    pct: { Mn: 13.0 }
  },
  {
    id: "zn_edta_15",
    name: "Zinc Chelate - EDTA (15% Zn)",
    aliases: ["Zn-EDTA 15%", "Zn-EDTA 15"],
    pct: { Zn: 15.0 }
  },
  {
    id: "cu_edta_15",
    name: "Copper Chelate - EDTA (15% Cu)",
    aliases: ["Cu-EDTA 15%", "Cu-EDTA 15"],
    pct: { Cu: 15.0 }
  },
  {
    id: "manganese_sulfate",
    name: "Manganese Sulfate",
    aliases: ["MnSO4·H2O"],
    pct: { Mn: 32.5, S: 18.9 }
  },
  {
    id: "zinc_sulfate_mono",
    name: "Zinc Sulfate - Monohydrate (36% Zn)",
    aliases: ["ZnSO4·H2O", "Zinc Sulfate H2O"],
    pct: { Zn: 36.0 }
  },
  {
    id: "borax",
    name: "Borax",
    aliases: ["Na2B4O7·10H2O"],
    pct: { B: 11.3 }
  },
  {
    id: "copper_sulfate",
    name: "Copper Sulfate",
    aliases: ["CuSO4·5H2O"],
    pct: { Cu: 25.5, S: 12.8 }
  },
  {
    id: "sodium_molybdate",
    name: "Sodium Molybdate",
    aliases: ["Na2MoO4·2H2O"],
    pct: { Mo: 39.6 }
  },
  {
    id: "ammonium_molybdate",
    name: "Ammonium Molybdate",
    aliases: ["(NH4)6Mo7O24·4H2O"],
    pct: { Mo: 52.0, N_total: 8.0, N_NH4: 8.0 }
  }
];

// Conversion factors for oxides to elements
const OXIDE_CONVERSIONS = {
  P2O5_to_P: 0.43646,
  K2O_to_K: 0.83013,
  CaO_to_Ca: 0.71469,
  MgO_to_Mg: 0.60317,
  SO3_to_S: 0.40059,
  SiO2_to_Si: 0.46744
};

// Molar masses for nutrients (g/mol) - for EC calculation
const MOLAR_MASSES = {
  'N_NO3': 14.007,
  'N_NH4': 14.007,
  'P': 30.974,
  'K': 39.098,
  'Mg': 24.305,
  'Ca': 40.078,
  'S': 32.065,
  'Fe': 55.845,
  'Mn': 54.938,
  'Zn': 65.38,
  'B': 10.811,
  'Cu': 63.546,
  'Mo': 95.95,
  'Na': 22.99,
  'Cl': 35.453
};

// Ionic charges (absolute values) - for EC calculation
const IONIC_CHARGES = {
  'N_NO3': 1,
  'N_NH4': 1,
  'P': 1,      // H2PO4- form
  'K': 1,
  'Mg': 2,
  'Ca': 2,
  'S': 2,      // SO4 2- form
  'Fe': 2,
  'Mn': 2,
  'Zn': 2,
  'B': 1,      // typically present as borate
  'Cu': 2,
  'Mo': 2,
  'Na': 1,
  'Cl': 1
};

// EC contribution factors (LMCv2 model from HydroBuddy)
// Units: S·cm²/mol (molar conductivity)
const EC_CONTRIBUTIONS = {
  'N_NO3': 71.46,
  'N_NH4': 73.5,
  'P': 57,         // H2PO4-
  'K': 73,
  'Mg': 106,
  'Ca': 119,
  'S': 160,        // SO4 2-
  'Fe': 108.0,
  'Mn': 0,         // negligible
  'Zn': 0,         // negligible
  'B': 0,          // negligible
  'Cu': 0,         // negligible
  'Mo': 76.35,
  'Na': 50.01,
  'Cl': 0
};

// Ion balance data: molar mass and ions for each fertilizer
// Format: {formula: 'chemical formula', ion: 'name', charge: number (absolute value), count: number, type: 'cation'|'anion'}
const ION_DATA = {
  potassium_nitrate_typical: {
    formula: 'KNO₃',
    molarMass: 101.1,
    ions: [
      {ion: 'K⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  map_typical: {
    formula: 'NH₄H₂PO₄',
    molarMass: 115,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'H₂PO₄⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  mkp_typical: {
    formula: 'KH₂PO₄',
    molarMass: 136.1,
    ions: [
      {ion: 'K⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'H₂PO₄⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  dap_common: {
    formula: '(NH₄)₂HPO₄',
    molarMass: 132.1,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'HPO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  ammonium_sulfate_common: {
    formula: '(NH₄)₂SO₄',
    molarMass: 132.14,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  ammonium_nitrate_common: {
    formula: 'NH₄NO₃',
    molarMass: 80,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  ammonium_nitrate_liquid: {
    formula: 'NH₄NO₃',
    molarMass: 80,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  magnesium_sulfate_heptahydrate_common: {
    formula: 'MgSO₄·7H₂O',
    molarMass: 246.47,
    ions: [
      {ion: 'Mg²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  magnesium_sulfate_anhydrous: {
    formula: 'MgSO₄',
    molarMass: 120.37,
    ions: [
      {ion: 'Mg²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  magnesium_nitrate_hexahydrate_typical: {
    formula: 'Mg(NO₃)₂·6H₂O',
    molarMass: 256,
    ions: [
      {ion: 'Mg²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  magnesium_nitrate_liquid: {
    formula: 'Mg(NO₃)₂',
    molarMass: 148.3,
    ions: [
      {ion: 'Mg²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  potassium_sulfate_common: {
    formula: 'K₂SO₄',
    molarMass: 174.3,
    ions: [
      {ion: 'K⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  potassium_chloride_common: {
    formula: 'KCl',
    molarMass: 74.6,
    ions: [
      {ion: 'K⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'Cl⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  calcium_nitrate_calcinit_typical: {
    formula: '5Ca(NO₃)₂·NH₄NO₃·10H₂O',
    molarMass: 1080,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 5, type: 'cation'},
      {ion: 'NH₄⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 11, type: 'anion'}
    ]
  },
  calcium_nitrate_4h2o: {
    formula: 'Ca(NO₃)₂·4H₂O',
    molarMass: 236.18,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  calcium_nitrate_anhydrous: {
    formula: 'Ca(NO₃)₂',
    molarMass: 164.1,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  calcium_chloride_dihydrate_common: {
    formula: 'CaCl₂·2H₂O',
    molarMass: 147,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'Cl⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  calcium_chloride_solid: {
    formula: 'CaCl₂',
    molarMass: 111,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'Cl⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  nitric_acid_38: {
    formula: 'HNO₃',
    molarMass: 167,
    ions: [
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  nitric_acid_60: {
    formula: 'HNO₃',
    molarMass: 105,
    ions: [
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  phosphoric_acid_49: {
    formula: 'H₃PO₄',
    molarMass: 167,
    ions: [
      {ion: 'H₂PO₄⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  calcium_nitrate_liquid: {
    formula: 'Ca(NO₃)₂',
    molarMass: 164.1,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  calcium_chloride_liquid: {
    formula: 'CaCl₂',
    molarMass: 111,
    ions: [
      {ion: 'Ca²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'Cl⁻', charge: 1, count: 2, type: 'anion'}
    ]
  },
  langbeinite_common: {
    formula: 'K₂Mg₂(SO₄)₃',
    molarMass: 415,
    ions: [
      {ion: 'K⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'Mg²⁺', charge: 2, count: 2, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 3, type: 'anion'}
    ]
  },
  ammonium_thiosulfate_common: {
    formula: '(NH₄)₂S₂O₃',
    molarMass: 148.2,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'S₂O₃²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  potassium_thiosulfate_common: {
    formula: 'K₂S₂O₃',
    molarMass: 190.3,
    ions: [
      {ion: 'K⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'S₂O₃²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  potassium_bicarbonate: {
    formula: 'KHCO₃',
    molarMass: 100.1,
    ions: [
      {ion: 'K⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'HCO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  urea_phosphate: {
    formula: 'CO(NH₂)₂·H₃PO₄',
    molarMass: 158.1,
    ions: [
      {ion: 'H₂PO₄⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  manganese_sulfate: {
    formula: 'MnSO₄',
    molarMass: 169,
    ions: [
      {ion: 'Mn²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  zinc_sulfate_heptahydrate_common: {
    formula: 'ZnSO₄·7H₂O',
    molarMass: 287.6,
    ions: [
      {ion: 'Zn²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  zinc_sulfate_mono: {
    molarMass: 179.5,
    ions: [
      {ion: 'Zn²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  copper_sulfate: {
    molarMass: 249.7,
    ions: [
      {ion: 'Cu²⁺', charge: 2, count: 1, type: 'cation'},
      {ion: 'SO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  sodium_molybdate: {
    molarMass: 241.9,
    ions: [
      {ion: 'Na⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'MoO₄²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  },
  ammonium_molybdate: {
    molarMass: 1235.9,
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 6, type: 'cation'},
      {ion: 'Mo₇O₂₄⁶⁻', charge: 6, count: 1, type: 'anion'}
    ]
  },
  uan32_solution_typical: {
    // UAN-32 contains urea (non-ionic) + ammonium nitrate (ionic)
    // Only accounting for the ammonium nitrate portion (50% of N)
    molarMass: 160,  // Effective based on ionic portion
    ions: [
      {ion: 'NH₄⁺', charge: 1, count: 1, type: 'cation'},
      {ion: 'NO₃⁻', charge: 1, count: 1, type: 'anion'}
    ]
  },
  borax: {
    molarMass: 381.4,
    ions: [
      {ion: 'Na⁺', charge: 1, count: 2, type: 'cation'},
      {ion: 'B₄O₇²⁻', charge: 2, count: 1, type: 'anion'}
    ]
  }
};

// Common fertilizers (most frequently used)
const COMMON_FERTILIZERS = [
  'calcium_nitrate_calcinit_typical',
  'potassium_nitrate_typical',
  'map_typical',
  'mkp_typical',
  'magnesium_sulfate_heptahydrate_common',
  'magnesium_nitrate_hexahydrate_typical',
  'potassium_sulfate_common',
  'ammonium_sulfate_common'
];

// Validation functions
function validateVolumeInput(input) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for invalid values
  if (input.value !== '' && (isNaN(value) || value <= 0)) {
    input.classList.add('input-error');
    // Reset to minimum valid value if user tries to leave field
    if (value <= 0) {
      input.value = 0.1;
    }
  }

  // Auto-recalculate if results are showing
  if (document.getElementById('results') && document.getElementById('results').style.display !== 'none') {
    const validValue = parseFloat(input.value);
    if (!isNaN(validValue) && validValue > 0) {
      calculate();
    }
  }
}

function validateGramsInput(input) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for negative values
  if (input.value !== '' && (isNaN(value) || value < 0)) {
    input.classList.add('input-error');
    // Reset to 0 for negative values
    if (value < 0) {
      input.value = 0;
    }
  }
}

function validateTargetInput(input, allowZero = false) {
  const value = parseFloat(input.value);

  // Remove error class first
  input.classList.remove('input-error');

  // Check for invalid values
  if (input.value !== '') {
    if (isNaN(value) || value < 0) {
      input.classList.add('input-error');
      if (value < 0) {
        input.value = allowZero ? 0 : 0.1;
      }
    } else if (!allowZero && value === 0) {
      input.classList.add('input-error');
    }
  }
}

// Initialize the page
function init() {
  renderFertilizerList();
  renderAvailableFertilizersList();
  renderReverseFertilizersList();

  // Add event listeners
  document.getElementById('search').addEventListener('input', filterFertilizers);
}

// Render available fertilizers list for formula builder
function renderAvailableFertilizersList() {
  const container = document.getElementById('available-fertilizers-list');
  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'fertilizer-checkbox-item';
    item.id = `available-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `available-${fert.id}`;
    checkbox.checked = COMMON_FERTILIZERS.includes(fert.id); // Pre-select common fertilizers

    const label = document.createElement('label');
    label.htmlFor = `available-${fert.id}`;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'fertilizer-label-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'fertilizer-label-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    item.appendChild(checkbox);
    item.appendChild(label);
    container.appendChild(item);
  });
}

// Select all available fertilizers
function selectAllAvailableFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) checkbox.checked = true;
  });
}

// Deselect all available fertilizers
function deselectAllAvailableFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Select only common fertilizers
function selectCommonFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox) {
      checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);
    }
  });
}

// Filter available fertilizers based on search term
function filterAvailableFertilizers(searchTerm) {
  const normalizedSearch = searchTerm.toLowerCase().trim();

  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`available-item-${fert.id}`);
    if (!item) return;

    // Search in name and aliases
    const nameMatch = fert.name.toLowerCase().includes(normalizedSearch);
    const aliasMatch = fert.aliases && fert.aliases.some(alias =>
      alias.toLowerCase().includes(normalizedSearch)
    );

    // Show/hide based on match
    if (nameMatch || aliasMatch || normalizedSearch === '') {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}

// Render the fertilizer list
function renderFertilizerList(filter = '') {
  const container = document.getElementById('fertilizer-list');

  // If list is empty, create all items first
  if (container.children.length === 0) {
    FERTILIZERS.forEach(fertilizer => {
      const item = document.createElement('div');
      item.className = 'fertilizer-item';
      item.id = `fert-${fertilizer.id}`;
      item.dataset.fertId = fertilizer.id;

      const composition = Object.entries(fertilizer.pct)
        .map(([key, val]) => `${key}: ${val}%`)
        .join(', ');

      item.innerHTML = `
        <div class="fertilizer-checkbox">
          <input type="checkbox" id="check-${fertilizer.id}"
                 onchange="toggleFertilizer('${fertilizer.id}')">
        </div>
        <label for="check-${fertilizer.id}" class="fertilizer-info">
          <div class="fertilizer-name">${fertilizer.name}</div>
          <div class="fertilizer-composition">${composition}</div>
        </label>
        <div class="fertilizer-input">
          <input type="number" id="grams-${fertilizer.id}"
                 value="0" min="0" step="0.1"
                 disabled
                 oninput="validateGramsInput(this)"
                 onchange="handleGramsChange('${fertilizer.id}')">
          <label>grams</label>
        </div>
      `;

      container.appendChild(item);
    });
  }

  // Filter by showing/hiding items
  const searchText = filter.toLowerCase();
  FERTILIZERS.forEach(fertilizer => {
    const item = document.getElementById(`fert-${fertilizer.id}`);
    if (item) {
      const matches = fertilizer.name.toLowerCase().includes(searchText) ||
                     fertilizer.aliases.some(a => a.toLowerCase().includes(searchText));
      item.style.display = matches ? '' : 'none';
    }
  });
}

// Filter fertilizers based on search
function filterFertilizers() {
  const search = document.getElementById('search').value;
  renderFertilizerList(search);
}

// Toggle fertilizer selection
function toggleFertilizer(id) {
  const checkbox = document.getElementById(`check-${id}`);
  const input = document.getElementById(`grams-${id}`);
  const item = document.getElementById(`fert-${id}`);

  if (checkbox.checked) {
    input.disabled = false;
    item.classList.add('active');
  } else {
    input.disabled = true;
    input.value = 0;
    item.classList.remove('active');
  }

  // Auto-calculate if results are showing
  if (document.getElementById('results').style.display !== 'none') {
    calculate();
  }
}

// Handle grams input change
function handleGramsChange(id) {
  if (document.getElementById('results').style.display !== 'none') {
    calculate();
  }
}

// Calculate EC using LMCv2 model (based on HydroBuddy)
function calculateECTDS(results) {
  // Calculate ionic strength
  let ionicStrength = 0;

  for (const [nutrient, ppm] of Object.entries(results)) {
    if (MOLAR_MASSES[nutrient] && IONIC_CHARGES[nutrient]) {
      const molarConc = ppm / (1000 * MOLAR_MASSES[nutrient]); // Convert ppm to mol/L
      const zi = IONIC_CHARGES[nutrient];
      ionicStrength += zi * zi * molarConc;
    }
  }
  ionicStrength = ionicStrength / 2; // Ionic strength formula

  // Calculate EC using LMCv2 model
  // Result is directly in mS/cm (EC contribution factors are calibrated for this)
  let predictedEC = 0;

  for (const [nutrient, ppm] of Object.entries(results)) {
    if (EC_CONTRIBUTIONS[nutrient] && MOLAR_MASSES[nutrient] && IONIC_CHARGES[nutrient]) {
      const molarConc = ppm / (1000 * MOLAR_MASSES[nutrient]);
      const zi = IONIC_CHARGES[nutrient];
      const contribution = molarConc * EC_CONTRIBUTIONS[nutrient] * Math.exp(-0.7025187 * Math.sqrt(ionicStrength) * Math.pow(zi, 1.5));
      predictedEC += contribution;
    }
  }

  return {
    ec: predictedEC,
    ionicStrength: ionicStrength
  };
}

// Check for warnings (incompatibilities and imbalances)
function checkWarnings(results, activeFertilizers) {
  const warnings = [];

  // 1. Check for Calcium + Sulfate incompatibility (in stock solutions)
  // This is critical for concentrated stock solutions
  const hasCa = (results.Ca || 0) > 10;
  const hasS = (results.S || 0) > 10;

  if (hasCa && hasS) {
    const caFertilizers = activeFertilizers.filter(f => f.pct.Ca).map(f => f.name).join(', ');
    const sFertilizers = activeFertilizers.filter(f => f.pct.S).map(f => f.name).join(', ');

    warnings.push({
      level: 'warning',
      category: 'Stock Solution Incompatibility',
      message: `Calcium and sulfate are both present. When making STOCK SOLUTIONS (not final mix), keep calcium sources (${caFertilizers}) separate from sulfate sources (${sFertilizers}) to prevent calcium sulfate precipitation (gypsum). This warning doesn't apply to the final diluted nutrient solution.`
    });
  }

  // 2. Check for high NH4:NO3 ratio (should be < 20%)
  const nh4 = results.N_NH4 || 0;
  const no3 = results.N_NO3 || 0;
  const totalN = nh4 + no3;

  if (totalN > 0) {
    const nh4Ratio = (nh4 / totalN) * 100;
    if (nh4Ratio > 30) {
      warnings.push({
        level: 'warning',
        category: 'Nitrogen Balance',
        message: `High ammonium ratio (${nh4Ratio.toFixed(1)}% NH₄⁺). Recommended: Keep NH₄⁺ below 20-30% of total N to avoid toxicity and acidification. Consider using more nitrate-based fertilizers.`
      });
    }
  }

  // 3. Check for Ca:Mg ratio (optimal is 3:1 to 5:1)
  const ca = results.Ca || 0;
  const mg = results.Mg || 0;

  if (ca > 10 && mg > 5) {
    const ratio = ca / mg;
    if (ratio < 2) {
      warnings.push({
        level: 'info',
        category: 'Ca:Mg Ratio',
        message: `Ca:Mg ratio is ${ratio.toFixed(2)}:1 (${ca.toFixed(1)} ppm Ca : ${mg.toFixed(1)} ppm Mg). Optimal range is 3:1 to 5:1. Consider reducing magnesium or increasing calcium.`
      });
    } else if (ratio > 7) {
      warnings.push({
        level: 'info',
        category: 'Ca:Mg Ratio',
        message: `Ca:Mg ratio is ${ratio.toFixed(2)}:1 (${ca.toFixed(1)} ppm Ca : ${mg.toFixed(1)} ppm Mg). Optimal range is 3:1 to 5:1. Consider reducing calcium or increasing magnesium.`
      });
    }
  }

  // 4. Check for K:Ca ratio (should be reasonably balanced)
  const k = results.K || 0;
  if (k > 10 && ca > 10) {
    const kCaRatio = k / ca;
    if (kCaRatio > 3) {
      warnings.push({
        level: 'info',
        category: 'K:Ca Ratio',
        message: `K:Ca ratio is ${kCaRatio.toFixed(2)}:1. Very high potassium relative to calcium may interfere with calcium uptake. Optimal K:Ca ratio is typically 0.5:1 to 2:1 depending on crop.`
      });
    }
  }

  // 5. Check for very high EC
  const ecData = calculateECTDS(results);
  if (ecData.ec > 3.5) {
    warnings.push({
      level: 'warning',
      category: 'High EC',
      message: `Electrical conductivity is very high (${ecData.ec.toFixed(2)} mS/cm). This may cause salt stress in plants. Consider reducing fertilizer amounts or increasing solution volume. Most crops prefer EC between 1.5-2.5 mS/cm.`
    });
  } else if (ecData.ec < 0.5 && totalN > 0) {
    warnings.push({
      level: 'info',
      category: 'Low EC',
      message: `Electrical conductivity is quite low (${ecData.ec.toFixed(2)} mS/cm). This solution may be too dilute for optimal plant growth. Consider increasing fertilizer amounts. Most crops prefer EC between 1.5-2.5 mS/cm.`
    });
  }

  // 6. Check for Cl- levels (chloride can be toxic at high levels)
  const cl = results.Cl || 0;
  if (cl > 100) {
    warnings.push({
      level: 'warning',
      category: 'High Chloride',
      message: `Chloride level is ${cl.toFixed(1)} ppm. High chloride (>100 ppm) can be toxic to sensitive crops. Consider using sulfate-based fertilizers instead of chloride-based ones.`
    });
  }

  return warnings;
}

// Display EC results
function displayECTDS(ecData) {
  const resultsSection = document.getElementById('ec-tds-section');
  const outputDiv = document.getElementById('ec-tds-result');

  resultsSection.style.display = 'block';

  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';

  html += `
    <div class="result-card">
      <div class="result-label">Electrical Conductivity (EC)</div>
      <div class="result-value">
        ${ecData.ec.toFixed(3)}
        <span class="result-unit">mS/cm</span>
      </div>
    </div>
  `;

  html += `
    <div class="result-card">
      <div class="result-label">Ionic Strength</div>
      <div class="result-value">
        ${ecData.ionicStrength.toFixed(4)}
        <span class="result-unit">mol/L</span>
      </div>
    </div>
  `;

  html += '</div>';

  html += `
    <div class="conversion-note" style="margin-top: 15px;">
      <strong>About EC:</strong> EC (Electrical Conductivity) measures the solution's ability to conduct electricity,
      indicating total dissolved salts. Most hydroponic crops prefer EC between 1.5-2.5 mS/cm.
      Calculation uses the LMCv2 model from HydroBuddy.
    </div>
  `;

  outputDiv.innerHTML = html;
}

// Display warnings
function displayWarnings(warnings) {
  const resultsSection = document.getElementById('warnings-section');
  const outputDiv = document.getElementById('warnings-result');

  if (warnings.length === 0) {
    resultsSection.style.display = 'none';
    return;
  }

  resultsSection.style.display = 'block';

  let html = '';

  warnings.forEach(warning => {
    const boxClass = warning.level === 'warning' ? 'warning-box' :
                     warning.level === 'error' ? 'error-box' : 'conversion-note';
    const icon = warning.level === 'warning' ? '⚠️' :
                 warning.level === 'error' ? '❌' : 'ℹ️';

    html += `
      <div class="${boxClass}" style="margin-bottom: 10px;">
        <strong>${icon} ${warning.category}</strong><br>
        ${warning.message}
      </div>
    `;
  });

  outputDiv.innerHTML = html;
}

// Main calculation function
function calculate() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value);

  // Validate volume
  if (!volume || volume <= 0 || isNaN(volume)) {
    alert('Please enter a valid volume greater than 0');
    volumeInput.classList.add('input-error');
    volumeInput.focus();
    return;
  }
  volumeInput.classList.remove('input-error');

  // Collect all active fertilizers and their amounts
  const activeFertilizers = [];
  let hasInvalidGrams = false;

  FERTILIZERS.forEach(f => {
    const checkbox = document.getElementById(`check-${f.id}`);
    if (checkbox && checkbox.checked) {
      const gramsInput = document.getElementById(`grams-${f.id}`);
      const grams = parseFloat(gramsInput.value);

      // Validate grams input
      if (isNaN(grams) || grams < 0) {
        gramsInput.classList.add('input-error');
        hasInvalidGrams = true;
      } else {
        gramsInput.classList.remove('input-error');
        if (grams > 0) {
          activeFertilizers.push({ ...f, grams });
        }
      }
    }
  });

  if (hasInvalidGrams) {
    alert('Please fix the invalid input values (highlighted in red)');
    return;
  }

  if (activeFertilizers.length === 0) {
    alert('Please select at least one fertilizer with an amount greater than 0');
    return;
  }

  // Calculate PPM for each nutrient
  const ppmResults = {};

  activeFertilizers.forEach(fert => {
    Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
      // ppm = (grams × 1000 × (pct/100)) / liters
      const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;

      if (!ppmResults[nutrient]) {
        ppmResults[nutrient] = 0;
      }

      // Handle nitrogen forms properly to avoid double counting
      if (nutrient === 'N_NO3' || nutrient === 'N_NH4') {
        ppmResults[nutrient] += ppm;
        // Also add to N_total
        if (!ppmResults.N_total) ppmResults.N_total = 0;
        ppmResults.N_total += ppm;
      } else if (nutrient === 'N_total') {
        // Only use N_total if there are no specific nitrogen forms
        if (!fert.pct.N_NO3 && !fert.pct.N_NH4) {
          ppmResults[nutrient] += ppm;
        }
      } else {
        ppmResults[nutrient] += ppm;
      }
    });
  });

  // Convert oxides to elements
  const finalResults = { ...ppmResults };

  // P from P2O5
  if (ppmResults.P2O5) {
    finalResults.P = (finalResults.P || 0) + (ppmResults.P2O5 * OXIDE_CONVERSIONS.P2O5_to_P);
  }

  // K from K2O
  if (ppmResults.K2O) {
    finalResults.K = (finalResults.K || 0) + (ppmResults.K2O * OXIDE_CONVERSIONS.K2O_to_K);
  }

  // Ca from CaO
  if (ppmResults.CaO) {
    finalResults.Ca = (finalResults.Ca || 0) + (ppmResults.CaO * OXIDE_CONVERSIONS.CaO_to_Ca);
  }

  // Mg from MgO
  if (ppmResults.MgO) {
    finalResults.Mg = (finalResults.Mg || 0) + (ppmResults.MgO * OXIDE_CONVERSIONS.MgO_to_Mg);
  }

  // S from SO3
  if (ppmResults.SO3) {
    finalResults.S = (finalResults.S || 0) + (ppmResults.SO3 * OXIDE_CONVERSIONS.SO3_to_S);
  }

  // Si from SiO2
  if (ppmResults.SiO2) {
    finalResults.Si = (finalResults.Si || 0) + (ppmResults.SiO2 * OXIDE_CONVERSIONS.SiO2_to_Si);
  }

  // Display selected fertilizers
  displaySelectedFertilizers(activeFertilizers);

  // Display results
  displayResults(finalResults);

  // Calculate and display EC
  const ecData = calculateECTDS(finalResults);
  displayECTDS(ecData);

  // Check and display warnings
  const warnings = checkWarnings(finalResults, activeFertilizers);
  displayWarnings(warnings);

  // Calculate and display ion balance
  calculateIonBalance(activeFertilizers, volume);

  // Calculate and display nutrient ratios
  const ratios = calculateNutrientRatios(finalResults);
  displayNutrientRatios(ratios);
}

// Display selected fertilizers
function displaySelectedFertilizers(activeFertilizers) {
  const section = document.getElementById('selected-fertilizers-section');
  const list = document.getElementById('selected-fertilizers-list');

  section.style.display = 'block';
  list.innerHTML = '';

  if (activeFertilizers.length === 0) {
    section.style.display = 'none';
    return;
  }

  activeFertilizers.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'selected-fertilizer-item';

    const composition = Object.entries(fert.pct)
      .map(([key, val]) => `${key}: ${val}%`)
      .join(', ');

    item.innerHTML = `
      <div class="selected-fertilizer-info">
        <div class="selected-fertilizer-name">${fert.name}</div>
        <div class="selected-fertilizer-composition">${composition}</div>
      </div>
      <div class="selected-fertilizer-amount">${fert.grams.toFixed(2)} g</div>
    `;

    list.appendChild(item);
  });
}

// Display the results
function displayResults(results) {
  const resultsSection = document.getElementById('results');
  const resultsGrid = document.getElementById('results-grid');

  resultsSection.style.display = 'block';
  resultsGrid.innerHTML = '';

  // Define display order and labels
  const displayOrder = [
    { key: 'N_total', label: 'Total Nitrogen (N)' },
    { key: 'N_NO3', label: 'Nitrate-N (NO₃-N)' },
    { key: 'N_NH4', label: 'Ammonium-N (NH₄-N)' },
    { key: 'N_Urea', label: 'Urea-N' },
    { key: 'P', label: 'Phosphorus (P)' },
    { key: 'P2O5', label: 'P₂O₅ (oxide form)' },
    { key: 'K', label: 'Potassium (K)' },
    { key: 'K2O', label: 'K₂O (oxide form)' },
    { key: 'Ca', label: 'Calcium (Ca)' },
    { key: 'Mg', label: 'Magnesium (Mg)' },
    { key: 'S', label: 'Sulfur (S)' },
    { key: 'Fe', label: 'Iron (Fe)' },
    { key: 'B', label: 'Boron (B)' },
    { key: 'Zn', label: 'Zinc (Zn)' },
    { key: 'Mn', label: 'Manganese (Mn)' },
    { key: 'Cu', label: 'Copper (Cu)' },
    { key: 'Mo', label: 'Molybdenum (Mo)' },
    { key: 'Cl', label: 'Chlorine (Cl)' },
    { key: 'Si', label: 'Silicon (Si)' }
  ];

  displayOrder.forEach(item => {
    if (results[item.key] !== undefined) {
      const card = document.createElement('div');
      const value = results[item.key];
      card.className = `result-card ${value < 0.01 ? 'zero' : ''}`;

      card.innerHTML = `
        <div class="result-label">${item.label}</div>
        <div class="result-value">
          ${value.toFixed(2)}
          <span class="result-unit">ppm</span>
        </div>
      `;

      resultsGrid.appendChild(card);
    }
  });

  // Scroll to results
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Calculate nutrient ratios
function calculateNutrientRatios(results) {
  const ratios = [];

  // Helper function to calculate ratio with 2 or 3 values
  function getRatio(values, names, decimals = 2) {
    // Filter out zero values
    const nonZeroValues = values.filter(v => v > 0);
    if (nonZeroValues.length === 0) return null;

    // Find the smallest non-zero value to use as base
    const minValue = Math.min(...nonZeroValues);

    // Calculate ratios relative to 1
    const ratioValues = values.map(v => v > 0 ? parseFloat((v / minValue).toFixed(decimals)) : 0);

    return {
      name: names.join(' : '),
      ratio: ratioValues.join(' : '),
      values: values,
      labels: names
    };
  }

  // N:P:K (elemental)
  const npk = getRatio(
    [results.N_total || 0, results.P || 0, results.K || 0],
    ['N', 'P', 'K']
  );
  if (npk) ratios.push(npk);

  // N:P2O5:K2O (oxide form) - common in fertilizer labels
  const npkOxide = getRatio(
    [results.N_total || 0, results.P2O5 || 0, results.K2O || 0],
    ['N', 'P₂O₅', 'K₂O']
  );
  if (npkOxide) ratios.push(npkOxide);

  // N:K ratio
  if ((results.N_total || 0) > 0 && (results.K || 0) > 0) {
    const nk = getRatio(
      [results.N_total || 0, results.K || 0],
      ['N', 'K']
    );
    if (nk) ratios.push(nk);
  }

  // NO3:NH4 ratio
  if ((results.N_NO3 || 0) > 0 || (results.N_NH4 || 0) > 0) {
    const no3nh4 = getRatio(
      [results.N_NO3 || 0, results.N_NH4 || 0],
      ['NO₃', 'NH₄']
    );
    if (no3nh4) ratios.push(no3nh4);
  }

  // Ca:Mg ratio
  if ((results.Ca || 0) > 0 && (results.Mg || 0) > 0) {
    const camg = getRatio(
      [results.Ca || 0, results.Mg || 0],
      ['Ca', 'Mg']
    );
    if (camg) ratios.push(camg);
  }

  // K:Ca ratio
  if ((results.K || 0) > 0 && (results.Ca || 0) > 0) {
    const kca = getRatio(
      [results.K || 0, results.Ca || 0],
      ['K', 'Ca']
    );
    if (kca) ratios.push(kca);
  }

  // K:Ca:Mg ratio in meq/L (accounts for different valences)
  if ((results.K || 0) > 0 && (results.Ca || 0) > 0 && (results.Mg || 0) > 0) {
    // Convert ppm to meq/L
    // meq/L = (ppm × valence) / atomic_weight
    const kMeq = (results.K || 0) / 39.1;  // K: valence 1, atomic weight 39.1
    const caMeq = (results.Ca || 0) * 2 / 40.08;  // Ca: valence 2, atomic weight 40.08
    const mgMeq = (results.Mg || 0) * 2 / 24.31;  // Mg: valence 2, atomic weight 24.31

    const kcamgMeq = getRatio(
      [kMeq, caMeq, mgMeq],
      ['K', 'Ca', 'Mg']
    );
    if (kcamgMeq) {
      kcamgMeq.name = 'K : Ca : Mg (meq/L basis)';
      kcamgMeq.values = [kMeq, caMeq, mgMeq];
      kcamgMeq.unit = 'meq/L';
      ratios.push(kcamgMeq);
    }
  }

  return ratios;
}

// Display nutrient ratio analysis
function displayNutrientRatios(ratios) {
  const ratioSection = document.getElementById('ratio-analysis-section');
  const ratioResult = document.getElementById('ratio-analysis-result');

  if (ratios.length === 0) {
    ratioSection.style.display = 'none';
    return;
  }

  ratioSection.style.display = 'block';

  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';

  ratios.forEach(ratio => {
    const unit = ratio.unit || 'ppm';
    html += `
      <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff;">
        <div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 1.1em;">
          ${ratio.name}
        </div>
        <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
          ${ratio.ratio}
        </div>
        <div style="font-size: 0.85em; color: #666;">
          ${ratio.labels.map((label, i) => `${label}: ${ratio.values[i].toFixed(1)} ${unit}`).join(' | ')}
        </div>
      </div>
    `;
  });

  html += '</div>';
  ratioResult.innerHTML = html;
}

// Calculate and display ion balance
function calculateIonBalance(activeFertilizers, volume) {
  let totalCations = 0;  // meq/L
  let totalAnions = 0;   // meq/L
  const ionDetails = {};  // Track individual ion contributions

  // Calculate meq for each fertilizer
  activeFertilizers.forEach(fert => {
    const ionData = ION_DATA[fert.id];

    if (!ionData) {
      // Skip fertilizers without ion data (like chelates, urea, etc.)
      return;
    }

    // Convert grams to moles
    const moles = fert.grams / ionData.molarMass;

    // Calculate meq for each ion
    ionData.ions.forEach(ionInfo => {
      const meq = moles * ionInfo.count * ionInfo.charge * 1000;
      const meqPerLiter = meq / volume;

      // Track by ion name
      if (!ionDetails[ionInfo.ion]) {
        ionDetails[ionInfo.ion] = {
          meq: 0,
          type: ionInfo.type
        };
      }
      ionDetails[ionInfo.ion].meq += meqPerLiter;

      // Add to totals
      if (ionInfo.type === 'cation') {
        totalCations += meqPerLiter;
      } else {
        totalAnions += meqPerLiter;
      }
    });
  });

  // Calculate imbalance percentage
  const average = (totalCations + totalAnions) / 2;
  const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;

  // Display results
  const ionBalanceSection = document.getElementById('ion-balance-section');
  const ionBalanceResult = document.getElementById('ion-balance-result');

  ionBalanceSection.style.display = 'block';

  // Determine status
  let statusColor, statusText;
  if (imbalance <= 10) {
    statusColor = '#28a745';
    statusText = 'Balanced ✓';
  } else if (imbalance <= 20) {
    statusColor = '#ffc107';
    statusText = 'Caution ⚠';
  } else {
    statusColor = '#dc3545';
    statusText = 'Imbalanced ✗';
  }

  let html = `
    <div class="ion-balance-summary">
      <div class="ion-balance-card">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Cations</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #007bff;">${totalCations.toFixed(2)} <span style="font-size: 0.7em;">meq/L</span></div>
      </div>
      <div class="ion-balance-card">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Anions</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #007bff;">${totalAnions.toFixed(2)} <span style="font-size: 0.7em;">meq/L</span></div>
      </div>
      <div class="ion-balance-card status" style="background: ${statusColor}20; border-color: ${statusColor};">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Imbalance</div>
        <div style="font-size: 1.5em; font-weight: bold; color: ${statusColor};">${imbalance.toFixed(1)}%</div>
        <div style="font-size: 0.9em; color: ${statusColor}; margin-top: 5px;">${statusText}</div>
      </div>
    </div>
  `;

  // Add individual ion breakdown
  const cations = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'cation');
  const anions = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'anion');

  if (cations.length > 0 || anions.length > 0) {
    html += `<div class="ion-balance-breakdown">`;

    // Cations column
    html += `<div><h4 style="margin-top: 0; color: #007bff;">Cations (+)</h4>`;
    cations.forEach(([ion, data]) => {
      const percentage = totalCations > 0 ? (data.meq / totalCations * 100).toFixed(1) : 0;
      html += `
        <div class="ion-list-item">
          <span>${ion}</span>
          <span><strong>${data.meq.toFixed(2)}</strong> meq/L (${percentage}%)</span>
        </div>
      `;
    });
    html += `</div>`;

    // Anions column
    html += `<div><h4 style="margin-top: 0; color: #007bff;">Anions (-)</h4>`;
    anions.forEach(([ion, data]) => {
      const percentage = totalAnions > 0 ? (data.meq / totalAnions * 100).toFixed(1) : 0;
      html += `
        <div class="ion-list-item">
          <span>${ion}</span>
          <span><strong>${data.meq.toFixed(2)}</strong> meq/L (${percentage}%)</span>
        </div>
      `;
    });
    html += `</div>`;

    html += `</div>`;
  }

  ionBalanceResult.innerHTML = html;
}

// Clear all selections and reset the form
function clearAll() {
  // Clear search box
  document.getElementById('search').value = '';

  // Reset volume input
  const volumeInput = document.getElementById('volume');
  volumeInput.value = 10;
  volumeInput.classList.remove('input-error');

  // Reset all fertilizers
  FERTILIZERS.forEach(f => {
    const checkbox = document.getElementById(`check-${f.id}`);
    const input = document.getElementById(`grams-${f.id}`);
    const item = document.getElementById(`fert-${f.id}`);

    if (checkbox) checkbox.checked = false;
    if (input) {
      input.value = 0;
      input.disabled = true;
      input.classList.remove('input-error');
    }
    if (item) {
      item.classList.remove('active');
      item.style.display = ''; // Show all items
    }
  });

  // Hide results
  document.getElementById('selected-fertilizers-section').style.display = 'none';
  document.getElementById('results').style.display = 'none';
  document.getElementById('ion-balance-section').style.display = 'none';
  document.getElementById('ratio-analysis-section').style.display = 'none';
  document.getElementById('ec-tds-section').style.display = 'none';
  document.getElementById('warnings-section').style.display = 'none';
}

// Tab switching
function switchTab(tabId) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });

  // Show selected tab
  document.getElementById(tabId).classList.add('active');
  event.target.classList.add('active');
}

// Clear formula builder
function clearFormulaBuilder() {
  // Clear target inputs and remove error states
  const targetIds = ['target-n', 'target-p', 'target-k', 'target-ca', 'target-mg', 'target-s'];
  targetIds.forEach(id => {
    const input = document.getElementById(id);
    input.value = '';
    input.classList.remove('input-error');
  });

  // Reset volume input
  const volumeInput = document.getElementById('formula-volume');
  volumeInput.value = '10';
  volumeInput.classList.remove('input-error');

  // Clear search box
  const searchInput = document.getElementById('available-fertilizer-search');
  if (searchInput) {
    searchInput.value = '';
    filterAvailableFertilizers('');
  }

  // Hide results
  document.getElementById('formula-results').style.display = 'none';
}

// Formula builder - main function
function buildFormula() {
  // Validate volume first
  const volumeInput = document.getElementById('formula-volume');
  const volume = parseFloat(volumeInput.value);

  if (!volume || volume <= 0 || isNaN(volume)) {
    alert('Please enter a valid solution volume greater than 0');
    volumeInput.classList.add('input-error');
    volumeInput.focus();
    return;
  }
  volumeInput.classList.remove('input-error');

  // Get and validate target values
  const targetInputs = {
    N: document.getElementById('target-n'),
    P: document.getElementById('target-p'),
    K: document.getElementById('target-k'),
    Ca: document.getElementById('target-ca'),
    Mg: document.getElementById('target-mg'),
    S: document.getElementById('target-s')
  };

  const targets = {};
  let hasInvalidInput = false;
  const missingRequired = [];

  Object.entries(targetInputs).forEach(([key, input]) => {
    const value = parseFloat(input.value);
    const isRequired = key !== 'S';

    if (input.value === '' || isNaN(value)) {
      if (isRequired) {
        input.classList.add('input-error');
        hasInvalidInput = true;
        missingRequired.push(key);
      }
      targets[key] = 0;
    } else if (value < 0) {
      input.classList.add('input-error');
      hasInvalidInput = true;
      targets[key] = 0;
    } else if (isRequired && value === 0) {
      input.classList.add('input-error');
      hasInvalidInput = true;
      missingRequired.push(key);
      targets[key] = 0;
    } else {
      input.classList.remove('input-error');
      targets[key] = value;
    }
  });

  // Validate required fields
  if (missingRequired.length > 0) {
    alert(`Please enter positive values for the following required nutrients: ${missingRequired.join(', ')}`);
    return;
  }

  if (hasInvalidInput) {
    alert('Please fix the invalid input values (highlighted in red)');
    return;
  }

  // Get available fertilizers
  const availableFertilizers = [];
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`available-${fert.id}`);
    if (checkbox && checkbox.checked) {
      availableFertilizers.push(fert);
    }
  });

  if (availableFertilizers.length === 0) {
    alert('Please select at least one available fertilizer');
    return;
  }

  // Run optimization algorithm
  const result = optimizeFormula(targets, volume, availableFertilizers);

  // Display results
  displayFormulaResults(result, targets, volume);
}

// Optimization algorithm - finds best fertilizer combination from available fertilizers
function optimizeFormula(targetRatios, volume, availableFertilizers, concentration = 75) {
  // Normalize target ratios - find smallest non-zero value and normalize to that
  const ratioValues = Object.values(targetRatios).filter(v => v > 0);
  const minRatio = ratioValues.length > 0 ? Math.min(...ratioValues) : 1;

  const normalizedRatios = {
    N: targetRatios.N / minRatio,
    P: targetRatios.P / minRatio,
    K: targetRatios.K / minRatio,
    Ca: targetRatios.Ca / minRatio,
    Mg: targetRatios.Mg / minRatio,
    S: targetRatios.S / minRatio
  };

  // Use user-selected concentration (base PPM for minimum ratio nutrient)
  // IMPORTANT: Work with COMMERCIAL ratios (N:P2O5:K2O), not elemental
  // concentration=50 → EC~1.0, concentration=75 → EC~1.5, concentration=100 → EC~2.0
  const basePPMForMinRatio = concentration;

  const targetPPM_Commercial = {
    N: normalizedRatios.N * basePPMForMinRatio,
    P2O5: normalizedRatios.P * basePPMForMinRatio,  // P input is treated as P2O5
    K2O: normalizedRatios.K * basePPMForMinRatio,   // K input is treated as K2O
    Ca: normalizedRatios.Ca * basePPMForMinRatio,
    Mg: normalizedRatios.Mg * basePPMForMinRatio,
    S: normalizedRatios.S * basePPMForMinRatio
  };

  const formula = {};
  const achieved = { N_total: 0, N_NO3: 0, N_NH4: 0, P2O5: 0, K2O: 0, P: 0, K: 0, Ca: 0, Mg: 0, S: 0 };

  // Helper function to calculate PPM contribution from a fertilizer
  function calculatePPM(fert, grams) {
    const contribution = { N_total: 0, N_NO3: 0, N_NH4: 0, P2O5: 0, K2O: 0, P: 0, K: 0, Ca: 0, Mg: 0, S: 0 };

    Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
      const ppm = (grams * 1000 * (percentage / 100)) / volume;

      if (nutrient === 'P2O5') {
        contribution.P2O5 += ppm;  // Track commercial P2O5
        contribution.P += ppm * OXIDE_CONVERSIONS.P2O5_to_P;  // Also track elemental
      } else if (nutrient === 'K2O') {
        contribution.K2O += ppm;  // Track commercial K2O
        contribution.K += ppm * OXIDE_CONVERSIONS.K2O_to_K;  // Also track elemental
      } else if (nutrient === 'N_NO3') {
        contribution.N_NO3 += ppm;
        contribution.N_total += ppm;
      } else if (nutrient === 'N_NH4') {
        contribution.N_NH4 += ppm;
        contribution.N_total += ppm;
      } else if (nutrient === 'N_total') {
        // Skip N_total if we have specific forms (N_NO3/N_NH4)
        // Only use N_total if there are no specific nitrogen forms defined
        if (!fert.pct.N_NO3 && !fert.pct.N_NH4) {
          contribution.N_total += ppm;
        }
      } else {
        contribution[nutrient] = (contribution[nutrient] || 0) + ppm;
      }
    });

    return contribution;
  }

  // Helper function to add fertilizer to formula
  function addFertilizer(fert, grams) {
    if (!formula[fert.id]) formula[fert.id] = 0;
    formula[fert.id] += grams;

    const contribution = calculatePPM(fert, grams);
    Object.keys(contribution).forEach(nutrient => {
      achieved[nutrient] += contribution[nutrient];
    });
  }

  // Find best fertilizer for a specific nutrient
  function findBestFor(nutrient, preferNH4 = false, preferS = false) {
    let best = null;
    let bestScore = -1;

    availableFertilizers.forEach(fert => {
      let score = 0;

      // Primary nutrient availability
      if (nutrient === 'Ca' && fert.pct.Ca) score += fert.pct.Ca * 10;
      if (nutrient === 'P' && fert.pct.P2O5) score += fert.pct.P2O5 * 10;
      if (nutrient === 'K' && fert.pct.K2O) score += fert.pct.K2O * 10;
      if (nutrient === 'Mg' && fert.pct.Mg) score += fert.pct.Mg * 10;

      // Bonus for NH4 if needed
      if (preferNH4 && fert.pct.N_NH4) score += fert.pct.N_NH4 * 5;

      // Bonus for S if needed
      if (preferS && fert.pct.S) score += fert.pct.S * 3;

      if (score > bestScore) {
        bestScore = score;
        best = fert;
      }
    });

    return best;
  }

  // Helper to calculate nutrient weight contribution (in grams) from fertilizer
  function calculateNutrientGrams(fert, fertGrams) {
    const grams = { N: 0, P: 0, K: 0, Ca: 0, Mg: 0, S: 0 };

    Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
      const nutrientGrams = fertGrams * (percentage / 100);

      if (nutrient === 'P2O5') {
        grams.P += nutrientGrams * OXIDE_CONVERSIONS.P2O5_to_P;
      } else if (nutrient === 'K2O') {
        grams.K += nutrientGrams * OXIDE_CONVERSIONS.K2O_to_K;
      } else if (nutrient === 'N_NO3' || nutrient === 'N_NH4') {
        grams.N += nutrientGrams;
      } else if (nutrient === 'N_total' && !fert.pct.N_NO3 && !fert.pct.N_NH4) {
        grams.N += nutrientGrams;
      } else if (nutrient === 'Ca' || nutrient === 'Mg' || nutrient === 'S') {
        grams[nutrient] += nutrientGrams;
      }
    });

    return grams;
  }

  // Step 1: Add Phosphorus (if needed)
  // Using commercial P2O5 directly, no conversion
  if (targetPPM_Commercial.P2O5 > 0) {
    const pFert = findBestFor('P');
    if (pFert && pFert.pct.P2O5) {
      const gramsNeeded = (targetPPM_Commercial.P2O5 * volume) / (pFert.pct.P2O5 * 10);
      addFertilizer(pFert, gramsNeeded);
    }
  }

  // Step 2: Add Potassium (if needed)
  // Using commercial K2O directly, no conversion
  if (targetPPM_Commercial.K2O > 0) {
    const kFert = findBestFor('K');
    if (kFert && kFert.pct.K2O) {
      const gramsNeeded = (targetPPM_Commercial.K2O * volume) / (kFert.pct.K2O * 10);
      addFertilizer(kFert, gramsNeeded);
    }
  }

  // Step 3: Add Calcium (if needed)
  if (targetPPM_Commercial.Ca > 0) {
    const caFert = findBestFor('Ca');
    if (caFert && caFert.pct.Ca) {
      const gramsNeeded = (targetPPM_Commercial.Ca * volume) / (caFert.pct.Ca * 10);
      addFertilizer(caFert, gramsNeeded);
    }
  }

  // Step 4: Add Magnesium (if needed)
  if (targetPPM_Commercial.Mg > 0) {
    const mgFert = findBestFor('Mg');
    if (mgFert && mgFert.pct.Mg) {
      const gramsNeeded = (targetPPM_Commercial.Mg * volume) / (mgFert.pct.Mg * 10);
      addFertilizer(mgFert, gramsNeeded);
    }
  }

  // Step 5: Add Sulfur (if needed)
  if (targetPPM_Commercial.S > 0) {
    const sFert = availableFertilizers.find(f => f.pct.S && f.pct.S > 0);
    if (sFert) {
      const gramsNeeded = (targetPPM_Commercial.S * volume) / (sFert.pct.S * 10);
      addFertilizer(sFert, gramsNeeded);
    }
  }

  // Step 6: Add Nitrogen (if needed and not achieved through other fertilizers)
  if (targetPPM_Commercial.N > 0) {
    const needN = Math.max(0, targetPPM_Commercial.N - achieved.N_total);
    if (needN > targetPPM_Commercial.N * 0.1) {
      const nFert = availableFertilizers.find(f => f.pct.N_total && f.pct.N_total > 15 && !f.pct.P2O5);
      if (nFert) {
        const gramsNeeded = (needN * volume) / (nFert.pct.N_total * 10);
        addFertilizer(nFert, gramsNeeded);
      }
    }
  }

  return { formula, achieved, targetRatios, targetPPM: targetPPM_Commercial };
}

// Display formula results
function displayFormulaResults(result, targets, volume) {
  const resultsSection = document.getElementById('formula-results');
  const outputDiv = document.getElementById('formula-output');

  resultsSection.style.display = 'block';

  let html = '<div class="formula-result"><h3>Fertilizers to Add (per ' + volume + 'L)</h3>';

  // Display formula
  Object.entries(result.formula).forEach(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    if (fert) {
      const composition = Object.entries(fert.pct)
        .map(([key, val]) => `${key}: ${val}%`)
        .join(', ');
      html += `
        <div class="formula-fertilizer">
          <div class="formula-fertilizer-info">
            <div class="formula-fertilizer-name">${fert.name}</div>
            <div class="formula-fertilizer-composition">${composition}</div>
          </div>
          <div class="formula-fertilizer-amount">${grams.toFixed(2)} g</div>
        </div>
      `;
    }
  });

  html += '</div>';

  // Comparison table
  html += '<h3>Target vs Achieved</h3>';
  html += '<div class="comparison-table-wrapper">';
  html += '<table class="comparison-table">';
  html += '<tr><th>Nutrient</th><th>Target (ppm)</th><th>Achieved (ppm)</th><th>Difference</th></tr>';

  const nutrients = ['N_total', 'P', 'K', 'Ca', 'Mg', 'S'];
  const labels = {
    N_total: 'Nitrogen (N)',
    P: 'Phosphorus (P)',
    K: 'Potassium (K)',
    Ca: 'Calcium (Ca)',
    Mg: 'Magnesium (Mg)',
    S: 'Sulfur (S)'
  };

  let allGood = true;
  const warnings = [];

  nutrients.forEach(nutrient => {
    const targetKey = nutrient === 'N_total' ? 'N' : nutrient;
    const target = targets[targetKey];
    const achieved = result.achieved[nutrient] || 0;

    if (target === 0 && nutrient === 'S') return; // Skip S if not specified

    const diff = achieved - target;
    const percentDiff = target > 0 ? (Math.abs(diff) / target * 100) : 0;

    let className = 'match';
    let status = '✓';

    if (percentDiff > 20) {
      className = 'miss';
      status = '✗';
      allGood = false;
      warnings.push(`${labels[nutrient]} is ${percentDiff.toFixed(1)}% off target`);
    } else if (percentDiff > 10) {
      className = 'close';
      status = '⚠';
      warnings.push(`${labels[nutrient]} is ${percentDiff.toFixed(1)}% off target (acceptable range)`);
    }

    html += `
      <tr>
        <td>${labels[nutrient]}</td>
        <td>${target.toFixed(1)}</td>
        <td class="${className}">${achieved.toFixed(1)} ${status}</td>
        <td class="${className}">${diff >= 0 ? '+' : ''}${diff.toFixed(1)} (${percentDiff.toFixed(1)}%)</td>
      </tr>
    `;
  });

  html += '</table>';
  html += '</div>';

  // NH4-N percentage
  const nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;
  html += `<div class="conversion-note" style="margin-top: 15px;">
    <strong>Nitrogen Form:</strong> ${result.achieved.N_NH4.toFixed(1)} ppm NH₄-N (${nh4Percent.toFixed(1)}% of total N),
    ${result.achieved.N_NO3.toFixed(1)} ppm NO₃-N (${(100 - nh4Percent).toFixed(1)}% of total N)
  </div>`;

  // Calculate ion balance for this formula
  const activeFertilizers = Object.entries(result.formula).map(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    return { ...fert, grams };
  });

  const ionBalance = calculateIonBalanceForFormula(activeFertilizers, volume);

  html += '<h3 style="margin-top: 20px;">Ion Balance</h3>';
  html += `<div class="ion-balance-summary" style="margin-top: 10px;">
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">Cations</div>
      <div style="font-size: 1.3em; font-weight: bold;">${ionBalance.totalCations.toFixed(2)} meq/L</div>
    </div>
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">Anions</div>
      <div style="font-size: 1.3em; font-weight: bold;">${ionBalance.totalAnions.toFixed(2)} meq/L</div>
    </div>
    <div class="ion-balance-card status" style="background: ${ionBalance.statusColor}20; border-color: ${ionBalance.statusColor};">
      <div style="font-size: 0.9em; color: #666;">Imbalance</div>
      <div style="font-size: 1.3em; font-weight: bold; color: ${ionBalance.statusColor};">${ionBalance.imbalance.toFixed(1)}%</div>
      <div style="font-size: 0.9em; color: ${ionBalance.statusColor};">${ionBalance.statusText}</div>
    </div>
  </div>`;

  // Add nutrient ratio analysis
  const ratios = calculateNutrientRatios(result.achieved);
  if (ratios.length > 0) {
    html += '<h3 style="margin-top: 20px;">Nutrient Ratio Analysis</h3>';
    html += '<div class="nutrient-ratio-grid">';

    ratios.forEach(ratio => {
      const unit = ratio.unit || 'ppm';
      html += `
        <div class="nutrient-ratio-card">
          <div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 1.1em;">
            ${ratio.name}
          </div>
          <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
            ${ratio.ratio}
          </div>
          <div style="font-size: 0.85em; color: #666;">
            ${ratio.labels.map((label, i) => `${label}: ${ratio.values[i].toFixed(1)} ${unit}`).join(' | ')}
          </div>
        </div>
      `;
    });

    html += '</div>';
  }

  // Warnings or errors
  if (!allGood) {
    html += '<div class="error-box"><strong>⚠ Cannot achieve exact targets</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul><p>This is the closest formula achievable with available fertilizers. Consider adjusting your targets or accepting the shown deviations.</p></div>';
  } else if (warnings.length > 0) {
    html += '<div class="warning-box"><strong>Note:</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul></div>';
  }

  outputDiv.innerHTML = html;
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Calculate ion balance for formula (returns summary data)
function calculateIonBalanceForFormula(activeFertilizers, volume) {
  let totalCations = 0;
  let totalAnions = 0;

  activeFertilizers.forEach(fert => {
    const ionData = ION_DATA[fert.id];
    if (!ionData) return;

    const moles = fert.grams / ionData.molarMass;

    ionData.ions.forEach(ionInfo => {
      const meq = moles * ionInfo.count * ionInfo.charge * 1000;
      const meqPerLiter = meq / volume;

      if (ionInfo.type === 'cation') {
        totalCations += meqPerLiter;
      } else {
        totalAnions += meqPerLiter;
      }
    });
  });

  const average = (totalCations + totalAnions) / 2;
  const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;

  let statusColor, statusText;
  if (imbalance <= 10) {
    statusColor = '#28a745';
    statusText = 'Balanced ✓';
  } else if (imbalance <= 20) {
    statusColor = '#ffc107';
    statusText = 'Caution ⚠';
  } else {
    statusColor = '#dc3545';
    statusText = 'Imbalanced ✗';
  }

  return { totalCations, totalAnions, imbalance, statusColor, statusText };
}

// ============================================================================
// REVERSE CALCULATOR FUNCTIONS
// ============================================================================

// Render reverse fertilizers list
function renderReverseFertilizersList() {
  const container = document.getElementById('reverse-fertilizers-list');
  if (!container) return;

  container.innerHTML = '';

  FERTILIZERS.forEach(fert => {
    const item = document.createElement('div');
    item.className = 'fertilizer-checkbox-item';
    item.id = `reverse-item-${fert.id}`;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `reverse-${fert.id}`;
    checkbox.checked = COMMON_FERTILIZERS.includes(fert.id); // Pre-select common fertilizers

    const label = document.createElement('label');
    label.htmlFor = `reverse-${fert.id}`;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'fertilizer-label-name';
    nameSpan.textContent = fert.name;
    label.appendChild(nameSpan);

    if (fert.aliases && fert.aliases.length > 0) {
      const aliasSpan = document.createElement('span');
      aliasSpan.className = 'fertilizer-label-aliases';
      aliasSpan.textContent = fert.aliases.join(', ');
      label.appendChild(aliasSpan);
    }

    item.appendChild(checkbox);
    item.appendChild(label);
    container.appendChild(item);
  });
}

// Select all reverse fertilizers
function selectAllReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) checkbox.checked = true;
  });
}

// Deselect all reverse fertilizers
function deselectAllReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Select only common reverse fertilizers
function selectCommonReverseFertilizers() {
  FERTILIZERS.forEach(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    if (checkbox) {
      checkbox.checked = COMMON_FERTILIZERS.includes(fert.id);
    }
  });
}

// Filter reverse fertilizers based on search term
function filterReverseFertilizers(searchTerm) {
  const normalizedSearch = searchTerm.toLowerCase().trim();

  FERTILIZERS.forEach(fert => {
    const item = document.getElementById(`reverse-item-${fert.id}`);
    if (!item) return;

    // Search in name and aliases
    const nameMatch = fert.name.toLowerCase().includes(normalizedSearch);
    const aliasMatch = fert.aliases && fert.aliases.some(alias =>
      alias.toLowerCase().includes(normalizedSearch)
    );

    // Show/hide based on match
    if (nameMatch || aliasMatch || normalizedSearch === '') {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}

// Clear reverse calculator
// Update input labels based on calculation mode
function updateReverseCalculationMode() {
  const mode = document.getElementById('reverse-calculation-mode').value;
  const pLabel = document.querySelector('label[for="reverse-p"]');
  const kLabel = document.querySelector('label[for="reverse-k"]');

  if (mode === 'elemental') {
    pLabel.textContent = 'Phosphorus (P)';
    kLabel.textContent = 'Potassium (K)';
  } else {
    pLabel.textContent = 'Phosphorus (P₂O₅)';
    kLabel.textContent = 'Potassium (K₂O)';
  }
}

function clearReverseCalculator() {
  // Clear target inputs and remove error states
  const targetIds = ['reverse-n', 'reverse-p', 'reverse-k', 'reverse-ca', 'reverse-mg', 'reverse-s'];
  targetIds.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.value = '';
      input.classList.remove('input-error');
    }
  });

  // Reset volume
  const volumeInput = document.getElementById('reverse-volume');
  if (volumeInput) {
    volumeInput.value = '10';
    volumeInput.classList.remove('input-error');
  }

  // Reset fertilizer selections to common only
  selectCommonReverseFertilizers();

  // Clear search box
  const searchInput = document.getElementById('reverse-fertilizer-search');
  if (searchInput) {
    searchInput.value = '';
    filterReverseFertilizers('');
  }

  // Hide results
  const resultsSection = document.getElementById('reverse-results');
  if (resultsSection) {
    resultsSection.style.display = 'none';
  }
}

// Main reverse calculator function
function calculateReverse() {
  // Get target values
  const targets = {
    N: parseFloat(document.getElementById('reverse-n').value) || 0,
    P: parseFloat(document.getElementById('reverse-p').value) || 0,
    K: parseFloat(document.getElementById('reverse-k').value) || 0,
    Ca: parseFloat(document.getElementById('reverse-ca').value) || 0,
    Mg: parseFloat(document.getElementById('reverse-mg').value) || 0,
    S: parseFloat(document.getElementById('reverse-s').value) || 0
  };

  const volume = parseFloat(document.getElementById('reverse-volume').value) || 10;
  const concentration = parseFloat(document.getElementById('reverse-concentration').value) || 75;

  // Validate inputs
  let hasError = false;
  const allNutrientFields = ['reverse-n', 'reverse-p', 'reverse-k', 'reverse-ca', 'reverse-mg', 'reverse-s'];

  // Validate all nutrient fields - must be valid numbers >= 0 or blank (treated as 0)
  allNutrientFields.forEach(id => {
    const input = document.getElementById(id);
    const value = input.value.trim();

    // Allow empty fields (treated as 0) or valid numbers >= 0
    if (value !== '' && (isNaN(parseFloat(value)) || parseFloat(value) < 0)) {
      input.classList.add('input-error');
      hasError = true;
    } else {
      input.classList.remove('input-error');
    }
  });

  // Check that at least one nutrient has a value > 0
  const hasAtLeastOneNutrient = Object.values(targets).some(val => val > 0);
  if (!hasAtLeastOneNutrient) {
    alert('Please enter at least one nutrient value greater than zero.');
    return;
  }

  // Validate volume
  const volumeInput = document.getElementById('reverse-volume');
  if (!volume || volume <= 0) {
    volumeInput.classList.add('input-error');
    hasError = true;
  } else {
    volumeInput.classList.remove('input-error');
  }

  if (hasError) {
    alert('Please fill in all nutrient fields with valid values (0 or greater). At least one nutrient must be greater than zero.');
    return;
  }

  // Get selected fertilizers
  const selectedFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`reverse-${fert.id}`);
    return checkbox && checkbox.checked;
  });

  if (selectedFertilizers.length === 0) {
    alert('Please select at least one fertilizer to use.');
    return;
  }

  // Run optimization
  const result = optimizeFormula(targets, volume, selectedFertilizers, concentration);

  // Display results
  displayReverseResults(result, targets, volume);
}

// Display reverse calculator results
function displayReverseResults(result, targets, volume) {
  const resultsSection = document.getElementById('reverse-results');
  const outputDiv = document.getElementById('reverse-output');

  resultsSection.style.display = 'block';

  let html = '<div class="formula-result"><h3>Fertilizers to Add (per ' + volume + 'L)</h3>';

  // Display formula
  if (Object.keys(result.formula).length === 0) {
    html += '<div class="error-box"><strong>Unable to calculate formula</strong><p>The selected fertilizers cannot achieve the target nutrient ratios. Try selecting different fertilizers or adjusting your targets.</p></div>';
  } else {
    Object.entries(result.formula).forEach(([fertId, grams]) => {
      const fert = FERTILIZERS.find(f => f.id === fertId);
      if (fert && grams > 0.01) { // Only show if significant amount
        const composition = Object.entries(fert.pct)
          .map(([key, val]) => `${key}: ${val}%`)
          .join(', ');
        html += `
          <div class="formula-fertilizer">
            <div class="formula-fertilizer-info">
              <div class="formula-fertilizer-name">${fert.name}</div>
              <div class="formula-fertilizer-composition">${composition}</div>
            </div>
            <div class="formula-fertilizer-amount">${grams.toFixed(2)} g</div>
          </div>
        `;
      }
    });
  }

  html += '</div>';

  // Note: Input values for P and K are treated as commercial oxide forms (P2O5, K2O)
  // This matches standard fertilizer labeling conventions
  // We'll display both oxide and elemental forms in the results table

  // Calculate achieved ratios using COMMERCIAL values (N:P2O5:K2O)
  const achievedPPM_Commercial = {
    N: result.achieved.N_total,
    P2O5: result.achieved.P2O5,
    K2O: result.achieved.K2O,
    Ca: result.achieved.Ca,
    Mg: result.achieved.Mg,
    S: result.achieved.S
  };

  // Normalize achieved values to ratios (find smallest non-zero value)
  const achievedValues = Object.values(achievedPPM_Commercial).filter(v => v > 0);
  const minAchieved = achievedValues.length > 0 ? Math.min(...achievedValues) : 1;
  const achievedRatios = {
    N: achievedPPM_Commercial.N > 0 ? achievedPPM_Commercial.N / minAchieved : 0,
    P2O5: achievedPPM_Commercial.P2O5 > 0 ? achievedPPM_Commercial.P2O5 / minAchieved : 0,
    K2O: achievedPPM_Commercial.K2O > 0 ? achievedPPM_Commercial.K2O / minAchieved : 0,
    Ca: achievedPPM_Commercial.Ca > 0 ? achievedPPM_Commercial.Ca / minAchieved : 0,
    Mg: achievedPPM_Commercial.Mg > 0 ? achievedPPM_Commercial.Mg / minAchieved : 0,
    S: achievedPPM_Commercial.S > 0 ? achievedPPM_Commercial.S / minAchieved : 0
  };

  // Normalize target values to ratios
  const targetValues = Object.values(targets).filter(v => v > 0);
  const minTarget = targetValues.length > 0 ? Math.min(...targetValues) : 1;
  const targetRatios = {
    N: targets.N > 0 ? targets.N / minTarget : 0,
    P2O5: targets.P > 0 ? targets.P / minTarget : 0,  // P input is treated as P2O5
    K2O: targets.K > 0 ? targets.K / minTarget : 0,   // K input is treated as K2O
    Ca: targets.Ca > 0 ? targets.Ca / minTarget : 0,
    Mg: targets.Mg > 0 ? targets.Mg / minTarget : 0,
    S: targets.S > 0 ? targets.S / minTarget : 0
  };

  // Get calculation mode preference
  const calculationMode = document.getElementById('reverse-calculation-mode').value; // 'oxide' or 'elemental'

  // Comparison table - showing nutrients based on selected mode
  html += '<h3>Target vs Achieved Ratios</h3>';
  html += '<div class="comparison-table-wrapper">';
  html += '<table class="comparison-table">';
  html += '<tr><th>Nutrient</th><th>Target Ratio</th><th>Achieved Ratio</th><th>PPM Achieved</th></tr>';

  // Display nutrients based on calculation mode
  let displayNutrients;
  if (calculationMode === 'elemental') {
    // Elemental mode: Show P and K (pure elements)
    displayNutrients = [
      { key: 'N', label: 'Nitrogen (N)', isCommercial: false },
      { key: 'P', label: 'Phosphorus (P)', isCommercial: false },
      { key: 'K', label: 'Potassium (K)', isCommercial: false },
      { key: 'Ca', label: 'Calcium (Ca)', isCommercial: false },
      { key: 'Mg', label: 'Magnesium (Mg)', isCommercial: false },
      { key: 'S', label: 'Sulfur (S)', isCommercial: false }
    ];
  } else {
    // Oxide mode: Show P₂O₅ and K₂O (commercial standard)
    displayNutrients = [
      { key: 'N', label: 'Nitrogen (N)', isCommercial: false },
      { key: 'P2O5', label: 'Phosphorus (P₂O₅)', isCommercial: true },
      { key: 'K2O', label: 'Potassium (K₂O)', isCommercial: true },
      { key: 'Ca', label: 'Calcium (Ca)', isCommercial: false },
      { key: 'Mg', label: 'Magnesium (Mg)', isCommercial: false },
      { key: 'S', label: 'Sulfur (S)', isCommercial: false }
    ];
  }

  let allGood = true;
  const warnings = [];

  displayNutrients.forEach(nutrient => {
    let targetRatio, achievedRatio, achievedPPM;

    // Get the ratio values for comparison (normalized)
    if (nutrient.key === 'N') {
      targetRatio = targetRatios.N;
      achievedRatio = achievedRatios.N;
      achievedPPM = result.achieved.N_total;
    } else if (nutrient.key === 'P') {
      // Elemental P - use P2O5 ratio but show elemental PPM
      targetRatio = targetRatios.P2O5;
      achievedRatio = achievedRatios.P2O5;
      achievedPPM = result.achieved.P || 0;
    } else if (nutrient.key === 'P2O5') {
      // Oxide form P2O5 (commercial)
      targetRatio = targetRatios.P2O5;
      achievedRatio = achievedRatios.P2O5;
      achievedPPM = result.achieved.P2O5 || 0;
    } else if (nutrient.key === 'K') {
      // Elemental K - use K2O ratio but show elemental PPM
      targetRatio = targetRatios.K2O;
      achievedRatio = achievedRatios.K2O;
      achievedPPM = result.achieved.K || 0;
    } else if (nutrient.key === 'K2O') {
      // Oxide form K2O (commercial)
      targetRatio = targetRatios.K2O;
      achievedRatio = achievedRatios.K2O;
      achievedPPM = result.achieved.K2O || 0;
    } else {
      // Ca, Mg, S - already elemental
      targetRatio = targetRatios[nutrient.key] || 0;
      achievedRatio = achievedRatios[nutrient.key] || 0;
      achievedPPM = result.achieved[nutrient.key] || 0;
    }

    // Skip if both target and achieved are zero
    if (targetRatio === 0 && achievedRatio === 0) return;

    // Compare RATIOS, not absolute PPM values
    const ratioDiff = targetRatio > 0 ? Math.abs((achievedRatio - targetRatio) / targetRatio * 100) : 0;

    let className = 'match';
    let status = '✓';

    if (ratioDiff > 15) {
      className = 'miss';
      status = '✗';
      allGood = false;
      if (!nutrient.isCommercial) {  // Only warn once for elemental form
        warnings.push(`${nutrient.label} ratio is ${ratioDiff.toFixed(1)}% off target`);
      }
    } else if (ratioDiff > 5) {
      className = 'close';
      status = '⚠';
      if (!nutrient.isCommercial) {  // Only warn once for elemental form
        warnings.push(`${nutrient.label} ratio is ${ratioDiff.toFixed(1)}% off target (acceptable range)`);
      }
    }

    html += `
      <tr>
        <td>${nutrient.label}</td>
        <td>${targetRatio.toFixed(2)}</td>
        <td class="${className}">${achievedRatio.toFixed(2)} ${status}</td>
        <td>${achievedPPM.toFixed(1)} ppm</td>
      </tr>
    `;
  });

  html += '</table>';
  html += '</div>';

  // Add mode-specific conversion note
  if (calculationMode === 'elemental') {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>Elemental Mode:</strong> Values shown are pure elements (P, K).
      <br>
      To convert to oxide forms: P₂O₅ = P × 2.29, K₂O = K × 1.20
    </div>`;
  } else {
    html += `<div class="conversion-note" style="margin-top: 15px;">
      <strong>Oxide Mode:</strong> Values shown are commercial oxide forms (P₂O₅, K₂O).
      <br>
      To convert to elements: P = P₂O₅ × 0.436, K = K₂O × 0.830
    </div>`;
  }

  // NH4-N percentage
  const nh4Percent = result.achieved.N_total > 0 ? (result.achieved.N_NH4 / result.achieved.N_total * 100) : 0;
  html += `<div class="conversion-note" style="margin-top: 15px;">
    <strong>Nitrogen Form:</strong> ${result.achieved.N_NH4.toFixed(1)} ppm NH₄-N (${nh4Percent.toFixed(1)}% of total N),
    ${result.achieved.N_NO3.toFixed(1)} ppm NO₃-N (${(100 - nh4Percent).toFixed(1)}% of total N)
  </div>`;

  // Calculate ion balance for this formula
  const activeFertilizers = Object.entries(result.formula).map(([fertId, grams]) => {
    const fert = FERTILIZERS.find(f => f.id === fertId);
    return { ...fert, grams };
  });

  const ionBalance = calculateIonBalanceForFormula(activeFertilizers, volume);

  html += '<h3 style="margin-top: 20px;">Ion Balance</h3>';
  html += `<div class="ion-balance-summary" style="margin-top: 10px;">
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">Cations</div>
      <div style="font-size: 1.3em; font-weight: bold;">${ionBalance.totalCations.toFixed(2)} meq/L</div>
    </div>
    <div class="ion-balance-card">
      <div style="font-size: 0.9em; color: #666;">Anions</div>
      <div style="font-size: 1.3em; font-weight: bold;">${ionBalance.totalAnions.toFixed(2)} meq/L</div>
    </div>
    <div class="ion-balance-card status" style="background: ${ionBalance.statusColor}20; border-color: ${ionBalance.statusColor};">
      <div style="font-size: 0.9em; color: #666;">Imbalance</div>
      <div style="font-size: 1.3em; font-weight: bold; color: ${ionBalance.statusColor};">${ionBalance.imbalance.toFixed(1)}%</div>
      <div style="font-size: 0.9em; color: ${ionBalance.statusColor};">${ionBalance.statusText}</div>
    </div>
  </div>`;

  // Add nutrient ratio analysis
  const ratios = calculateNutrientRatios(result.achieved);
  if (ratios.length > 0) {
    html += '<h3 style="margin-top: 20px;">Nutrient Ratio Analysis</h3>';
    html += '<div class="nutrient-ratio-grid">';

    ratios.forEach(ratio => {
      const unit = ratio.unit || 'ppm';
      html += `
        <div class="nutrient-ratio-card">
          <div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 1.1em;">
            ${ratio.name}
          </div>
          <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px;">
            ${ratio.ratio}
          </div>
          <div style="font-size: 0.85em; color: #666;">
            ${ratio.labels.map((label, i) => `${label}: ${ratio.values[i].toFixed(1)} ${unit}`).join(' | ')}
          </div>
        </div>
      `;
    });

    html += '</div>';
  }

  // Warnings or errors
  if (!allGood) {
    html += '<div class="error-box"><strong>⚠ Cannot achieve exact targets</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul><p>This is the closest formula achievable with selected fertilizers. Consider:</p><ul><li>Selecting additional fertilizers</li><li>Adjusting your target values</li><li>Accepting the shown deviations</li></ul></div>';
  } else if (warnings.length > 0) {
    html += '<div class="warning-box"><strong>Note:</strong><ul>';
    warnings.forEach(w => html += `<li>${w}</li>`);
    html += '</ul></div>';
  } else {
    html += '<div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 4px; margin-top: 15px;"><strong style="color: #28a745;">✓ Targets Successfully Achieved!</strong><p style="margin: 5px 0 0 0;">All nutrient values are within acceptable ranges.</p></div>';
  }

  outputDiv.innerHTML = html;
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// PPM Explanation Modal Functions
let calculationData = null; // Store calculation data for the modal

function openPPMExplanation() {
  const modal = document.getElementById('ppm-modal');
  const modalBody = modal.querySelector('.modal-body');

  // Generate dynamic content based on current calculation
  modalBody.innerHTML = generateExplanationContent();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
}

function closePPMExplanation(event) {
  if (event && event.target !== event.currentTarget) return;

  const modal = document.getElementById('ppm-modal');
  modal.classList.remove('active');
  document.body.style.overflow = ''; // Restore scrolling
}

function generateExplanationContent() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value) || 10;

  // Get active fertilizers
  const activeFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`check-${fert.id}`);
    const input = document.getElementById(`grams-${fert.id}`);
    const grams = input ? parseFloat(input.value) : 0;
    return checkbox && checkbox.checked && grams > 0;
  }).map(fert => {
    const input = document.getElementById(`grams-${fert.id}`);
    return {
      ...fert,
      grams: parseFloat(input.value)
    };
  });

  let content = `
    <!-- What is PPM? -->
    <div class="explanation-section">
      <h3>What is PPM?</h3>
      <p>
        <strong>PPM stands for "Parts Per Million"</strong> - it's a way to measure very small concentrations.
        Think of it like this: <span class="highlight">1 PPM = 1 milligram per liter (mg/L)</span>.
      </p>
      <p>
        For example, 100 PPM of Nitrogen means there are 100 milligrams of nitrogen in every liter of water.
      </p>
    </div>

    <!-- The Basic Formula -->
    <div class="explanation-section">
      <h3>The Basic Formula</h3>
      <div class="formula-box">
        <div class="formula">PPM = (grams × 1000 × percentage) ÷ liters</div>
        <div class="description">This tells us the concentration of nutrients in your solution</div>
      </div>
      <p><strong>Where:</strong></p>
      <ul style="line-height: 1.8;">
        <li><strong>grams</strong> = Amount of fertilizer you're adding</li>
        <li><strong>1000</strong> = Converts grams to milligrams (mg)</li>
        <li><strong>percentage</strong> = The nutrient content in the fertilizer (÷ 100)</li>
        <li><strong>liters</strong> = Volume of water in your solution</li>
      </ul>
    </div>
  `;

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">No Calculation Yet</h3>
        <p>
          Add some fertilizers and click "Calculate" to see your personalized calculation breakdown here!
        </p>
        <p>
          The calculator will show you step-by-step how we arrived at each PPM value based on your specific fertilizer selections and amounts.
        </p>
      </div>
    `;
  } else {
    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">Your Current Calculation</h3>
        <p><strong>Solution Volume:</strong> ${volume} liters</p>
        <p><strong>Fertilizers Used:</strong> ${activeFertilizers.length}</p>
      </div>
    `;

    // Calculate contributions from each fertilizer
    const nutrientContributions = {};

    content += `
      <div class="explanation-section">
        <h3>Step-by-Step Breakdown</h3>
        <p>Here's exactly how we calculated each nutrient from your selected fertilizers:</p>
    `;

    activeFertilizers.forEach((fert, index) => {
      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${fert.name}
          </h4>
          <p style="margin: 10px 0 10px 38px;"><strong>Amount used:</strong> ${fert.grams} grams</p>
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>Nutrient</th>
                  <th>% in Fertilizer</th>
                  <th>Calculation</th>
                  <th>PPM</th>
                </tr>
              </thead>
              <tbody>
      `;

      Object.entries(fert.pct).forEach(([nutrient, percentage]) => {
        const ppm = (fert.grams * 1000 * (percentage / 100)) / volume;
        const calculation = `(${fert.grams} × 1000 × ${percentage / 100}) ÷ ${volume}`;

        // Track contributions for summary
        if (!nutrientContributions[nutrient]) {
          nutrientContributions[nutrient] = [];
        }
        nutrientContributions[nutrient].push({
          fertilizer: fert.name,
          ppm: ppm,
          percentage: percentage
        });

        content += `
          <tr>
            <td><strong>${nutrient}</strong></td>
            <td>${percentage}%</td>
            <td style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td><strong>${ppm.toFixed(2)} PPM</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary section showing total PPM for each nutrient
    if (Object.keys(nutrientContributions).length > 0) {
      content += `
        <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
          <h3 style="color: #28a745;">Final Results - Total PPM</h3>
          <p>When using multiple fertilizers, we add up the PPM from each source:</p>
          <div style="margin-top: 15px;">
      `;

      // Calculate final results with oxide conversions
      const finalResults = {};
      Object.entries(nutrientContributions).forEach(([nutrient, contributions]) => {
        const totalPPM = contributions.reduce((sum, c) => sum + c.ppm, 0);

        // Check if this is an oxide that needs conversion
        let displayNutrient = nutrient;
        let displayPPM = totalPPM;
        let conversionNote = '';

        if (nutrient === 'P2O5' && OXIDE_CONVERSIONS.P2O5_to_P) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.P2O5_to_P;
          finalResults['P'] = convertedPPM;
          conversionNote = ` → <strong>${convertedPPM.toFixed(2)} PPM P</strong> (elemental form)`;
          displayNutrient = 'P₂O₅';
        } else if (nutrient === 'K2O' && OXIDE_CONVERSIONS.K2O_to_K) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.K2O_to_K;
          finalResults['K'] = convertedPPM;
          conversionNote = ` → <strong>${convertedPPM.toFixed(2)} PPM K</strong> (elemental form)`;
          displayNutrient = 'K₂O';
        } else if (nutrient === 'MgO' && OXIDE_CONVERSIONS.MgO_to_Mg) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.MgO_to_Mg;
          finalResults['Mg'] = convertedPPM;
          conversionNote = ` → <strong>${convertedPPM.toFixed(2)} PPM Mg</strong> (elemental form)`;
        } else if (nutrient === 'CaO' && OXIDE_CONVERSIONS.CaO_to_Ca) {
          const convertedPPM = totalPPM * OXIDE_CONVERSIONS.CaO_to_Ca;
          finalResults['Ca'] = convertedPPM;
          conversionNote = ` → <strong>${convertedPPM.toFixed(2)} PPM Ca</strong> (elemental form)`;
        } else {
          finalResults[nutrient] = totalPPM;
        }

        content += `
          <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 3px solid #28a745;">
            <strong style="font-size: 1.1em; color: #28a745;">${displayNutrient}:</strong>
        `;

        if (contributions.length > 1) {
          content += `<div style="margin: 8px 0 8px 20px; line-height: 1.8;">`;
          contributions.forEach(c => {
            content += `<div>• ${c.fertilizer}: ${c.ppm.toFixed(2)} PPM</div>`;
          });
          content += `</div>`;
          content += `<div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #dee2e6;">`;
          content += `<strong>Total: ${totalPPM.toFixed(2)} PPM${conversionNote}</strong>`;
          content += `</div>`;
        } else {
          content += ` <strong>${totalPPM.toFixed(2)} PPM${conversionNote}</strong>`;
        }

        content += `</div>`;
      });

      content += `
          </div>
        </div>
      `;

      // Oxide conversion explanation if applicable
      const hasOxides = Object.keys(nutrientContributions).some(n =>
        n === 'P2O5' || n === 'K2O' || n === 'MgO' || n === 'CaO'
      );

      if (hasOxides) {
        content += `
          <div class="explanation-section">
            <h3>About Oxide Conversions</h3>
            <p>
              Some fertilizers list nutrients in <strong>oxide form</strong> (like P₂O₅, K₂O),
              but plants use the <strong>elemental form</strong> (P, K). The calculator automatically converts these:
            </p>
            <table class="conversion-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Oxide Form</th>
                  <th>Elemental Form</th>
                  <th>Conversion Factor</th>
                </tr>
              </thead>
              <tbody>
        `;

        if (nutrientContributions['P2O5']) {
          content += `
                <tr>
                  <td>P₂O₅ (Phosphate)</td>
                  <td>P (Phosphorus)</td>
                  <td>×0.436</td>
                </tr>
          `;
        }
        if (nutrientContributions['K2O']) {
          content += `
                <tr>
                  <td>K₂O (Potash)</td>
                  <td>K (Potassium)</td>
                  <td>×0.830</td>
                </tr>
          `;
        }
        if (nutrientContributions['MgO']) {
          content += `
                <tr>
                  <td>MgO (Magnesium Oxide)</td>
                  <td>Mg (Magnesium)</td>
                  <td>×0.603</td>
                </tr>
          `;
        }
        if (nutrientContributions['CaO']) {
          content += `
                <tr>
                  <td>CaO (Calcium Oxide)</td>
                  <td>Ca (Calcium)</td>
                  <td>×0.715</td>
                </tr>
          `;
        }

        content += `
              </tbody>
            </table>
          </div>
        `;
      }
    }
  }

  // Always include helpful tips
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">Quick Tips</h3>
      <ul style="line-height: 1.8;">
        <li>1 PPM = 1 mg/L (milligram per liter)</li>
        <li>Start with lower PPM values and increase gradually</li>
        <li>Different plants need different nutrient levels</li>
        <li>More fertilizer ≠ better growth; balance is key</li>
        <li>Check your water's existing nutrient content if possible</li>
      </ul>
    </div>
  `;

  return content;
}

// Ion Balance Explanation Modal Functions
function openIonBalanceExplanation() {
  const modal = document.getElementById('ion-balance-modal');
  const modalBody = modal.querySelector('#ion-balance-modal-body');

  // Generate dynamic content based on current calculation
  modalBody.innerHTML = generateIonBalanceExplanation();

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeIonBalanceExplanation(event) {
  if (event && event.target !== event.currentTarget) return;

  const modal = document.getElementById('ion-balance-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function generateIonBalanceExplanation() {
  const volumeInput = document.getElementById('volume');
  const volume = parseFloat(volumeInput.value) || 10;

  // Get active fertilizers
  const activeFertilizers = FERTILIZERS.filter(fert => {
    const checkbox = document.getElementById(`check-${fert.id}`);
    const input = document.getElementById(`grams-${fert.id}`);
    const grams = input ? parseFloat(input.value) : 0;
    return checkbox && checkbox.checked && grams > 0;
  }).map(fert => {
    const input = document.getElementById(`grams-${fert.id}`);
    return {
      ...fert,
      grams: parseFloat(input.value)
    };
  });

  let content = `
    <!-- What is Ion Balance? -->
    <div class="explanation-section">
      <h3>What is Ion Balance?</h3>
      <p>
        When fertilizers dissolve in water, they break apart into <strong>charged particles called ions</strong>:
      </p>
      <ul style="line-height: 1.8;">
        <li><strong>Cations (+)</strong> - Positively charged ions like K⁺, Ca²⁺, Mg²⁺, NH₄⁺</li>
        <li><strong>Anions (-)</strong> - Negatively charged ions like NO₃⁻, SO₄²⁻, H₂PO₄⁻</li>
      </ul>
      <p>
        For a <span class="highlight">healthy nutrient solution</span>, the total positive charges should roughly equal the total negative charges.
        This keeps the pH stable and prevents nutrient lockout.
      </p>
    </div>

    <!-- What is meq/L? -->
    <div class="explanation-section">
      <h3>Understanding meq/L (Milliequivalents per Liter)</h3>
      <p>
        <strong>meq/L</strong> is a unit that measures the <strong>electrical charge</strong> of ions in solution, not their weight.
      </p>
      <p>
        Think of it like this: A calcium ion (Ca²⁺) has twice the charge of a potassium ion (K⁺), even if they weigh the same.
        meq/L accounts for this difference in charge.
      </p>
      <div class="formula-box">
        <div class="formula">meq/L = (grams ÷ molar mass) × ion count × charge × 1000 ÷ liters</div>
        <div class="description">This tells us the electrical charge contribution of each ion</div>
      </div>
      <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #6c757d;">
        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">
          <strong>📌 Important Notes:</strong>
        </p>
        <ul style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
          <li><strong>Hydration water</strong> (e.g., ·7H₂O, ·4H₂O) adds to molar mass but NOT to charge - it's just water in the crystal structure</li>
          <li><strong>Urea</strong> doesn't form charged ions, so it's excluded from ion balance (but its nitrogen still counts for nutrients)</li>
        </ul>
      </div>
    </div>
  `;

  if (activeFertilizers.length === 0) {
    content += `
      <div class="explanation-section" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">No Calculation Yet</h3>
        <p>
          Add some fertilizers and click "Calculate" to see your personalized ion balance breakdown here!
        </p>
        <p>
          The calculator will show you step-by-step how each fertilizer contributes cations and anions to your solution.
        </p>
      </div>
    `;
  } else {
    // Calculate ion balance
    let totalCations = 0;
    let totalAnions = 0;
    const ionDetails = {};
    const fertilizerBreakdown = [];

    activeFertilizers.forEach(fert => {
      const ionData = ION_DATA[fert.id];

      if (!ionData) {
        return; // Skip fertilizers without ion data
      }

      const moles = fert.grams / ionData.molarMass;
      const fertIons = [];

      ionData.ions.forEach(ionInfo => {
        const meq = moles * ionInfo.count * ionInfo.charge * 1000;
        const meqPerLiter = meq / volume;

        fertIons.push({
          ...ionInfo,
          meq: meqPerLiter,
          calculation: {
            moles: moles,
            meq: meq,
            meqPerLiter: meqPerLiter
          }
        });

        // Track by ion name
        if (!ionDetails[ionInfo.ion]) {
          ionDetails[ionInfo.ion] = {
            meq: 0,
            type: ionInfo.type
          };
        }
        ionDetails[ionInfo.ion].meq += meqPerLiter;

        // Add to totals
        if (ionInfo.type === 'cation') {
          totalCations += meqPerLiter;
        } else {
          totalAnions += meqPerLiter;
        }
      });

      fertilizerBreakdown.push({
        fert: fert,
        ionData: ionData,
        moles: moles,
        ions: fertIons
      });
    });

    const average = (totalCations + totalAnions) / 2;
    const imbalance = average > 0 ? Math.abs(totalCations - totalAnions) / average * 100 : 0;

    content += `
      <!-- Your Calculation -->
      <div class="explanation-section" style="background: #e8f4f8; border-left-color: #17a2b8;">
        <h3 style="color: #17a2b8;">Your Current Solution</h3>
        <p><strong>Solution Volume:</strong> ${volume} liters</p>
        <p><strong>Fertilizers Used:</strong> ${activeFertilizers.length}</p>
      </div>

      <!-- Step-by-Step Breakdown -->
      <div class="explanation-section">
        <h3>Step-by-Step Ion Calculation</h3>
        <p>Here's how each fertilizer contributes ions to your solution:</p>
    `;

    fertilizerBreakdown.forEach((item, index) => {
      const formulaDisplay = item.ionData.formula ?
        `<span style="background: #e8f4f8; padding: 4px 8px; border-radius: 4px; font-family: monospace; margin-left: 10px; font-size: 0.9em;">${item.ionData.formula}</span>` :
        '';

      // Check for hydration water in the formula
      const hasHydrationWater = item.ionData.formula && item.ionData.formula.includes('H₂O');

      // Check if this is urea or urea-based (name contains 'urea' but not 'urea phosphate' since that has ions)
      const isUreaOnly = item.fert.name.toLowerCase().includes('urea') &&
                         !item.fert.name.toLowerCase().includes('phosphate') &&
                         !item.fert.name.toLowerCase().includes('thiosulfate');

      content += `
        <div class="step">
          <h4 style="margin-top: 0; color: #007bff;">
            <span class="step-number">${index + 1}</span>
            ${item.fert.name}
            ${formulaDisplay}
          </h4>
          <p style="margin: 10px 0 10px 38px;">
            <strong>Amount:</strong> ${item.fert.grams} grams<br>
            <strong>Molar Mass:</strong> ${item.ionData.molarMass} g/mol<br>
            <strong>Moles:</strong> ${item.fert.grams} ÷ ${item.ionData.molarMass} = <strong>${item.moles.toFixed(4)} mol</strong>
          </p>
      `;

      // Add note about hydration water if applicable
      if (hasHydrationWater) {
        content += `
          <div style="margin: 10px 0 10px 38px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.9em;">
            <strong>💧 About Hydration Water:</strong> The water molecules (like ·7H₂O) in this formula add to the molar mass
            but do NOT contribute to the ion balance. They're just water trapped in the crystal structure.
          </div>
        `;
      }

      // Add note about urea if applicable
      if (isUreaOnly) {
        content += `
          <div style="margin: 10px 0 10px 38px; padding: 10px; background: #d1ecf1; border-left: 3px solid #17a2b8; border-radius: 4px; font-size: 0.9em;">
            <strong>ℹ️ About Urea:</strong> Urea does NOT form charged ions like nitrate (NO₃⁻) or ammonium (NH₄⁺).
            Therefore, it is NOT counted in ion balance calculations. However, its nitrogen content IS still counted
            when calculating nutrient PPM values.
          </div>
        `;
      }

      content += `
          <div style="margin-left: 38px;">
            <table class="conversion-table" style="font-size: 0.9em;">
              <thead>
                <tr>
                  <th>Ion</th>
                  <th>Type</th>
                  <th>Count × Charge</th>
                  <th>Calculation</th>
                  <th>meq/L</th>
                </tr>
              </thead>
              <tbody>
      `;

      item.ions.forEach(ion => {
        const chargeSymbol = ion.type === 'cation' ? '+' : '-';
        const calculation = `${item.moles.toFixed(4)} × ${ion.count} × ${ion.charge} × 1000 ÷ ${volume}`;

        content += `
          <tr>
            <td><strong>${ion.ion}</strong></td>
            <td>${ion.type === 'cation' ? 'Cation (+)' : 'Anion (-)'}</td>
            <td>${ion.count} × ${ion.charge}</td>
            <td style="font-family: monospace; font-size: 0.85em;">${calculation}</td>
            <td><strong>${ion.meq.toFixed(2)} meq/L</strong></td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    content += `</div>`;

    // Summary section
    const cations = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'cation');
    const anions = Object.entries(ionDetails).filter(([ion, data]) => data.type === 'anion');

    let statusColor, statusText;
    if (imbalance <= 10) {
      statusColor = '#28a745';
      statusText = 'Balanced ✓';
    } else if (imbalance <= 20) {
      statusColor = '#ffc107';
      statusText = 'Caution ⚠';
    } else {
      statusColor = '#dc3545';
      statusText = 'Imbalanced ✗';
    }

    content += `
      <div class="explanation-section" style="background: ${statusColor}20; border-left-color: ${statusColor};">
        <h3 style="color: ${statusColor};">Final Ion Balance Results</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
          <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Cations (+)</div>
            <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${totalCations.toFixed(2)}</div>
            <div style="font-size: 0.9em; color: #666;">meq/L</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Anions (-)</div>
            <div style="font-size: 1.8em; font-weight: bold; color: #007bff;">${totalAnions.toFixed(2)}</div>
            <div style="font-size: 0.9em; color: #666;">meq/L</div>
          </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid ${statusColor};">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Imbalance Percentage</div>
          <div style="font-size: 2em; font-weight: bold; color: ${statusColor};">${imbalance.toFixed(1)}%</div>
          <div style="font-size: 1em; color: ${statusColor}; margin-top: 5px;">${statusText}</div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
          <h4 style="margin-top: 0;">How we calculated imbalance:</h4>
          <p style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
            Average = (${totalCations.toFixed(2)} + ${totalAnions.toFixed(2)}) ÷ 2 = ${average.toFixed(2)} meq/L<br>
            Imbalance = |${totalCations.toFixed(2)} - ${totalAnions.toFixed(2)}| ÷ ${average.toFixed(2)} × 100 = <strong>${imbalance.toFixed(1)}%</strong>
          </p>
        </div>
      </div>
    `;

    // Individual ion breakdown
    if (cations.length > 0 || anions.length > 0) {
      content += `
        <div class="explanation-section">
          <h3>Ion Breakdown by Type</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      `;

      // Cations
      content += `
        <div>
          <h4 style="color: #007bff; margin-top: 0;">Cations (+)</h4>
      `;
      cations.forEach(([ion, data]) => {
        const percentage = totalCations > 0 ? (data.meq / totalCations * 100).toFixed(1) : 0;
        content += `
          <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
            <div style="display: flex; justify-content: space-between;">
              <strong>${ion}</strong>
              <span>${data.meq.toFixed(2)} meq/L</span>
            </div>
            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${percentage}% of total cations</div>
          </div>
        `;
      });
      content += `</div>`;

      // Anions
      content += `
        <div>
          <h4 style="color: #007bff; margin-top: 0;">Anions (-)</h4>
      `;
      anions.forEach(([ion, data]) => {
        const percentage = totalAnions > 0 ? (data.meq / totalAnions * 100).toFixed(1) : 0;
        content += `
          <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
            <div style="display: flex; justify-content: space-between;">
              <strong>${ion}</strong>
              <span>${data.meq.toFixed(2)} meq/L</span>
            </div>
            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${percentage}% of total anions</div>
          </div>
        `;
      });
      content += `</div>`;

      content += `</div></div>`;
    }
  }

  // Always include interpretation guide
  content += `
    <div class="explanation-section" style="background: #d4edda; border-left-color: #28a745;">
      <h3 style="color: #28a745;">Interpreting Your Results</h3>
      <ul style="line-height: 1.8;">
        <li><strong>≤10% Imbalance:</strong> Balanced ✓ - Excellent! Your solution has good charge balance</li>
        <li><strong>10-20% Imbalance:</strong> Caution ⚠ - Acceptable, but monitor pH closely</li>
        <li><strong>>20% Imbalance:</strong> Imbalanced ✗ - May cause pH swings and nutrient lockouts</li>
      </ul>
      <p style="margin-top: 15px;">
        <strong>Why does this matter?</strong> Charge imbalance can cause pH to drift up or down,
        which may lock out certain nutrients even if they're present in your solution.
      </p>
    </div>
  `;

  return content;
}

// Initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
